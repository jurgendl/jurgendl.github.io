(function(domGlobals){"use strict";function curry(fn){for(var initialArgs=[],_i=1;_i<arguments.length;_i++)initialArgs[_i-1]=arguments[_i];return function(){for(var restArgs=[],_i=0;_i<arguments.length;_i++)restArgs[_i]=arguments[_i];var all=initialArgs.concat(restArgs);return fn.apply(null,all)}}function __rest(s,e){var t={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(t[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i])&&(t[p[i]]=s[p[i]])}return t}function ClosestOrAncestor(is,ancestor,scope,a,isRoot){return is(scope,a)?Option.some(scope):isFunction(isRoot)&&isRoot(scope)?Option.none():ancestor(scope,a,isRoot)}function Dimension(name,getOffset){var set=function(element,h){if(!isNumber(h)&&!h.match(/^[0-9]+$/))throw new Error(name+".set accepts only positive integer values. Value was "+h);var dom=element.dom();isSupported(dom)&&(dom.style[name]=h+"px")},get=function(element){var r=getOffset(element);if(r<=0||null===r){var css=get$4(element,name);return parseFloat(css)||0}return r},getOuter=get,aggregate=function(element,properties){return foldl(properties,function(acc,property){var val=get$4(element,property),value=void 0===val?0:parseInt(val,10);return isNaN(value)?acc:acc+value},0)},max=function(element,value,properties){var cumulativeInclusions=aggregate(element,properties),absoluteMax=value>cumulativeInclusions?value-cumulativeInclusions:0;return absoluteMax};return{set:set,get:get,getOuter:getOuter,aggregate:aggregate,max:max}}function NodeValue(is,name){var get=function(element){if(!is(element))throw new Error("Can only get "+name+" value of a "+name+" node");return getOption(element).getOr("")},getOption=function(element){return is(element)?Option.from(element.dom().nodeValue):Option.none()},set=function(element,value){if(!is(element))throw new Error("Can only set raw "+name+" value of a "+name+" node");element.dom().nodeValue=value};return{get:get,getOption:getOption,set:set}}function isSketchSpec(spec){return void 0!==spec.uid}function NotificationManagerImpl(editor,extras,uiMothership){var backstage=extras.backstage,getEditorContainer=function(editor){return editor.inline?editor.getElement():editor.getContentAreaContainer()},prePositionNotifications=function(notifications){each(notifications,function(notification){notification.moveTo(0,0)})},positionNotifications=function(notifications){if(notifications.length>0){var firstItem=notifications.slice(0,1)[0],container=getEditorContainer(editor);firstItem.moveRel(container,"tc-tc"),each(notifications,function(notification,index){index>0&&notification.moveRel(notifications[index-1].getEl(),"bc-tc")})}},reposition=function(notifications){prePositionNotifications(notifications),positionNotifications(notifications)},open=function(settings,closeCallback){var close=function(){closeCallback(),InlineView.hide(notificationWrapper)},notification=build$1(Notification.sketch({text:settings.text,level:contains(["success","error","warning","info"],settings.type)?settings.type:void 0,progress:!0===settings.progressBar,icon:Option.from(settings.icon),onAction:close,iconProvider:backstage.shared.providers.icons,translationProvider:backstage.shared.providers.translate})),notificationWrapper=build$1(InlineView.sketch({dom:{tag:"div",classes:["tox-notifications-container"]},lazySink:extras.backstage.shared.getSink,fireDismissalEventInstead:{}}));return uiMothership.add(notificationWrapper),settings.timeout>0&&global$2.setTimeout(function(){close()},settings.timeout),{close:close,moveTo:function(x,y){InlineView.showAt(notificationWrapper,{anchor:"makeshift",x:x,y:y},premade$1(notification))},moveRel:function(element,rel){InlineView.showAt(notificationWrapper,extras.backstage.shared.anchors.banner(),premade$1(notification))},text:function(nuText){Notification.updateText(notification,nuText)},settings:settings,getEl:function(){},progressBar:{value:function(percent){Notification.updateProgress(notification,percent)}}}},close=function(notification){notification.close()},getArgs=function(notification){return notification.settings};return{open:open,close:close,reposition:reposition,getArgs:getArgs}}function renderInsertTableMenuItem(spec){var numRows=10,numColumns=10,sizeLabelId=generate$1("size-label"),cells=makeCells(sizeLabelId,numRows,numColumns),memLabel=record({dom:{tag:"span",classes:["tox-insert-table-picker__label"],attributes:{id:sizeLabelId}},components:[text("0x0")],behaviours:derive$1([Replacing.config({})])});return{type:"widget",data:{value:generate$1("widget-id")},dom:{tag:"div",classes:["tox-fancymenuitem"]},autofocus:!0,components:[parts$2().widget({dom:{tag:"div",classes:["tox-insert-table-picker"]},components:makeComponents(cells).concat(memLabel.asSpec()),behaviours:derive$1([config("insert-table-picker",[runWithTarget(cellOverEvent,function(c,t,e){var row=e.event().row(),col=e.event().col();selectCells(cells,row,col,numRows,numColumns),Replacing.set(memLabel.get(c),[makeLabelText(row,col)])}),runWithTarget(cellExecuteEvent,function(c,_,e){spec.onAction({numRows:e.event().row()+1,numColumns:e.event().col()+1}),emit(c,sandboxClose())})]),Keying.config({initSize:{numRows:numRows,numColumns:numColumns},mode:"flatgrid",selector:'[role="button"]'})])})]}}function ColorCache(max){void 0===max&&(max=10);var storageString=global$8.getItem(storageName),localstorage=isString(storageString)?JSON.parse(storageString):[],prune=function(list){var diff=max-list.length;return diff<0?list.slice(0,max):list},cache=prune(localstorage),add=function(key){indexOf(cache,key).each(remove),cache.unshift(key),cache.length>max&&cache.pop(),global$8.setItem(storageName,JSON.stringify(cache))},remove=function(idx){cache.splice(idx,1)},state=function(){return cache.slice(0)};return{add:add,state:state}}function renderColorSwatchItem(spec,backstage){var items=ColorSwatch.getColors(backstage.colorinput.getColors(),backstage.colorinput.hasCustomColors()),columns=backstage.colorinput.getColorCols(),presets="color",menuSpec=createPartialChoiceMenu(generate$1("menu-value"),items,function(value){spec.onAction({value:value})},columns,presets,ItemResponse$1.CLOSE_ON_EXECUTE,function(){return!1},backstage.shared.providers),widgetSpec=deepMerge(__assign({},menuSpec,{markers:markers$1(presets),movement:deriveMenuMovement(columns,presets)}));return{type:"widget",data:{value:generate$1("widget-id")},dom:{tag:"div",classes:["tox-fancymenuitem"]},autofocus:!0,components:[parts$2().widget(Menu.sketch(widgetSpec))]}}function DelayedFunction(fun,delay){var ref=null,schedule=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];ref=domGlobals.setTimeout(function(){fun.apply(null,args),ref=null},delay)},cancel=function(){null!==ref&&(domGlobals.clearTimeout(ref),ref=null)};return{cancel:cancel,schedule:schedule}}function EventRegistry(){var registry={},registerId=function(extraArgs,id,events){each$1(events,function(v,k){var handlers=void 0!==registry[k]?registry[k]:{};handlers[id]=curryArgs(v,extraArgs),registry[k]=handlers})},findHandler=function(handlers,elem){return read$1(elem).fold(function(){return Option.none()},function(id){var reader=readOpt$1(id);return handlers.bind(reader).map(function(descHandler){return eventHandler(elem,descHandler)})})},filterByType=function(type){return readOptFrom$1(registry,type).map(function(handlers){return mapToArray(handlers,function(f,id){return broadcastHandler(id,f)})}).getOr([])},find=function(isAboveRoot,type,target){var readType=readOpt$1(type),handlers=readType(registry);return closest$1(target,function(elem){return findHandler(handlers,elem)},isAboveRoot)},unregisterId=function(id){each$1(registry,function(handlersById,eventName){handlersById.hasOwnProperty(id)&&delete handlersById[id]})};return{registerId:registerId,unregisterId:unregisterId,filterByType:filterByType,find:find}}function Registry(){var events=EventRegistry(),components={},readOrTag=function(component){var elem=component.element();return read$1(elem).fold(function(){return write("uid-",component.element())},function(uid){return uid})},failOnDuplicate=function(component,tagId){var conflict=components[tagId];if(conflict!==component)throw new Error('The tagId "'+tagId+'" is already used by: '+element(conflict.element())+"\nCannot use it for: "+element(component.element())+"\nThe conflicting element is"+(inBody(conflict.element())?" ":" not ")+"already in the DOM");unregister(component)},register=function(component){var tagId=readOrTag(component);hasKey$1(components,tagId)&&failOnDuplicate(component,tagId);var extraArgs=[component];events.registerId(extraArgs,tagId,component.events()),components[tagId]=component},unregister=function(component){read$1(component.element()).each(function(tagId){delete components[tagId],events.unregisterId(tagId)})},filter=function(type){return events.filterByType(type)},find=function(isAboveRoot,type,target){return events.find(isAboveRoot,type,target)},getById=function(id){return readOpt$1(id)(components)};return{find:find,filter:filter,register:register,unregister:unregister,getById:getById}}function create$5(width,height){return resize(domGlobals.document.createElement("canvas"),width,height)}function clone$1(canvas){var tCanvas=create$5(canvas.width,canvas.height),ctx=get2dContext(tCanvas);return ctx.drawImage(canvas,0,0),tCanvas}function get2dContext(canvas){return canvas.getContext("2d")}function resize(canvas,width,height){return canvas.width=width,canvas.height=height,canvas}function getWidth(image){return image.naturalWidth||image.width}function getHeight(image){return image.naturalHeight||image.height}function blobToImage(blob){return new Promise$1(function(resolve,reject){function loaded(){removeListeners(),resolve(image)}function error(){removeListeners(),reject("Unable to load data of type "+blob.type+": "+blobUrl)}var blobUrl=domGlobals.URL.createObjectURL(blob),image=new domGlobals.Image,removeListeners=function(){image.removeEventListener("load",loaded),image.removeEventListener("error",error)};image.addEventListener("load",loaded),image.addEventListener("error",error),image.src=blobUrl,image.complete&&loaded()})}function dataUriToBlobSync(uri){var data=uri.split(","),matches=/data:([^;]+)/.exec(data[0]);if(!matches)return Option.none();for(var mimetype=matches[1],base64=data[1],sliceSize=1024,byteCharacters=domGlobals.atob(base64),bytesLength=byteCharacters.length,slicesCount=Math.ceil(bytesLength/sliceSize),byteArrays=new Array(slicesCount),sliceIndex=0;sliceIndex<slicesCount;++sliceIndex){for(var begin=sliceIndex*sliceSize,end=Math.min(begin+sliceSize,bytesLength),bytes=new Array(end-begin),offset=begin,i=0;offset<end;++i,++offset)bytes[i]=byteCharacters[offset].charCodeAt(0);byteArrays[sliceIndex]=new Uint8Array(bytes)}return Option.some(new domGlobals.Blob(byteArrays,{type:mimetype}))}function dataUriToBlob(uri){return new Promise$1(function(resolve,reject){dataUriToBlobSync(uri).fold(function(){reject("uri is not base64: "+uri)},resolve)})}function canvasToBlob(canvas,type,quality){return type=type||"image/png",domGlobals.HTMLCanvasElement.prototype.toBlob?new Promise$1(function(resolve,reject){canvas.toBlob(function(blob){blob?resolve(blob):reject()},type,quality)}):dataUriToBlob(canvas.toDataURL(type,quality))}function canvasToDataURL(canvas,type,quality){return type=type||"image/png",canvas.toDataURL(type,quality)}function blobToCanvas(blob){return blobToImage(blob).then(function(image){revokeImageUrl(image);var canvas=create$5(getWidth(image),getHeight(image)),context=get2dContext(canvas);return context.drawImage(image,0,0),canvas})}function blobToDataUri(blob){return new Promise$1(function(resolve){var reader=new domGlobals.FileReader;reader.onloadend=function(){resolve(reader.result)},reader.readAsDataURL(blob)})}function revokeImageUrl(image){domGlobals.URL.revokeObjectURL(image.src)}function create$6(getCanvas,blob,uri){function toBlob(){return Promise$1.resolve(blob)}function toDataURL(){return uri}function toBase64(){return uri.split(",")[1]}function toAdjustedBlob(type,quality){return getCanvas.then(function(canvas){return canvasToBlob(canvas,type,quality)})}function toAdjustedDataURL(type,quality){return getCanvas.then(function(canvas){return canvasToDataURL(canvas,type,quality)})}function toAdjustedBase64(type,quality){return toAdjustedDataURL(type,quality).then(function(dataurl){return dataurl.split(",")[1]})}function toCanvas(){return getCanvas.then(clone$1)}var initialType=blob.type,getType=constant(initialType);return{getType:getType,toBlob:toBlob,toDataURL:toDataURL,toBase64:toBase64,toAdjustedBlob:toAdjustedBlob,toAdjustedDataURL:toAdjustedDataURL,toAdjustedBase64:toAdjustedBase64,toCanvas:toCanvas}}function fromBlob(blob){return blobToDataUri(blob).then(function(uri){return create$6(blobToCanvas(blob),blob,uri)})}function fromCanvas(canvas,type){return canvasToBlob(canvas,type).then(function(blob){return create$6(Promise$1.resolve(canvas),blob,canvas.toDataURL())})}function clamp(value,min,max){var parsedValue="string"==typeof value?parseFloat(value):value;return parsedValue>max?parsedValue=max:parsedValue<min&&(parsedValue=min),parsedValue}function identity$1(){return[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1]}function multiply(matrix1,matrix2){for(var val,col=[],out=new Array(25),i=0;i<5;i++){for(var j=0;j<5;j++)col[j]=matrix2[j+5*i];for(j=0;j<5;j++){val=0;for(var k=0;k<5;k++)val+=matrix1[j+5*k]*col[k];out[j+5*i]=val}}return out}function adjustContrast(matrix,value){var x;return value=clamp(value,-1,1),value*=100,value<0?x=127+value/100*127:(x=value%1,x=0===x?DELTA_INDEX[value]:DELTA_INDEX[Math.floor(value)]*(1-x)+DELTA_INDEX[Math.floor(value)+1]*x,x=127*x+127),multiply(matrix,[x/127,0,0,0,.5*(127-x),0,x/127,0,0,.5*(127-x),0,0,x/127,0,.5*(127-x),0,0,0,1,0,0,0,0,0,1])}function adjustBrightness(matrix,value){return value=clamp(255*value,-255,255),multiply(matrix,[1,0,0,0,value,0,1,0,0,value,0,0,1,0,value,0,0,0,1,0,0,0,0,0,1])}function adjustColors(matrix,adjustR,adjustG,adjustB){return adjustR=clamp(adjustR,0,2),adjustG=clamp(adjustG,0,2),adjustB=clamp(adjustB,0,2),multiply(matrix,[adjustR,0,0,0,0,0,adjustG,0,0,0,0,0,adjustB,0,0,0,0,0,1,0,0,0,0,0,1])}function colorFilter(ir,matrix){return ir.toCanvas().then(function(canvas){return applyColorFilter(canvas,ir.getType(),matrix)})}function applyColorFilter(canvas,type,matrix){function applyMatrix(pixelsData,m){for(var r,g,b,a,data=pixelsData.data,m0=m[0],m1=m[1],m2=m[2],m3=m[3],m4=m[4],m5=m[5],m6=m[6],m7=m[7],m8=m[8],m9=m[9],m10=m[10],m11=m[11],m12=m[12],m13=m[13],m14=m[14],m15=m[15],m16=m[16],m17=m[17],m18=m[18],m19=m[19],i=0;i<data.length;i+=4)r=data[i],g=data[i+1],b=data[i+2],a=data[i+3],data[i]=r*m0+g*m1+b*m2+a*m3+m4,data[i+1]=r*m5+g*m6+b*m7+a*m8+m9,data[i+2]=r*m10+g*m11+b*m12+a*m13+m14,data[i+3]=r*m15+g*m16+b*m17+a*m18+m19;return pixelsData}var context=get2dContext(canvas),pixels=applyMatrix(context.getImageData(0,0,canvas.width,canvas.height),matrix);return context.putImageData(pixels,0,0),fromCanvas(canvas,type)}function convoluteFilter(ir,matrix){return ir.toCanvas().then(function(canvas){return applyConvoluteFilter(canvas,ir.getType(),matrix)})}function applyConvoluteFilter(canvas,type,matrix){function applyMatrix(pIn,pOut,aMatrix){function clamp(value,min,max){return value>max?value=max:value<min&&(value=min),value}for(var side=Math.round(Math.sqrt(aMatrix.length)),halfSide=Math.floor(side/2),rgba=pIn.data,drgba=pOut.data,w=pIn.width,h=pIn.height,y=0;y<h;y++)for(var x=0;x<w;x++){for(var r=0,g=0,b=0,cy=0;cy<side;cy++)for(var cx=0;cx<side;cx++){var scx=clamp(x+cx-halfSide,0,w-1),scy=clamp(y+cy-halfSide,0,h-1),innerOffset=4*(scy*w+scx),wt=aMatrix[cy*side+cx];r+=rgba[innerOffset]*wt,g+=rgba[innerOffset+1]*wt,b+=rgba[innerOffset+2]*wt}var offset=4*(y*w+x);drgba[offset]=clamp(r,0,255),drgba[offset+1]=clamp(g,0,255),drgba[offset+2]=clamp(b,0,255)}return pOut}var context=get2dContext(canvas),pixelsIn=context.getImageData(0,0,canvas.width,canvas.height),pixelsOut=context.getImageData(0,0,canvas.width,canvas.height);return pixelsOut=applyMatrix(pixelsIn,pixelsOut,matrix),context.putImageData(pixelsOut,0,0),fromCanvas(canvas,type)}function functionColorFilter(colorFn){var filterImpl=function(canvas,type,value){function applyLookup(pixelsData,lookupData){for(var data=pixelsData.data,i=0;i<data.length;i+=4)data[i]=lookupData[data[i]],data[i+1]=lookupData[data[i+1]],data[i+2]=lookupData[data[i+2]];return pixelsData}for(var context=get2dContext(canvas),lookup=new Array(256),i=0;i<lookup.length;i++)lookup[i]=colorFn(i,value);var pixels=applyLookup(context.getImageData(0,0,canvas.width,canvas.height),lookup);return context.putImageData(pixels,0,0),fromCanvas(canvas,type)};return function(ir,value){return ir.toCanvas().then(function(canvas){return filterImpl(canvas,ir.getType(),value)})}}function complexAdjustableColorFilter(matrixAdjustFn){return function(ir,adjust){return colorFilter(ir,matrixAdjustFn(identity$1(),adjust))}}function basicColorFilter(matrix){return function(ir){return colorFilter(ir,matrix)}}function basicConvolutionFilter(kernel){return function(ir){return convoluteFilter(ir,kernel)}}function scale(image,dW,dH){var sW=getWidth(image),sH=getHeight(image),wRatio=dW/sW,hRatio=dH/sH,scaleCapped=!1;(wRatio<.5||wRatio>2)&&(wRatio=wRatio<.5?.5:2,scaleCapped=!0),(hRatio<.5||hRatio>2)&&(hRatio=hRatio<.5?.5:2,scaleCapped=!0);var scaled=_scale(image,wRatio,hRatio);return scaleCapped?scaled.then(function(tCanvas){return scale(tCanvas,dW,dH)}):scaled}function _scale(image,wRatio,hRatio){return new Promise$1(function(resolve){var sW=getWidth(image),sH=getHeight(image),dW=Math.floor(sW*wRatio),dH=Math.floor(sH*hRatio),canvas=create$5(dW,dH),context=get2dContext(canvas);context.drawImage(image,0,0,sW,sH,0,0,dW,dH),resolve(canvas)})}function rotate(ir,angle){return ir.toCanvas().then(function(canvas){return applyRotate(canvas,ir.getType(),angle)})}function applyRotate(image,type,angle){var canvas=create$5(image.width,image.height),context=get2dContext(canvas),translateX=0,translateY=0;return angle=angle<0?360+angle:angle,90!==angle&&270!==angle||resize(canvas,canvas.height,canvas.width),90!==angle&&180!==angle||(translateX=canvas.width),270!==angle&&180!==angle||(translateY=canvas.height),context.translate(translateX,translateY),context.rotate(angle*Math.PI/180),context.drawImage(image,0,0),fromCanvas(canvas,type)}function flip(ir,axis){return ir.toCanvas().then(function(canvas){return applyFlip(canvas,ir.getType(),axis)})}function applyFlip(image,type,axis){var canvas=create$5(image.width,image.height),context=get2dContext(canvas);return"v"===axis?(context.scale(1,-1),context.drawImage(image,0,-canvas.height)):(context.scale(-1,1),context.drawImage(image,-canvas.width,0)),fromCanvas(canvas,type)}function crop(ir,x,y,w,h){return ir.toCanvas().then(function(canvas){return applyCrop(canvas,ir.getType(),x,y,w,h)})}function applyCrop(image,type,x,y,w,h){var canvas=create$5(w,h),context=get2dContext(canvas);return context.drawImage(image,-x,-y),fromCanvas(canvas,type)}function resize$1(ir,w,h){return ir.toCanvas().then(function(canvas){return scale(canvas,w,h).then(function(newCanvas){return fromCanvas(newCanvas,ir.getType())})})}function getDocumentSize(doc){var documentElement,body,scrollWidth,clientWidth,offsetWidth,scrollHeight,clientHeight,offsetHeight,max=Math.max;return documentElement=doc.documentElement,body=doc.body,scrollWidth=max(documentElement.scrollWidth,body.scrollWidth),clientWidth=max(documentElement.clientWidth,body.clientWidth),offsetWidth=max(documentElement.offsetWidth,body.offsetWidth),scrollHeight=max(documentElement.scrollHeight,body.scrollHeight),clientHeight=max(documentElement.clientHeight,body.clientHeight),offsetHeight=max(documentElement.offsetHeight,body.offsetHeight),{width:scrollWidth<offsetWidth?clientWidth:scrollWidth,height:scrollHeight<offsetHeight?clientHeight:scrollHeight}}function updateWithTouchData(e){var keys,i;if(e.changedTouches)for(keys="screenX screenY pageX pageY clientX clientY".split(" "),i=0;i<keys.length;i++)e[keys[i]]=e.changedTouches[0][keys[i]]}function DragHelper(id,settings){var $eventOverlay,downButton,start,stop,drag,startX,startY,doc=settings.document||domGlobals.document;settings=settings||{};var handleElement=doc.getElementById(settings.handle||id);start=function(e){var handleElm,cursor,docSize=getDocumentSize(doc);updateWithTouchData(e),e.preventDefault(),downButton=e.button,handleElm=handleElement,startX=e.screenX,startY=e.screenY,cursor=domGlobals.window.getComputedStyle?domGlobals.window.getComputedStyle(handleElm,null).getPropertyValue("cursor"):handleElm.runtimeStyle.cursor,$eventOverlay=global$b("<div></div>").css({position:"absolute",top:0,left:0,width:docSize.width,height:docSize.height,zIndex:2147483647,opacity:1e-4,cursor:cursor}).appendTo(doc.body),global$b(doc).on("mousemove touchmove",drag).on("mouseup touchend",stop),settings.start(e)},drag=function(e){if(updateWithTouchData(e),e.button!==downButton)return stop(e);e.deltaX=e.screenX-startX,e.deltaY=e.screenY-startY,e.preventDefault(),settings.drag(e)},stop=function(e){updateWithTouchData(e),global$b(doc).off("mousemove touchmove",drag).off("mouseup touchend",stop),$eventOverlay.remove(),settings.stop&&settings.stop(e)},this.destroy=function(){global$b(handleElement).off()},global$b(handleElement).on("mousedown touchstart",start)}function CropRect(currentRect,viewPortRect,clampRect,containerElm,action){function getAbsoluteRect(outerRect,relativeRect){return{x:relativeRect.x+outerRect.x,y:relativeRect.y+outerRect.y,w:relativeRect.w,h:relativeRect.h}}function getRelativeRect(outerRect,innerRect){return{x:innerRect.x-outerRect.x,y:innerRect.y-outerRect.y,w:innerRect.w,h:innerRect.h}}function getInnerRect(){return getRelativeRect(clampRect,currentRect)}function moveRect(handle,startRect,deltaX,deltaY){var x,y,w,h,rect;x=startRect.x,y=startRect.y,w=startRect.w,h=startRect.h,x+=deltaX*handle.deltaX,y+=deltaY*handle.deltaY,w+=deltaX*handle.deltaW,h+=deltaY*handle.deltaH,w<20&&(w=20),h<20&&(h=20),rect=currentRect=global$c.clamp({x:x,y:y,w:w,h:h},clampRect,"move"===handle.name),rect=getRelativeRect(clampRect,rect),instance.fire("updateRect",{rect:rect}),setInnerRect(rect)}function render(){function createDragHelper(handle){var startRect;return new DragHelper(id,{document:containerElm.ownerDocument,handle:id+"-"+handle.name,start:function(){startRect=currentRect},drag:function(e){moveRect(handle,startRect,e.deltaX,e.deltaY)}})}global$b('<div id="'+id+'" class="'+prefix+'croprect-container" role="grid" aria-dropeffect="execute">').appendTo(containerElm),global$e.each(blockers,function(blocker){global$b("#"+id,containerElm).append('<div id="'+id+"-"+blocker+'"class="'+prefix+'croprect-block" style="display: none" data-mce-bogus="all">')}),global$e.each(handles,function(handle){global$b("#"+id,containerElm).append('<div id="'+id+"-"+handle.name+'" class="'+prefix+"croprect-handle "+prefix+"croprect-handle-"+handle.name+'"style="display: none" data-mce-bogus="all" role="gridcell" tabindex="-1" aria-label="'+handle.label+'" aria-grabbed="false" title="'+handle.label+'">')}),dragHelpers=global$e.map(handles,createDragHelper),repaint(currentRect),global$b(containerElm).on("focusin focusout",function(e){global$b(e.target).attr("aria-grabbed","focus"===e.type?"true":"false")}),global$b(containerElm).on("keydown",function(e){function moveAndBlock(evt,handle,startRect,deltaX,deltaY){evt.stopPropagation(),evt.preventDefault(),moveRect(activeHandle,startRect,deltaX,deltaY)}var activeHandle;switch(global$e.each(handles,function(handle){if(e.target.id===id+"-"+handle.name)return activeHandle=handle,!1}),e.keyCode){case global$f.LEFT:moveAndBlock(e,activeHandle,currentRect,-10,0);break;case global$f.RIGHT:moveAndBlock(e,activeHandle,currentRect,10,0);break;case global$f.UP:moveAndBlock(e,activeHandle,currentRect,0,-10);break;case global$f.DOWN:moveAndBlock(e,activeHandle,currentRect,0,10);break;case global$f.ENTER:case global$f.SPACEBAR:e.preventDefault(),action()}})}function toggleVisibility(state){var selectors;selectors=global$e.map(handles,function(handle){return"#"+id+"-"+handle.name}).concat(global$e.map(blockers,function(blocker){return"#"+id+"-"+blocker})).join(","),state?global$b(selectors,containerElm).show():global$b(selectors,containerElm).hide()}function repaint(rect){function updateElementRect(name,rect){rect.h<0&&(rect.h=0),rect.w<0&&(rect.w=0),global$b("#"+id+"-"+name,containerElm).css({left:rect.x,top:rect.y,width:rect.w,height:rect.h})}global$e.each(handles,function(handle){global$b("#"+id+"-"+handle.name,containerElm).css({left:rect.w*handle.xMul+rect.x,top:rect.h*handle.yMul+rect.y})}),updateElementRect("top",{x:viewPortRect.x,y:viewPortRect.y,w:viewPortRect.w,h:rect.y-viewPortRect.y}),updateElementRect("right",{x:rect.x+rect.w,y:rect.y,w:viewPortRect.w-rect.x-rect.w+viewPortRect.x,h:rect.h}),updateElementRect("bottom",{x:viewPortRect.x,y:rect.y+rect.h,w:viewPortRect.w,h:viewPortRect.h-rect.y-rect.h+viewPortRect.y}),updateElementRect("left",{x:viewPortRect.x,y:rect.y,w:rect.x-viewPortRect.x,h:rect.h}),updateElementRect("move",rect)}function setRect(rect){currentRect=rect,repaint(currentRect)}function setViewPortRect(rect){viewPortRect=rect,repaint(currentRect)}function setInnerRect(rect){setRect(getAbsoluteRect(clampRect,rect))}function setClampRect(rect){clampRect=rect,repaint(currentRect)}function destroy(){global$e.each(dragHelpers,function(helper){helper.destroy()}),dragHelpers=[]}var instance,handles,dragHelpers,blockers,prefix="tox-",id=prefix+"crid-"+count++;return handles=[{name:"move",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:0,deltaH:0,label:"Crop Mask"},{name:"nw",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:-1,deltaH:-1,label:"Top Left Crop Handle"},{name:"ne",xMul:1,yMul:0,deltaX:0,deltaY:1,deltaW:1,deltaH:-1,label:"Top Right Crop Handle"},{name:"sw",xMul:0,yMul:1,deltaX:1,deltaY:0,deltaW:-1,deltaH:1,label:"Bottom Left Crop Handle"},{name:"se",xMul:1,yMul:1,deltaX:0,deltaY:0,deltaW:1,deltaH:1,label:"Bottom Right Crop Handle"}],blockers=["top","right","bottom","left"],render(),instance=global$e.extend({toggleVisibility:toggleVisibility,setClampRect:setClampRect,setRect:setRect,getInnerRect:getInnerRect,setInnerRect:setInnerRect,setViewPortRect:setViewPortRect,destroy:destroy},global$d),instance}function UndoStack(){function add(state){var removed;return removed=data.splice(++index),data.push(state),{state:state,removed:removed}}function undo(){if(canUndo())return data[--index]}function redo(){if(canRedo())return data[++index]}function canUndo(){return index>0}function canRedo(){return-1!==index&&index<data.length-1}var data=[],index=-1;return{data:data,add:add,undo:undo,redo:redo,canUndo:canUndo,canRedo:canRedo}}function Theme(){global$1.add("silver",function(editor){var _a=Render.setup(editor),uiMothership=_a.uiMothership,backstage=_a.backstage,renderUI=_a.renderUI,getUi=_a.getUi;Autocompleter.register(editor,backstage.shared);var windowMgr=WindowManager.setup({editor:editor,backstage:backstage});return{renderUI:renderUI,getWindowManagerImpl:constant(windowMgr),getNotificationManagerImpl:function(){return NotificationManagerImpl(editor,{backstage:backstage},uiMothership)},ui:getUi()}})}var pIndexOf,fastIndex,slowIndex,SimpleResultType,noop=function(){},noarg=function(f){return function(){return f()}},compose=function(fa,fb){return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];return fa(fb.apply(null,args))}},constant=function(value){return function(){return value}},identity=function(x){return x},not=function(f){return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];return!f.apply(null,args)}},die=function(msg){return function(){throw new Error(msg)}},never=constant(!1),always=constant(!0),global$1=tinymce.util.Tools.resolve("tinymce.ThemeManager"),__assign=function(){return __assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i],s)Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t},__assign.apply(this,arguments)},never$1=never,always$1=always,none=function(){return NONE},NONE=function(){var eq=function(o){return o.isNone()},call=function(thunk){return thunk()},id=function(n){return n},noop=function(){},nul=function(){return null},undef=function(){},me={fold:function(n,s){return n()},is:never$1,isSome:never$1,isNone:always$1,getOr:id,getOrThunk:call,getOrDie:function(msg){throw new Error(msg||"error: getOrDie called on none.")},getOrNull:nul,getOrUndefined:undef,or:id,orThunk:call,map:none,ap:none,each:noop,bind:none,flatten:none,exists:never$1,forall:always$1,filter:none,equals:eq,equals_:eq,toArray:function(){return[]},toString:constant("none()")};return Object.freeze&&Object.freeze(me),me}(),some=function(a){var constant_a=function(){return a},self=function(){return me},map=function(f){return some(f(a))},bind=function(f){return f(a)},me={fold:function(n,s){return s(a)},is:function(v){return a===v},isSome:always$1,isNone:never$1,getOr:constant_a,getOrThunk:constant_a,getOrDie:constant_a,getOrNull:constant_a,getOrUndefined:constant_a,or:self,orThunk:self,map:map,ap:function(optfab){return optfab.fold(none,function(fab){return some(fab(a))})},each:function(f){f(a)},bind:bind,flatten:constant_a,exists:bind,forall:bind,filter:function(f){return f(a)?me:NONE},equals:function(o){return o.is(a)},equals_:function(o,elementEq){return o.fold(never$1,function(b){return elementEq(a,b)})},toArray:function(){return[a]},toString:function(){return"some("+a+")"}};return me},from=function(value){return null==value?NONE:some(value)},Option={some:some,none:none,from:from},value=function(o){var is=function(v){return o===v},or=function(opt){return value(o)},orThunk=function(f){return value(o)},map=function(f){return value(f(o))},mapError=function(f){return value(o)},each=function(f){f(o)},bind=function(f){return f(o)},fold=function(_,onValue){return onValue(o)},exists=function(f){return f(o)},forall=function(f){return f(o)},toOption=function(){return Option.some(o)};return{is:is,isValue:always,isError:never,getOr:constant(o),getOrThunk:constant(o),getOrDie:constant(o),or:or,orThunk:orThunk,fold:fold,map:map,mapError:mapError,each:each,bind:bind,exists:exists,forall:forall,toOption:toOption}},error=function(message){var getOrThunk=function(f){return f()},getOrDie=function(){return die(String(message))()},or=function(opt){return opt},orThunk=function(f){return f()},map=function(f){return error(message)},mapError=function(f){return error(f(message))},bind=function(f){return error(message)},fold=function(onError,_){return onError(message)};return{is:never,isValue:never,isError:always,getOr:identity,getOrThunk:getOrThunk,getOrDie:getOrDie,or:or,orThunk:orThunk,fold:fold,map:map,mapError:mapError,each:noop,bind:bind,exists:never,forall:always,toOption:Option.none}},fromOption=function(opt,err){return opt.fold(function(){return error(err)},value)},Result={value:value,error:error,fromOption:fromOption},typeOf=function(x){if(null===x)return"null";var t=typeof x;return"object"===t&&(Array.prototype.isPrototypeOf(x)||x.constructor&&"Array"===x.constructor.name)?"array":"object"===t&&(String.prototype.isPrototypeOf(x)||x.constructor&&"String"===x.constructor.name)?"string":t},isType=function(type){return function(value){return typeOf(value)===type}},isString=isType("string"),isObject=isType("object"),isArray=isType("array"),isBoolean=isType("boolean"),isFunction=isType("function"),isNumber=isType("number"),isArrayOf=function(value,pred){if(isArray(value)){for(var i=0,len=value.length;i<len;++i)if(!0!==pred(value[i]))return!1;return!0}return!1},slice=Array.prototype.slice,rawIndexOf=(pIndexOf=Array.prototype.indexOf,fastIndex=function(xs,x){return pIndexOf.call(xs,x)},slowIndex=function(xs,x){return slowIndexOf(xs,x)},
void 0===pIndexOf?slowIndex:fastIndex),indexOf=function(xs,x){var r=rawIndexOf(xs,x);return-1===r?Option.none():Option.some(r)},contains=function(xs,x){return rawIndexOf(xs,x)>-1},exists=function(xs,pred){return findIndex(xs,pred).isSome()},range=function(num,f){for(var r=[],i=0;i<num;i++)r.push(f(i));return r},chunk=function(array,size){for(var r=[],i=0;i<array.length;i+=size){var s=slice.call(array,i,i+size);r.push(s)}return r},map=function(xs,f){for(var len=xs.length,r=new Array(len),i=0;i<len;i++){var x=xs[i];r[i]=f(x,i,xs)}return r},each=function(xs,f){for(var i=0,len=xs.length;i<len;i++){var x=xs[i];f(x,i,xs)}},eachr=function(xs,f){for(var i=xs.length-1;i>=0;i--){var x=xs[i];f(x,i,xs)}},partition=function(xs,pred){for(var pass=[],fail=[],i=0,len=xs.length;i<len;i++){var x=xs[i],arr=pred(x,i,xs)?pass:fail;arr.push(x)}return{pass:pass,fail:fail}},filter=function(xs,pred){for(var r=[],i=0,len=xs.length;i<len;i++){var x=xs[i];pred(x,i,xs)&&r.push(x)}return r},foldr=function(xs,f,acc){return eachr(xs,function(x){acc=f(acc,x)}),acc},foldl=function(xs,f,acc){return each(xs,function(x){acc=f(acc,x)}),acc},find=function(xs,pred){for(var i=0,len=xs.length;i<len;i++){var x=xs[i];if(pred(x,i,xs))return Option.some(x)}return Option.none()},findIndex=function(xs,pred){for(var i=0,len=xs.length;i<len;i++){var x=xs[i];if(pred(x,i,xs))return Option.some(i)}return Option.none()},slowIndexOf=function(xs,x){for(var i=0,len=xs.length;i<len;++i)if(xs[i]===x)return i;return-1},push=Array.prototype.push,flatten=function(xs){for(var r=[],i=0,len=xs.length;i<len;++i){if(!isArray(xs[i]))throw new Error("Arr.flatten item "+i+" was not an array, input: "+xs);push.apply(r,xs[i])}return r},bind=function(xs,f){var output=map(xs,f);return flatten(output)},forall=function(xs,pred){for(var i=0,len=xs.length;i<len;++i){var x=xs[i];if(!0!==pred(x,i,xs))return!1}return!0},reverse=function(xs){var r=slice.call(xs,0);return r.reverse(),r},difference=function(a1,a2){return filter(a1,function(x){return!contains(a2,x)})},pure=function(x){return[x]},sort=function(xs,comparator){var copy=slice.call(xs,0);return copy.sort(comparator),copy},head=function(xs){return 0===xs.length?Option.none():Option.some(xs[0])},last=function(xs){return 0===xs.length?Option.none():Option.some(xs[xs.length-1])},from$1=isFunction(Array.from)?Array.from:function(x){return slice.call(x)},keys=Object.keys,hasOwnProperty=Object.hasOwnProperty,each$1=function(obj,f){for(var props=keys(obj),k=0,len=props.length;k<len;k++){var i=props[k],x=obj[i];f(x,i,obj)}},map$1=function(obj,f){return tupleMap(obj,function(x,i,obj){return{k:i,v:f(x,i,obj)}})},tupleMap=function(obj,f){var r={};return each$1(obj,function(x,i){var tuple=f(x,i,obj);r[tuple.k]=tuple.v}),r},mapToArray=function(obj,f){var r=[];return each$1(obj,function(value,name){r.push(f(value,name))}),r},find$1=function(obj,pred){for(var props=keys(obj),k=0,len=props.length;k<len;k++){var i=props[k],x=obj[i];if(pred(x,i,obj))return Option.some(x)}return Option.none()},values=function(obj){return mapToArray(obj,function(v){return v})},get=function(obj,key){return has(obj,key)?Option.from(obj[key]):Option.none()},has=function(obj,key){return hasOwnProperty.call(obj,key)},generate=function(cases){if(!isArray(cases))throw new Error("cases must be an array");if(0===cases.length)throw new Error("there must be at least one case");var constructors=[],adt={};return each(cases,function(acase,count){var keys$1=keys(acase);if(1!==keys$1.length)throw new Error("one and only one name per case");var key=keys$1[0],value=acase[key];if(void 0!==adt[key])throw new Error("duplicate key detected:"+key);if("cata"===key)throw new Error("cannot have a case named cata (sorry)");if(!isArray(value))throw new Error("case arguments must be an array");constructors.push(key),adt[key]=function(){var argLength=arguments.length;if(argLength!==value.length)throw new Error("Wrong number of arguments to case "+key+". Expected "+value.length+" ("+value+"), got "+argLength);for(var args=new Array(argLength),i=0;i<args.length;i++)args[i]=arguments[i];var match=function(branches){var branchKeys=keys(branches);if(constructors.length!==branchKeys.length)throw new Error("Wrong number of arguments to match. Expected: "+constructors.join(",")+"\nActual: "+branchKeys.join(","));var allReqd=forall(constructors,function(reqKey){return contains(branchKeys,reqKey)});if(!allReqd)throw new Error("Not all branches were specified when using match. Specified: "+branchKeys.join(", ")+"\nRequired: "+constructors.join(", "));return branches[key].apply(null,args)};return{fold:function(){if(arguments.length!==cases.length)throw new Error("Wrong number of arguments to fold. Expected "+cases.length+", got "+arguments.length);var target=arguments[count];return target.apply(null,args)},match:match,log:function(label){domGlobals.console.log(label,{constructors:constructors,constructor:key,params:args})}}}}),adt},Adt={generate:generate},hasOwnProperty$1=Object.prototype.hasOwnProperty,shallow=function(old,nu){return nu},deep=function(old,nu){var bothObjects=isObject(old)&&isObject(nu);return bothObjects?deepMerge(old,nu):nu},baseMerge=function(merger){return function(){for(var objects=new Array(arguments.length),i=0;i<objects.length;i++)objects[i]=arguments[i];if(0===objects.length)throw new Error("Can't merge zero objects");for(var ret={},j=0;j<objects.length;j++){var curObject=objects[j];for(var key in curObject)hasOwnProperty$1.call(curObject,key)&&(ret[key]=merger(ret[key],curObject[key]))}return ret}},deepMerge=baseMerge(deep),merge=baseMerge(shallow),cached=function(f){var r,called=!1;return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];return called||(called=!0,r=f.apply(null,args)),r}},adt=Adt.generate([{strict:[]},{defaultedThunk:["fallbackThunk"]},{asOption:[]},{asDefaultedOptionThunk:["fallbackThunk"]},{mergeWithThunk:["baseThunk"]}]),defaulted=function(fallback){return adt.defaultedThunk(constant(fallback))},mergeWith=function(base){return adt.mergeWithThunk(constant(base))},strict=adt.strict,asOption=adt.asOption,defaultedThunk=adt.defaultedThunk,mergeWithThunk=adt.mergeWithThunk,exclude=function(obj,fields){var r={};return each$1(obj,function(v,k){contains(fields,k)||(r[k]=v)}),r},readOpt=function(key){return function(obj){return has(obj,key)?Option.from(obj[key]):Option.none()}},readOr=function(key,fallback){return function(obj){return has(obj,key)?obj[key]:fallback}},readOptFrom=function(obj,key){return readOpt(key)(obj)},hasKey=function(obj,key){return has(obj,key)&&void 0!==obj[key]&&null!==obj[key]},wrap=function(key,value){var r={};return r[key]=value,r},wrapAll=function(keyvalues){var r={};return each(keyvalues,function(kv){r[kv.key]=kv.value}),r},partition$1=(Adt.generate([{bothErrors:["error1","error2"]},{firstError:["error1","value2"]},{secondError:["value1","error2"]},{bothValues:["value1","value2"]}]),function(results){var errors=[],values=[];return each(results,function(result){result.fold(function(err){errors.push(err)},function(value){values.push(value)})}),{errors:errors,values:values}}),exclude$1=function(obj,fields){return exclude(obj,fields)},readOpt$1=function(key){return readOpt(key)},readOr$1=function(key,fallback){return readOr(key,fallback)},readOptFrom$1=function(obj,key){return readOptFrom(obj,key)},wrap$1=function(key,value){return wrap(key,value)},wrapAll$1=function(keyvalues){return wrapAll(keyvalues)},mergeValues=function(values,base){return 0===values.length?Result.value(base):Result.value(deepMerge(base,merge.apply(void 0,values)))},mergeErrors=function(errors){return Result.error(flatten(errors))},consolidate=function(objs,base){var partitions=partition$1(objs);return partitions.errors.length>0?mergeErrors(partitions.errors):mergeValues(partitions.values,base)},hasKey$1=function(obj,key){return hasKey(obj,key)};(function(SimpleResultType){SimpleResultType[SimpleResultType.Error=0]="Error",SimpleResultType[SimpleResultType.Value=1]="Value"})(SimpleResultType||(SimpleResultType={}));var EventConfiguration,fold=function(res,onError,onValue){return res.stype===SimpleResultType.Error?onError(res.serror):onValue(res.svalue)},partition$2=function(results){var values=[],errors=[];return each(results,function(obj){fold(obj,function(err){return errors.push(err)},function(val){return values.push(val)})}),{values:values,errors:errors}},mapError=function(res,f){return res.stype===SimpleResultType.Error?{stype:SimpleResultType.Error,serror:f(res.serror)}:res},map$2=function(res,f){return res.stype===SimpleResultType.Value?{stype:SimpleResultType.Value,svalue:f(res.svalue)}:res},bind$1=function(res,f){return res.stype===SimpleResultType.Value?f(res.svalue):res},bindError=function(res,f){return res.stype===SimpleResultType.Error?f(res.serror):res},svalue=function(v){return{stype:SimpleResultType.Value,svalue:v}},serror=function(e){return{stype:SimpleResultType.Error,serror:e}},toResult=function(res){return fold(res,Result.error,Result.value)},fromResult=function(res){return res.fold(serror,svalue)},SimpleResult={fromResult:fromResult,toResult:toResult,svalue:svalue,partition:partition$2,serror:serror,bind:bind$1,bindError:bindError,map:map$2,mapError:mapError,fold:fold},mergeValues$1=function(values,base){return values.length>0?SimpleResult.svalue(deepMerge(base,merge.apply(void 0,values))):SimpleResult.svalue(base)},mergeErrors$1=function(errors){return compose(SimpleResult.serror,flatten)(errors)},consolidateObj=function(objects,base){var partition=SimpleResult.partition(objects);return partition.errors.length>0?mergeErrors$1(partition.errors):mergeValues$1(partition.values,base)},consolidateArr=function(objects){var partitions=SimpleResult.partition(objects);return partitions.errors.length>0?mergeErrors$1(partitions.errors):SimpleResult.svalue(partitions.values)},ResultCombine={consolidateObj:consolidateObj,consolidateArr:consolidateArr},typeAdt=Adt.generate([{setOf:["validator","valueType"]},{arrOf:["valueType"]},{objOf:["fields"]},{itemOf:["validator"]},{choiceOf:["key","branches"]},{thunk:["description"]},{func:["args","outputSchema"]}]),fieldAdt=Adt.generate([{field:["name","presence","type"]},{state:["name"]}]),formatObj=function(input){return isObject(input)&&keys(input).length>100?" removed due to size":JSON.stringify(input,null,2)},formatErrors=function(errors){var es=errors.length>10?errors.slice(0,10).concat([{path:[],getErrorInfo:function(){return"... (only showing first ten failures)"}}]):errors;return map(es,function(e){return"Failed path: ("+e.path.join(" > ")+")\n"+e.getErrorInfo()})},nu=function(path,getErrorInfo){return SimpleResult.serror([{path:path,getErrorInfo:getErrorInfo}])},missingStrict=function(path,key,obj){return nu(path,function(){return'Could not find valid *strict* value for "'+key+'" in '+formatObj(obj)})},missingKey=function(path,key){return nu(path,function(){return'Choice schema did not contain choice key: "'+key+'"'})},missingBranch=function(path,branches,branch){return nu(path,function(){return'The chosen schema: "'+branch+'" did not exist in branches: '+formatObj(branches)})},unsupportedFields=function(path,unsupported){return nu(path,function(){return"There are unsupported fields: ["+unsupported.join(", ")+"] specified"})},custom=function(path,err){return nu(path,function(){return err})},adt$1=Adt.generate([{field:["key","okey","presence","prop"]},{state:["okey","instantiator"]}]),strictAccess=function(path,obj,key){return readOptFrom(obj,key).fold(function(){return missingStrict(path,key,obj)},SimpleResult.svalue)},fallbackAccess=function(obj,key,fallbackThunk){var v=readOptFrom(obj,key).fold(function(){return fallbackThunk(obj)},identity);return SimpleResult.svalue(v)},optionAccess=function(obj,key){return SimpleResult.svalue(readOptFrom(obj,key))},optionDefaultedAccess=function(obj,key,fallback){var opt=readOptFrom(obj,key).map(function(val){return!0===val?fallback(obj):val});return SimpleResult.svalue(opt)},cExtractOne=function(path,obj,field,strength){return field.fold(function(key,okey,presence,prop){var bundle=function(av){var result=prop.extract(path.concat([key]),strength,av);return SimpleResult.map(result,function(res){return wrap(okey,strength(res))})},bundleAsOption=function(optValue){return optValue.fold(function(){var outcome=wrap(okey,strength(Option.none()));return SimpleResult.svalue(outcome)},function(ov){var result=prop.extract(path.concat([key]),strength,ov);return SimpleResult.map(result,function(res){return wrap(okey,strength(Option.some(res)))})})};return presence.fold(function(){return SimpleResult.bind(strictAccess(path,obj,key),bundle)},function(fallbackThunk){return SimpleResult.bind(fallbackAccess(obj,key,fallbackThunk),bundle)},function(){return SimpleResult.bind(optionAccess(obj,key),bundleAsOption)},function(fallbackThunk){return SimpleResult.bind(optionDefaultedAccess(obj,key,fallbackThunk),bundleAsOption)},function(baseThunk){var base=baseThunk(obj),result=SimpleResult.map(fallbackAccess(obj,key,constant({})),function(v){return deepMerge(base,v)});return SimpleResult.bind(result,bundle)})},function(okey,instantiator){var state=instantiator(obj);return SimpleResult.svalue(wrap(okey,strength(state)))})},cExtract=function(path,obj,fields,strength){var results=map(fields,function(field){return cExtractOne(path,obj,field,strength)});return ResultCombine.consolidateObj(results,{})},valueThunk=function(getDelegate){var extract=function(path,strength,val){return getDelegate().extract(path,strength,val)},toString=function(){return getDelegate().toString()},toDsl=function(){return getDelegate().toDsl()};return{extract:extract,toString:toString,toDsl:toDsl}},value$1=function(validator){var extract=function(path,strength,val){return SimpleResult.bindError(validator(val,strength),function(err){return custom(path,err)})},toString=function(){return"val"},toDsl=function(){return typeAdt.itemOf(validator)};return{extract:extract,toString:toString,toDsl:toDsl}},getSetKeys=function(obj){var keys$1=keys(obj);return filter(keys$1,function(k){return hasKey$1(obj,k)})},objOfOnly=function(fields){var delegate=objOf(fields),fieldNames=foldr(fields,function(acc,f){return f.fold(function(key){return deepMerge(acc,wrap$1(key,!0))},constant(acc))},{}),extract=function(path,strength,o){var keys=isBoolean(o)?[]:getSetKeys(o),extra=filter(keys,function(k){return!hasKey$1(fieldNames,k)});return 0===extra.length?delegate.extract(path,strength,o):unsupportedFields(path,extra)};return{extract:extract,toString:delegate.toString,toDsl:delegate.toDsl}},objOf=function(fields){var extract=function(path,strength,o){return cExtract(path,o,fields,strength)},toString=function(){var fieldStrings=map(fields,function(field){return field.fold(function(key,okey,presence,prop){return key+" -> "+prop.toString()},function(okey,instantiator){return"state("+okey+")"})});return"obj{\n"+fieldStrings.join("\n")+"}"},toDsl=function(){return typeAdt.objOf(map(fields,function(f){return f.fold(function(key,okey,presence,prop){return fieldAdt.field(key,presence,prop)},function(okey,instantiator){return fieldAdt.state(okey)})}))};return{extract:extract,toString:toString,toDsl:toDsl}},arrOf=function(prop){var extract=function(path,strength,array){var results=map(array,function(a,i){return prop.extract(path.concat(["["+i+"]"]),strength,a)});return ResultCombine.consolidateArr(results)},toString=function(){return"array("+prop.toString()+")"},toDsl=function(){return typeAdt.arrOf(prop)};return{extract:extract,toString:toString,toDsl:toDsl}},setOf=function(validator,prop){var validateKeys=function(path,keys){return arrOf(value$1(validator)).extract(path,identity,keys)},extract=function(path,strength,o){var keys$1=keys(o),validatedKeys=validateKeys(path,keys$1);return SimpleResult.bind(validatedKeys,function(validKeys){var schema=map(validKeys,function(vk){return adt$1.field(vk,vk,strict(),prop)});return objOf(schema).extract(path,strength,o)})},toString=function(){return"setOf("+prop.toString()+")"},toDsl=function(){return typeAdt.setOf(validator,prop)};return{extract:extract,toString:toString,toDsl:toDsl}},anyValue=constant(value$1(SimpleResult.svalue)),arrOfObj=compose(arrOf,objOf),state=adt$1.state,field=adt$1.field,chooseFrom=function(path,strength,input,branches,ch){var fields=readOptFrom$1(branches,ch);return fields.fold(function(){return missingBranch(path,branches,ch)},function(vp){return vp.extract(path.concat(["branch: "+ch]),strength,input)})},choose=function(key,branches){var extract=function(path,strength,input){var choice=readOptFrom$1(input,key);return choice.fold(function(){return missingKey(path,key)},function(chosen){return chooseFrom(path,strength,input,branches,chosen)})},toString=function(){return"chooseOn("+key+"). Possible values: "+keys(branches)},toDsl=function(){return typeAdt.choiceOf(key,branches)};return{extract:extract,toString:toString,toDsl:toDsl}},_anyValue=value$1(SimpleResult.svalue),arrOfObj$1=function(objFields){return arrOfObj(objFields)},arrOfVal=function(){return arrOf(_anyValue)},valueThunkOf=valueThunk,valueOf=function(validator){return value$1(function(v){return validator(v).fold(SimpleResult.serror,SimpleResult.svalue)})},setOf$1=function(validator,prop){return setOf(function(v){return SimpleResult.fromResult(validator(v))},prop)},extract=function(label,prop,strength,obj){var res=prop.extract([label],strength,obj);return SimpleResult.mapError(res,function(errs){return{input:obj,errors:errs}})},asRaw=function(label,prop,obj){return SimpleResult.toResult(extract(label,prop,identity,obj))},getOrDie=function(extraction){return extraction.fold(function(errInfo){throw new Error(formatError(errInfo))},identity)},asRawOrDie=function(label,prop,obj){return getOrDie(asRaw(label,prop,obj))},formatError=function(errInfo){return"Errors: \n"+formatErrors(errInfo.errors)+"\n\nInput object: "+formatObj(errInfo.input)},chooseProcessor=function(key,branches){return choose(key,branches)},choose$1=function(key,branches){return choose(key,map$1(branches,objOf))},anyValue$1=constant(_anyValue),typedValue=function(validator,expectedType){return value$1(function(a){var actualType=typeof a;return validator(a)?SimpleResult.svalue(a):SimpleResult.serror("Expected type: "+expectedType+" but got: "+actualType)})},number=typedValue(isNumber,"number"),string=typedValue(isString,"string"),boolean=typedValue(isBoolean,"boolean"),functionProcessor=typedValue(isFunction,"function"),isPostMessageable=function(val){var every=function(iter,callbackFn){for(var result=iter.next();!result.done;){if(!callbackFn(result.value))return!1;result=iter.next()}return!0};if(Object(val)!==val)return!0;switch({}.toString.call(val).slice(8,-1)){case"Boolean":case"Number":case"String":case"Date":case"RegExp":case"Blob":case"FileList":case"ImageData":case"ImageBitmap":case"ArrayBuffer":return!0;case"Array":case"Object":return Object.keys(val).every(function(prop){return isPostMessageable(val[prop])});case"Map":return every(val.keys(),isPostMessageable)&&every(val.values(),isPostMessageable);case"Set":return every(val.keys(),isPostMessageable);default:return!1}},postMessageable=value$1(function(a){return isPostMessageable(a)?SimpleResult.svalue(a):SimpleResult.serror("Expected value to be acceptable for sending via postMessage")}),validateEnum=function(values){return valueOf(function(value){return contains(values,value)?Result.value(value):Result.error('Unsupported value: "'+value+'", choose one of "'+values.join(", ")+'".')})},strict$1=function(key){return field(key,key,strict(),anyValue())},strictOf=function(key,schema){return field(key,key,strict(),schema)},strictNumber=function(key){return strictOf(key,number)},strictString=function(key){return strictOf(key,string)},strictStringEnum=function(key,values){return field(key,key,strict(),validateEnum(values))},strictBoolean=function(key){return strictOf(key,boolean)},strictFunction=function(key){return strictOf(key,functionProcessor)},forbid=function(key,message){return field(key,key,asOption(),value$1(function(v){return SimpleResult.serror("The field: "+key+" is forbidden. "+message)}))},strictObjOf=function(key,objSchema){return field(key,key,strict(),objOf(objSchema))},strictArrayOfObj=function(key,objFields){return field(key,key,strict(),arrOfObj(objFields))},strictArrayOf=function(key,schema){return field(key,key,strict(),arrOf(schema))},option=function(key){return field(key,key,asOption(),anyValue())},optionOf=function(key,schema){return field(key,key,asOption(),schema)},optionNumber=function(key){return optionOf(key,number)},optionString=function(key){return optionOf(key,string)},optionFunction=function(key){return optionOf(key,functionProcessor)},optionArrayOf=function(key,schema){return optionOf(key,arrOf(schema))},optionObjOf=function(key,objSchema){return optionOf(key,objOf(objSchema))},optionObjOfOnly=function(key,objSchema){return optionOf(key,objOfOnly(objSchema))},defaulted$1=function(key,fallback){return field(key,key,defaulted(fallback),anyValue())},defaultedOf=function(key,fallback,schema){return field(key,key,defaulted(fallback),schema)},defaultedNumber=function(key,fallback){return defaultedOf(key,fallback,number)},defaultedString=function(key,fallback){return defaultedOf(key,fallback,string)},defaultedStringEnum=function(key,fallback,values){return defaultedOf(key,fallback,validateEnum(values))},defaultedBoolean=function(key,fallback){return defaultedOf(key,fallback,boolean)},defaultedFunction=function(key,fallback){return defaultedOf(key,fallback,functionProcessor)},defaultedPostMsg=function(key,fallback){return defaultedOf(key,fallback,postMessageable)},defaultedObjOf=function(key,fallback,objSchema){return defaultedOf(key,fallback,objOf(objSchema))},state$1=function(okey,instantiator){return state(okey,instantiator)},Cell=function(initial){var value=initial,get=function(){return value},set=function(v){value=v},clone=function(){return Cell(get())};return{get:get,set:set,clone:clone}},fromHtml=function(html,scope){var doc=scope||domGlobals.document,div=doc.createElement("div");if(div.innerHTML=html,!div.hasChildNodes()||div.childNodes.length>1)throw domGlobals.console.error("HTML does not have a single root node",html),new Error("HTML must have a single root node");return fromDom(div.childNodes[0])},fromTag=function(tag,scope){var doc=scope||domGlobals.document,node=doc.createElement(tag);return fromDom(node)},fromText=function(text,scope){var doc=scope||domGlobals.document,node=doc.createTextNode(text);return fromDom(node)},fromDom=function(node){if(null==node)throw new Error("Node cannot be null or undefined");return{dom:constant(node)}},fromPoint=function(docElm,x,y){var doc=docElm.dom();return Option.from(doc.elementFromPoint(x,y)).map(fromDom)},Element={fromHtml:fromHtml,fromTag:fromTag,fromText:fromText,fromDom:fromDom,fromPoint:fromPoint},compareDocumentPosition=function(a,b,match){return 0!=(a.compareDocumentPosition(b)&match)},documentPositionPreceding=function(a,b){return compareDocumentPosition(a,b,domGlobals.Node.DOCUMENT_POSITION_PRECEDING)},documentPositionContainedBy=function(a,b){return compareDocumentPosition(a,b,domGlobals.Node.DOCUMENT_POSITION_CONTAINED_BY)},Node={documentPositionPreceding:documentPositionPreceding,documentPositionContainedBy:documentPositionContainedBy},firstMatch=function(regexes,s){for(var i=0;i<regexes.length;i++){var x=regexes[i];if(x.test(s))return x}},find$2=function(regexes,agent){var r=firstMatch(regexes,agent);if(!r)return{major:0,minor:0};var group=function(i){return Number(agent.replace(r,"$"+i))};return nu$1(group(1),group(2))},detect=function(versionRegexes,agent){var cleanedAgent=String(agent).toLowerCase();return 0===versionRegexes.length?unknown():find$2(versionRegexes,cleanedAgent)},unknown=function(){return nu$1(0,0)},nu$1=function(major,minor){return{major:major,minor:minor}},Version={nu:nu$1,detect:detect,unknown:unknown},edge="Edge",chrome="Chrome",ie="IE",opera="Opera",firefox="Firefox",safari="Safari",isBrowser=function(name,current){return function(){return current===name}},unknown$1=function(){return nu$2({current:void 0,version:Version.unknown()})},nu$2=function(info){var current=info.current,version=info.version;return{current:current,version:version,isEdge:isBrowser(edge,current),isChrome:isBrowser(chrome,current),isIE:isBrowser(ie,current),isOpera:isBrowser(opera,current),isFirefox:isBrowser(firefox,current),isSafari:isBrowser(safari,current)}},Browser={unknown:unknown$1,nu:nu$2,edge:constant(edge),chrome:constant(chrome),ie:constant(ie),opera:constant(opera),firefox:constant(firefox),safari:constant(safari)},windows="Windows",ios="iOS",android="Android",linux="Linux",osx="OSX",solaris="Solaris",freebsd="FreeBSD",isOS=function(name,current){return function(){return current===name}},unknown$2=function(){return nu$3({current:void 0,version:Version.unknown()})},nu$3=function(info){var current=info.current,version=info.version;return{current:current,version:version,isWindows:isOS(windows,current),isiOS:isOS(ios,current),isAndroid:isOS(android,current),isOSX:isOS(osx,current),isLinux:isOS(linux,current),isSolaris:isOS(solaris,current),isFreeBSD:isOS(freebsd,current)}},OperatingSystem={unknown:unknown$2,nu:nu$3,windows:constant(windows),ios:constant(ios),android:constant(android),linux:constant(linux),osx:constant(osx),solaris:constant(solaris),freebsd:constant(freebsd)},DeviceType=function(os,browser,userAgent){var isiPad=os.isiOS()&&!0===/ipad/i.test(userAgent),isiPhone=os.isiOS()&&!isiPad,isAndroid3=os.isAndroid()&&3===os.version.major,isAndroid4=os.isAndroid()&&4===os.version.major,isTablet=isiPad||isAndroid3||isAndroid4&&!0===/mobile/i.test(userAgent),isTouch=os.isiOS()||os.isAndroid(),isPhone=isTouch&&!isTablet,iOSwebview=browser.isSafari()&&os.isiOS()&&!1===/safari/i.test(userAgent);return{isiPad:constant(isiPad),isiPhone:constant(isiPhone),isTablet:constant(isTablet),isPhone:constant(isPhone),isTouch:constant(isTouch),isAndroid:os.isAndroid,isiOS:os.isiOS,isWebView:constant(iOSwebview)}},detect$1=function(candidates,userAgent){var agent=String(userAgent).toLowerCase();return find(candidates,function(candidate){return candidate.search(agent)})},detectBrowser=function(browsers,userAgent){return detect$1(browsers,userAgent).map(function(browser){var version=Version.detect(browser.versionRegexes,userAgent);return{current:browser.name,version:version}})},detectOs=function(oses,userAgent){return detect$1(oses,userAgent).map(function(os){var version=Version.detect(os.versionRegexes,userAgent);return{current:os.name,version:version}})},UaString={detectBrowser:detectBrowser,detectOs:detectOs},checkRange=function(str,substr,start){if(""===substr)return!0;if(str.length<substr.length)return!1;var x=str.substr(start,start+substr.length);return x===substr},contains$1=function(str,substr){return-1!==str.indexOf(substr)},endsWith=function(str,suffix){return checkRange(str,suffix,str.length-suffix.length)},trim=function(str){return str.replace(/^\s+|\s+$/g,"")},normalVersionRegex=/.*?version\/\ ?([0-9]+)\.([0-9]+).*/,checkContains=function(target){return function(uastring){return contains$1(uastring,target)}},browsers=[{name:"Edge",versionRegexes:[/.*?edge\/ ?([0-9]+)\.([0-9]+)$/],search:function(uastring){return contains$1(uastring,"edge/")&&contains$1(uastring,"chrome")&&contains$1(uastring,"safari")&&contains$1(uastring,"applewebkit")}},{name:"Chrome",versionRegexes:[/.*?chrome\/([0-9]+)\.([0-9]+).*/,normalVersionRegex],search:function(uastring){return contains$1(uastring,"chrome")&&!contains$1(uastring,"chromeframe")}},{name:"IE",versionRegexes:[/.*?msie\ ?([0-9]+)\.([0-9]+).*/,/.*?rv:([0-9]+)\.([0-9]+).*/],search:function(uastring){return contains$1(uastring,"msie")||contains$1(uastring,"trident")}},{name:"Opera",versionRegexes:[normalVersionRegex,/.*?opera\/([0-9]+)\.([0-9]+).*/],search:checkContains("opera")},{name:"Firefox",versionRegexes:[/.*?firefox\/\ ?([0-9]+)\.([0-9]+).*/],search:checkContains("firefox")},{name:"Safari",versionRegexes:[normalVersionRegex,/.*?cpu os ([0-9]+)_([0-9]+).*/],search:function(uastring){return(contains$1(uastring,"safari")||contains$1(uastring,"mobile/"))&&contains$1(uastring,"applewebkit")}}],oses=[{name:"Windows",search:checkContains("win"),versionRegexes:[/.*?windows\ nt\ ?([0-9]+)\.([0-9]+).*/]},{name:"iOS",search:function(uastring){return contains$1(uastring,"iphone")||contains$1(uastring,"ipad")},versionRegexes:[/.*?version\/\ ?([0-9]+)\.([0-9]+).*/,/.*cpu os ([0-9]+)_([0-9]+).*/,/.*cpu iphone os ([0-9]+)_([0-9]+).*/]},{name:"Android",search:checkContains("android"),versionRegexes:[/.*?android\ ?([0-9]+)\.([0-9]+).*/]},{name:"OSX",search:checkContains("os x"),versionRegexes:[/.*?os\ x\ ?([0-9]+)_([0-9]+).*/]},{name:"Linux",search:checkContains("linux"),versionRegexes:[]},{name:"Solaris",search:checkContains("sunos"),versionRegexes:[]},{name:"FreeBSD",search:checkContains("freebsd"),versionRegexes:[]}],PlatformInfo={browsers:constant(browsers),oses:constant(oses)},detect$2=function(userAgent){var browsers=PlatformInfo.browsers(),oses=PlatformInfo.oses(),browser=UaString.detectBrowser(browsers,userAgent).fold(Browser.unknown,Browser.nu),os=UaString.detectOs(oses,userAgent).fold(OperatingSystem.unknown,OperatingSystem.nu),deviceType=DeviceType(os,browser,userAgent);return{browser:browser,os:os,deviceType:deviceType}},PlatformDetection={detect:detect$2},detect$3=cached(function(){var userAgent=domGlobals.navigator.userAgent;return PlatformDetection.detect(userAgent)}),PlatformDetection$1={detect:detect$3},DOCUMENT=(domGlobals.Node.ATTRIBUTE_NODE,domGlobals.Node.CDATA_SECTION_NODE,domGlobals.Node.COMMENT_NODE,domGlobals.Node.DOCUMENT_NODE),ELEMENT=(domGlobals.Node.DOCUMENT_TYPE_NODE,domGlobals.Node.DOCUMENT_FRAGMENT_NODE,domGlobals.Node.ELEMENT_NODE),TEXT=domGlobals.Node.TEXT_NODE,ELEMENT$1=(domGlobals.Node.PROCESSING_INSTRUCTION_NODE,domGlobals.Node.ENTITY_REFERENCE_NODE,domGlobals.Node.ENTITY_NODE,domGlobals.Node.NOTATION_NODE,ELEMENT),DOCUMENT$1=DOCUMENT,is=function(element,selector){var dom=element.dom();if(dom.nodeType!==ELEMENT$1)return!1;var elem=dom;if(void 0!==elem.matches)return elem.matches(selector);if(void 0!==elem.msMatchesSelector)return elem.msMatchesSelector(selector);if(void 0!==elem.webkitMatchesSelector)return elem.webkitMatchesSelector(selector);if(void 0!==elem.mozMatchesSelector)return elem.mozMatchesSelector(selector);throw new Error("Browser lacks native selectors")},bypassSelector=function(dom){return dom.nodeType!==ELEMENT$1&&dom.nodeType!==DOCUMENT$1||0===dom.childElementCount},all=function(selector,scope){var base=void 0===scope?domGlobals.document:scope.dom();return bypassSelector(base)?[]:map(base.querySelectorAll(selector),Element.fromDom)},one=function(selector,scope){var base=void 0===scope?domGlobals.document:scope.dom();return bypassSelector(base)?Option.none():Option.from(base.querySelector(selector)).map(Element.fromDom)},eq=function(e1,e2){return e1.dom()===e2.dom()},regularContains=function(e1,e2){var d1=e1.dom(),d2=e2.dom();return d1!==d2&&d1.contains(d2)},ieContains=function(e1,e2){return Node.documentPositionContainedBy(e1.dom(),e2.dom())},browser=PlatformDetection$1.detect().browser,contains$2=browser.isIE()?ieContains:regularContains,isSource=function(component,simulatedEvent){return eq(component.element(),simulatedEvent.event().target())},nu$4=function(parts){if(!hasKey$1(parts,"can")&&!hasKey$1(parts,"abort")&&!hasKey$1(parts,"run"))throw new Error("EventHandler defined by: "+JSON.stringify(parts,null,2)+" does not have can, abort, or run!");return asRawOrDie("Extracting event.handler",objOfOnly([defaulted$1("can",constant(!0)),defaulted$1("abort",constant(!1)),defaulted$1("run",noop)]),parts)},all$1=function(handlers,f){return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];return foldl(handlers,function(acc,handler){return acc&&f(handler).apply(void 0,args)},!0)}},any=function(handlers,f){return function(){
for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];return foldl(handlers,function(acc,handler){return acc||f(handler).apply(void 0,args)},!1)}},read=function(handler){return isFunction(handler)?{can:constant(!0),abort:constant(!1),run:handler}:handler},fuse=function(handlers){var can=all$1(handlers,function(handler){return handler.can}),abort=any(handlers,function(handler){return handler.abort}),run=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];each(handlers,function(handler){handler.run.apply(void 0,args)})};return nu$4({can:can,abort:abort,run:run})},touchstart=constant("touchstart"),touchmove=constant("touchmove"),touchend=constant("touchend"),mousedown=constant("mousedown"),mousemove=constant("mousemove"),mouseout=constant("mouseout"),mouseup=constant("mouseup"),mouseover=constant("mouseover"),focusin=constant("focusin"),focusout=constant("focusout"),keydown=constant("keydown"),keyup=constant("keyup"),input=constant("input"),change=constant("change"),click=constant("click"),transitionend=constant("transitionend"),selectstart=constant("selectstart"),alloy={tap:constant("alloy.tap")},focus=constant("alloy.focus"),postBlur=constant("alloy.blur.post"),postPaste=constant("alloy.paste.post"),receive=constant("alloy.receive"),execute=constant("alloy.execute"),focusItem=constant("alloy.focus.item"),tap=alloy.tap,tapOrClick=PlatformDetection$1.detect().deviceType.isTouch()?alloy.tap:click,longpress=constant("alloy.longpress"),sandboxClose=constant("alloy.sandbox.close"),typeaheadCancel=constant("alloy.typeahead.cancel"),systemInit=constant("alloy.system.init"),windowScroll=constant("alloy.system.scroll"),windowResize=constant("alloy.system.resize"),attachedToDom=constant("alloy.system.attached"),detachedFromDom=constant("alloy.system.detached"),dismissRequested=constant("alloy.system.dismissRequested"),focusShifted=constant("alloy.focusmanager.shifted"),slotVisibility=constant("alloy.slotcontainer.visibility"),changeTab=constant("alloy.change.tab"),dismissTab=constant("alloy.dismiss.tab"),highlight=constant("alloy.highlight"),dehighlight=constant("alloy.dehighlight"),emit=function(component,event){dispatchWith(component,component.element(),event,{})},emitWith=function(component,event,properties){dispatchWith(component,component.element(),event,properties)},emitExecute=function(component){emit(component,execute())},dispatch=function(component,target,event){dispatchWith(component,target,event,{})},dispatchWith=function(component,target,event,properties){var data=__assign({target:target},properties);component.getSystem().triggerEvent(event,target,map$1(data,constant))},dispatchEvent=function(component,target,event,simulatedEvent){component.getSystem().triggerEvent(event,target,simulatedEvent.event())},name=(void 0!==domGlobals.window?domGlobals.window:Function("return this;")(),function(element){var r=element.dom().nodeName;return r.toLowerCase()}),type=function(element){return element.dom().nodeType},isType$1=function(t){return function(element){return type(element)===t}},isElement=isType$1(ELEMENT),isText=isType$1(TEXT),inBody=function(element){var dom=isText(element)?element.dom().parentNode:element.dom();return null!=dom&&dom.ownerDocument.body.contains(dom)},body=cached(function(){return getBody(Element.fromDom(domGlobals.document))}),getBody=function(doc){var b=doc.dom().body;if(null==b)throw new Error("Body is not available yet");return Element.fromDom(b)},ancestor=function(scope,predicate,isRoot){for(var element=scope.dom(),stop=isFunction(isRoot)?isRoot:constant(!1);element.parentNode;){element=element.parentNode;var el=Element.fromDom(element);if(predicate(el))return Option.some(el);if(stop(el))break}return Option.none()},closest=function(scope,predicate,isRoot){var is=function(s,test){return test(s)};return ClosestOrAncestor(is,ancestor,scope,predicate,isRoot)},descendant=function(scope,predicate){var descend=function(node){for(var i=0;i<node.childNodes.length;i++){var child_1=Element.fromDom(node.childNodes[i]);if(predicate(child_1))return Option.some(child_1);var res=descend(node.childNodes[i]);if(res.isSome())return res}return Option.none()};return descend(scope.dom())},closest$1=function(target,transform,isRoot){var delegate=closest(target,function(elem){return transform(elem).isSome()},isRoot);return delegate.bind(transform)},derive=function(configs){return wrapAll$1(configs)},abort=function(name,predicate){return{key:name,value:nu$4({abort:predicate})}},can=function(name,predicate){return{key:name,value:nu$4({can:predicate})}},preventDefault=function(name){return{key:name,value:nu$4({run:function(component,simulatedEvent){simulatedEvent.event().prevent()}})}},run=function(name,handler){return{key:name,value:nu$4({run:handler})}},runActionExtra=function(name,action,extra){return{key:name,value:nu$4({run:function(component){action.apply(void 0,[component].concat(extra))}})}},runOnName=function(name){return function(handler){return run(name,handler)}},runOnSourceName=function(name){return function(handler){return{key:name,value:nu$4({run:function(component,simulatedEvent){isSource(component,simulatedEvent)&&handler(component,simulatedEvent)}})}}},redirectToUid=function(name,uid){return run(name,function(component,simulatedEvent){component.getSystem().getByUid(uid).each(function(redirectee){dispatchEvent(redirectee,redirectee.element(),name,simulatedEvent)})})},redirectToPart=function(name,detail,partName){var uid=detail.partUids[partName];return redirectToUid(name,uid)},runWithTarget=function(name,f){return run(name,function(component,simulatedEvent){var ev=simulatedEvent.event(),target=component.getSystem().getByDom(ev.target()).fold(function(){var closest=closest$1(ev.target(),function(el){return component.getSystem().getByDom(el).toOption()},constant(!1));return closest.getOr(component)},function(c){return c});f(component,target,simulatedEvent)})},cutter=function(name){return run(name,function(component,simulatedEvent){simulatedEvent.cut()})},stopper=function(name){return run(name,function(component,simulatedEvent){simulatedEvent.stop()})},runOnSource=function(name,f){return runOnSourceName(name)(f)},runOnAttached=runOnSourceName(attachedToDom()),runOnDetached=runOnSourceName(detachedFromDom()),runOnInit=runOnSourceName(systemInit()),runOnExecute=runOnName(execute()),Immutable=function(){for(var fields=[],_i=0;_i<arguments.length;_i++)fields[_i]=arguments[_i];return function(){for(var values=[],_i=0;_i<arguments.length;_i++)values[_i]=arguments[_i];if(fields.length!==values.length)throw new Error('Wrong number of arguments to struct. Expected "['+fields.length+']", got '+values.length+" arguments");var struct={};return each(fields,function(name,i){struct[name]=constant(values[i])}),struct}},sort$1=function(arr){return arr.slice(0).sort()},reqMessage=function(required,keys){throw new Error("All required keys ("+sort$1(required).join(", ")+") were not specified. Specified keys were: "+sort$1(keys).join(", ")+".")},unsuppMessage=function(unsupported){throw new Error("Unsupported keys for object: "+sort$1(unsupported).join(", "))},validateStrArr=function(label,array){if(!isArray(array))throw new Error("The "+label+" fields must be an array. Was: "+array+".");each(array,function(a){if(!isString(a))throw new Error("The value "+a+" in the "+label+" fields was not a string.")})},checkDupes=function(everything){var sorted=sort$1(everything),dupe=find(sorted,function(s,i){return i<sorted.length-1&&s===sorted[i+1]});dupe.each(function(d){throw new Error("The field: "+d+" occurs more than once in the combined fields: ["+sorted.join(", ")+"].")})},MixedBag=function(required,optional){var everything=required.concat(optional);if(0===everything.length)throw new Error("You must specify at least one required or optional field.");return validateStrArr("required",required),validateStrArr("optional",optional),checkDupes(everything),function(obj){var keys$1=keys(obj),allReqd=forall(required,function(req){return contains(keys$1,req)});allReqd||reqMessage(required,keys$1);var unsupported=filter(keys$1,function(key){return!contains(everything,key)});unsupported.length>0&&unsuppMessage(unsupported);var r={};return each(required,function(req){r[req]=constant(obj[req])}),each(optional,function(opt){r[opt]=constant(Object.prototype.hasOwnProperty.call(obj,opt)?Option.some(obj[opt]):Option.none())}),r}},owner=function(element){return Element.fromDom(element.dom().ownerDocument)},defaultView=function(element){return Element.fromDom(element.dom().ownerDocument.defaultView)},parent=function(element){return Option.from(element.dom().parentNode).map(Element.fromDom)},offsetParent=function(element){return Option.from(element.dom().offsetParent).map(Element.fromDom)},nextSibling=function(element){return Option.from(element.dom().nextSibling).map(Element.fromDom)},children=function(element){return map(element.dom().childNodes,Element.fromDom)},child=function(element,index){var cs=element.dom().childNodes;return Option.from(cs[index]).map(Element.fromDom)},firstChild=function(element){return child(element,0)},fromHtml$1=(Immutable("element","offset"),function(html,scope){var doc=scope||domGlobals.document,div=doc.createElement("div");return div.innerHTML=html,children(Element.fromDom(div))}),before=function(marker,element){var parent$1=parent(marker);parent$1.each(function(v){v.dom().insertBefore(element.dom(),marker.dom())})},after=function(marker,element){var sibling=nextSibling(marker);sibling.fold(function(){var parent$1=parent(marker);parent$1.each(function(v){append(v,element)})},function(v){before(v,element)})},prepend=function(parent,element){var firstChild$1=firstChild(parent);firstChild$1.fold(function(){append(parent,element)},function(v){parent.dom().insertBefore(element.dom(),v.dom())})},append=function(parent,element){parent.dom().appendChild(element.dom())},appendAt=function(parent,element,index){child(parent,index).fold(function(){append(parent,element)},function(v){before(v,element)})},before$1=function(marker,elements){each(elements,function(x){before(marker,x)})},append$1=function(parent,elements){each(elements,function(x){append(parent,x)})},empty=function(element){element.dom().textContent="",each(children(element),function(rogue){remove(rogue)})},remove=function(element){var dom=element.dom();null!==dom.parentNode&&dom.parentNode.removeChild(dom)},unwrap=function(wrapper){var children$1=children(wrapper);children$1.length>0&&before$1(wrapper,children$1),remove(wrapper)},get$1=function(element){return element.dom().innerHTML},set=function(element,content){var owner$1=owner(element),docDom=owner$1.dom(),fragment=Element.fromDom(docDom.createDocumentFragment()),contentElements=fromHtml$1(content,docDom);append$1(fragment,contentElements),empty(element),append(element,fragment)},getOuter=function(element){var container=Element.fromTag("div"),clone=Element.fromDom(element.dom().cloneNode(!0));return append(container,clone),get$1(container)},rawSet=function(dom,key,value){if(!(isString(value)||isBoolean(value)||isNumber(value)))throw domGlobals.console.error("Invalid call to Attr.set. Key ",key,":: Value ",value,":: Element ",dom),new Error("Attribute value was not simple");dom.setAttribute(key,value+"")},set$1=function(element,key,value){rawSet(element.dom(),key,value)},setAll=function(element,attrs){var dom=element.dom();each$1(attrs,function(v,k){rawSet(dom,k,v)})},get$2=function(element,key){var v=element.dom().getAttribute(key);return null===v?void 0:v},has$1=function(element,key){var dom=element.dom();return!(!dom||!dom.hasAttribute)&&dom.hasAttribute(key)},remove$1=function(element,key){element.dom().removeAttribute(key)},clone=function(original,isDeep){return Element.fromDom(original.dom().cloneNode(isDeep))},shallow$1=function(original){return clone(original,!1)},getHtml=function(element){var clone=shallow$1(element);return getOuter(clone)},element=function(elem){return getHtml(elem)},isRecursive=function(component,originator,target){return eq(originator,component.element())&&!eq(originator,target)},events=derive([can(focus(),function(component,simulatedEvent){var originator=simulatedEvent.event().originator(),target=simulatedEvent.event().target();return!isRecursive(component,originator,target)||(domGlobals.console.warn(focus()+" did not get interpreted by the desired target. \nOriginator: "+element(originator)+"\nTarget: "+element(target)+"\nCheck the "+focus()+" event handlers"),!1)})]),DefaultEvents=Object.freeze({events:events}),unique=0,generate$1=function(prefix){var date=new Date,time=date.getTime(),random=Math.floor(1e9*Math.random());return unique++,prefix+"_"+random+unique+String(time)},prefix=constant("alloy-id-"),idAttr=constant("data-alloy-id"),prefix$1=prefix(),idAttr$1=idAttr(),write=function(label,elem){var id=generate$1(prefix$1+label);return writeOnly(elem,id),id},writeOnly=function(elem,uid){Object.defineProperty(elem.dom(),idAttr$1,{value:uid,writable:!0})},read$1=function(elem){var id=isElement(elem)?elem.dom()[idAttr$1]:null;return Option.from(id)},generate$2=function(prefix){return generate$1(prefix)},make=identity,NoContextApi=function(getComp){var fail=function(event){return function(){throw new Error("The component must be in a context to send: "+event+"\n"+element(getComp().element())+" is not in context.")}};return{debugInfo:constant("fake"),triggerEvent:fail("triggerEvent"),triggerFocus:fail("triggerFocus"),triggerEscape:fail("triggerEscape"),build:fail("build"),addToWorld:fail("addToWorld"),removeFromWorld:fail("removeFromWorld"),addToGui:fail("addToGui"),removeFromGui:fail("removeFromGui"),getByUid:fail("getByUid"),getByDom:fail("getByDom"),broadcast:fail("broadcast"),broadcastOn:fail("broadcastOn"),broadcastEvent:fail("broadcastEvent"),isConnected:constant(!1)}},singleton=NoContextApi(),markAsBehaviourApi=function(f,apiName,apiFunction){var delegate=apiFunction.toString(),endIndex=delegate.indexOf(")")+1,openBracketIndex=delegate.indexOf("("),parameters=delegate.substring(openBracketIndex+1,endIndex-1).split(/,\s*/);return f.toFunctionAnnotation=function(){return{name:apiName,parameters:cleanParameters(parameters.slice(0,1).concat(parameters.slice(3)))}},f},cleanParameters=function(parameters){return map(parameters,function(p){return endsWith(p,"/*")?p.substring(0,p.length-"/*".length):p})},markAsExtraApi=function(f,extraName){var delegate=f.toString(),endIndex=delegate.indexOf(")")+1,openBracketIndex=delegate.indexOf("("),parameters=delegate.substring(openBracketIndex+1,endIndex-1).split(/,\s*/);return f.toFunctionAnnotation=function(){return{name:extraName,parameters:cleanParameters(parameters)}},f},markAsSketchApi=function(f,apiFunction){var delegate=apiFunction.toString(),endIndex=delegate.indexOf(")")+1,openBracketIndex=delegate.indexOf("("),parameters=delegate.substring(openBracketIndex+1,endIndex-1).split(/,\s*/);return f.toFunctionAnnotation=function(){return{name:"OVERRIDE",parameters:cleanParameters(parameters.slice(1))}},f},premadeTag=generate$1("alloy-premade"),premade=function(comp){return wrap$1(premadeTag,comp)},getPremade=function(spec){return readOptFrom$1(spec,premadeTag)},makeApi=function(f){return markAsSketchApi(function(component){for(var rest=[],_i=1;_i<arguments.length;_i++)rest[_i-1]=arguments[_i];return f.apply(void 0,[component.getApis()].concat([component].concat(rest)))},f)},NoState={init:function(){return nu$5({readState:function(){return"No State required"}})}},nu$5=function(spec){return spec},generateFrom=function(spec,all){var schema=map(all,function(a){return optionObjOf(a.name(),[strict$1("config"),defaulted$1("state",NoState)])}),validated=asRaw("component.behaviours",objOf(schema),spec.behaviours).fold(function(errInfo){throw new Error(formatError(errInfo)+"\nComplete spec:\n"+JSON.stringify(spec,null,2))},function(v){return v});return{list:all,data:map$1(validated,function(optBlobThunk){var optBlob=optBlobThunk,output=optBlob.map(function(blob){return{config:blob.config,state:blob.state.init(blob.config)}});return function(){return output}})}},getBehaviours=function(bData){return bData.list},getData=function(bData){return bData.data},byInnerKey=function(data,tuple){var r={};return each$1(data,function(detail,key){each$1(detail,function(value,indexKey){var chain=readOr$1(indexKey,[])(r);r[indexKey]=chain.concat([tuple(key,value)])})}),r},nu$6=function(s){return{classes:void 0!==s.classes?s.classes:[],attributes:void 0!==s.attributes?s.attributes:{},styles:void 0!==s.styles?s.styles:{}}},merge$1=function(defnA,mod){return __assign({},defnA,{attributes:__assign({},defnA.attributes,mod.attributes),styles:__assign({},defnA.styles,mod.styles),classes:defnA.classes.concat(mod.classes)})},combine=function(info,baseMod,behaviours,base){var modsByBehaviour=__assign({},baseMod);each(behaviours,function(behaviour){modsByBehaviour[behaviour.name()]=behaviour.exhibit(info,base)});var nameAndMod=function(name,modification){return{name:name,modification:modification}},byAspect=byInnerKey(modsByBehaviour,nameAndMod),combineObjects=function(objects){return foldr(objects,function(b,a){return __assign({},a.modification,b)},{})},combinedClasses=foldr(byAspect.classes,function(b,a){return a.modification.concat(b)},[]),combinedAttributes=combineObjects(byAspect.attributes),combinedStyles=combineObjects(byAspect.styles);return nu$6({classes:combinedClasses,attributes:combinedAttributes,styles:combinedStyles})},sortKeys=function(label,keyName,array,order){var sliced=array.slice(0);try{var sorted=sliced.sort(function(a,b){var aKey=a[keyName](),bKey=b[keyName](),aIndex=order.indexOf(aKey),bIndex=order.indexOf(bKey);if(-1===aIndex)throw new Error("The ordering for "+label+" does not have an entry for "+aKey+".\nOrder specified: "+JSON.stringify(order,null,2));if(-1===bIndex)throw new Error("The ordering for "+label+" does not have an entry for "+bKey+".\nOrder specified: "+JSON.stringify(order,null,2));return aIndex<bIndex?-1:bIndex<aIndex?1:0});return Result.value(sorted)}catch(err){return Result.error([err])}},uncurried=function(handler,purpose){return{handler:handler,purpose:constant(purpose)}},curried=function(handler,purpose){return{cHandler:handler,purpose:constant(purpose)}},curryArgs=function(descHandler,extraArgs){return curried(curry.apply(void 0,[descHandler.handler].concat(extraArgs)),descHandler.purpose())},getCurried=function(descHandler){return descHandler.cHandler},behaviourTuple=function(name,handler){return{name:constant(name),handler:constant(handler)}},nameToHandlers=function(behaviours,info){var r={};return each(behaviours,function(behaviour){r[behaviour.name()]=behaviour.handlers(info)}),r},groupByEvents=function(info,behaviours,base){var behaviourEvents=__assign({},base,nameToHandlers(behaviours,info));return byInnerKey(behaviourEvents,behaviourTuple)},combine$1=function(info,eventOrder,behaviours,base){var byEventName=groupByEvents(info,behaviours,base);return combineGroups(byEventName,eventOrder)},assemble=function(rawHandler){var handler=read(rawHandler);return function(component,simulatedEvent){for(var rest=[],_i=2;_i<arguments.length;_i++)rest[_i-2]=arguments[_i];var args=[component,simulatedEvent].concat(rest);handler.abort.apply(void 0,args)?simulatedEvent.stop():handler.can.apply(void 0,args)&&handler.run.apply(void 0,args)}},missingOrderError=function(eventName,tuples){return Result.error(["The event ("+eventName+') has more than one behaviour that listens to it.\nWhen this occurs, you must specify an event ordering for the behaviours in your spec (e.g. [ "listing", "toggling" ]).\nThe behaviours that can trigger it are: '+JSON.stringify(map(tuples,function(c){return c.name()}),null,2)])},fuse$1=function(tuples,eventOrder,eventName){var order=eventOrder[eventName];return order?sortKeys("Event: "+eventName,"name",tuples,order).map(function(sortedTuples){var handlers=map(sortedTuples,function(tuple){return tuple.handler()});return fuse(handlers)}):missingOrderError(eventName,tuples)},combineGroups=function(byEventName,eventOrder){var r=mapToArray(byEventName,function(tuples,eventName){var combined=1===tuples.length?Result.value(tuples[0].handler()):fuse$1(tuples,eventOrder,eventName);return combined.map(function(handler){var assembled=assemble(handler),purpose=tuples.length>1?filter(eventOrder[eventName],function(o){return exists(tuples,function(t){return t.name()===o})}).join(" > "):tuples[0].name();return wrap$1(eventName,uncurried(assembled,purpose))})});return consolidate(r,{})},toInfo=function(spec){return asRaw("custom.definition",objOf([field("dom","dom",strict(),objOf([strict$1("tag"),defaulted$1("styles",{}),defaulted$1("classes",[]),defaulted$1("attributes",{}),option("value"),option("innerHtml")])),strict$1("components"),strict$1("uid"),defaulted$1("events",{}),defaulted$1("apis",{}),field("eventOrder","eventOrder",mergeWith({"alloy.execute":["disabling","alloy.base.behaviour","toggling","typeaheadevents"],"alloy.focus":["alloy.base.behaviour","focusing","keying"],"alloy.system.init":["alloy.base.behaviour","disabling","toggling","representing"],input:["alloy.base.behaviour","representing","streaming","invalidating"],"alloy.system.detached":["alloy.base.behaviour","representing","item-events","tooltipping"],mousedown:["focusing","alloy.base.behaviour","item-type-events"],mouseover:["item-type-events","tooltipping"]}),anyValue$1()),option("domModification")]),spec)},toDefinition=function(detail){return __assign({},detail.dom,{uid:detail.uid,domChildren:map(detail.components,function(comp){return comp.element()})})},toModification=function(detail){return detail.domModification.fold(function(){return nu$6({})},nu$6)},toEvents=function(info){return info.events},read$2=function(element,attr){var value=get$2(element,attr);return void 0===value||""===value?[]:value.split(" ")},add=function(element,attr,id){var old=read$2(element,attr),nu=old.concat([id]);return set$1(element,attr,nu.join(" ")),!0},remove$2=function(element,attr,id){var nu=filter(read$2(element,attr),function(v){return v!==id});return nu.length>0?set$1(element,attr,nu.join(" ")):remove$1(element,attr),!1},supports=function(element){return void 0!==element.dom().classList},get$3=function(element){return read$2(element,"class")},add$1=function(element,clazz){return add(element,"class",clazz)},remove$3=function(element,clazz){return remove$2(element,"class",clazz)},add$2=function(element,clazz){supports(element)?element.dom().classList.add(clazz):add$1(element,clazz)},cleanClass=function(element){var classList=supports(element)?element.dom().classList:get$3(element);0===classList.length&&remove$1(element,"class")},remove$4=function(element,clazz){if(supports(element)){var classList=element.dom().classList;classList.remove(clazz)}else remove$3(element,clazz);cleanClass(element)},has$2=function(element,clazz){return supports(element)&&element.dom().classList.contains(clazz)},add$3=function(element,classes){each(classes,function(x){add$2(element,x)})},remove$5=function(element,classes){each(classes,function(x){remove$4(element,x)})},isSupported=function(dom){return void 0!==dom.style&&isFunction(dom.style.getPropertyValue)},internalSet=function(dom,property,value){if(!isString(value))throw domGlobals.console.error("Invalid call to CSS.set. Property ",property,":: Value ",value,":: Element ",dom),new Error("CSS value must be a string: "+value);isSupported(dom)&&dom.style.setProperty(property,value)},internalRemove=function(dom,property){isSupported(dom)&&dom.style.removeProperty(property)},set$2=function(element,property,value){var dom=element.dom();internalSet(dom,property,value)},setAll$1=function(element,css){var dom=element.dom();each$1(css,function(v,k){internalSet(dom,k,v)})},setOptions=function(element,css){var dom=element.dom();each$1(css,function(v,k){v.fold(function(){internalRemove(dom,k)},function(value){internalSet(dom,k,value)})})},get$4=function(element,property){var dom=element.dom(),styles=domGlobals.window.getComputedStyle(dom),r=styles.getPropertyValue(property),v=""!==r||inBody(element)?r:getUnsafeProperty(dom,property);return null===v?void 0:v},getUnsafeProperty=function(dom,property){return isSupported(dom)?dom.style.getPropertyValue(property):""},getRaw=function(element,property){var dom=element.dom(),raw=getUnsafeProperty(dom,property);return Option.from(raw).filter(function(r){return r.length>0})},isValidValue=function(tag,property,value){var element=Element.fromTag(tag);set$2(element,property,value);var style=getRaw(element,property);return style.isSome()},remove$6=function(element,property){var dom=element.dom();internalRemove(dom,property),has$1(element,"style")&&""===trim(get$2(element,"style"))&&remove$1(element,"style")},reflow=function(e){return e.dom().offsetWidth},get$5=function(element){return element.dom().value},set$3=function(element,value){if(void 0===value)throw new Error("Value.set was undefined");element.dom().value=value},renderToDom=function(definition){var subject=Element.fromTag(definition.tag);setAll(subject,definition.attributes),add$3(subject,definition.classes),setAll$1(subject,definition.styles),definition.innerHtml.each(function(html){return set(subject,html)});var children=definition.domChildren;return append$1(subject,children),definition.value.each(function(value){set$3(subject,value)}),definition.uid,writeOnly(subject,definition.uid),subject},getBehaviours$1=function(spec){var behaviours=readOr$1("behaviours",{})(spec),keys$1=filter(keys(behaviours),function(k){return void 0!==behaviours[k]});return map(keys$1,function(k){return behaviours[k].me})},generateFrom$1=function(spec,all){return generateFrom(spec,all)},generate$3=function(spec){var all=getBehaviours$1(spec);return generateFrom$1(spec,all)},getDomDefinition=function(info,bList,bData){var definition=toDefinition(info),infoModification=toModification(info),baseModification={"alloy.base.modification":infoModification},modification=bList.length>0?combine(bData,baseModification,bList,definition):infoModification;return merge$1(definition,modification)},getEvents=function(info,bList,bData){var baseEvents={"alloy.base.behaviour":toEvents(info)};return combine$1(bData,info.eventOrder,bList,baseEvents).getOrDie()},build=function(spec){var getMe=function(){return me},systemApi=Cell(singleton),info=getOrDie(toInfo(spec)),bBlob=generate$3(spec),bList=getBehaviours(bBlob),bData=getData(bBlob),modDefinition=getDomDefinition(info,bList,bData),item=renderToDom(modDefinition),events=getEvents(info,bList,bData),subcomponents=Cell(info.components),connect=function(newApi){systemApi.set(newApi)},disconnect=function(){systemApi.set(NoContextApi(getMe))},syncComponents=function(){var children$1=children(item),subs=bind(children$1,function(child){return systemApi.get().getByDom(child).fold(function(){return[]},function(c){return[c]})});subcomponents.set(subs)},config=function(behaviour){var b=bData,f=isFunction(b[behaviour.name()])?b[behaviour.name()]:function(){throw new Error("Could not find "+behaviour.name()+" in "+JSON.stringify(spec,null,2))};return f()},hasConfigured=function(behaviour){return isFunction(bData[behaviour.name()])},getApis=function(){return info.apis},readState=function(behaviourName){return bData[behaviourName]().map(function(b){return b.state.readState()}).getOr("not enabled")},me={getSystem:systemApi.get,config:config,hasConfigured:hasConfigured,spec:constant(spec),readState:readState,getApis:getApis,connect:connect,disconnect:disconnect,element:constant(item),syncComponents:syncComponents,components:subcomponents.get,events:constant(events)};return me},buildSubcomponents=function(spec){var components=readOr$1("components",[])(spec);return map(components,build$1)},buildFromSpec=function(userSpec){var _a=make(userSpec),specEvents=_a.events,spec=__rest(_a,["events"]),components=buildSubcomponents(spec),completeSpec=__assign({},spec,{events:__assign({},DefaultEvents,specEvents),components:components});return Result.value(build(completeSpec))},text=function(textContent){var element=Element.fromText(textContent);return external({element:element})},external=function(spec){var extSpec=asRawOrDie("external.component",objOfOnly([strict$1("element"),option("uid")]),spec),systemApi=Cell(NoContextApi()),connect=function(newApi){systemApi.set(newApi)},disconnect=function(){systemApi.set(NoContextApi(function(){return me}))};extSpec.uid.each(function(uid){writeOnly(extSpec.element,uid)});var me={getSystem:systemApi.get,config:Option.none,hasConfigured:constant(!1),connect:connect,disconnect:disconnect,getApis:function(){return{}},element:constant(extSpec.element),spec:constant(spec),readState:constant("No state"),syncComponents:noop,components:constant([]),events:constant({})};return premade(me)},uids=generate$2,build$1=function(spec){return getPremade(spec).fold(function(){var userSpecWithUid=spec.hasOwnProperty("uid")?spec:__assign({uid:uids("")},spec);return buildFromSpec(userSpecWithUid).getOrDie()},function(prebuilt){return prebuilt})},premade$1=premade,closest$2=function(scope,predicate,isRoot){return closest(scope,predicate,isRoot).isSome()},ancestor$1=function(scope,selector,isRoot){return ancestor(scope,function(e){return is(e,selector)},isRoot)},descendant$1=function(scope,selector){return one(selector,scope)},closest$3=function(scope,selector,isRoot){return ClosestOrAncestor(is,ancestor$1,scope,selector,isRoot)},find$3=function(queryElem){var dependent=closest(queryElem,function(elem){if(!isElement(elem))return!1;var id=get$2(elem,"id");return void 0!==id&&id.indexOf("aria-owns")>-1});return dependent.bind(function(dep){var id=get$2(dep,"id"),doc=owner(dep);return descendant$1(doc,'[aria-owns="'+id+'"]')})},manager=function(){var ariaId=generate$1("aria-owns"),link=function(elem){set$1(elem,"aria-owns",ariaId)},unlink=function(elem){remove$1(elem,"aria-owns")};return{id:constant(ariaId),link:link,unlink:unlink}},isAriaPartOf=function(component,queryElem){return find$3(queryElem).exists(function(owner){return isPartOf(component,owner)})},isPartOf=function(component,queryElem){return closest$2(queryElem,function(el){return eq(el,component.element())},constant(!1))||isAriaPartOf(component,queryElem)},cat=function(arr){for(var r=[],push=function(x){r.push(x)},i=0;i<arr.length;i++)arr[i].each(push);return r},findMap=function(arr,f){for(var i=0;i<arr.length;i++){var r=f(arr[i],i);if(r.isSome())return r}return Option.none()},liftN=function(arr,f){for(var r=[],i=0;i<arr.length;i++){var x=arr[i];if(!x.isSome())return Option.none();r.push(x.getOrDie())}return Option.some(f.apply(null,r))},unknown$3="unknown";(function(EventConfiguration){EventConfiguration[EventConfiguration.STOP=0]="STOP",EventConfiguration[EventConfiguration.NORMAL=1]="NORMAL",EventConfiguration[EventConfiguration.LOGGING=2]="LOGGING"})(EventConfiguration||(EventConfiguration={}));var FocusInsideModes,eventConfig=Cell({}),makeEventLogger=function(eventName,initialTarget){var sequence=[],startTime=(new Date).getTime();return{logEventCut:function(name,target,purpose){sequence.push({outcome:"cut",target:target,purpose:purpose})},logEventStopped:function(name,target,purpose){sequence.push({outcome:"stopped",target:target,purpose:purpose})},logNoParent:function(name,target,purpose){sequence.push({outcome:"no-parent",target:target,purpose:purpose})},logEventNoHandlers:function(name,target){sequence.push({outcome:"no-handlers-left",target:target})},logEventResponse:function(name,target,purpose){sequence.push({outcome:"response",purpose:purpose,target:target})},write:function(){var finishTime=(new Date).getTime();contains(["mousemove","mouseover","mouseout",systemInit()],eventName)||domGlobals.console.log(eventName,{event:eventName,time:finishTime-startTime,target:initialTarget.dom(),sequence:map(sequence,function(s){return contains(["cut","stopped","response"],s.outcome)?"{"+s.purpose+"} "+s.outcome+" at ("+element(s.target)+")":s.outcome})})}}},processEvent=function(eventName,initialTarget,f){
var status=readOptFrom$1(eventConfig.get(),eventName).orThunk(function(){var patterns=keys(eventConfig.get());return findMap(patterns,function(p){return eventName.indexOf(p)>-1?Option.some(eventConfig.get()[p]):Option.none()})}).getOr(EventConfiguration.NORMAL);switch(status){case EventConfiguration.NORMAL:return f(noLogger());case EventConfiguration.LOGGING:var logger=makeEventLogger(eventName,initialTarget),output=f(logger);return logger.write(),output;case EventConfiguration.STOP:return!0}},path=["alloy/data/Fields","alloy/debugging/Debugging"],getTrace=function(){var err=new Error;if(void 0!==err.stack){var lines=err.stack.split("\n");return find(lines,function(line){return line.indexOf("alloy")>0&&!exists(path,function(p){return line.indexOf(p)>-1})}).getOr(unknown$3)}return unknown$3},ignoreEvent={logEventCut:noop,logEventStopped:noop,logNoParent:noop,logEventNoHandlers:noop,logEventResponse:noop,write:noop},monitorEvent=function(eventName,initialTarget,f){return processEvent(eventName,initialTarget,f)},noLogger=constant(ignoreEvent),menuFields=constant([strict$1("menu"),strict$1("selectedMenu")]),itemFields=constant([strict$1("item"),strict$1("selectedItem")]),itemSchema=(constant(objOf(itemFields().concat(menuFields()))),constant(objOf(itemFields()))),_initSize=strictObjOf("initSize",[strict$1("numColumns"),strict$1("numRows")]),itemMarkers=function(){return strictOf("markers",itemSchema())},tieredMenuMarkers=function(){return strictObjOf("markers",[strict$1("backgroundMenu")].concat(menuFields()).concat(itemFields()))},markers=function(required){return strictObjOf("markers",map(required,strict$1))},onPresenceHandler=function(label,fieldName,presence){getTrace();return field(fieldName,fieldName,presence,valueOf(function(f){return Result.value(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];return f.apply(void 0,args)})}))},onHandler=function(fieldName){return onPresenceHandler("onHandler",fieldName,defaulted(noop))},onKeyboardHandler=function(fieldName){return onPresenceHandler("onKeyboardHandler",fieldName,defaulted(Option.none))},onStrictHandler=function(fieldName){return onPresenceHandler("onHandler",fieldName,strict())},onStrictKeyboardHandler=function(fieldName){return onPresenceHandler("onKeyboardHandler",fieldName,strict())},output=function(name,value){return state$1(name,constant(value))},snapshot=function(name){return state$1(name,identity)},initSize=constant(_initSize),executeEvent=function(bConfig,bState,executor){return runOnExecute(function(component){executor(component,bConfig,bState)})},loadEvent=function(bConfig,bState,f){return runOnInit(function(component,simulatedEvent){f(component,bConfig,bState)})},create=function(schema,name,active,apis,extra,state){var configSchema=objOfOnly(schema),schemaSchema=optionObjOf(name,[optionObjOfOnly("config",schema)]);return doCreate(configSchema,schemaSchema,name,active,apis,extra,state)},createModes=function(modes,name,active,apis,extra,state){var configSchema=modes,schemaSchema=optionObjOf(name,[optionOf("config",modes)]);return doCreate(configSchema,schemaSchema,name,active,apis,extra,state)},wrapApi=function(bName,apiFunction,apiName){var f=function(component){for(var rest=[],_i=1;_i<arguments.length;_i++)rest[_i-1]=arguments[_i];var args=[component].concat(rest);return component.config({name:constant(bName)}).fold(function(){throw new Error("We could not find any behaviour configuration for: "+bName+". Using API: "+apiName)},function(info){var rest=Array.prototype.slice.call(args,1);return apiFunction.apply(void 0,[component,info.config,info.state].concat(rest))})};return markAsBehaviourApi(f,apiName,apiFunction)},revokeBehaviour=function(name){return{key:name,value:void 0}},doCreate=function(configSchema,schemaSchema,name,active,apis,extra,state){var getConfig=function(info){return hasKey$1(info,name)?info[name]():Option.none()},wrappedApis=map$1(apis,function(apiF,apiName){return wrapApi(name,apiF,apiName)}),wrappedExtra=map$1(extra,function(extraF,extraName){return markAsExtraApi(extraF,extraName)}),me=__assign({},wrappedExtra,wrappedApis,{revoke:curry(revokeBehaviour,name),config:function(spec){var prepared=asRawOrDie(name+"-config",configSchema,spec);return{key:name,value:{config:prepared,me:me,configAsRaw:cached(function(){return asRawOrDie(name+"-config",configSchema,spec)}),initialConfig:spec,state:state}}},schema:function(){return schemaSchema},exhibit:function(info,base){return getConfig(info).bind(function(behaviourInfo){return readOptFrom$1(active,"exhibit").map(function(exhibitor){return exhibitor(base,behaviourInfo.config,behaviourInfo.state)})}).getOr(nu$6({}))},name:function(){return name},handlers:function(info){return getConfig(info).map(function(behaviourInfo){var getEvents=readOr$1("events",function(a,b){return{}})(active);return getEvents(behaviourInfo.config,behaviourInfo.state)}).getOr({})}});return me},derive$1=function(capabilities){return wrapAll$1(capabilities)},simpleSchema=objOfOnly([strict$1("fields"),strict$1("name"),defaulted$1("active",{}),defaulted$1("apis",{}),defaulted$1("state",NoState),defaulted$1("extra",{})]),create$1=function(data){var value=asRawOrDie("Creating behaviour: "+data.name,simpleSchema,data);return create(value.fields,value.name,value.active,value.apis,value.extra,value.state)},modeSchema=objOfOnly([strict$1("branchKey"),strict$1("branches"),strict$1("name"),defaulted$1("active",{}),defaulted$1("apis",{}),defaulted$1("state",NoState),defaulted$1("extra",{})]),createModes$1=function(data){var value=asRawOrDie("Creating behaviour: "+data.name,modeSchema,data);return createModes(choose$1(value.branchKey,value.branches),value.name,value.active,value.apis,value.extra,value.state)},revoke=constant(void 0),chooseChannels=function(channels,message){return message.universal()?channels:filter(channels,function(ch){return contains(message.channels(),ch)})},events$1=function(receiveConfig){return derive([run(receive(),function(component,message){var channelMap=receiveConfig.channels,channels=keys(channelMap),targetChannels=chooseChannels(channels,message);each(targetChannels,function(ch){var channelInfo=channelMap[ch],channelSchema=channelInfo.schema,data=asRawOrDie("channel["+ch+"] data\nReceiver: "+element(component.element()),channelSchema,message.data());channelInfo.onReceive(component,data)})})])},ActiveReceiving=Object.freeze({events:events$1}),ReceivingSchema=[strictOf("channels",setOf$1(Result.value,objOfOnly([onStrictHandler("onReceive"),defaulted$1("schema",anyValue$1())])))],Receiving=create$1({fields:ReceivingSchema,name:"receiving",active:ActiveReceiving}),exhibit=function(base,posConfig){return nu$6({classes:[],styles:posConfig.useFixed?{}:{position:"relative"}})},ActivePosition=Object.freeze({exhibit:exhibit}),r=function(left,top){var translate=function(x,y){return r(left+x,top+y)};return{left:constant(left),top:constant(top),translate:translate}},Position=r,boxPosition=function(dom){var box=dom.getBoundingClientRect();return Position(box.left,box.top)},firstDefinedOrZero=function(a,b){return void 0!==a?a:void 0!==b?b:0},absolute=function(element){var doc=element.dom().ownerDocument,body=doc.body,win=doc.defaultView,html=doc.documentElement,scrollTop=firstDefinedOrZero(win.pageYOffset,html.scrollTop),scrollLeft=firstDefinedOrZero(win.pageXOffset,html.scrollLeft),clientTop=firstDefinedOrZero(html.clientTop,body.clientTop),clientLeft=firstDefinedOrZero(html.clientLeft,body.clientLeft);return viewport(element).translate(scrollLeft-clientLeft,scrollTop-clientTop)},viewport=function(element){var dom=element.dom(),doc=dom.ownerDocument,body=doc.body;return body===dom?Position(body.offsetLeft,body.offsetTop):inBody(element)?boxPosition(dom):Position(0,0)},api=Dimension("height",function(element){var dom=element.dom();return inBody(element)?dom.getBoundingClientRect().height:dom.offsetHeight}),get$6=function(element){return api.get(element)},getOuter$1=function(element){return api.getOuter(element)},setMax=function(element,value){var inclusions=["margin-top","border-top-width","padding-top","padding-bottom","border-bottom-width","margin-bottom"],absMax=api.max(element,value,inclusions);set$2(element,"max-height",absMax+"px")},api$1=Dimension("width",function(element){return element.dom().offsetWidth}),set$4=function(element,h){api$1.set(element,h)},get$7=function(element){return api$1.get(element)},getOuter$2=function(element){return api$1.getOuter(element)},get$8=(PlatformDetection$1.detect().browser.isSafari(),function(_DOC){var doc=void 0!==_DOC?_DOC.dom():domGlobals.document,x=doc.body.scrollLeft||doc.documentElement.scrollLeft,y=doc.body.scrollTop||doc.documentElement.scrollTop;return Position(x,y)}),walkUp=function(navigation,doc){var frame=navigation.view(doc);return frame.fold(constant([]),function(f){var parent=navigation.owner(f),rest=walkUp(navigation,parent);return[f].concat(rest)})},pathTo=function(element,navigation){var d=navigation.owner(element),paths=walkUp(navigation,d);return Option.some(paths)},view=function(doc){var element=doc.dom()===domGlobals.document?Option.none():Option.from(doc.dom().defaultView.frameElement);return element.map(Element.fromDom)},owner$1=function(element){return owner(element)},Navigation=Object.freeze({view:view,owner:owner$1}),find$4=function(element){var doc=Element.fromDom(domGlobals.document),scroll=get$8(doc),path=pathTo(element,Navigation);return path.fold(curry(absolute,element),function(frames){var offset=viewport(element),r=foldr(frames,function(b,a){var loc=viewport(a);return{left:b.left+loc.left(),top:b.top+loc.top()}},{left:0,top:0});return Position(r.left+offset.left()+scroll.left(),r.top+offset.top()+scroll.top())})},pointed=Immutable("point","width","height"),rect=Immutable("x","y","width","height"),bounds=function(x,y,width,height){return{x:constant(x),y:constant(y),width:constant(width),height:constant(height),right:constant(x+width),bottom:constant(y+height)}},box=function(element){var xy=absolute(element),w=getOuter$2(element),h=getOuter$1(element);return bounds(xy.left(),xy.top(),w,h)},win=function(){var width=domGlobals.window.innerWidth,height=domGlobals.window.innerHeight,doc=Element.fromDom(domGlobals.document),scroll=get$8(doc);return bounds(scroll.left(),scroll.top(),width,height)},allAlignments=["valignCentre","alignLeft","alignRight","alignCentre","top","bottom","left","right"],nu$7=function(width,yoffset,classes){var getClasses=function(prop){return readOptFrom$1(classes,prop).getOr([])},make=function(xDelta,yDelta,alignmentsOn){var alignmentsOff=difference(allAlignments,alignmentsOn);return{offset:function(){return Position(xDelta,yDelta)},classesOn:function(){return bind(alignmentsOn,getClasses)},classesOff:function(){return bind(alignmentsOff,getClasses)}}};return{southeast:function(){return make(-width,yoffset,["top","alignLeft"])},southwest:function(){return make(width,yoffset,["top","alignRight"])},south:function(){return make(-width/2,yoffset,["top","alignCentre"])},northeast:function(){return make(-width,-yoffset,["bottom","alignLeft"])},northwest:function(){return make(width,-yoffset,["bottom","alignRight"])},north:function(){return make(-width/2,-yoffset,["bottom","alignCentre"])},east:function(){return make(width,-yoffset/2,["valignCentre","left"])},west:function(){return make(-width,-yoffset/2,["valignCentre","right"])},innerNorthwest:function(){return make(-width,yoffset,["top","alignRight"])},innerNortheast:function(){return make(width,yoffset,["top","alignLeft"])},innerNorth:function(){return make(-width/2,yoffset,["top","alignCentre"])},innerSouthwest:function(){return make(-width,-yoffset,["bottom","alignRight"])},innerSoutheast:function(){return make(width,-yoffset,["bottom","alignLeft"])},innerSouth:function(){return make(-width/2,-yoffset,["bottom","alignCentre"])},innerWest:function(){return make(width,-yoffset/2,["valignCentre","right"])},innerEast:function(){return make(-width,-yoffset/2,["valignCentre","left"])}}},fallback=function(){return nu$7(0,0,{})},nu$8=Immutable("x","y","bubble","direction","label"),adt$2=Adt.generate([{southeast:[]},{southwest:[]},{northeast:[]},{northwest:[]},{south:[]},{north:[]},{east:[]},{west:[]}]),cata=function(subject,southeast,southwest,northeast,northwest,south,north,east,west){return subject.fold(southeast,southwest,northeast,northwest,south,north,east,west)},cataVertical=function(subject,south,middle,north){return subject.fold(south,south,north,north,south,north,middle,middle)},southeast=adt$2.southeast,southwest=adt$2.southwest,northeast=adt$2.northeast,northwest=adt$2.northwest,south=adt$2.south,north=adt$2.north,east=adt$2.east,west=adt$2.west,eastX=function(anchor){return anchor.x()},middleX=function(anchor,element){return anchor.x()+anchor.width()/2-element.width()/2},westX=function(anchor,element){return anchor.x()+anchor.width()-element.width()},northY=function(anchor,element){return anchor.y()-element.height()},southY=function(anchor){return anchor.y()+anchor.height()},centreY=function(anchor,element){return anchor.y()+anchor.height()/2-element.height()/2},eastEdgeX=function(anchor){return anchor.x()+anchor.width()},westEdgeX=function(anchor,element){return anchor.x()-element.width()},southeast$1=function(anchor,element,bubbles){return nu$8(eastX(anchor),southY(anchor),bubbles.southeast(),southeast(),"layout-se")},southwest$1=function(anchor,element,bubbles){return nu$8(westX(anchor,element),southY(anchor),bubbles.southwest(),southwest(),"layout-sw")},northeast$1=function(anchor,element,bubbles){return nu$8(eastX(anchor),northY(anchor,element),bubbles.northeast(),northeast(),"layout-ne")},northwest$1=function(anchor,element,bubbles){return nu$8(westX(anchor,element),northY(anchor,element),bubbles.northwest(),northwest(),"layout-nw")},north$1=function(anchor,element,bubbles){return nu$8(middleX(anchor,element),northY(anchor,element),bubbles.north(),north(),"layout-n")},south$1=function(anchor,element,bubbles){return nu$8(middleX(anchor,element),southY(anchor),bubbles.south(),south(),"layout-s")},east$1=function(anchor,element,bubbles){return nu$8(eastEdgeX(anchor),centreY(anchor,element),bubbles.east(),east(),"layout-e")},west$1=function(anchor,element,bubbles){return nu$8(westEdgeX(anchor,element),centreY(anchor,element),bubbles.west(),west(),"layout-w")},all$2=function(){return[southeast$1,southwest$1,northeast$1,northwest$1,south$1,north$1,east$1,west$1]},allRtl=function(){return[southwest$1,southeast$1,northwest$1,northeast$1,south$1,north$1,east$1,west$1]},decision=MixedBag(["x","y","width","height","maxHeight","direction","classes","label","candidateYforTest"],[]),css=Immutable("position","left","top","right","bottom"),adt$3=Adt.generate([{none:[]},{relative:["x","y","width","height"]},{fixed:["x","y","width","height"]}]),positionWithDirection=function(posName,decision,x,y,width,height){var decisionX=decision.x()-x,decisionY=decision.y()-y,decisionWidth=decision.width(),decisionHeight=decision.height(),decisionRight=width-(decisionX+decisionWidth),decisionBottom=height-(decisionY+decisionHeight),left=Option.some(decisionX),top=Option.some(decisionY),right=Option.some(decisionRight),bottom=Option.some(decisionBottom),none=Option.none();return cata(decision.direction(),function(){return css(posName,left,top,none,none)},function(){return css(posName,none,top,right,none)},function(){return css(posName,left,none,none,bottom)},function(){return css(posName,none,none,right,bottom)},function(){return css(posName,left,top,none,none)},function(){return css(posName,left,none,none,bottom)},function(){return css(posName,left,top,none,none)},function(){return css(posName,none,top,right,none)})},reposition=function(origin,decision){return origin.fold(function(){return css("absolute",Option.some(decision.x()),Option.some(decision.y()),Option.none(),Option.none())},function(x,y,width,height){return positionWithDirection("absolute",decision,x,y,width,height)},function(x,y,width,height){return positionWithDirection("fixed",decision,x,y,width,height)})},toBox=function(origin,element){var rel=curry(find$4,element),position=origin.fold(rel,rel,function(){var scroll=get$8();return find$4(element).translate(-scroll.left(),-scroll.top())}),width=getOuter$2(element),height=getOuter$1(element);return bounds(position.left(),position.top(),width,height)},viewport$1=function(origin,getBounds){return getBounds.fold(function(){return origin.fold(win,win,bounds)},function(b){return origin.fold(b,b,bounds)})},cata$1=function(subject,onNone,onRelative,onFixed){return subject.fold(onNone,onRelative,onFixed)},relative=adt$3.relative,fixed=adt$3.fixed,nu$9=function(x){return x},onDirection=function(isLtr,isRtl){return function(element){return"rtl"===getDirection(element)?isRtl:isLtr}},getDirection=function(element){return"rtl"===get$4(element,"direction")?"rtl":"ltr"},schema$1=function(){return optionObjOf("layouts",[strict$1("onLtr"),strict$1("onRtl")])},get$9=function(elem,info,defaultLtr,defaultRtl){var ltr=info.layouts.map(function(ls){return ls.onLtr(elem)}).getOr(defaultLtr),rtl=info.layouts.map(function(ls){return ls.onRtl(elem)}).getOr(defaultRtl),f=onDirection(ltr,rtl);return f(elem)},placement=function(component,anchorInfo,origin){var hotspot=anchorInfo.hotspot,anchorBox=toBox(origin,hotspot.element()),layouts=get$9(component.element(),anchorInfo,all$2(),allRtl());return Option.some(nu$9({anchorBox:anchorBox,bubble:anchorInfo.bubble.getOr(fallback()),overrides:anchorInfo.overrides,layouts:layouts,placer:Option.none()}))},HotspotAnchor=[strict$1("hotspot"),option("bubble"),defaulted$1("overrides",{}),schema$1(),output("placement",placement)],placement$1=function(component,anchorInfo,origin){var anchorBox=bounds(anchorInfo.x,anchorInfo.y,anchorInfo.width,anchorInfo.height),layouts=get$9(component.element(),anchorInfo,all$2(),allRtl());return Option.some(nu$9({anchorBox:anchorBox,bubble:anchorInfo.bubble,overrides:anchorInfo.overrides,layouts:layouts,placer:Option.none()}))},MakeshiftAnchor=[strict$1("x"),strict$1("y"),defaulted$1("height",0),defaulted$1("width",0),defaulted$1("bubble",fallback()),defaulted$1("overrides",{}),schema$1(),output("placement",placement$1)],zeroWidth=function(){return"\ufeff"},create$2=Immutable("start","soffset","finish","foffset"),SimRange={create:create$2},adt$4=Adt.generate([{before:["element"]},{on:["element","offset"]},{after:["element"]}]),cata$2=function(subject,onBefore,onOn,onAfter){return subject.fold(onBefore,onOn,onAfter)},getStart=function(situ){return situ.fold(identity,identity,identity)},before$2=adt$4.before,on=adt$4.on,after$1=adt$4.after,Situ={before:before$2,on:on,after:after$1,cata:cata$2,getStart:getStart},adt$5=Adt.generate([{domRange:["rng"]},{relative:["startSitu","finishSitu"]},{exact:["start","soffset","finish","foffset"]}]),exactFromRange=function(simRange){return adt$5.exact(simRange.start(),simRange.soffset(),simRange.finish(),simRange.foffset())},getStart$1=function(selection){return selection.match({domRange:function(rng){return Element.fromDom(rng.startContainer)},relative:function(startSitu,finishSitu){return Situ.getStart(startSitu)},exact:function(start,soffset,finish,foffset){return start}})},domRange=adt$5.domRange,relative$1=adt$5.relative,exact=adt$5.exact,getWin=function(selection){var start=getStart$1(selection);return defaultView(start)},range$1=SimRange.create,Selection={domRange:domRange,relative:relative$1,exact:exact,exactFromRange:exactFromRange,getWin:getWin,range:range$1},setStart=function(rng,situ){situ.fold(function(e){rng.setStartBefore(e.dom())},function(e,o){rng.setStart(e.dom(),o)},function(e){rng.setStartAfter(e.dom())})},setFinish=function(rng,situ){situ.fold(function(e){rng.setEndBefore(e.dom())},function(e,o){rng.setEnd(e.dom(),o)},function(e){rng.setEndAfter(e.dom())})},relativeToNative=function(win,startSitu,finishSitu){var range=win.document.createRange();return setStart(range,startSitu),setFinish(range,finishSitu),range},exactToNative=function(win,start,soffset,finish,foffset){var rng=win.document.createRange();return rng.setStart(start.dom(),soffset),rng.setEnd(finish.dom(),foffset),rng},toRect=function(rect){return{left:constant(rect.left),top:constant(rect.top),right:constant(rect.right),bottom:constant(rect.bottom),width:constant(rect.width),height:constant(rect.height)}},getFirstRect=function(rng){var rects=rng.getClientRects(),rect=rects.length>0?rects[0]:rng.getBoundingClientRect();return rect.width>0||rect.height>0?Option.some(rect).map(toRect):Option.none()},adt$6=Adt.generate([{ltr:["start","soffset","finish","foffset"]},{rtl:["start","soffset","finish","foffset"]}]),fromRange=function(win,type,range){return type(Element.fromDom(range.startContainer),range.startOffset,Element.fromDom(range.endContainer),range.endOffset)},getRanges=function(win,selection){return selection.match({domRange:function(rng){return{ltr:constant(rng),rtl:Option.none}},relative:function(startSitu,finishSitu){return{ltr:cached(function(){return relativeToNative(win,startSitu,finishSitu)}),rtl:cached(function(){return Option.some(relativeToNative(win,finishSitu,startSitu))})}},exact:function(start,soffset,finish,foffset){return{ltr:cached(function(){return exactToNative(win,start,soffset,finish,foffset)}),rtl:cached(function(){return Option.some(exactToNative(win,finish,foffset,start,soffset))})}}})},doDiagnose=function(win,ranges){var rng=ranges.ltr();if(rng.collapsed){var reversed=ranges.rtl().filter(function(rev){return!1===rev.collapsed});return reversed.map(function(rev){return adt$6.rtl(Element.fromDom(rev.endContainer),rev.endOffset,Element.fromDom(rev.startContainer),rev.startOffset)}).getOrThunk(function(){return fromRange(win,adt$6.ltr,rng)})}return fromRange(win,adt$6.ltr,rng)},diagnose=function(win,selection){var ranges=getRanges(win,selection);return doDiagnose(win,ranges)},asLtrRange=function(win,selection){var diagnosis=diagnose(win,selection);return diagnosis.match({ltr:function(start,soffset,finish,foffset){var rng=win.document.createRange();return rng.setStart(start.dom(),soffset),rng.setEnd(finish.dom(),foffset),rng},rtl:function(start,soffset,finish,foffset){var rng=win.document.createRange();return rng.setStart(finish.dom(),foffset),rng.setEnd(start.dom(),soffset),rng}})},searchForPoint=function(rectForOffset,x,y,maxX,length){if(0===length)return 0;if(x===maxX)return length-1;for(var xDelta=maxX,i=1;i<length;i++){var rect=rectForOffset(i),curDeltaX=Math.abs(x-rect.left);if(y<=rect.bottom){if(y<rect.top||curDeltaX>xDelta)return i-1;xDelta=curDeltaX}}return 0},inRect=function(rect,x,y){return x>=rect.left&&x<=rect.right&&y>=rect.top&&y<=rect.bottom},api$2=NodeValue(isText,"text"),get$a=function(element){return api$2.get(element)},getOption=function(element){return api$2.getOption(element)},locateOffset=function(doc,textnode,x,y,rect){var rangeForOffset=function(o){var r=doc.dom().createRange();return r.setStart(textnode.dom(),o),r.collapse(!0),r},rectForOffset=function(o){var r=rangeForOffset(o);return r.getBoundingClientRect()},length=get$a(textnode).length,offset=searchForPoint(rectForOffset,x,y,rect.right,length);return rangeForOffset(offset)},locate=function(doc,node,x,y){var r=doc.dom().createRange();r.selectNode(node.dom());var rects=r.getClientRects(),foundRect=findMap(rects,function(rect){return inRect(rect,x,y)?Option.some(rect):Option.none()});return foundRect.map(function(rect){return locateOffset(doc,node,x,y,rect)})},searchInChildren=function(doc,node,x,y){var r=doc.dom().createRange(),nodes=children(node);return findMap(nodes,function(n){return r.selectNode(n.dom()),inRect(r.getBoundingClientRect(),x,y)?locateNode(doc,n,x,y):Option.none()})},locateNode=function(doc,node,x,y){return isText(node)?locate(doc,node,x,y):searchInChildren(doc,node,x,y)},locate$1=function(doc,node,x,y){var r=doc.dom().createRange();r.selectNode(node.dom());var rect=r.getBoundingClientRect(),boundedX=Math.max(rect.left,Math.min(rect.right,x)),boundedY=Math.max(rect.top,Math.min(rect.bottom,y));return locateNode(doc,node,boundedX,boundedY)},getEnd=function(element){return"img"===name(element)?1:getOption(element).fold(function(){return children(element).length},function(v){return v.length})},NBSP=" ",isTextNodeWithCursorPosition=function(el){return getOption(el).filter(function(text){return 0!==text.trim().length||text.indexOf(NBSP)>-1}).isSome()},elementsWithCursorPosition=["img","br"],isCursorPosition=function(elem){var hasCursorPosition=isTextNodeWithCursorPosition(elem);return hasCursorPosition||contains(elementsWithCursorPosition,name(elem))},first=function(element){return descendant(element,isCursorPosition)},last$1=function(element){return descendantRtl(element,isCursorPosition)},descendantRtl=function(scope,predicate){var descend=function(element){for(var children$1=children(element),i=children$1.length-1;i>=0;i--){var child=children$1[i];if(predicate(child))return Option.some(child);var res=descend(child);if(res.isSome())return res}return Option.none()};return descend(scope)},COLLAPSE_TO_LEFT=!0,COLLAPSE_TO_RIGHT=!1,getCollapseDirection=function(rect,x){return x-rect.left<rect.right-x?COLLAPSE_TO_LEFT:COLLAPSE_TO_RIGHT},createCollapsedNode=function(doc,target,collapseDirection){var r=doc.dom().createRange();return r.selectNode(target.dom()),r.collapse(collapseDirection),r},locateInElement=function(doc,node,x){var cursorRange=doc.dom().createRange();cursorRange.selectNode(node.dom());var rect=cursorRange.getBoundingClientRect(),collapseDirection=getCollapseDirection(rect,x),f=collapseDirection===COLLAPSE_TO_LEFT?first:last$1;return f(node).map(function(target){return createCollapsedNode(doc,target,collapseDirection)})},locateInEmpty=function(doc,node,x){var rect=node.dom().getBoundingClientRect(),collapseDirection=getCollapseDirection(rect,x);return Option.some(createCollapsedNode(doc,node,collapseDirection))},search=function(doc,node,x){var f=0===children(node).length?locateInEmpty:locateInElement;return f(doc,node,x)},caretPositionFromPoint=function(doc,x,y){return Option.from(doc.dom().caretPositionFromPoint(x,y)).bind(function(pos){if(null===pos.offsetNode)return Option.none();var r=doc.dom().createRange();return r.setStart(pos.offsetNode,pos.offset),r.collapse(),Option.some(r)})},caretRangeFromPoint=function(doc,x,y){return Option.from(doc.dom().caretRangeFromPoint(x,y))},searchTextNodes=function(doc,node,x,y){var r=doc.dom().createRange();r.selectNode(node.dom());var rect=r.getBoundingClientRect(),boundedX=Math.max(rect.left,Math.min(rect.right,x)),boundedY=Math.max(rect.top,Math.min(rect.bottom,y));return locate$1(doc,node,boundedX,boundedY)},searchFromPoint=function(doc,x,y){return Element.fromPoint(doc,x,y).bind(function(elem){var fallback=function(){return search(doc,elem,x)};return 0===children(elem).length?fallback():searchTextNodes(doc,elem,x,y).orThunk(fallback)})},descendants=(document.caretPositionFromPoint||document.caretRangeFromPoint,function(scope,selector){return all(selector,scope)}),makeRange=function(start,soffset,finish,foffset){var doc=owner(start),rng=doc.dom().createRange();return rng.setStart(start.dom(),soffset),rng.setEnd(finish.dom(),foffset),rng},after$2=function(start,soffset,finish,foffset){var r=makeRange(start,soffset,finish,foffset),same=eq(start,finish)&&soffset===foffset;return r.collapsed&&!same},readRange=function(selection){if(selection.rangeCount>0){var firstRng=selection.getRangeAt(0),lastRng=selection.getRangeAt(selection.rangeCount-1);return Option.some(SimRange.create(Element.fromDom(firstRng.startContainer),firstRng.startOffset,Element.fromDom(lastRng.endContainer),lastRng.endOffset))}return Option.none()},doGetExact=function(selection){var anchor=Element.fromDom(selection.anchorNode),focus=Element.fromDom(selection.focusNode);return after$2(anchor,selection.anchorOffset,focus,selection.focusOffset)?Option.some(SimRange.create(anchor,selection.anchorOffset,focus,selection.focusOffset)):readRange(selection)},getExact=function(win){return Option.from(win.getSelection()).filter(function(sel){return sel.rangeCount>0}).bind(doGetExact)},getFirstRect$1=function(win,selection){var rng=asLtrRange(win,selection);return getFirstRect(rng)},point=Immutable("element","offset"),descendOnce=function(element,offset){var children$1=children(element);if(0===children$1.length)return point(element,offset);if(offset<children$1.length)return point(children$1[offset],0);var last=children$1[children$1.length-1],len=isText(last)?get$a(last).length:children(last).length;return point(last,len)},adt$7=Adt.generate([{screen:["point"]},{absolute:["point","scrollLeft","scrollTop"]}]),toFixed=function(pos){return pos.fold(function(point){return point},function(point,scrollLeft,scrollTop){return point.translate(-scrollLeft,-scrollTop)})},toAbsolute=function(pos){return pos.fold(function(point){return point},function(point,scrollLeft,scrollTop){return point})},sum=function(points){return foldl(points,function(b,a){return b.translate(a.left(),a.top())},Position(0,0))},sumAsFixed=function(positions){var points=map(positions,toFixed);return sum(points)},sumAsAbsolute=function(positions){var points=map(positions,toAbsolute);return sum(points)},screen=adt$7.screen,absolute$1=adt$7.absolute,getOffset=function(component,origin,anchorInfo){var win=defaultView(anchorInfo.root).dom(),hasSameOwner=function(frame){var frameOwner=owner(frame),compOwner=owner(component.element());return eq(frameOwner,compOwner)};return Option.from(win.frameElement).map(Element.fromDom).filter(hasSameOwner).map(absolute)},getRootPoint=function(component,origin,anchorInfo){var doc=owner(component.element()),outerScroll=get$8(doc),offset=getOffset(component,origin,anchorInfo).getOr(outerScroll);return absolute$1(offset,outerScroll.left(),outerScroll.top())},capRect=function(left,top,width,height){var newLeft=left,newTop=top,newWidth=width,newHeight=height;left<0&&(newLeft=0,newWidth=width+left),top<0&&(newTop=0,newHeight=height+top);var point=screen(Position(newLeft,newTop));return Option.some(pointed(point,newWidth,newHeight))},calcNewAnchor=function(optBox,rootPoint,anchorInfo,origin,elem){return optBox.map(function(box){var points=[rootPoint,box.point()],topLeft=cata$1(origin,function(){return sumAsAbsolute(points)},function(){return sumAsAbsolute(points)},function(){return sumAsFixed(points)}),anchorBox=rect(topLeft.left(),topLeft.top(),box.width(),box.height()),layoutsLtr=function(){return anchorInfo.showAbove?[northeast$1,northwest$1,southeast$1,southwest$1,north$1,south$1]:[southeast$1,southwest$1,northeast$1,northwest$1,south$1,south$1]},layoutsRtl=function(){return anchorInfo.showAbove?[northwest$1,northeast$1,southwest$1,southeast$1,north$1,south$1]:[southwest$1,southeast$1,northwest$1,northeast$1,south$1,north$1]},layouts=get$9(elem,anchorInfo,layoutsLtr(),layoutsRtl());return nu$9({anchorBox:anchorBox,bubble:anchorInfo.bubble.getOr(fallback()),overrides:anchorInfo.overrides,layouts:layouts,placer:Option.none()})})},ContentAnchorCommon={capRect:capRect,calcNewAnchor:calcNewAnchor},point$1=Immutable("element","offset"),descendOnce$1=function(element,offset){return isText(element)?point$1(element,offset):descendOnce(element,offset)},getAnchorSelection=function(win,anchorInfo){var getSelection=anchorInfo.getSelection.getOrThunk(function(){return function(){return getExact(win)}});return getSelection().map(function(sel){var modStart=descendOnce$1(sel.start(),sel.soffset()),modFinish=descendOnce$1(sel.finish(),sel.foffset());return Selection.range(modStart.element(),modStart.offset(),modFinish.element(),modFinish.offset())})},placement$2=function(component,anchorInfo,origin){var win=defaultView(anchorInfo.root).dom(),rootPoint=getRootPoint(component,origin,anchorInfo),selectionBox=getAnchorSelection(win,anchorInfo).bind(function(sel){var optRect=getFirstRect$1(win,Selection.exactFromRange(sel)).orThunk(function(){var x=Element.fromText(zeroWidth());return before(sel.start(),x),getFirstRect$1(win,Selection.exact(x,0,x,1)).map(function(rect){
return remove(x),rect})});return optRect.bind(function(rawRect){return ContentAnchorCommon.capRect(rawRect.left(),rawRect.top(),rawRect.width(),rawRect.height())})}),targetElement=getAnchorSelection(win,anchorInfo).bind(function(sel){return isElement(sel.start())?Option.some(sel.start()):parent(sel.start())}),elem=targetElement.getOr(component.element());return ContentAnchorCommon.calcNewAnchor(selectionBox,rootPoint,anchorInfo,origin,elem)},SelectionAnchor=[option("getSelection"),strict$1("root"),option("bubble"),schema$1(),defaulted$1("overrides",{}),defaulted$1("showAbove",!1),output("placement",placement$2)],placement$3=function(component,anchorInfo,origin){var rootPoint=getRootPoint(component,origin,anchorInfo);return anchorInfo.node.bind(function(target){var rect=target.dom().getBoundingClientRect(),nodeBox=ContentAnchorCommon.capRect(rect.left,rect.top,rect.width,rect.height),elem=anchorInfo.node.getOr(component.element());return ContentAnchorCommon.calcNewAnchor(nodeBox,rootPoint,anchorInfo,origin,elem)})},NodeAnchor=[strict$1("node"),strict$1("root"),option("bubble"),schema$1(),defaulted$1("overrides",{}),defaulted$1("showAbove",!1),output("placement",placement$3)],eastX$1=function(anchor){return anchor.x()+anchor.width()},westX$1=function(anchor,element){return anchor.x()-element.width()},northY$1=function(anchor,element){return anchor.y()-element.height()+anchor.height()},southY$1=function(anchor){return anchor.y()},southeast$2=function(anchor,element,bubbles){return nu$8(eastX$1(anchor),southY$1(anchor),bubbles.southeast(),southeast(),"link-layout-se")},southwest$2=function(anchor,element,bubbles){return nu$8(westX$1(anchor,element),southY$1(anchor),bubbles.southwest(),southwest(),"link-layout-sw")},northeast$2=function(anchor,element,bubbles){return nu$8(eastX$1(anchor),northY$1(anchor,element),bubbles.northeast(),northeast(),"link-layout-ne")},northwest$2=function(anchor,element,bubbles){return nu$8(westX$1(anchor,element),northY$1(anchor,element),bubbles.northwest(),northwest(),"link-layout-nw")},all$3=function(){return[southeast$2,southwest$2,northeast$2,northwest$2]},allRtl$1=function(){return[southwest$2,southeast$2,northwest$2,northeast$2]},placement$4=function(component,submenuInfo,origin){var anchorBox=toBox(origin,submenuInfo.item.element()),layouts=get$9(component.element(),submenuInfo,all$3(),allRtl$1());return Option.some(nu$9({anchorBox:anchorBox,bubble:fallback(),overrides:submenuInfo.overrides,layouts:layouts,placer:Option.none()}))},SubmenuAnchor=[strict$1("item"),schema$1(),defaulted$1("overrides",{}),output("placement",placement$4)],AnchorSchema=choose$1("anchor",{selection:SelectionAnchor,node:NodeAnchor,hotspot:HotspotAnchor,submenu:SubmenuAnchor,makeshift:MakeshiftAnchor}),anchor=Immutable("anchorBox","origin"),box$1=function(anchorBox,origin){return anchor(anchorBox,origin)},adt$8=Adt.generate([{fit:["reposition"]},{nofit:["reposition","deltaW","deltaH"]}]),attempt=function(candidate,width,height,bounds){var candidateX=candidate.x(),candidateY=candidate.y(),bubbleLeft=candidate.bubble().offset().left(),bubbleTop=candidate.bubble().offset().top(),boundsX=bounds.x(),boundsY=bounds.y(),boundsWidth=bounds.width(),boundsHeight=bounds.height(),newX=candidateX+bubbleLeft,newY=candidateY+bubbleTop,xInBounds=newX>=boundsX,yInBounds=newY>=boundsY,originInBounds=xInBounds&&yInBounds,xFit=newX+width<=boundsX+boundsWidth,yFit=newY+height<=boundsY+boundsHeight,sizeInBounds=xFit&&yFit,deltaW=xInBounds?Math.min(width,boundsX+boundsWidth-newX):Math.abs(boundsX-(newX+width)),deltaH=yInBounds?Math.min(height,boundsY+boundsHeight-newY):Math.abs(boundsY-(newY+height)),maxX=bounds.x()+bounds.width(),minX=Math.max(bounds.x(),newX),limitX=Math.min(minX,maxX),limitY=yInBounds?newY:newY+(height-deltaH),upAvailable=constant(limitY+deltaH-boundsY),downAvailable=constant(boundsY+boundsHeight-limitY),maxHeight=cataVertical(candidate.direction(),downAvailable,downAvailable,upAvailable),reposition=decision({x:limitX,y:limitY,width:deltaW,height:deltaH,maxHeight:maxHeight,direction:candidate.direction(),classes:{on:candidate.bubble().classesOn(),off:candidate.bubble().classesOff()},label:candidate.label(),candidateYforTest:newY});return originInBounds&&sizeInBounds?adt$8.fit(reposition):adt$8.nofit(reposition,deltaW,deltaH)},attempts=function(candidates,anchorBox,elementBox,bubbles,bounds){var panelWidth=elementBox.width(),panelHeight=elementBox.height(),attemptBestFit=function(layout,reposition,deltaW,deltaH){var next=layout(anchorBox,elementBox,bubbles),attemptLayout=attempt(next,panelWidth,panelHeight,bounds);return attemptLayout.fold(adt$8.fit,function(newReposition,newDeltaW,newDeltaH){var improved=newDeltaH>deltaH||newDeltaW>deltaW;return improved?adt$8.nofit(newReposition,newDeltaW,newDeltaH):adt$8.nofit(reposition,deltaW,deltaH)})},abc=foldl(candidates,function(b,a){var bestNext=curry(attemptBestFit,a);return b.fold(adt$8.fit,bestNext)},adt$8.nofit(decision({x:anchorBox.x(),y:anchorBox.y(),width:elementBox.width(),height:elementBox.height(),maxHeight:elementBox.height(),direction:southeast(),classes:[],label:"none",candidateYforTest:anchorBox.y()}),-1,-1));return abc.fold(identity,identity)},elementSize=function(p){return{width:constant(getOuter$2(p)),height:constant(getOuter$1(p))}},layout=function(anchorBox,element,bubbles,options){remove$6(element,"max-height");var elementBox=elementSize(element);return attempts(options.preference(),anchorBox,elementBox,bubbles,options.bounds())},setClasses=function(element,decision){var classInfo=decision.classes();remove$5(element,classInfo.off),add$3(element,classInfo.on)},setHeight=function(element,decision,options){var maxHeightFunction=options.maxHeightFunction();maxHeightFunction(element,decision.maxHeight())},position=function(element,decision,options){var addPx=function(num){return num+"px"},newPosition=reposition(options.origin(),decision);setOptions(element,{position:Option.some(newPosition.position()),left:newPosition.left().map(addPx),top:newPosition.top().map(addPx),right:newPosition.right().map(addPx),bottom:newPosition.bottom().map(addPx)})},setMaxHeight=function(element,maxHeight){setMax(element,Math.floor(maxHeight))},anchored=constant(function(element,available){setMaxHeight(element,available),setAll$1(element,{"overflow-x":"hidden","overflow-y":"auto"})}),expandable=constant(function(element,available){setMaxHeight(element,available)}),reparteeOptions=MixedBag(["bounds","origin","preference","maxHeightFunction"],[]),defaultOr=function(options,key,dephault){return void 0===options[key]?dephault:options[key]},simple=function(anchor,element,bubble,layouts,getBounds,overrideOptions){var maxHeightFunction=defaultOr(overrideOptions,"maxHeightFunction",anchored()),anchorBox=anchor.anchorBox(),origin=anchor.origin(),options=reparteeOptions({bounds:viewport$1(origin,getBounds),origin:origin,preference:layouts,maxHeightFunction:maxHeightFunction});go(anchorBox,element,bubble,options)},go=function(anchorBox,element,bubble,options){var decision=layout(anchorBox,element,bubble,options);position(element,decision,options),setClasses(element,decision),setHeight(element,decision,options)},getFixedOrigin=function(){return fixed(0,0,domGlobals.window.innerWidth,domGlobals.window.innerHeight)},getRelativeOrigin=function(component){var position=absolute(component.element()),bounds=component.element().dom().getBoundingClientRect();return relative(position.left(),position.top(),bounds.width,bounds.height)},place=function(component,origin,anchoring,getBounds,placee){var anchor=box$1(anchoring.anchorBox,origin);simple(anchor,placee.element(),anchoring.bubble,anchoring.layouts,getBounds,anchoring.overrides)},position$1=function(component,posConfig,posState,anchor,placee){var boxElement=Option.none();positionWithin(component,posConfig,posState,anchor,placee,boxElement)},positionWithin=function(component,posConfig,posState,anchor,placee,boxElement){var boundsBox=boxElement.map(box);return positionWithinBounds(component,posConfig,posState,anchor,placee,boundsBox)},positionWithinBounds=function(component,posConfig,posState,anchor,placee,bounds){var anchorage=asRawOrDie("positioning anchor.info",AnchorSchema,anchor);set$2(placee.element(),"position","fixed");var oldVisibility=getRaw(placee.element(),"visibility");set$2(placee.element(),"visibility","hidden");var origin=posConfig.useFixed?getFixedOrigin():getRelativeOrigin(component),placer=anchorage.placement,getBounds=bounds.map(constant).or(posConfig.getBounds);placer(component,anchorage,origin).each(function(anchoring){var doPlace=anchoring.placer.getOr(place);doPlace(component,origin,anchoring,getBounds,placee)}),oldVisibility.fold(function(){remove$6(placee.element(),"visibility")},function(vis){set$2(placee.element(),"visibility",vis)}),getRaw(placee.element(),"left").isNone()&&getRaw(placee.element(),"top").isNone()&&getRaw(placee.element(),"right").isNone()&&getRaw(placee.element(),"bottom").isNone()&&getRaw(placee.element(),"position").is("fixed")&&remove$6(placee.element(),"position")},getMode=function(component,pConfig,pState){return pConfig.useFixed?"fixed":"absolute"},PositionApis=Object.freeze({position:position$1,positionWithin:positionWithin,positionWithinBounds:positionWithinBounds,getMode:getMode}),PositionSchema=[defaulted$1("useFixed",!1),option("getBounds")],Positioning=create$1({fields:PositionSchema,name:"positioning",active:ActivePosition,apis:PositionApis}),fireDetaching=function(component){emit(component,detachedFromDom());var children=component.components();each(children,fireDetaching)},fireAttaching=function(component){var children=component.components();each(children,fireAttaching),emit(component,attachedToDom())},attach=function(parent,child){attachWith(parent,child,append)},attachWith=function(parent,child,insertion){parent.getSystem().addToWorld(child),insertion(parent.element(),child.element()),inBody(parent.element())&&fireAttaching(child),parent.syncComponents()},doDetach=function(component){fireDetaching(component),remove(component.element()),component.getSystem().removeFromWorld(component)},detach=function(component){var parent$1=parent(component.element()).bind(function(p){return component.getSystem().getByDom(p).fold(Option.none,Option.some)});doDetach(component),parent$1.each(function(p){p.syncComponents()})},detachChildren=function(component){var subs=component.components();each(subs,doDetach),empty(component.element()),component.syncComponents()},attachSystem=function(element,guiSystem){attachSystemInternal(element,guiSystem,append)},attachSystemAfter=function(element,guiSystem){attachSystemInternal(element,guiSystem,after)},attachSystemInternal=function(element,guiSystem,inserter){inserter(element,guiSystem.element());var children$1=children(guiSystem.element());each(children$1,function(child){guiSystem.getByDom(child).each(fireAttaching)})},detachSystem=function(guiSystem){var children$1=children(guiSystem.element());each(children$1,function(child){guiSystem.getByDom(child).each(fireDetaching)}),remove(guiSystem.element())},rebuild=function(sandbox,sConfig,sState,data){sState.get().each(function(data){detachChildren(sandbox)});var point=sConfig.getAttachPoint(sandbox);attach(point,sandbox);var built=sandbox.getSystem().build(data);return attach(sandbox,built),sState.set(built),built},open=function(sandbox,sConfig,sState,data){var newState=rebuild(sandbox,sConfig,sState,data);return sConfig.onOpen(sandbox,newState),newState},openWhileCloaked=function(sandbox,sConfig,sState,data,transaction){cloak(sandbox,sConfig),open(sandbox,sConfig,sState,data),transaction(),decloak(sandbox,sConfig)},close=function(sandbox,sConfig,sState){sState.get().each(function(data){detachChildren(sandbox),detach(sandbox),sConfig.onClose(sandbox,data),sState.clear()})},isOpen=function(sandbox,sConfig,sState){return sState.isOpen()},isPartOf$1=function(sandbox,sConfig,sState,queryElem){return isOpen(sandbox,sConfig,sState)&&sState.get().exists(function(data){return sConfig.isPartOf(sandbox,data,queryElem)})},getState=function(sandbox,sConfig,sState){return sState.get()},store=function(sandbox,cssKey,attr,newValue){getRaw(sandbox.element(),cssKey).fold(function(){remove$1(sandbox.element(),attr)},function(v){set$1(sandbox.element(),attr,v)}),set$2(sandbox.element(),cssKey,newValue)},restore=function(sandbox,cssKey,attr){if(has$1(sandbox.element(),attr)){var oldValue=get$2(sandbox.element(),attr);set$2(sandbox.element(),cssKey,oldValue)}else remove$6(sandbox.element(),cssKey)},cloak=function(sandbox,sConfig,sState){var sink=sConfig.getAttachPoint(sandbox);set$2(sandbox.element(),"position",Positioning.getMode(sink)),store(sandbox,"visibility",sConfig.cloakVisibilityAttr,"hidden")},hasPosition=function(element){return exists(["top","left","right","bottom"],function(pos){return getRaw(element,pos).isSome()})},decloak=function(sandbox,sConfig,sState){hasPosition(sandbox.element())||remove$6(sandbox.element(),"position"),restore(sandbox,"visibility",sConfig.cloakVisibilityAttr)},SandboxApis=Object.freeze({cloak:cloak,decloak:decloak,open:open,openWhileCloaked:openWhileCloaked,close:close,isOpen:isOpen,isPartOf:isPartOf$1,getState:getState}),events$2=function(sandboxConfig,sandboxState){return derive([run(sandboxClose(),function(sandbox,simulatedEvent){close(sandbox,sandboxConfig,sandboxState)})])},ActiveSandbox=Object.freeze({events:events$2}),SandboxSchema=[onHandler("onOpen"),onHandler("onClose"),strict$1("isPartOf"),strict$1("getAttachPoint"),defaulted$1("cloakVisibilityAttr","data-precloak-visibility")],init=function(){var contents=Cell(Option.none()),readState=constant("not-implemented"),isOpen=function(){return contents.get().isSome()},set=function(c){contents.set(Option.some(c))},get=function(c){return contents.get()},clear=function(){contents.set(Option.none())};return nu$5({readState:readState,isOpen:isOpen,clear:clear,set:set,get:get})},SandboxState=Object.freeze({init:init}),Sandboxing=create$1({fields:SandboxSchema,name:"sandboxing",active:ActiveSandbox,apis:SandboxApis,state:SandboxState}),dismissPopups=constant("dismiss.popups"),mouseReleased=constant("mouse.released"),schema$2=objOfOnly([defaulted$1("isExtraPart",constant(!1)),optionObjOf("fireEventInstead",[defaulted$1("event",dismissRequested())])]),receivingConfig=function(rawSpec){var c=receiving(rawSpec);return Receiving.config(c)},receiving=function(rawSpec){var spec=asRawOrDie("Dismissal",schema$2,rawSpec);return{channels:wrap$1(dismissPopups(),{schema:objOfOnly([strict$1("target")]),onReceive:function(sandbox,data){if(Sandboxing.isOpen(sandbox)){var isPart=Sandboxing.isPartOf(sandbox,data.target)||spec.isExtraPart(sandbox,data.target);isPart||spec.fireEventInstead.fold(function(){return Sandboxing.close(sandbox)},function(fe){return emit(sandbox,fe.event)})}}})}},field$1=function(name,forbidden){return defaultedObjOf(name,{},map(forbidden,function(f){return forbid(f.name(),"Cannot configure "+f.name()+" for "+name)}).concat([state$1("dump",identity)]))},get$b=function(data){return data.dump},augment=function(data,original){return __assign({},data.dump,derive$1(original))},SketchBehaviours={field:field$1,augment:augment,get:get$b},_placeholder="placeholder",adt$9=Adt.generate([{single:["required","valueThunk"]},{multiple:["required","valueThunks"]}]),subPlaceholder=function(owner,detail,compSpec,placeholders){return owner.exists(function(o){return o!==compSpec.owner})?adt$9.single(!0,constant(compSpec)):readOptFrom$1(placeholders,compSpec.name).fold(function(){throw new Error("Unknown placeholder component: "+compSpec.name+"\nKnown: ["+keys(placeholders)+"]\nNamespace: "+owner.getOr("none")+"\nSpec: "+JSON.stringify(compSpec,null,2))},function(newSpec){return newSpec.replace()})},scan=function(owner,detail,compSpec,placeholders){return compSpec.uiType===_placeholder?subPlaceholder(owner,detail,compSpec,placeholders):adt$9.single(!1,constant(compSpec))},substitute=function(owner,detail,compSpec,placeholders){var base=scan(owner,detail,compSpec,placeholders);return base.fold(function(req,valueThunk){var value=valueThunk(detail,compSpec.config,compSpec.validated),childSpecs=readOptFrom$1(value,"components").getOr([]),substituted=bind(childSpecs,function(c){return substitute(owner,detail,c,placeholders)});return[__assign({},value,{components:substituted})]},function(req,valuesThunk){var values=valuesThunk(detail,compSpec.config,compSpec.validated),preprocessor=compSpec.validated.preprocess.getOr(identity);return preprocessor(values)})},substituteAll=function(owner,detail,components,placeholders){return bind(components,function(c){return substitute(owner,detail,c,placeholders)})},oneReplace=function(label,replacements){var called=!1,used=function(){return called},replace=function(){if(!0===called)throw new Error("Trying to use the same placeholder more than once: "+label);return called=!0,replacements},required=function(){return replacements.fold(function(req,_){return req},function(req,_){return req})};return{name:constant(label),required:required,used:used,replace:replace}},substitutePlaces=function(owner,detail,components,placeholders){var ps=map$1(placeholders,function(ph,name){return oneReplace(name,ph)}),outcome=substituteAll(owner,detail,components,ps);return each$1(ps,function(p){if(!1===p.used()&&p.required())throw new Error("Placeholder: "+p.name()+" was not found in components list\nNamespace: "+owner.getOr("none")+"\nComponents: "+JSON.stringify(detail.components,null,2))}),outcome},single=adt$9.single,multiple=adt$9.multiple,placeholder=constant(_placeholder),adt$a=Adt.generate([{required:["data"]},{external:["data"]},{optional:["data"]},{group:["data"]}]),fFactory=defaulted$1("factory",{sketch:identity}),fSchema=defaulted$1("schema",[]),fName=strict$1("name"),fPname=field("pname","pname",defaultedThunk(function(typeSpec){return"<alloy."+generate$1(typeSpec.name)+">"}),anyValue$1()),fGroupSchema=state$1("schema",function(){return[option("preprocess")]}),fDefaults=defaulted$1("defaults",constant({})),fOverrides=defaulted$1("overrides",constant({})),requiredSpec=objOf([fFactory,fSchema,fName,fPname,fDefaults,fOverrides]),externalSpec=objOf([fFactory,fSchema,fName,fDefaults,fOverrides]),optionalSpec=objOf([fFactory,fSchema,fName,fPname,fDefaults,fOverrides]),groupSpec=objOf([fFactory,fGroupSchema,fName,strict$1("unit"),fPname,fDefaults,fOverrides]),asNamedPart=function(part){return part.fold(Option.some,Option.none,Option.some,Option.some)},name$1=function(part){var get=function(data){return data.name};return part.fold(get,get,get,get)},asCommon=function(part){return part.fold(identity,identity,identity,identity)},convert=function(adtConstructor,partSchema){return function(spec){var data=asRawOrDie("Converting part type",partSchema,spec);return adtConstructor(data)}},required=convert(adt$a.required,requiredSpec),external$1=convert(adt$a.external,externalSpec),optional=convert(adt$a.optional,optionalSpec),group=convert(adt$a.group,groupSpec),original=constant("entirety"),PartType=Object.freeze({required:required,external:external$1,optional:optional,group:group,asNamedPart:asNamedPart,name:name$1,asCommon:asCommon,original:original}),combine$2=function(detail,data,partSpec,partValidated){return deepMerge(data.defaults(detail,partSpec,partValidated),partSpec,{uid:detail.partUids[data.name]},data.overrides(detail,partSpec,partValidated))},subs=function(owner,detail,parts){var internals={},externals={};return each(parts,function(part){part.fold(function(data){internals[data.pname]=single(!0,function(detail,partSpec,partValidated){return data.factory.sketch(combine$2(detail,data,partSpec,partValidated))})},function(data){var partSpec=detail.parts[data.name];externals[data.name]=constant(data.factory.sketch(combine$2(detail,data,partSpec[original()]),partSpec))},function(data){internals[data.pname]=single(!1,function(detail,partSpec,partValidated){return data.factory.sketch(combine$2(detail,data,partSpec,partValidated))})},function(data){internals[data.pname]=multiple(!0,function(detail,_partSpec,_partValidated){var units=detail[data.name];return map(units,function(u){return data.factory.sketch(deepMerge(data.defaults(detail,u,_partValidated),u,data.overrides(detail,u)))})})})}),{internals:constant(internals),externals:constant(externals)}},generate$4=function(owner,parts){var r={};return each(parts,function(part){asNamedPart(part).each(function(np){var g=doGenerateOne(owner,np.pname);r[np.name]=function(config){var validated=asRawOrDie("Part: "+np.name+" in "+owner,objOf(np.schema),config);return __assign({},g,{config:config,validated:validated})}})}),r},doGenerateOne=function(owner,pname){return{uiType:placeholder(),owner:owner,name:pname}},generateOne=function(owner,pname,config){return{uiType:placeholder(),owner:owner,name:pname,config:config,validated:{}}},schemas=function(parts){return bind(parts,function(part){return part.fold(Option.none,Option.some,Option.none,Option.none).map(function(data){return strictObjOf(data.name,data.schema.concat([snapshot(original())]))}).toArray()})},names=function(parts){return map(parts,name$1)},substitutes=function(owner,detail,parts){return subs(owner,detail,parts)},components=function(owner,detail,internals){return substitutePlaces(Option.some(owner),detail,detail.components,internals)},getPart=function(component,detail,partKey){var uid=detail.partUids[partKey];return component.getSystem().getByUid(uid).toOption()},getPartOrDie=function(component,detail,partKey){return getPart(component,detail,partKey).getOrDie("Could not find part: "+partKey)},getParts=function(component,detail,partKeys){var r={},uids=detail.partUids,system=component.getSystem();return each(partKeys,function(pk){r[pk]=constant(system.getByUid(uids[pk]))}),r},getAllParts=function(component,detail){var system=component.getSystem();return map$1(detail.partUids,function(pUid,k){return constant(system.getByUid(pUid))})},getAllPartNames=function(detail){return keys(detail.partUids)},getPartsOrDie=function(component,detail,partKeys){var r={},uids=detail.partUids,system=component.getSystem();return each(partKeys,function(pk){r[pk]=constant(system.getByUid(uids[pk]).getOrDie())}),r},defaultUids=function(baseUid,partTypes){var partNames=names(partTypes);return wrapAll$1(map(partNames,function(pn){return{key:pn,value:baseUid+"-"+pn}}))},defaultUidsSchema=function(partTypes){return field("partUids","partUids",mergeWithThunk(function(spec){return defaultUids(spec.uid,partTypes)}),anyValue$1())},AlloyParts=Object.freeze({generate:generate$4,generateOne:generateOne,schemas:schemas,names:names,substitutes:substitutes,components:components,defaultUids:defaultUids,defaultUidsSchema:defaultUidsSchema,getAllParts:getAllParts,getAllPartNames:getAllPartNames,getPart:getPart,getPartOrDie:getPartOrDie,getParts:getParts,getPartsOrDie:getPartsOrDie}),base=function(partSchemas,partUidsSchemas){var ps=partSchemas.length>0?[strictObjOf("parts",partSchemas)]:[];return ps.concat([strict$1("uid"),defaulted$1("dom",{}),defaulted$1("components",[]),snapshot("originalSpec"),defaulted$1("debug.sketcher",{})]).concat(partUidsSchemas)},asRawOrDie$1=function(label,schema,spec,partSchemas,partUidsSchemas){var baseS=base(partSchemas,partUidsSchemas);return asRawOrDie(label+" [SpecSchema]",objOfOnly(baseS.concat(schema)),spec)},single$1=function(owner,schema,factory,spec){var specWithUid=supplyUid(spec),detail=asRawOrDie$1(owner,schema,specWithUid,[],[]);return factory(detail,specWithUid)},composite=function(owner,schema,partTypes,factory,spec){var specWithUid=supplyUid(spec),partSchemas=schemas(partTypes),partUidsSchema=defaultUidsSchema(partTypes),detail=asRawOrDie$1(owner,schema,specWithUid,partSchemas,[partUidsSchema]),subs=substitutes(owner,detail,partTypes),components$1=components(owner,detail,subs.internals());return factory(detail,components$1,specWithUid,subs.externals())},supplyUid=function(spec){return spec.hasOwnProperty("uid")?spec:__assign({},spec,{uid:generate$2("uid")})},singleSchema=objOfOnly([strict$1("name"),strict$1("factory"),strict$1("configFields"),defaulted$1("apis",{}),defaulted$1("extraApis",{})]),compositeSchema=objOfOnly([strict$1("name"),strict$1("factory"),strict$1("configFields"),strict$1("partFields"),defaulted$1("apis",{}),defaulted$1("extraApis",{})]),single$2=function(rawConfig){var config=asRawOrDie("Sketcher for "+rawConfig.name,singleSchema,rawConfig),sketch=function(spec){return single$1(config.name,config.configFields,config.factory,spec)},apis=map$1(config.apis,makeApi),extraApis=map$1(config.extraApis,function(f,k){return markAsExtraApi(f,k)});return __assign({name:constant(config.name),partFields:constant([]),configFields:constant(config.configFields),sketch:sketch},apis,extraApis)},composite$1=function(rawConfig){var config=asRawOrDie("Sketcher for "+rawConfig.name,compositeSchema,rawConfig),sketch=function(spec){return composite(config.name,config.configFields,config.partFields,config.factory,spec)},parts=generate$4(config.name,config.partFields),apis=map$1(config.apis,makeApi),extraApis=map$1(config.extraApis,function(f,k){return markAsExtraApi(f,k)});return __assign({name:constant(config.name),partFields:constant(config.partFields),configFields:constant(config.configFields),sketch:sketch,parts:constant(parts)},apis,extraApis)},inside=function(target){return"input"===name(target)&&"radio"!==get$2(target,"type")||"textarea"===name(target)},getCurrent=function(component,composeConfig,composeState){return composeConfig.find(component)},ComposeApis=Object.freeze({getCurrent:getCurrent}),ComposeSchema=[strict$1("find")],Composing=create$1({fields:ComposeSchema,name:"composing",apis:ComposeApis}),cycleBy=function(value,delta,min,max){var r=value+delta;return r>max?min:r<min?max:r},cap=function(value,min,max){return value<=min?min:value>=max?max:value},dehighlightAllExcept=function(component,hConfig,hState,skip){var highlighted=descendants(component.element(),"."+hConfig.highlightClass);each(highlighted,function(h){exists(skip,function(skipComp){return skipComp.element()===h})||(remove$4(h,hConfig.highlightClass),component.getSystem().getByDom(h).each(function(target){hConfig.onDehighlight(component,target),emit(target,dehighlight())}))})},dehighlightAll=function(component,hConfig,hState){return dehighlightAllExcept(component,hConfig,hState,[])},dehighlight$1=function(component,hConfig,hState,target){isHighlighted(component,hConfig,hState,target)&&(remove$4(target.element(),hConfig.highlightClass),hConfig.onDehighlight(component,target),emit(target,dehighlight()))},highlight$1=function(component,hConfig,hState,target){dehighlightAllExcept(component,hConfig,hState,[target]),isHighlighted(component,hConfig,hState,target)||(add$2(target.element(),hConfig.highlightClass),hConfig.onHighlight(component,target),emit(target,highlight()))},highlightFirst=function(component,hConfig,hState){getFirst(component,hConfig).each(function(firstComp){highlight$1(component,hConfig,hState,firstComp)})},highlightLast=function(component,hConfig,hState){getLast(component,hConfig).each(function(lastComp){highlight$1(component,hConfig,hState,lastComp)})},highlightAt=function(component,hConfig,hState,index){getByIndex(component,hConfig,hState,index).fold(function(err){throw new Error(err)},function(firstComp){highlight$1(component,hConfig,hState,firstComp)})},highlightBy=function(component,hConfig,hState,predicate){var candidates=getCandidates(component,hConfig),targetComp=find(candidates,predicate);targetComp.each(function(c){highlight$1(component,hConfig,hState,c)})},isHighlighted=function(component,hConfig,hState,queryTarget){return has$2(queryTarget.element(),hConfig.highlightClass)},getHighlighted=function(component,hConfig,hState){return descendant$1(component.element(),"."+hConfig.highlightClass).bind(function(e){return component.getSystem().getByDom(e).toOption()})},getByIndex=function(component,hConfig,hState,index){var items=descendants(component.element(),"."+hConfig.itemClass);return Option.from(items[index]).fold(function(){return Result.error("No element found with index "+index)},component.getSystem().getByDom)},getFirst=function(component,hConfig,hState){return descendant$1(component.element(),"."+hConfig.itemClass).bind(function(e){return component.getSystem().getByDom(e).toOption()})},getLast=function(component,hConfig,hState){var items=descendants(component.element(),"."+hConfig.itemClass),last=items.length>0?Option.some(items[items.length-1]):Option.none();return last.bind(function(c){return component.getSystem().getByDom(c).toOption()})},getDelta=function(component,hConfig,hState,delta){var items=descendants(component.element(),"."+hConfig.itemClass),current=findIndex(items,function(item){return has$2(item,hConfig.highlightClass)});return current.bind(function(selected){var dest=cycleBy(selected,delta,0,items.length-1);return component.getSystem().getByDom(items[dest]).toOption()})},getPrevious=function(component,hConfig,hState){return getDelta(component,hConfig,hState,-1)},getNext=function(component,hConfig,hState){return getDelta(component,hConfig,hState,1)},getCandidates=function(component,hConfig,hState){var items=descendants(component.element(),"."+hConfig.itemClass);return cat(map(items,function(i){return component.getSystem().getByDom(i).toOption()}))},HighlightApis=Object.freeze({dehighlightAll:dehighlightAll,dehighlight:dehighlight$1,highlight:highlight$1,highlightFirst:highlightFirst,highlightLast:highlightLast,highlightAt:highlightAt,highlightBy:highlightBy,isHighlighted:isHighlighted,getHighlighted:getHighlighted,getFirst:getFirst,getLast:getLast,getPrevious:getPrevious,getNext:getNext,getCandidates:getCandidates}),HighlightSchema=[strict$1("highlightClass"),strict$1("itemClass"),onHandler("onHighlight"),onHandler("onDehighlight")],Highlighting=create$1({fields:HighlightSchema,name:"highlighting",apis:HighlightApis}),BACKSPACE=function(){return[8]},TAB=function(){return[9]},ENTER=function(){return[13]},ESCAPE=function(){return[27]},SPACE=function(){return[32]},LEFT=function(){return[37]},UP=function(){return[38]},RIGHT=function(){return[39]},DOWN=function(){return[40]},cyclePrev=function(values,index,predicate){var before=reverse(values.slice(0,index)),after=reverse(values.slice(index+1));return find(before.concat(after),predicate)},tryPrev=function(values,index,predicate){var before=reverse(values.slice(0,index));return find(before,predicate)},cycleNext=function(values,index,predicate){var before=values.slice(0,index),after=values.slice(index+1);return find(after.concat(before),predicate)},tryNext=function(values,index,predicate){var after=values.slice(index+1);return find(after,predicate)},inSet=function(keys){return function(event){var raw=event.raw();return contains(keys,raw.which)}},and=function(preds){return function(event){return forall(preds,function(pred){return pred(event)})}},isShift=function(event){var raw=event.raw();return!0===raw.shiftKey},isControl=function(event){var raw=event.raw();return!0===raw.ctrlKey},isNotShift=not(isShift),rule=function(matches,action){return{matches:matches,classification:action}},choose$2=function(transitions,event){var transition=find(transitions,function(t){return t.matches(event)});return transition.map(function(t){return t.classification})},focus$1=function(element){element.dom().focus()},blur=function(element){element.dom().blur()},hasFocus=function(element){var doc=owner(element).dom();return element.dom()===doc.activeElement},active=function(_doc){var doc=void 0!==_doc?_doc.dom():domGlobals.document;return Option.from(doc.activeElement).map(Element.fromDom)},search$1=function(element){return active(owner(element)).filter(function(e){return element.dom().contains(e.dom())})},reportFocusShifting=function(component,prevFocus,newFocus){var noChange=prevFocus.exists(function(p){return newFocus.exists(function(n){return eq(n,p)})});noChange||emitWith(component,focusShifted(),{prevFocus:prevFocus,newFocus:newFocus})},dom=function(){
var get=function(component){return search$1(component.element())},set=function(component,focusee){var prevFocus=get(component);component.getSystem().triggerFocus(focusee,component.element());var newFocus=get(component);reportFocusShifting(component,prevFocus,newFocus)};return{get:get,set:set}},highlights=function(){var get=function(component){return Highlighting.getHighlighted(component).map(function(item){return item.element()})},set=function(component,element){var prevFocus=get(component);component.getSystem().getByDom(element).fold(noop,function(item){Highlighting.highlight(component,item)});var newFocus=get(component);reportFocusShifting(component,prevFocus,newFocus)};return{get:get,set:set}};(function(FocusInsideModes){FocusInsideModes.OnFocusMode="onFocus",FocusInsideModes.OnEnterOrSpaceMode="onEnterOrSpace",FocusInsideModes.OnApiMode="onApi"})(FocusInsideModes||(FocusInsideModes={}));var ItemResponse,typical=function(infoSchema,stateInit,getKeydownRules,getKeyupRules,optFocusIn){var schema=function(){return infoSchema.concat([defaulted$1("focusManager",dom()),defaultedOf("focusInside","onFocus",valueOf(function(val){return contains(["onFocus","onEnterOrSpace","onApi"],val)?Result.value(val):Result.error("Invalid value for focusInside")})),output("handler",me),output("state",stateInit),output("sendFocusIn",optFocusIn)])},processKey=function(component,simulatedEvent,getRules,keyingConfig,keyingState){var rules=getRules(component,simulatedEvent,keyingConfig,keyingState);return choose$2(rules,simulatedEvent.event()).bind(function(rule){return rule(component,simulatedEvent,keyingConfig,keyingState)})},toEvents=function(keyingConfig,keyingState){var onFocusHandler=keyingConfig.focusInside!==FocusInsideModes.OnFocusMode?Option.none():optFocusIn(keyingConfig).map(function(focusIn){return run(focus(),function(component,simulatedEvent){focusIn(component,keyingConfig,keyingState),simulatedEvent.stop()})}),tryGoInsideComponent=function(component,simulatedEvent){var isEnterOrSpace=inSet(SPACE().concat(ENTER()))(simulatedEvent.event());keyingConfig.focusInside===FocusInsideModes.OnEnterOrSpaceMode&&isEnterOrSpace&&isSource(component,simulatedEvent)&&optFocusIn(keyingConfig).each(function(focusIn){focusIn(component,keyingConfig,keyingState),simulatedEvent.stop()})};return derive(onFocusHandler.toArray().concat([run(keydown(),function(component,simulatedEvent){processKey(component,simulatedEvent,getKeydownRules,keyingConfig,keyingState).fold(function(){tryGoInsideComponent(component,simulatedEvent)},function(_){simulatedEvent.stop()})}),run(keyup(),function(component,simulatedEvent){processKey(component,simulatedEvent,getKeyupRules,keyingConfig,keyingState).each(function(_){simulatedEvent.stop()})})]))},me={schema:schema,processKey:processKey,toEvents:toEvents};return me},create$3=function(cyclicField){var schema=[option("onEscape"),option("onEnter"),defaulted$1("selector",'[data-alloy-tabstop="true"]:not(:disabled)'),defaulted$1("firstTabstop",0),defaulted$1("useTabstopAt",constant(!0)),option("visibilitySelector")].concat([cyclicField]),isVisible=function(tabbingConfig,element){var target=tabbingConfig.visibilitySelector.bind(function(sel){return closest$3(element,sel)}).getOr(element);return get$6(target)>0},findInitial=function(component,tabbingConfig){var tabstops=descendants(component.element(),tabbingConfig.selector),visibles=filter(tabstops,function(elem){return isVisible(tabbingConfig,elem)});return Option.from(visibles[tabbingConfig.firstTabstop])},findCurrent=function(component,tabbingConfig){return tabbingConfig.focusManager.get(component).bind(function(elem){return closest$3(elem,tabbingConfig.selector)})},isTabstop=function(tabbingConfig,element){return isVisible(tabbingConfig,element)&&tabbingConfig.useTabstopAt(element)},focusIn=function(component,tabbingConfig){findInitial(component,tabbingConfig).each(function(target){tabbingConfig.focusManager.set(component,target)})},goFromTabstop=function(component,tabstops,stopIndex,tabbingConfig,cycle){return cycle(tabstops,stopIndex,function(elem){return isTabstop(tabbingConfig,elem)}).fold(function(){return tabbingConfig.cyclic?Option.some(!0):Option.none()},function(target){return tabbingConfig.focusManager.set(component,target),Option.some(!0)})},go=function(component,simulatedEvent,tabbingConfig,cycle){var tabstops=descendants(component.element(),tabbingConfig.selector);return findCurrent(component,tabbingConfig).bind(function(tabstop){var optStopIndex=findIndex(tabstops,curry(eq,tabstop));return optStopIndex.bind(function(stopIndex){return goFromTabstop(component,tabstops,stopIndex,tabbingConfig,cycle)})})},goBackwards=function(component,simulatedEvent,tabbingConfig,tabbingState){var navigate=tabbingConfig.cyclic?cyclePrev:tryPrev;return go(component,simulatedEvent,tabbingConfig,navigate)},goForwards=function(component,simulatedEvent,tabbingConfig,tabbingState){var navigate=tabbingConfig.cyclic?cycleNext:tryNext;return go(component,simulatedEvent,tabbingConfig,navigate)},execute=function(component,simulatedEvent,tabbingConfig,tabbingState){return tabbingConfig.onEnter.bind(function(f){return f(component,simulatedEvent)})},exit=function(component,simulatedEvent,tabbingConfig,tabbingState){return tabbingConfig.onEscape.bind(function(f){return f(component,simulatedEvent)})},getKeydownRules=constant([rule(and([isShift,inSet(TAB())]),goBackwards),rule(inSet(TAB()),goForwards),rule(inSet(ESCAPE()),exit),rule(and([isNotShift,inSet(ENTER())]),execute)]),getKeyupRules=constant([]);return typical(schema,NoState.init,getKeydownRules,getKeyupRules,function(){return Option.some(focusIn)})},AcyclicType=create$3(state$1("cyclic",constant(!1))),CyclicType=create$3(state$1("cyclic",constant(!0))),doDefaultExecute=function(component,simulatedEvent,focused){return dispatch(component,focused,execute()),Option.some(!0)},defaultExecute=function(component,simulatedEvent,focused){return inside(focused)&&inSet(SPACE())(simulatedEvent.event())?Option.none():doDefaultExecute(component,simulatedEvent,focused)},stopEventForFirefox=function(component,simulatedEvent){return Option.some(!0)},schema$3=[defaulted$1("execute",defaultExecute),defaulted$1("useSpace",!1),defaulted$1("useEnter",!0),defaulted$1("useControlEnter",!1),defaulted$1("useDown",!1)],execute$1=function(component,simulatedEvent,executeConfig){return executeConfig.execute(component,simulatedEvent,component.element())},getKeydownRules=function(component,simulatedEvent,executeConfig,executeState){var spaceExec=executeConfig.useSpace&&!inside(component.element())?SPACE():[],enterExec=executeConfig.useEnter?ENTER():[],downExec=executeConfig.useDown?DOWN():[],execKeys=spaceExec.concat(enterExec).concat(downExec);return[rule(inSet(execKeys),execute$1)].concat(executeConfig.useControlEnter?[rule(and([isControl,inSet(ENTER())]),execute$1)]:[])},getKeyupRules=function(component,simulatedEvent,executeConfig,executeState){return executeConfig.useSpace&&!inside(component.element())?[rule(inSet(SPACE()),stopEventForFirefox)]:[]},ExecutionType=typical(schema$3,NoState.init,getKeydownRules,getKeyupRules,function(){return Option.none()}),flatgrid=function(spec){var dimensions=Cell(Option.none()),setGridSize=function(numRows,numColumns){dimensions.set(Option.some({numRows:constant(numRows),numColumns:constant(numColumns)}))},getNumRows=function(){return dimensions.get().map(function(d){return d.numRows()})},getNumColumns=function(){return dimensions.get().map(function(d){return d.numColumns()})};return nu$5({readState:function(){return dimensions.get().map(function(d){return{numRows:d.numRows(),numColumns:d.numColumns()}}).getOr({numRows:"?",numColumns:"?"})},setGridSize:setGridSize,getNumRows:getNumRows,getNumColumns:getNumColumns})},init$1=function(spec){return spec.state(spec)},KeyingState=Object.freeze({flatgrid:flatgrid,init:init$1}),useH=function(movement){return function(component,simulatedEvent,config,state){var move=movement(component.element());return use(move,component,simulatedEvent,config,state)}},west$2=function(moveLeft,moveRight){var movement=onDirection(moveLeft,moveRight);return useH(movement)},east$2=function(moveLeft,moveRight){var movement=onDirection(moveRight,moveLeft);return useH(movement)},useV=function(move){return function(component,simulatedEvent,config,state){return use(move,component,simulatedEvent,config,state)}},use=function(move,component,simulatedEvent,config,state){var outcome=config.focusManager.get(component).bind(function(focused){return move(component.element(),focused,config,state)});return outcome.map(function(newFocus){return config.focusManager.set(component,newFocus),!0})},north$2=useV,south$2=useV,move=useV,isHidden=function(dom){return dom.offsetWidth<=0&&dom.offsetHeight<=0},isVisible=function(element){var dom=element.dom();return!isHidden(dom)},indexInfo=MixedBag(["index","candidates"],[]),locate$2=function(candidates,predicate){return findIndex(candidates,predicate).map(function(index){return indexInfo({index:index,candidates:candidates})})},locateVisible=function(container,current,selector){var predicate=curry(eq,current),candidates=descendants(container,selector),visible=filter(candidates,isVisible);return locate$2(visible,predicate)},findIndex$1=function(elements,target){return findIndex(elements,function(elem){return eq(target,elem)})},withGrid=function(values,index,numCols,f){var oldRow=Math.floor(index/numCols),oldColumn=index%numCols;return f(oldRow,oldColumn).bind(function(address){var newIndex=address.row()*numCols+address.column();return newIndex>=0&&newIndex<values.length?Option.some(values[newIndex]):Option.none()})},cycleHorizontal=function(values,index,numRows,numCols,delta){return withGrid(values,index,numCols,function(oldRow,oldColumn){var onLastRow=oldRow===numRows-1,colsInRow=onLastRow?values.length-oldRow*numCols:numCols,newColumn=cycleBy(oldColumn,delta,0,colsInRow-1);return Option.some({row:constant(oldRow),column:constant(newColumn)})})},cycleVertical=function(values,index,numRows,numCols,delta){return withGrid(values,index,numCols,function(oldRow,oldColumn){var newRow=cycleBy(oldRow,delta,0,numRows-1),onLastRow=newRow===numRows-1,colsInRow=onLastRow?values.length-newRow*numCols:numCols,newCol=cap(oldColumn,0,colsInRow-1);return Option.some({row:constant(newRow),column:constant(newCol)})})},cycleRight=function(values,index,numRows,numCols){return cycleHorizontal(values,index,numRows,numCols,1)},cycleLeft=function(values,index,numRows,numCols){return cycleHorizontal(values,index,numRows,numCols,-1)},cycleUp=function(values,index,numRows,numCols){return cycleVertical(values,index,numRows,numCols,-1)},cycleDown=function(values,index,numRows,numCols){return cycleVertical(values,index,numRows,numCols,1)},schema$4=[strict$1("selector"),defaulted$1("execute",defaultExecute),onKeyboardHandler("onEscape"),defaulted$1("captureTab",!1),initSize()],focusIn=function(component,gridConfig,gridState){descendant$1(component.element(),gridConfig.selector).each(function(first){gridConfig.focusManager.set(component,first)})},findCurrent=function(component,gridConfig){return gridConfig.focusManager.get(component).bind(function(elem){return closest$3(elem,gridConfig.selector)})},execute$2=function(component,simulatedEvent,gridConfig,gridState){return findCurrent(component,gridConfig).bind(function(focused){return gridConfig.execute(component,simulatedEvent,focused)})},doMove=function(cycle){return function(element,focused,gridConfig,gridState){return locateVisible(element,focused,gridConfig.selector).bind(function(identified){return cycle(identified.candidates(),identified.index(),gridState.getNumRows().getOr(gridConfig.initSize.numRows),gridState.getNumColumns().getOr(gridConfig.initSize.numColumns))})}},handleTab=function(component,simulatedEvent,gridConfig,gridState){return gridConfig.captureTab?Option.some(!0):Option.none()},doEscape=function(component,simulatedEvent,gridConfig,gridState){return gridConfig.onEscape(component,simulatedEvent)},moveLeft=doMove(cycleLeft),moveRight=doMove(cycleRight),moveNorth=doMove(cycleUp),moveSouth=doMove(cycleDown),getKeydownRules$1=constant([rule(inSet(LEFT()),west$2(moveLeft,moveRight)),rule(inSet(RIGHT()),east$2(moveLeft,moveRight)),rule(inSet(UP()),north$2(moveNorth)),rule(inSet(DOWN()),south$2(moveSouth)),rule(and([isShift,inSet(TAB())]),handleTab),rule(and([isNotShift,inSet(TAB())]),handleTab),rule(inSet(ESCAPE()),doEscape),rule(inSet(SPACE().concat(ENTER())),execute$2)]),getKeyupRules$1=constant([rule(inSet(SPACE()),stopEventForFirefox)]),FlatgridType=typical(schema$4,flatgrid,getKeydownRules$1,getKeyupRules$1,function(){return Option.some(focusIn)}),horizontal=function(container,selector,current,delta){var isDisabledButton=function(candidate){return"button"===name(candidate)&&"disabled"===get$2(candidate,"disabled")},tryCycle=function(initial,index,candidates){var newIndex=cycleBy(index,delta,0,candidates.length-1);return newIndex===initial?Option.none():isDisabledButton(candidates[newIndex])?tryCycle(initial,newIndex,candidates):Option.from(candidates[newIndex])};return locateVisible(container,current,selector).bind(function(identified){var index=identified.index(),candidates=identified.candidates();return tryCycle(index,index,candidates)})},schema$5=[strict$1("selector"),defaulted$1("getInitial",Option.none),defaulted$1("execute",defaultExecute),onKeyboardHandler("onEscape"),defaulted$1("executeOnMove",!1),defaulted$1("allowVertical",!0)],findCurrent$1=function(component,flowConfig){return flowConfig.focusManager.get(component).bind(function(elem){return closest$3(elem,flowConfig.selector)})},execute$3=function(component,simulatedEvent,flowConfig){return findCurrent$1(component,flowConfig).bind(function(focused){return flowConfig.execute(component,simulatedEvent,focused)})},focusIn$1=function(component,flowConfig){flowConfig.getInitial(component).orThunk(function(){return descendant$1(component.element(),flowConfig.selector)}).each(function(first){flowConfig.focusManager.set(component,first)})},moveLeft$1=function(element,focused,info){return horizontal(element,info.selector,focused,-1)},moveRight$1=function(element,focused,info){return horizontal(element,info.selector,focused,1)},doMove$1=function(movement){return function(component,simulatedEvent,flowConfig){return movement(component,simulatedEvent,flowConfig).bind(function(){return flowConfig.executeOnMove?execute$3(component,simulatedEvent,flowConfig):Option.some(!0)})}},doEscape$1=function(component,simulatedEvent,flowConfig,_flowState){return flowConfig.onEscape(component,simulatedEvent)},getKeydownRules$2=function(_component,_se,flowConfig,_flowState){var westMovers=LEFT().concat(flowConfig.allowVertical?UP():[]),eastMovers=RIGHT().concat(flowConfig.allowVertical?DOWN():[]);return[rule(inSet(westMovers),doMove$1(west$2(moveLeft$1,moveRight$1))),rule(inSet(eastMovers),doMove$1(east$2(moveLeft$1,moveRight$1))),rule(inSet(ENTER()),execute$3),rule(inSet(SPACE()),execute$3),rule(inSet(ESCAPE()),doEscape$1)]},getKeyupRules$2=constant([rule(inSet(SPACE()),stopEventForFirefox)]),FlowType=typical(schema$5,NoState.init,getKeydownRules$2,getKeyupRules$2,function(){return Option.some(focusIn$1)}),outcome=MixedBag(["rowIndex","columnIndex","cell"],[]),toCell=function(matrix,rowIndex,columnIndex){return Option.from(matrix[rowIndex]).bind(function(row){return Option.from(row[columnIndex]).map(function(cell){return outcome({rowIndex:rowIndex,columnIndex:columnIndex,cell:cell})})})},cycleHorizontal$1=function(matrix,rowIndex,startCol,deltaCol){var row=matrix[rowIndex],colsInRow=row.length,newColIndex=cycleBy(startCol,deltaCol,0,colsInRow-1);return toCell(matrix,rowIndex,newColIndex)},cycleVertical$1=function(matrix,colIndex,startRow,deltaRow){var nextRowIndex=cycleBy(startRow,deltaRow,0,matrix.length-1),colsInNextRow=matrix[nextRowIndex].length,nextColIndex=cap(colIndex,0,colsInNextRow-1);return toCell(matrix,nextRowIndex,nextColIndex)},moveHorizontal=function(matrix,rowIndex,startCol,deltaCol){var row=matrix[rowIndex],colsInRow=row.length,newColIndex=cap(startCol+deltaCol,0,colsInRow-1);return toCell(matrix,rowIndex,newColIndex)},moveVertical=function(matrix,colIndex,startRow,deltaRow){var nextRowIndex=cap(startRow+deltaRow,0,matrix.length-1),colsInNextRow=matrix[nextRowIndex].length,nextColIndex=cap(colIndex,0,colsInNextRow-1);return toCell(matrix,nextRowIndex,nextColIndex)},cycleRight$1=function(matrix,startRow,startCol){return cycleHorizontal$1(matrix,startRow,startCol,1)},cycleLeft$1=function(matrix,startRow,startCol){return cycleHorizontal$1(matrix,startRow,startCol,-1)},cycleUp$1=function(matrix,startRow,startCol){return cycleVertical$1(matrix,startCol,startRow,-1)},cycleDown$1=function(matrix,startRow,startCol){return cycleVertical$1(matrix,startCol,startRow,1)},moveLeft$2=function(matrix,startRow,startCol){return moveHorizontal(matrix,startRow,startCol,-1)},moveRight$2=function(matrix,startRow,startCol){return moveHorizontal(matrix,startRow,startCol,1)},moveUp=function(matrix,startRow,startCol){return moveVertical(matrix,startCol,startRow,-1)},moveDown=function(matrix,startRow,startCol){return moveVertical(matrix,startCol,startRow,1)},schema$6=[strictObjOf("selectors",[strict$1("row"),strict$1("cell")]),defaulted$1("cycles",!0),defaulted$1("previousSelector",Option.none),defaulted$1("execute",defaultExecute)],focusIn$2=function(component,matrixConfig){var focused=matrixConfig.previousSelector(component).orThunk(function(){var selectors=matrixConfig.selectors;return descendant$1(component.element(),selectors.cell)});focused.each(function(cell){matrixConfig.focusManager.set(component,cell)})},execute$4=function(component,simulatedEvent,matrixConfig){return search$1(component.element()).bind(function(focused){return matrixConfig.execute(component,simulatedEvent,focused)})},toMatrix=function(rows,matrixConfig){return map(rows,function(row){return descendants(row,matrixConfig.selectors.cell)})},doMove$2=function(ifCycle,ifMove){return function(element,focused,matrixConfig){var move=matrixConfig.cycles?ifCycle:ifMove;return closest$3(focused,matrixConfig.selectors.row).bind(function(inRow){var cellsInRow=descendants(inRow,matrixConfig.selectors.cell);return findIndex$1(cellsInRow,focused).bind(function(colIndex){var allRows=descendants(element,matrixConfig.selectors.row);return findIndex$1(allRows,inRow).bind(function(rowIndex){var matrix=toMatrix(allRows,matrixConfig);return move(matrix,rowIndex,colIndex).map(function(next){return next.cell()})})})})}},moveLeft$3=doMove$2(cycleLeft$1,moveLeft$2),moveRight$3=doMove$2(cycleRight$1,moveRight$2),moveNorth$1=doMove$2(cycleUp$1,moveUp),moveSouth$1=doMove$2(cycleDown$1,moveDown),getKeydownRules$3=constant([rule(inSet(LEFT()),west$2(moveLeft$3,moveRight$3)),rule(inSet(RIGHT()),east$2(moveLeft$3,moveRight$3)),rule(inSet(UP()),north$2(moveNorth$1)),rule(inSet(DOWN()),south$2(moveSouth$1)),rule(inSet(SPACE().concat(ENTER())),execute$4)]),getKeyupRules$3=constant([rule(inSet(SPACE()),stopEventForFirefox)]),MatrixType=typical(schema$6,NoState.init,getKeydownRules$3,getKeyupRules$3,function(){return Option.some(focusIn$2)}),schema$7=[strict$1("selector"),defaulted$1("execute",defaultExecute),defaulted$1("moveOnTab",!1)],execute$5=function(component,simulatedEvent,menuConfig){return menuConfig.focusManager.get(component).bind(function(focused){return menuConfig.execute(component,simulatedEvent,focused)})},focusIn$3=function(component,menuConfig){descendant$1(component.element(),menuConfig.selector).each(function(first){menuConfig.focusManager.set(component,first)})},moveUp$1=function(element,focused,info){return horizontal(element,info.selector,focused,-1)},moveDown$1=function(element,focused,info){return horizontal(element,info.selector,focused,1)},fireShiftTab=function(component,simulatedEvent,menuConfig){return menuConfig.moveOnTab?move(moveUp$1)(component,simulatedEvent,menuConfig):Option.none()},fireTab=function(component,simulatedEvent,menuConfig){return menuConfig.moveOnTab?move(moveDown$1)(component,simulatedEvent,menuConfig):Option.none()},getKeydownRules$4=constant([rule(inSet(UP()),move(moveUp$1)),rule(inSet(DOWN()),move(moveDown$1)),rule(and([isShift,inSet(TAB())]),fireShiftTab),rule(and([isNotShift,inSet(TAB())]),fireTab),rule(inSet(ENTER()),execute$5),rule(inSet(SPACE()),execute$5)]),getKeyupRules$4=constant([rule(inSet(SPACE()),stopEventForFirefox)]),MenuType=typical(schema$7,NoState.init,getKeydownRules$4,getKeyupRules$4,function(){return Option.some(focusIn$3)}),schema$8=[onKeyboardHandler("onSpace"),onKeyboardHandler("onEnter"),onKeyboardHandler("onShiftEnter"),onKeyboardHandler("onLeft"),onKeyboardHandler("onRight"),onKeyboardHandler("onTab"),onKeyboardHandler("onShiftTab"),onKeyboardHandler("onUp"),onKeyboardHandler("onDown"),onKeyboardHandler("onEscape"),defaulted$1("stopSpaceKeyup",!1),option("focusIn")],getKeydownRules$5=function(component,simulatedEvent,specialInfo){return[rule(inSet(SPACE()),specialInfo.onSpace),rule(and([isNotShift,inSet(ENTER())]),specialInfo.onEnter),rule(and([isShift,inSet(ENTER())]),specialInfo.onShiftEnter),rule(and([isShift,inSet(TAB())]),specialInfo.onShiftTab),rule(and([isNotShift,inSet(TAB())]),specialInfo.onTab),rule(inSet(UP()),specialInfo.onUp),rule(inSet(DOWN()),specialInfo.onDown),rule(inSet(LEFT()),specialInfo.onLeft),rule(inSet(RIGHT()),specialInfo.onRight),rule(inSet(SPACE()),specialInfo.onSpace),rule(inSet(ESCAPE()),specialInfo.onEscape)]},getKeyupRules$5=function(component,simulatedEvent,specialInfo){return specialInfo.stopSpaceKeyup?[rule(inSet(SPACE()),stopEventForFirefox)]:[]},SpecialType=typical(schema$8,NoState.init,getKeydownRules$5,getKeyupRules$5,function(specialInfo){return specialInfo.focusIn}),acyclic=AcyclicType.schema(),cyclic=CyclicType.schema(),flow=FlowType.schema(),flatgrid$1=FlatgridType.schema(),matrix=MatrixType.schema(),execution=ExecutionType.schema(),menu=MenuType.schema(),special=SpecialType.schema(),KeyboardBranches=Object.freeze({acyclic:acyclic,cyclic:cyclic,flow:flow,flatgrid:flatgrid$1,matrix:matrix,execution:execution,menu:menu,special:special}),Keying=createModes$1({branchKey:"mode",branches:KeyboardBranches,name:"keying",active:{events:function(keyingConfig,keyingState){var handler=keyingConfig.handler;return handler.toEvents(keyingConfig,keyingState)}},apis:{focusIn:function(component,keyConfig,keyState){keyConfig.sendFocusIn(keyConfig).fold(function(){component.getSystem().triggerFocus(component.element(),component.element())},function(sendFocusIn){sendFocusIn(component,keyConfig,keyState)})},setGridSize:function(component,keyConfig,keyState,numRows,numColumns){hasKey$1(keyState,"setGridSize")?keyState.setGridSize(numRows,numColumns):domGlobals.console.error("Layout does not support setGridSize")}},state:KeyingState}),preserve=function(f,container){var ownerDoc=owner(container),refocus=active(ownerDoc).bind(function(focused){var hasFocus=function(elem){return eq(focused,elem)};return hasFocus(container)?Option.some(container):descendant(container,hasFocus)}),result=f(container);return refocus.each(function(oldFocus){active(ownerDoc).filter(function(newFocus){return eq(newFocus,oldFocus)}).fold(function(){focus$1(oldFocus)},noop)}),result},set$5=function(component,replaceConfig,replaceState,data){detachChildren(component),preserve(function(){var children=map(data,component.getSystem().build);each(children,function(l){attach(component,l)})},component.element())},insert=function(component,replaceConfig,insertion,childSpec){var child=component.getSystem().build(childSpec);attachWith(component,child,insertion)},append$2=function(component,replaceConfig,replaceState,appendee){insert(component,replaceConfig,append,appendee)},prepend$1=function(component,replaceConfig,replaceState,prependee){insert(component,replaceConfig,prepend,prependee)},remove$7=function(component,replaceConfig,replaceState,removee){var children=contents(component),foundChild=find(children,function(child){return eq(removee.element(),child.element())});foundChild.each(detach)},contents=function(component,replaceConfig){return component.components()},replaceAt=function(component,replaceConfig,replaceState,replaceeIndex,replacer){var children=contents(component);return Option.from(children[replaceeIndex]).map(function(replacee){return remove$7(component,replaceConfig,replaceState,replacee),replacer.each(function(r){insert(component,replaceConfig,function(p,c){appendAt(p,c,replaceeIndex)},r)}),replacee})},replaceBy=function(component,replaceConfig,replaceState,replaceePred,replacer){var children=contents(component);return findIndex(children,replaceePred).bind(function(replaceeIndex){return replaceAt(component,replaceConfig,replaceState,replaceeIndex,replacer)})},ReplaceApis=Object.freeze({append:append$2,prepend:prepend$1,remove:remove$7,replaceAt:replaceAt,replaceBy:replaceBy,set:set$5,contents:contents}),Replacing=create$1({fields:[],name:"replacing",apis:ReplaceApis}),onLoad=function(component,repConfig,repState){repConfig.store.manager.onLoad(component,repConfig,repState)},onUnload=function(component,repConfig,repState){repConfig.store.manager.onUnload(component,repConfig,repState)},setValue=function(component,repConfig,repState,data){repConfig.store.manager.setValue(component,repConfig,repState,data)},getValue=function(component,repConfig,repState){return repConfig.store.manager.getValue(component,repConfig,repState)},getState$1=function(component,repConfig,repState){return repState},RepresentApis=Object.freeze({onLoad:onLoad,onUnload:onUnload,setValue:setValue,getValue:getValue,getState:getState$1}),events$3=function(repConfig,repState){var es=repConfig.resetOnDom?[runOnAttached(function(comp,se){onLoad(comp,repConfig,repState)}),runOnDetached(function(comp,se){onUnload(comp,repConfig,repState)})]:[loadEvent(repConfig,repState,onLoad)];return derive(es)},ActiveRepresenting=Object.freeze({events:events$3}),memory=function(){var data=Cell(null),readState=function(){return{mode:"memory",value:data.get()}},isNotSet=function(){return null===data.get()},clear=function(){data.set(null)};return nu$5({set:data.set,get:data.get,isNotSet:isNotSet,clear:clear,readState:readState})},manual=function(){var readState=function(){};return nu$5({readState:readState})},dataset=function(){var dataByValue=Cell({}),dataByText=Cell({}),readState=function(){return{mode:"dataset",dataByValue:dataByValue.get(),dataByText:dataByText.get()}},clear=function(){dataByValue.set({}),dataByText.set({})},lookup=function(itemString){return readOptFrom$1(dataByValue.get(),itemString).orThunk(function(){return readOptFrom$1(dataByText.get(),itemString)})},update=function(items){var currentDataByValue=dataByValue.get(),currentDataByText=dataByText.get(),newDataByValue={},newDataByText={};each(items,function(item){newDataByValue[item.value]=item,readOptFrom$1(item,"meta").each(function(meta){readOptFrom$1(meta,"text").each(function(text){newDataByText[text]=item})})}),dataByValue.set(__assign({},currentDataByValue,newDataByValue)),dataByText.set(__assign({},currentDataByText,newDataByText))};return nu$5({readState:readState,lookup:lookup,update:update,clear:clear})},init$2=function(spec){return spec.store.manager.state(spec)},RepresentState=Object.freeze({memory:memory,dataset:dataset,manual:manual,init:init$2}),setValue$1=function(component,repConfig,repState,data){var store=repConfig.store;repState.update([data]),store.setValue(component,data),repConfig.onSetValue(component,data)},getValue$1=function(component,repConfig,repState){var store=repConfig.store,key=store.getDataKey(component);return repState.lookup(key).fold(function(){return store.getFallbackEntry(key)},function(data){return data})},onLoad$1=function(component,repConfig,repState){var store=repConfig.store;store.initialValue.each(function(data){setValue$1(component,repConfig,repState,data)})},onUnload$1=function(component,repConfig,repState){repState.clear()},DatasetStore=[option("initialValue"),strict$1("getFallbackEntry"),strict$1("getDataKey"),strict$1("setValue"),output("manager",{setValue:setValue$1,getValue:getValue$1,onLoad:onLoad$1,onUnload:onUnload$1,state:dataset})],getValue$2=function(component,repConfig,repState){return repConfig.store.getValue(component)},setValue$2=function(component,repConfig,repState,data){repConfig.store.setValue(component,data),repConfig.onSetValue(component,data)},onLoad$2=function(component,repConfig,repState){repConfig.store.initialValue.each(function(data){repConfig.store.setValue(component,data)})},ManualStore=[strict$1("getValue"),defaulted$1("setValue",noop),option("initialValue"),output("manager",{setValue:setValue$2,getValue:getValue$2,onLoad:onLoad$2,onUnload:noop,state:NoState.init})],setValue$3=function(component,repConfig,repState,data){repState.set(data),repConfig.onSetValue(component,data)},getValue$3=function(component,repConfig,repState){return repState.get()},onLoad$3=function(component,repConfig,repState){repConfig.store.initialValue.each(function(initVal){repState.isNotSet()&&repState.set(initVal)})},onUnload$2=function(component,repConfig,repState){repState.clear()},MemoryStore=[option("initialValue"),output("manager",{setValue:setValue$3,getValue:getValue$3,onLoad:onLoad$3,onUnload:onUnload$2,state:memory})],RepresentSchema=[defaultedOf("store",{mode:"memory"},choose$1("mode",{memory:MemoryStore,manual:ManualStore,dataset:DatasetStore})),onHandler("onSetValue"),defaulted$1("resetOnDom",!1)],Representing=create$1({fields:RepresentSchema,name:"representing",active:ActiveRepresenting,apis:RepresentApis,extra:{setValueFrom:function(component,source){var value=Representing.getValue(source);Representing.setValue(component,value)}},state:RepresentState}),events$4=function(name,eventHandlers){var events=derive(eventHandlers);return create$1({fields:[strict$1("enabled")],name:name,active:{events:constant(events)}})},config=function(name,eventHandlers){var me=events$4(name,eventHandlers);return{key:name,value:{config:{},me:me,configAsRaw:constant({}),initialConfig:{},state:NoState}}},focus$2=function(component,focusConfig){focusConfig.ignore||(focus$1(component.element()),focusConfig.onFocus(component))},blur$1=function(component,focusConfig){focusConfig.ignore||blur(component.element())},isFocused=function(component){return hasFocus(component.element())},FocusApis=Object.freeze({focus:focus$2,blur:blur$1,isFocused:isFocused}),exhibit$1=function(base,focusConfig){var mod=focusConfig.ignore?{}:{attributes:{tabindex:"-1"}};return nu$6(mod)},events$5=function(focusConfig){return derive([run(focus(),function(component,simulatedEvent){focus$2(component,focusConfig),simulatedEvent.stop()})].concat(focusConfig.stopMousedown?[run(mousedown(),function(_,simulatedEvent){simulatedEvent.event().prevent()})]:[]))},ActiveFocus=Object.freeze({exhibit:exhibit$1,events:events$5}),FocusSchema=[onHandler("onFocus"),defaulted$1("stopMousedown",!1),defaulted$1("ignore",!1)],Focusing=create$1({fields:FocusSchema,name:"focusing",active:ActiveFocus,apis:FocusApis}),updateAriaState=function(component,toggleConfig,toggleState){var ariaInfo=toggleConfig.aria;ariaInfo.update(component,ariaInfo,toggleState.get())},updateClass=function(component,toggleConfig,toggleState){toggleConfig.toggleClass.each(function(toggleClass){toggleState.get()?add$2(component.element(),toggleClass):remove$4(component.element(),toggleClass)})},toggle=function(component,toggleConfig,toggleState){set$6(component,toggleConfig,toggleState,!toggleState.get())},on$1=function(component,toggleConfig,toggleState){toggleState.set(!0),updateClass(component,toggleConfig,toggleState),updateAriaState(component,toggleConfig,toggleState)},off=function(component,toggleConfig,toggleState){toggleState.set(!1),updateClass(component,toggleConfig,toggleState),updateAriaState(component,toggleConfig,toggleState)},set$6=function(component,toggleConfig,toggleState,state){var action=state?on$1:off;action(component,toggleConfig,toggleState)
},isOn=function(component,toggleConfig,toggleState){return toggleState.get()},onLoad$4=function(component,toggleConfig,toggleState){set$6(component,toggleConfig,toggleState,toggleConfig.selected)},ToggleApis=Object.freeze({onLoad:onLoad$4,toggle:toggle,isOn:isOn,on:on$1,off:off,set:set$6}),exhibit$2=function(base,toggleConfig,toggleState){return nu$6({})},events$6=function(toggleConfig,toggleState){var execute=executeEvent(toggleConfig,toggleState,toggle),load=loadEvent(toggleConfig,toggleState,onLoad$4);return derive(flatten([toggleConfig.toggleOnExecute?[execute]:[],[load]]))},ActiveToggle=Object.freeze({exhibit:exhibit$2,events:events$6}),SetupBehaviourCellState=function(initialState){var init=function(){var cell=Cell(initialState),get=function(){return cell.get()},set=function(newState){return cell.set(newState)},clear=function(){return cell.set(initialState)},readState=function(){return cell.get()};return{get:get,set:set,clear:clear,readState:readState}};return{init:init}},updatePressed=function(component,ariaInfo,status){set$1(component.element(),"aria-pressed",status),ariaInfo.syncWithExpanded&&updateExpanded(component,ariaInfo,status)},updateSelected=function(component,ariaInfo,status){set$1(component.element(),"aria-selected",status)},updateChecked=function(component,ariaInfo,status){set$1(component.element(),"aria-checked",status)},updateExpanded=function(component,ariaInfo,status){set$1(component.element(),"aria-expanded",status)},ToggleSchema=[defaulted$1("selected",!1),option("toggleClass"),defaulted$1("toggleOnExecute",!0),defaultedOf("aria",{mode:"none"},choose$1("mode",{pressed:[defaulted$1("syncWithExpanded",!1),output("update",updatePressed)],checked:[output("update",updateChecked)],expanded:[output("update",updateExpanded)],selected:[output("update",updateSelected)],none:[output("update",noop)]}))],Toggling=create$1({fields:ToggleSchema,name:"toggling",active:ActiveToggle,apis:ToggleApis,state:SetupBehaviourCellState(!1)}),hoverEvent="alloy.item-hover",focusEvent="alloy.item-focus",onHover=function(item){(search$1(item.element()).isNone()||Focusing.isFocused(item))&&(Focusing.isFocused(item)||Focusing.focus(item),emitWith(item,hoverEvent,{item:item}))},onFocus=function(item){emitWith(item,focusEvent,{item:item})},hover=constant(hoverEvent),focus$3=constant(focusEvent),builder=function(detail){return{dom:detail.dom,domModification:__assign({},detail.domModification,{attributes:__assign({role:detail.toggling.isSome()?"menuitemcheckbox":"menuitem"},detail.domModification.attributes,{"aria-haspopup":detail.hasSubmenu},detail.hasSubmenu?{"aria-expanded":!1}:{})}),behaviours:SketchBehaviours.augment(detail.itemBehaviours,[detail.toggling.fold(Toggling.revoke,function(tConfig){return Toggling.config(__assign({aria:{mode:"checked"}},tConfig))}),Focusing.config({ignore:detail.ignoreFocus,stopMousedown:detail.ignoreFocus,onFocus:function(component){onFocus(component)}}),Keying.config({mode:"execution"}),Representing.config({store:{mode:"memory",initialValue:detail.data}}),config("item-type-events",[run(tapOrClick(),emitExecute),cutter(mousedown()),run(mouseover(),onHover),run(focusItem(),Focusing.focus)])]),components:detail.components,eventOrder:detail.eventOrder}},schema$9=[strict$1("data"),strict$1("components"),strict$1("dom"),defaulted$1("hasSubmenu",!1),option("toggling"),SketchBehaviours.field("itemBehaviours",[Toggling,Focusing,Keying,Representing]),defaulted$1("ignoreFocus",!1),defaulted$1("domModification",{}),output("builder",builder),defaulted$1("eventOrder",{})],builder$1=function(detail){return{dom:detail.dom,components:detail.components,events:derive([stopper(focusItem())])}},schema$a=[strict$1("dom"),strict$1("components"),output("builder",builder$1)],owner$2=function(){return"item-widget"},parts=constant([required({name:"widget",overrides:function(detail){return{behaviours:derive$1([Representing.config({store:{mode:"manual",getValue:function(component){return detail.data},setValue:function(){}}})])}}})]),builder$2=function(detail){var subs=substitutes(owner$2(),detail,parts()),components$1=components(owner$2(),detail,subs.internals()),focusWidget=function(component){return getPart(component,detail,"widget").map(function(widget){return Keying.focusIn(widget),widget})},onHorizontalArrow=function(component,simulatedEvent){return inside(simulatedEvent.event().target())?Option.none():detail.autofocus?(simulatedEvent.setSource(component.element()),Option.none()):Option.none()};return{dom:detail.dom,components:components$1,domModification:detail.domModification,events:derive([runOnExecute(function(component,simulatedEvent){focusWidget(component).each(function(widget){simulatedEvent.stop()})}),run(mouseover(),onHover),run(focusItem(),function(component,simulatedEvent){detail.autofocus?focusWidget(component):Focusing.focus(component)})]),behaviours:SketchBehaviours.augment(detail.widgetBehaviours,[Representing.config({store:{mode:"memory",initialValue:detail.data}}),Focusing.config({ignore:detail.ignoreFocus,onFocus:function(component){onFocus(component)}}),Keying.config({mode:"special",focusIn:detail.autofocus?function(component){focusWidget(component)}:revoke(),onLeft:onHorizontalArrow,onRight:onHorizontalArrow,onEscape:function(component,simulatedEvent){return Focusing.isFocused(component)||detail.autofocus?detail.autofocus?(simulatedEvent.setSource(component.element()),Option.none()):Option.none():(Focusing.focus(component),Option.some(!0))}})])}},schema$b=[strict$1("uid"),strict$1("data"),strict$1("components"),strict$1("dom"),defaulted$1("autofocus",!1),defaulted$1("ignoreFocus",!1),SketchBehaviours.field("widgetBehaviours",[Representing,Focusing,Keying]),defaulted$1("domModification",{}),defaultUidsSchema(parts()),output("builder",builder$2)],itemSchema$1=choose$1("type",{widget:schema$b,item:schema$9,separator:schema$a}),configureGrid=function(detail,movementInfo){return{mode:"flatgrid",selector:"."+detail.markers.item,initSize:{numColumns:movementInfo.initSize.numColumns,numRows:movementInfo.initSize.numRows},focusManager:detail.focusManager}},configureMatrix=function(detail,movementInfo){return{mode:"matrix",selectors:{row:movementInfo.rowSelector,cell:"."+detail.markers.item},focusManager:detail.focusManager}},configureMenu=function(detail,movementInfo){return{mode:"menu",selector:"."+detail.markers.item,moveOnTab:movementInfo.moveOnTab,focusManager:detail.focusManager}},parts$1=constant([group({factory:{sketch:function(spec){var itemInfo=asRawOrDie("menu.spec item",itemSchema$1,spec);return itemInfo.builder(itemInfo)}},name:"items",unit:"item",defaults:function(detail,u){return u.hasOwnProperty("uid")?u:__assign({},u,{uid:generate$2("item")})},overrides:function(detail,u){return{type:u.type,ignoreFocus:detail.fakeFocus,domModification:{classes:[detail.markers.item]}}}})]),schema$c=constant([strict$1("value"),strict$1("items"),strict$1("dom"),strict$1("components"),defaulted$1("eventOrder",{}),field$1("menuBehaviours",[Highlighting,Representing,Composing,Keying]),defaultedOf("movement",{mode:"menu",moveOnTab:!0},choose$1("mode",{grid:[initSize(),output("config",configureGrid)],matrix:[output("config",configureMatrix),strict$1("rowSelector")],menu:[defaulted$1("moveOnTab",!0),output("config",configureMenu)]})),itemMarkers(),defaulted$1("fakeFocus",!1),defaulted$1("focusManager",dom()),onHandler("onHighlight")]),focus$4=constant("alloy.menu-focus"),make$1=function(detail,components,spec,externals){return{uid:detail.uid,dom:detail.dom,markers:detail.markers,behaviours:augment(detail.menuBehaviours,[Highlighting.config({highlightClass:detail.markers.selectedItem,itemClass:detail.markers.item,onHighlight:detail.onHighlight}),Representing.config({store:{mode:"memory",initialValue:detail.value}}),Composing.config({find:Option.some}),Keying.config(detail.movement.config(detail,detail.movement))]),events:derive([run(focus$3(),function(menu,simulatedEvent){var event=simulatedEvent.event();menu.getSystem().getByDom(event.target()).each(function(item){Highlighting.highlight(menu,item),simulatedEvent.stop(),emitWith(menu,focus$4(),{menu:menu,item:item})})}),run(hover(),function(menu,simulatedEvent){var item=simulatedEvent.event().item();Highlighting.highlight(menu,item)})]),components:components,eventOrder:detail.eventOrder,domModification:{attributes:{role:"menu"}}}},Menu=composite$1({name:"Menu",configFields:schema$c(),partFields:parts$1(),factory:make$1}),transpose=function(obj){return tupleMap(obj,function(v,k){return{k:v,v:k}})},trace=function(items,byItem,byMenu,finish){return readOptFrom$1(byMenu,finish).bind(function(triggerItem){return readOptFrom$1(items,triggerItem).bind(function(triggerMenu){var rest=trace(items,byItem,byMenu,triggerMenu);return Option.some([triggerMenu].concat(rest))})}).getOr([])},generate$5=function(menus,expansions){var items={};each$1(menus,function(menuItems,menu){each(menuItems,function(item){items[item]=menu})});var byItem=expansions,byMenu=transpose(expansions),menuPaths=map$1(byMenu,function(_triggerItem,submenu){return[submenu].concat(trace(items,byItem,byMenu,submenu))});return map$1(items,function(menu){return readOptFrom$1(menuPaths,menu).getOr([menu])})},init$3=function(){var expansions=Cell({}),menus=Cell({}),paths=Cell({}),primary=Cell(Option.none()),directory=Cell({}),clear=function(){expansions.set({}),menus.set({}),paths.set({}),primary.set(Option.none())},isClear=function(){return primary.get().isNone()},setMenuBuilt=function(menuName,built){var _a;menus.set(__assign({},menus.get(),(_a={},_a[menuName]={type:"prepared",menu:built},_a)))},setContents=function(sPrimary,sMenus,sExpansions,dir){primary.set(Option.some(sPrimary)),expansions.set(sExpansions),menus.set(sMenus),directory.set(dir);var sPaths=generate$5(dir,sExpansions);paths.set(sPaths)},expand=function(itemValue){return readOptFrom$1(expansions.get(),itemValue).map(function(menu){var current=readOptFrom$1(paths.get(),itemValue).getOr([]);return[menu].concat(current)})},collapse=function(itemValue){return readOptFrom$1(paths.get(),itemValue).bind(function(path){return path.length>1?Option.some(path.slice(1)):Option.none()})},refresh=function(itemValue){return readOptFrom$1(paths.get(),itemValue)},lookupMenu=function(menuValue){return readOptFrom$1(menus.get(),menuValue)},otherMenus=function(path){var menuValues=directory.get();return difference(keys(menuValues),path)},getPrimary=function(){return primary.get().bind(function(primaryName){return lookupMenu(primaryName).bind(function(prep){return"prepared"===prep.type?Option.some(prep.menu):Option.none()})})},getMenus=function(){return menus.get()};return{setMenuBuilt:setMenuBuilt,setContents:setContents,expand:expand,refresh:refresh,collapse:collapse,lookupMenu:lookupMenu,otherMenus:otherMenus,getPrimary:getPrimary,getMenus:getMenus,clear:clear,isClear:isClear}},LayeredState={init:init$3},make$2=function(detail,rawUiSpec){var ExpandHighlightDecision,submenuParentItems=Cell(Option.none()),buildMenus=function(container,primaryName,menus){return map$1(menus,function(spec,name){var makeSketch=function(){return Menu.sketch(__assign({dom:spec.dom},spec,{value:name,items:spec.items,markers:detail.markers,fakeFocus:detail.fakeFocus,onHighlight:detail.onHighlight,focusManager:detail.fakeFocus?highlights():dom()}))};return name===primaryName?{type:"prepared",menu:container.getSystem().build(makeSketch())}:{type:"notbuilt",nbMenu:makeSketch}})},layeredState=LayeredState.init(),setup=function(container){var componentMap=buildMenus(container,detail.data.primary,detail.data.menus),directory=toDirectory();return layeredState.setContents(detail.data.primary,componentMap,detail.data.expansions,directory),layeredState.getPrimary()},getItemValue=function(item){return Representing.getValue(item).value},toDirectory=function(container){return map$1(detail.data.menus,function(data,menuName){return bind(data.items,function(item){return"separator"===item.type?[]:[item.data.value]})})},setActiveMenu=function(container,menu){Highlighting.highlight(container,menu),Highlighting.getHighlighted(menu).orThunk(function(){return Highlighting.getFirst(menu)}).each(function(item){dispatch(container,item.element(),focusItem())})},getMenus=function(state,menuValues){return cat(map(menuValues,function(mv){return state.lookupMenu(mv).bind(function(prep){return"prepared"===prep.type?Option.some(prep.menu):Option.none()})}))},closeOthers=function(container,state,path){var others=getMenus(state,state.otherMenus(path));each(others,function(o){remove$5(o.element(),[detail.markers.backgroundMenu]),detail.stayInDom||Replacing.remove(container,o)})},getSubmenuParents=function(container){return submenuParentItems.get().getOrThunk(function(){var r={},items=descendants(container.element(),"."+detail.markers.item),parentItems=filter(items,function(i){return"true"===get$2(i,"aria-haspopup")});return each(parentItems,function(i){container.getSystem().getByDom(i).each(function(itemComp){var key=getItemValue(itemComp);r[key]=itemComp})}),submenuParentItems.set(Option.some(r)),r})},updateAriaExpansions=function(container,path){var parentItems=getSubmenuParents(container);each$1(parentItems,function(v,k){var expanded=contains(path,k);set$1(v.element(),"aria-expanded",expanded)})},updateMenuPath=function(container,state,path){return Option.from(path[0]).bind(function(latestMenuName){return state.lookupMenu(latestMenuName).bind(function(menuPrep){if("notbuilt"===menuPrep.type)return Option.none();var activeMenu=menuPrep.menu,rest=getMenus(state,path.slice(1));return each(rest,function(r){add$2(r.element(),detail.markers.backgroundMenu)}),inBody(activeMenu.element())||Replacing.append(container,premade$1(activeMenu)),remove$5(activeMenu.element(),[detail.markers.backgroundMenu]),setActiveMenu(container,activeMenu),closeOthers(container,state,path),Option.some(activeMenu)})})};(function(ExpandHighlightDecision){ExpandHighlightDecision[ExpandHighlightDecision.HighlightSubmenu=0]="HighlightSubmenu",ExpandHighlightDecision[ExpandHighlightDecision.HighlightParent=1]="HighlightParent"})(ExpandHighlightDecision||(ExpandHighlightDecision={}));var buildIfRequired=function(container,menuName,menuPrep){if("notbuilt"===menuPrep.type){var menu=container.getSystem().build(menuPrep.nbMenu());return layeredState.setMenuBuilt(menuName,menu),menu}return menuPrep.menu},expandRight=function(container,item,decision){void 0===decision&&(decision=ExpandHighlightDecision.HighlightSubmenu);var value=getItemValue(item);return layeredState.expand(value).bind(function(path){return updateAriaExpansions(container,path),Option.from(path[0]).bind(function(menuName){return layeredState.lookupMenu(menuName).bind(function(activeMenuPrep){var activeMenu=buildIfRequired(container,menuName,activeMenuPrep);return inBody(activeMenu.element())||Replacing.append(container,premade$1(activeMenu)),detail.onOpenSubmenu(container,item,activeMenu),decision===ExpandHighlightDecision.HighlightSubmenu?(Highlighting.highlightFirst(activeMenu),updateMenuPath(container,layeredState,path)):(Highlighting.dehighlightAll(activeMenu),Option.some(item))})})})},collapseLeft=function(container,item){var value=getItemValue(item);return layeredState.collapse(value).bind(function(path){return updateAriaExpansions(container,path),updateMenuPath(container,layeredState,path).map(function(activeMenu){return detail.onCollapseMenu(container,item,activeMenu),activeMenu})})},updateView=function(container,item){var value=getItemValue(item);return layeredState.refresh(value).bind(function(path){return updateAriaExpansions(container,path),updateMenuPath(container,layeredState,path)})},onRight=function(container,item){return inside(item.element())?Option.none():expandRight(container,item,ExpandHighlightDecision.HighlightSubmenu)},onLeft=function(container,item){return inside(item.element())?Option.none():collapseLeft(container,item)},onEscape=function(container,item){return collapseLeft(container,item).orThunk(function(){return detail.onEscape(container,item).map(function(){return container})})},keyOnItem=function(f){return function(container,simulatedEvent){return closest$3(simulatedEvent.getSource(),"."+detail.markers.item).bind(function(target){return container.getSystem().getByDom(target).toOption().bind(function(item){return f(container,item).map(function(){return!0})})})}},events=derive([run(focus$4(),function(sandbox,simulatedEvent){var menu=simulatedEvent.event().menu();Highlighting.highlight(sandbox,menu);var value=getItemValue(simulatedEvent.event().item());layeredState.refresh(value).each(function(path){return closeOthers(sandbox,layeredState,path)})}),runOnExecute(function(component,simulatedEvent){var target=simulatedEvent.event().target();component.getSystem().getByDom(target).each(function(item){var itemValue=getItemValue(item);0===itemValue.indexOf("collapse-item")&&collapseLeft(component,item),expandRight(component,item,ExpandHighlightDecision.HighlightSubmenu).fold(function(){detail.onExecute(component,item)},function(){})})}),runOnAttached(function(container,simulatedEvent){setup(container).each(function(primary){Replacing.append(container,premade$1(primary)),detail.onOpenMenu(container,primary),detail.highlightImmediately&&setActiveMenu(container,primary)})})].concat(detail.navigateOnHover?[run(hover(),function(sandbox,simulatedEvent){var item=simulatedEvent.event().item();updateView(sandbox,item),expandRight(sandbox,item,ExpandHighlightDecision.HighlightParent),detail.onHover(sandbox,item)})]:[])),collapseMenuApi=function(container){Highlighting.getHighlighted(container).each(function(currentMenu){Highlighting.getHighlighted(currentMenu).each(function(currentItem){collapseLeft(container,currentItem)})})},highlightPrimary=function(container){layeredState.getPrimary().each(function(primary){setActiveMenu(container,primary)})},apis={collapseMenu:collapseMenuApi,highlightPrimary:highlightPrimary};return{uid:detail.uid,dom:detail.dom,markers:detail.markers,behaviours:augment(detail.tmenuBehaviours,[Keying.config({mode:"special",onRight:keyOnItem(onRight),onLeft:keyOnItem(onLeft),onEscape:keyOnItem(onEscape),focusIn:function(container,keyInfo){layeredState.getPrimary().each(function(primary){dispatch(container,primary.element(),focusItem())})}}),Highlighting.config({highlightClass:detail.markers.selectedMenu,itemClass:detail.markers.menu}),Composing.config({find:function(container){return Highlighting.getHighlighted(container)}}),Replacing.config({})]),eventOrder:detail.eventOrder,apis:apis,events:events}},collapseItem=constant("collapse-item"),tieredData=function(primary,menus,expansions){return{primary:primary,menus:menus,expansions:expansions}},singleData=function(name,menu){return{primary:name,menus:wrap$1(name,menu),expansions:{}}},collapseItem$1=function(text){return{value:generate$1(collapseItem()),meta:{text:text}}},tieredMenu=single$2({name:"TieredMenu",configFields:[onStrictKeyboardHandler("onExecute"),onStrictKeyboardHandler("onEscape"),onStrictHandler("onOpenMenu"),onStrictHandler("onOpenSubmenu"),onHandler("onCollapseMenu"),defaulted$1("highlightImmediately",!0),strictObjOf("data",[strict$1("primary"),strict$1("menus"),strict$1("expansions")]),defaulted$1("fakeFocus",!1),onHandler("onHighlight"),onHandler("onHover"),tieredMenuMarkers(),strict$1("dom"),defaulted$1("navigateOnHover",!0),defaulted$1("stayInDom",!1),field$1("tmenuBehaviours",[Keying,Highlighting,Composing,Replacing]),defaulted$1("eventOrder",{})],apis:{collapseMenu:function(apis,tmenu){apis.collapseMenu(tmenu)},highlightPrimary:function(apis,tmenu){apis.highlightPrimary(tmenu)}},factory:make$2,extraApis:{tieredData:tieredData,singleData:singleData,collapseItem:collapseItem$1}}),makeMenu=function(detail,menuSandbox,anchor,menuSpec){var lazySink=function(){return detail.lazySink(menuSandbox)};return tieredMenu.sketch({dom:{tag:"div"},data:menuSpec.data,markers:menuSpec.menu.markers,onEscape:function(){return Sandboxing.close(menuSandbox),detail.onEscape.map(function(handler){return handler(menuSandbox)}),Option.some(!0)},onExecute:function(){return Option.some(!0)},onOpenMenu:function(tmenu,menu){Positioning.position(lazySink().getOrDie(),anchor,menu)},onOpenSubmenu:function(tmenu,item,submenu){var sink=lazySink().getOrDie();Positioning.position(sink,{anchor:"submenu",item:item},submenu)}})},factory=function(detail,spec){var isPartOfRelated=function(sandbox,queryElem){var related=detail.getRelated(sandbox);return related.exists(function(rel){return isPartOf(rel,queryElem)})},setContent=function(sandbox,thing){Sandboxing.open(sandbox,thing)},showAt=function(sandbox,anchor,thing){var getBounds=Option.none();showWithin(sandbox,anchor,thing,getBounds)},showWithin=function(sandbox,anchor,thing,boxElement){var sink=detail.lazySink(sandbox).getOrDie();Sandboxing.openWhileCloaked(sandbox,thing,function(){return Positioning.positionWithin(sink,anchor,sandbox,boxElement)}),detail.onShow(sandbox)},showWithinBounds=function(sandbox,anchor,thing,bounds){var sink=detail.lazySink(sandbox).getOrDie();Sandboxing.openWhileCloaked(sandbox,thing,function(){return Positioning.positionWithinBounds(sink,anchor,sandbox,bounds)}),detail.onShow(sandbox)},showMenuAt=function(sandbox,anchor,menuSpec){var menu=makeMenu(detail,sandbox,anchor,menuSpec);Sandboxing.open(sandbox,menu),detail.onShow(sandbox)},hide=function(sandbox){Sandboxing.close(sandbox),detail.onHide(sandbox)},getContent=function(sandbox){return Sandboxing.getState(sandbox)},apis={setContent:setContent,showAt:showAt,showWithin:showWithin,showWithinBounds:showWithinBounds,showMenuAt:showMenuAt,hide:hide,getContent:getContent,isOpen:Sandboxing.isOpen};return{uid:detail.uid,dom:detail.dom,behaviours:augment(detail.inlineBehaviours,[Sandboxing.config({isPartOf:function(sandbox,data,queryElem){return isPartOf(data,queryElem)||isPartOfRelated(sandbox,queryElem)},getAttachPoint:function(sandbox){return detail.lazySink(sandbox).getOrDie()}}),receivingConfig(__assign({isExtraPart:constant(!1)},detail.fireDismissalEventInstead.map(function(fe){return{fireEventInstead:{event:fe.event}}}).getOr({})))]),eventOrder:detail.eventOrder,apis:apis}},InlineView=single$2({name:"InlineView",configFields:[strict$1("lazySink"),onHandler("onShow"),onHandler("onHide"),optionFunction("onEscape"),field$1("inlineBehaviours",[Sandboxing,Receiving]),optionObjOf("fireDismissalEventInstead",[defaulted$1("event",dismissRequested())]),defaulted$1("getRelated",Option.none),defaulted$1("eventOrder",Option.none)],factory:factory,apis:{showAt:function(apis,component,anchor,thing){apis.showAt(component,anchor,thing)},showWithin:function(apis,component,anchor,thing,boxElement){apis.showWithin(component,anchor,thing,boxElement)},showWithinBounds:function(apis,component,anchor,thing,bounds){apis.showWithinBounds(component,anchor,thing,bounds)},showMenuAt:function(apis,component,anchor,menuSpec){apis.showMenuAt(component,anchor,menuSpec)},hide:function(apis,component){apis.hide(component)},isOpen:function(apis,component){return apis.isOpen(component)},getContent:function(apis,component){return apis.getContent(component)},setContent:function(apis,component,thing){apis.setContent(component,thing)}}}),events$7=function(optAction){var executeHandler=function(action){return run(execute(),function(component,simulatedEvent){action(component),simulatedEvent.stop()})},onClick=function(component,simulatedEvent){simulatedEvent.stop(),emitExecute(component)},onMousedown=function(component,simulatedEvent){simulatedEvent.cut()},pointerEvents=PlatformDetection$1.detect().deviceType.isTouch()?[run(tap(),onClick)]:[run(click(),onClick),run(mousedown(),onMousedown)];return derive(flatten([optAction.map(executeHandler).toArray(),pointerEvents]))},factory$1=function(detail){var events=events$7(detail.action),tag=detail.dom.tag,lookupAttr=function(attr){return readOptFrom$1(detail.dom,"attributes").bind(function(attrs){return readOptFrom$1(attrs,attr)})},getModAttributes=function(){if("button"===tag){var type=lookupAttr("type").getOr("button"),roleAttrs=lookupAttr("role").map(function(role){return{role:role}}).getOr({});return __assign({type:type},roleAttrs)}var role=lookupAttr("role").getOr("button");return{role:role}};return{uid:detail.uid,dom:detail.dom,components:detail.components,events:events,behaviours:SketchBehaviours.augment(detail.buttonBehaviours,[Focusing.config({}),Keying.config({mode:"execution",useSpace:!0,useEnter:!0})]),domModification:{attributes:getModAttributes()},eventOrder:detail.eventOrder}},Button=single$2({name:"Button",factory:factory$1,configFields:[defaulted$1("uid",void 0),strict$1("dom"),defaulted$1("components",[]),SketchBehaviours.field("buttonBehaviours",[Focusing,Keying]),option("action"),option("role"),defaulted$1("eventOrder",{})]}),record=function(spec){var uid=isSketchSpec(spec)&&hasKey$1(spec,"uid")?spec.uid:generate$2("memento"),get=function(anyInSystem){return anyInSystem.getSystem().getByUid(uid).getOrDie()},getOpt=function(anyInSystem){return anyInSystem.getSystem().getByUid(uid).fold(Option.none,Option.some)},asSpec=function(){return __assign({},spec,{uid:uid})};return{get:get,getOpt:getOpt,asSpec:asSpec}},defaultIcon=function(icons){return Option.from(icons()["temporary-placeholder"]).getOr("!not found!")},get$c=function(name,icons){return Option.from(icons()[name]).getOrThunk(function(){return defaultIcon(icons)})},getOr=function(name,icons,fallback){return Option.from(icons()[name]).or(fallback).getOrThunk(function(){return defaultIcon(icons)})},getFirst$1=function(names,icons){return findMap(names,function(name){return Option.from(icons()[name])}).getOrThunk(function(){return defaultIcon(icons)})},notificationIconMap={success:"checkmark",error:"warning",err:"error",warning:"warning",warn:"warning",info:"info"},factory$2=function(detail){var memBannerText=record({dom:{tag:"p",innerHtml:detail.translationProvider(detail.text)},behaviours:derive$1([Replacing.config({})])}),renderPercentBar=function(percent){return{dom:{tag:"div",classes:["tox-bar"],attributes:{style:"width: "+percent+"%"}}}},renderPercentText=function(percent){return{dom:{tag:"div",classes:["tox-text"],innerHtml:percent+"%"}}},memBannerProgress=record({dom:{tag:"div",classes:detail.progress?["tox-progress-bar","tox-progress-indicator"]:["tox-progress-bar"]},components:[{dom:{tag:"div",classes:["tox-bar-container"]},components:[renderPercentBar(0)]},renderPercentText(0)],behaviours:derive$1([Replacing.config({})])}),updateProgress=function(comp,percent){comp.getSystem().isConnected()&&memBannerProgress.getOpt(comp).each(function(progress){Replacing.set(progress,[{dom:{tag:"div",classes:["tox-bar-container"]},components:[renderPercentBar(percent)]},renderPercentText(percent)])})},updateText=function(comp,text$1){if(comp.getSystem().isConnected()){var banner=memBannerText.get(comp);Replacing.set(banner,[text(text$1)])}},apis={updateProgress:updateProgress,updateText:updateText},iconChoices=flatten([detail.icon.toArray(),detail.level.toArray(),detail.level.bind(function(level){return Option.from(notificationIconMap[level])}).toArray()]);return{uid:detail.uid,dom:{tag:"div",attributes:{role:"alert"},classes:detail.level.map(function(level){return["tox-notification","tox-notification--in","tox-notification--"+level]}).getOr(["tox-notification","tox-notification--in"])},components:[{dom:{tag:"div",classes:["tox-notification__icon"],innerHtml:getFirst$1(iconChoices,detail.iconProvider)}},{dom:{tag:"div",classes:["tox-notification__body"]},components:[memBannerText.asSpec()],behaviours:derive$1([Replacing.config({})])}].concat(detail.progress?[memBannerProgress.asSpec()]:[]).concat(Button.sketch({dom:{tag:"button",classes:["tox-notification__dismiss","tox-button","tox-button--naked","tox-button--icon"]},components:[{dom:{tag:"div",classes:["tox-icon"],innerHtml:get$c("close",detail.iconProvider),attributes:{"aria-label":detail.translationProvider("Close")}}}],action:function(comp){detail.onAction(comp)}})),apis:apis}},Notification=single$2({name:"Notification",factory:factory$2,configFields:[option("level"),strict$1("progress"),strict$1("icon"),strict$1("onAction"),strict$1("text"),strict$1("iconProvider"),strict$1("translationProvider")],apis:{updateProgress:function(apis,comp,percent){apis.updateProgress(comp,percent)},updateText:function(apis,comp,text){apis.updateText(comp,text)}}}),global$2=tinymce.util.Tools.resolve("tinymce.util.Delay"),last$2=function(fn,rate){var timer=null,cancel=function(){null!==timer&&(domGlobals.clearTimeout(timer),timer=null)},throttle=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];null!==timer&&domGlobals.clearTimeout(timer),timer=domGlobals.setTimeout(function(){fn.apply(null,args),timer=null},rate)};return{cancel:cancel,throttle:throttle}},global$3=tinymce.util.Tools.resolve("tinymce.dom.TreeWalker"),isText$1=function(node){return node.nodeType===domGlobals.Node.TEXT_NODE},outcome$1=Adt.generate([{aborted:[]},{edge:["element"]},{success:["info"]}]),phase=Adt.generate([{abort:[]},{kontinue:[]},{finish:["info"]}]),repeat=function(dom,node,offset,process,walker,recent){var terminate=function(){return recent.fold(outcome$1.aborted,outcome$1.edge)},recurse=function(){var next=walker();return next?repeat(dom,next,Option.none(),process,walker,Option.some(node)):terminate()};if(dom.isBlock(node))return terminate();if(isText$1(node)){var text=node.textContent;return process(phase,node,text,offset).fold(outcome$1.aborted,function(){return recurse()},outcome$1.success)}return recurse()},repeatLeft=function(dom,node,offset,process,rootNode){var walker=new global$3(node,rootNode||dom.getRoot());return repeat(dom,node,Option.some(offset),process,walker.prev,Option.none())},autocompleteSelector="[data-mce-autocompleter]",create$4=function(editor,range){return detect$4(Element.fromDom(editor.selection.getNode())).getOrThunk(function(){var wrapper=Element.fromHtml('<span data-mce-autocompleter="1" data-mce-bogus="1"></span>',editor.getDoc());return append(wrapper,Element.fromDom(range.extractContents())),range.insertNode(wrapper.dom()),parent(wrapper).each(function(elm){return elm.dom().normalize()}),last$1(wrapper).map(function(last){editor.selection.setCursorLocation(last.dom(),getEnd(last))}),wrapper})},detect$4=function(elm){return closest$3(elm,autocompleteSelector)},isValidTextRange=function(rng){return rng.collapsed&&3===rng.startContainer.nodeType},whiteSpace=/[\u00a0 \t\r\n]/,parse=function(text,index,ch,minChars){var i;for(i=index-1;i>=0;i--){var char=text.charAt(i);if(whiteSpace.test(char))return Option.none();if(char===ch)break}return-1===i||index-i<minChars?Option.none():Option.some(text.substring(i+1,index))},getText=function(rng,ch){var text=rng.toString().substring(ch.length);return text.replace(/\u00A0/g," ").replace(/\uFEFF/g,"")},findStart=function(dom,initRange,ch,minChars){if(void 0===minChars&&(minChars=0),!isValidTextRange(initRange))return Option.none();var findTriggerCh=function(phase,element,text,optOffset){var index=optOffset.getOr(text.length);return parse(text,index,ch,1).fold(function(){return text.match(whiteSpace)?phase.abort():phase.kontinue()},function(newText){var range=initRange.cloneRange();return range.setStart(element,index-newText.length-1),range.setEnd(initRange.endContainer,initRange.endOffset),text.length<minChars?phase.abort():phase.finish({text:getText(range,ch),range:range,triggerChar:ch})})};return repeatLeft(dom,initRange.startContainer,initRange.startOffset,findTriggerCh).fold(Option.none,Option.none,Option.some)},getContext=function(dom,initRange,ch,minChars){return void 0===minChars&&(minChars=0),detect$4(Element.fromDom(initRange.startContainer)).fold(function(){return findStart(dom,initRange,ch,minChars)},function(elm){var range=dom.createRng();return range.selectNode(elm.dom()),Option.some({range:range,text:getText(range,ch),triggerChar:ch})})},setup=function(api,editor){editor.on("keypress compositionend",api.onKeypress.throttle),editor.on("remove",api.onKeypress.cancel)
;var redirectKeyToItem=function(item,e){emitWith(item,keydown(),{raw:e})};editor.on("keydown",function(e){var getItem=function(){return api.getView().bind(Highlighting.getHighlighted)};8===e.which&&api.onKeypress.throttle(e),api.isActive()&&(27===e.which&&api.cancelIfNecessary(),api.isMenuOpen()?13===e.which?(getItem().each(emitExecute),e.preventDefault()):40===e.which?(getItem().fold(function(){api.getView().each(Highlighting.highlightFirst)},function(item){redirectKeyToItem(item,e)}),e.preventDefault(),e.stopImmediatePropagation()):37!==e.which&&38!==e.which&&39!==e.which||getItem().each(function(item){redirectKeyToItem(item,e),e.preventDefault(),e.stopImmediatePropagation()}):13!==e.which&&38!==e.which&&40!==e.which||api.cancelIfNecessary())}),editor.on("NodeChange",function(e){api.isActive()&&detect$4(Element.fromDom(e.element)).isNone()&&api.cancelIfNecessary()})},AutocompleterEditorEvents={setup:setup},global$4=tinymce.util.Tools.resolve("tinymce.util.Promise"),point$2=function(element,offset){return{element:element,offset:offset}},isText$2=function(node){return node.nodeType===domGlobals.Node.TEXT_NODE},isElement$1=function(node){return node.nodeType===domGlobals.Node.ELEMENT_NODE},toLast=function(node){if(isText$2(node))return point$2(node,node.data.length);var children=node.childNodes;return children.length>0?toLast(children[children.length-1]):point$2(node,children.length)},toLeaf=function(node,offset){var children=node.childNodes;return children.length>0&&offset<children.length?toLeaf(children[offset],0):children.length>0&&isElement$1(node)&&children.length===offset?toLast(children[children.length-1]):point$2(node,offset)},isStartOfWord=function(dom){var process=function(phase,element,text,optOffset){var index=optOffset.getOr(text.length);return 0===index?phase.kontinue():phase.finish(/\s/.test(text.charAt(index-1)))};return function(rng){var leaf=toLeaf(rng.startContainer,rng.startOffset);return repeatLeft(dom,leaf.element,leaf.offset,process).fold(constant(!0),constant(!0),identity)}},getTriggerContext=function(dom,initRange,database){return findMap(database.triggerChars,function(ch){return getContext(dom,initRange,ch)})},lookup=function(editor,getDatabase){var database=getDatabase(),rng=editor.selection.getRng();return getTriggerContext(editor.dom,rng,database).bind(function(context){return lookupWithContext(editor,getDatabase,context)})},lookupWithContext=function(editor,getDatabase,context,fetchOptions){void 0===fetchOptions&&(fetchOptions={});var database=getDatabase(),rng=editor.selection.getRng(),startText=rng.startContainer.nodeValue,autocompleters=filter(database.lookupByChar(context.triggerChar),function(autocompleter){return context.text.length>=autocompleter.minChars&&autocompleter.matches.getOrThunk(function(){return isStartOfWord(editor.dom)})(context.range,startText,context.text)});if(0===autocompleters.length)return Option.none();var lookupData=global$4.all(map(autocompleters,function(ac){var fetchResult=ac.fetch(context.text,ac.maxResults,fetchOptions);return fetchResult.then(function(results){return{matchText:context.text,items:results,columns:ac.columns,onAction:ac.onAction}})}));return Option.some({lookupData:lookupData,context:context})},separatorMenuItemSchema=objOf([strictString("type"),optionString("text")]),createSeparatorMenuItem=function(spec){return asRaw("separatormenuitem",separatorMenuItemSchema,spec)},autocompleterItemSchema=objOf([state$1("type",function(){return"autocompleteitem"}),state$1("active",function(){return!1}),state$1("disabled",function(){return!1}),defaulted$1("meta",{}),strictString("value"),optionString("text"),optionString("icon")]),autocompleterSchema=objOf([strictString("type"),strictString("ch"),defaultedNumber("minChars",1),defaulted$1("columns",1),defaultedNumber("maxResults",10),optionFunction("matches"),strictFunction("fetch"),strictFunction("onAction")]),createSeparatorItem=function(spec){return asRaw("Autocompleter.Separator",separatorMenuItemSchema,spec)},createAutocompleterItem=function(spec){return asRaw("Autocompleter.Item",autocompleterItemSchema,spec)},createAutocompleter=function(spec){return asRaw("Autocompleter",autocompleterSchema,spec)},stringArray=function(a){var all={};return each(a,function(key){all[key]={}}),keys(all)},register=function(editor){var popups=editor.ui.registry.getAll().popups,dataset=map$1(popups,function(popup){return createAutocompleter(popup).fold(function(err){throw new Error(formatError(err))},function(x){return x})}),triggerChars=stringArray(mapToArray(dataset,function(v){return v.ch})),datasetValues=values(dataset),lookupByChar=function(ch){return filter(datasetValues,function(dv){return dv.ch===ch})};return{dataset:dataset,triggerChars:triggerChars,lookupByChar:lookupByChar}},commonMenuItemFields=[defaultedBoolean("disabled",!1),optionString("text"),optionString("shortcut"),field("value","value",defaultedThunk(function(){return generate$1("menuitem-value")}),anyValue$1()),defaulted$1("meta",{})],menuItemSchema=objOf([strictString("type"),defaultedFunction("onSetup",function(){return noop}),defaultedFunction("onAction",noop),optionString("icon")].concat(commonMenuItemFields)),createMenuItem=function(spec){return asRaw("menuitem",menuItemSchema,spec)},nestedMenuItemSchema=objOf([strictString("type"),strictFunction("getSubmenuItems"),defaultedFunction("onSetup",function(){return noop}),optionString("icon")].concat(commonMenuItemFields)),createNestedMenuItem=function(spec){return asRaw("nestedmenuitem",nestedMenuItemSchema,spec)},toggleMenuItemSchema=objOf([strictString("type"),defaultedBoolean("active",!1),defaultedFunction("onSetup",function(){return noop}),strictFunction("onAction")].concat(commonMenuItemFields)),createToggleMenuItem=function(spec){return asRaw("togglemenuitem",toggleMenuItemSchema,spec)},choiceMenuItemSchema=objOf([strictString("type"),defaultedBoolean("active",!1),optionString("icon")].concat(commonMenuItemFields)),createChoiceMenuItem=function(spec){return asRaw("choicemenuitem",choiceMenuItemSchema,spec)},fancyTypes=["inserttable","colorswatch"],fancyMenuItemSchema=objOf([strictString("type"),strictStringEnum("fancytype",fancyTypes),defaultedFunction("onAction",noop)]),createFancyMenuItem=function(spec){return asRaw("fancymenuitem",fancyMenuItemSchema,spec)},detectSize=function(comp,margin,selectorClass){var descendants$1=descendants(comp.element(),"."+selectorClass);if(descendants$1.length>0){var columnLength=findIndex(descendants$1,function(c){var thisTop=c.dom().getBoundingClientRect().top,cTop=descendants$1[0].dom().getBoundingClientRect().top;return Math.abs(thisTop-cTop)>margin}).getOr(descendants$1.length);return Option.some({numColumns:columnLength,numRows:Math.ceil(descendants$1.length/columnLength)})}return Option.none()},namedEvents=function(name,handlers){return derive$1([config(name,handlers)])},unnamedEvents=function(handlers){return namedEvents(generate$1("unnamed-events"),handlers)},SimpleBehaviours={namedEvents:namedEvents,unnamedEvents:unnamedEvents},TooltippingSchema=[strict$1("lazySink"),strict$1("tooltipDom"),defaulted$1("exclusive",!0),defaulted$1("tooltipComponents",[]),defaulted$1("delay",300),defaultedStringEnum("mode","normal",["normal","follow-highlight"]),defaulted$1("anchor",function(comp){return{anchor:"hotspot",hotspot:comp,layouts:{onLtr:constant([south$1,north$1,southeast$1,northeast$1,southwest$1,northwest$1]),onRtl:constant([south$1,north$1,southeast$1,northeast$1,southwest$1,northwest$1])}}}),onHandler("onHide"),onHandler("onShow")],init$4=function(){var timer=Cell(Option.none()),popup=Cell(Option.none()),getTooltip=function(){return popup.get()},setTooltip=function(s){popup.set(Option.some(s))},clearTooltip=function(){popup.set(Option.none())},clearTimer=function(){timer.get().each(function(t){domGlobals.clearTimeout(t)})},resetTimer=function(f,delay){clearTimer(),timer.set(Option.some(domGlobals.setTimeout(function(){f()},delay)))},isShowing=function(){return popup.get().isSome()},readState=constant("not-implemented");return nu$5({getTooltip:getTooltip,isShowing:isShowing,setTooltip:setTooltip,clearTooltip:clearTooltip,clearTimer:clearTimer,resetTimer:resetTimer,readState:readState})},TooltippingState=Object.freeze({init:init$4}),ExclusivityChannel=generate$1("tooltip.exclusive"),ShowTooltipEvent=generate$1("tooltip.show"),HideTooltipEvent=generate$1("tooltip.hide"),hideAllExclusive=function(component,tConfig,tState){component.getSystem().broadcastOn([ExclusivityChannel],{})},setComponents=function(component,tConfig,tState,specs){tState.getTooltip().each(function(tooltip){tooltip.getSystem().isConnected()&&Replacing.set(tooltip,specs)})},TooltippingApis=Object.freeze({hideAllExclusive:hideAllExclusive,setComponents:setComponents}),events$8=function(tooltipConfig,state){var hide=function(comp){state.getTooltip().each(function(p){detach(p),tooltipConfig.onHide(comp,p),state.clearTooltip()}),state.clearTimer()},show=function(comp){if(!state.isShowing()){hideAllExclusive(comp);var sink=tooltipConfig.lazySink(comp).getOrDie(),popup=comp.getSystem().build({dom:tooltipConfig.tooltipDom,components:tooltipConfig.tooltipComponents,events:derive("normal"===tooltipConfig.mode?[run(mouseover(),function(_){emit(comp,ShowTooltipEvent)}),run(mouseout(),function(_){emit(comp,HideTooltipEvent)})]:[]),behaviours:derive$1([Replacing.config({})])});state.setTooltip(popup),attach(sink,popup),tooltipConfig.onShow(comp,popup),Positioning.position(sink,tooltipConfig.anchor(comp),popup)}};return derive(flatten([[run(ShowTooltipEvent,function(comp){state.resetTimer(function(){show(comp)},tooltipConfig.delay)}),run(HideTooltipEvent,function(comp){state.resetTimer(function(){hide(comp)},tooltipConfig.delay)}),run(receive(),function(comp,message){var receivingData=message;contains(receivingData.channels(),ExclusivityChannel)&&hide(comp)}),runOnDetached(function(comp){hide(comp)})],"normal"===tooltipConfig.mode?[run(focusin(),function(comp){emit(comp,ShowTooltipEvent)}),run(postBlur(),function(comp){emit(comp,HideTooltipEvent)}),run(mouseover(),function(comp){emit(comp,ShowTooltipEvent)}),run(mouseout(),function(comp){emit(comp,HideTooltipEvent)})]:[run(highlight(),function(comp,se){emit(comp,ShowTooltipEvent)}),run(dehighlight(),function(comp){emit(comp,HideTooltipEvent)})]]))},ActiveTooltipping=Object.freeze({events:events$8}),Tooltipping=create$1({fields:TooltippingSchema,name:"tooltipping",active:ActiveTooltipping,state:TooltippingState,apis:TooltippingApis}),getAttrs=function(elem){var attributes=void 0!==elem.dom().attributes?elem.dom().attributes:[];return foldl(attributes,function(b,attr){var _a;return"class"===attr.name?b:__assign({},b,(_a={},_a[attr.name]=attr.value,_a))},{})},getClasses=function(elem){return Array.prototype.slice.call(elem.dom().classList,0)},fromHtml$2=function(html){var elem=Element.fromHtml(html),children$1=children(elem),attrs=getAttrs(elem),classes=getClasses(elem),contents=0===children$1.length?{}:{innerHtml:get$1(elem)};return __assign({tag:name(elem),classes:classes,attributes:attrs},contents)},global$5=tinymce.util.Tools.resolve("tinymce.util.I18n"),navClass="tox-menu-nav__js",selectableClass="tox-collection__item",colorClass="tox-swatch",presetClasses={normal:navClass,color:colorClass},tickedClass="tox-collection__item--enabled",groupHeadingClass="tox-collection__group-heading",iconClass="tox-collection__item-icon",textClass="tox-collection__item-label",accessoryClass="tox-collection__item-accessory",caretClass="tox-collection__item-caret",checkmarkClass="tox-collection__item-checkmark",activeClass="tox-collection__item--active",iconClassRtl="tox-collection__item-icon-rtl",classForPreset=function(presets){return readOptFrom$1(presetClasses,presets).getOr(navClass)},global$6=tinymce.util.Tools.resolve("tinymce.Env"),convertText=function(source){var mac={alt:"&#x2325;",ctrl:"&#x2303;",shift:"&#x21E7;",meta:"&#x2318;",access:"&#x2303;&#x2325;"},other={meta:"Ctrl",access:"Shift+Alt"},replace=global$6.mac?mac:other,shortcut=source.split("+"),updated=map(shortcut,function(segment){var search=segment.toLowerCase().trim();return has(replace,search)?replace[search]:segment});return global$6.mac?updated.join(""):updated.join("+")},ConvertShortcut={convertText:convertText},renderIcon=function(iconHtml){return{dom:{tag:"div",classes:[iconClass],innerHtml:iconHtml}}},renderText=function(text$1){return{dom:{tag:"div",classes:[textClass]},components:[text(global$5.translate(text$1))]}},renderHtml=function(html){return{dom:{tag:"div",classes:[textClass],innerHtml:html}}},renderStyledText=function(style,text$1){return{dom:{tag:"div",classes:[textClass]},components:[{dom:{tag:style.tag,attributes:{style:style.styleAttr}},components:[text(global$5.translate(text$1))]}]}},renderShortcut=function(shortcut){return{dom:{tag:"div",classes:[accessoryClass],innerHtml:ConvertShortcut.convertText(shortcut)}}},renderCheckmark=function(icons){return{dom:{tag:"div",classes:[iconClass,checkmarkClass],innerHtml:get$c("checkmark",icons)}}},renderSubmenuCaret=function(icons){return{dom:{tag:"div",classes:[caretClass],innerHtml:get$c("chevron-right",icons)}}},renderColorStructure=function(itemText,itemValue,iconSvg,providerBackstage){var colorPickerCommand="custom",removeColorCommand="remove",getDom=function(){var common=colorClass,icon=iconSvg.getOr(""),title=itemText.map(function(text){return' title="'+providerBackstage.translate(text)+'"'}).getOr("");return fromHtml$2(itemValue===colorPickerCommand?'<button class="'+common+' tox-swatches__picker-btn"'+title+">"+icon+"</button>":itemValue===removeColorCommand?'<div class="'+common+' tox-swatch--remove"'+title+">"+icon+"</div>":'<div class="'+common+'" style="background-color: '+itemValue+'" data-mce-color="'+itemValue+'"'+title+"></div>")};return{dom:getDom(),optComponents:[]}},renderNormalItemStructure=function(info,icon,renderIcons,textRender,rtlClass){var leftIcon=renderIcons?info.checkMark.orThunk(function(){return icon.or(Option.some("")).map(renderIcon)}):Option.none(),domTitle=info.ariaLabel.map(function(label){return{attributes:{title:global$5.translate(label)}}}).getOr({}),dom=merge({tag:"div",classes:[navClass,selectableClass].concat(rtlClass?[iconClassRtl]:[])},domTitle),content=info.htmlContent.fold(function(){return info.textContent.map(textRender)},function(html){return Option.some(renderHtml(html))}),menuItem={dom:dom,optComponents:[leftIcon,content,info.shortcutContent.map(renderShortcut),info.caret]};return menuItem},rtlIcon=["list-num-default","list-num-lower-alpha","list-num-lower-greek","list-num-lower-roman","list-num-upper-alpha","list-num-upper-roman"],rtlTransform=["list-bull-circle","list-bull-default","list-bull-square"],renderItemStructure=function(info,providersBackstage,renderIcons,fallbackIcon){void 0===fallbackIcon&&(fallbackIcon=Option.none());var getIconName=function(iconName){return iconName.map(function(name){return global$5.isRtl()&&contains(rtlIcon,name)?name+"-rtl":name})},needRtlClass=global$5.isRtl()&&info.iconContent.exists(function(name){return contains(rtlTransform,name)}),icon=getIconName(info.iconContent).map(function(iconName){return getOr(iconName,providersBackstage.icons,fallbackIcon)}),textRender=Option.from(info.meta).fold(function(){return renderText},function(meta){return has(meta,"style")?curry(renderStyledText,meta.style):renderText});return"color"===info.presets?renderColorStructure(info.ariaLabel,info.value,icon,providersBackstage):renderNormalItemStructure(info,icon,renderIcons,textRender,needRtlClass)},nativeDisabled=["input","button","textarea","select"],onLoad$5=function(component,disableConfig,disableState){disableConfig.disabled&&disable(component,disableConfig)},hasNative=function(component,config){return!0===config.useNative&&contains(nativeDisabled,name(component.element()))},nativeIsDisabled=function(component){return has$1(component.element(),"disabled")},nativeDisable=function(component){set$1(component.element(),"disabled","disabled")},nativeEnable=function(component){remove$1(component.element(),"disabled")},ariaIsDisabled=function(component){return"true"===get$2(component.element(),"aria-disabled")},ariaDisable=function(component){set$1(component.element(),"aria-disabled","true")},ariaEnable=function(component){set$1(component.element(),"aria-disabled","false")},disable=function(component,disableConfig,disableState){disableConfig.disableClass.each(function(disableClass){add$2(component.element(),disableClass)});var f=hasNative(component,disableConfig)?nativeDisable:ariaDisable;f(component),disableConfig.onDisabled(component)},enable=function(component,disableConfig,disableState){disableConfig.disableClass.each(function(disableClass){remove$4(component.element(),disableClass)});var f=hasNative(component,disableConfig)?nativeEnable:ariaEnable;f(component),disableConfig.onEnabled(component)},isDisabled=function(component,disableConfig){return hasNative(component,disableConfig)?nativeIsDisabled(component):ariaIsDisabled(component)},set$7=function(component,disableConfig,disableState,disabled){var f=disabled?disable:enable;f(component,disableConfig,disableState)},DisableApis=Object.freeze({enable:enable,disable:disable,isDisabled:isDisabled,onLoad:onLoad$5,set:set$7}),exhibit$3=function(base,disableConfig,disableState){return nu$6({classes:disableConfig.disabled?disableConfig.disableClass.map(pure).getOr([]):[]})},events$9=function(disableConfig,disableState){return derive([abort(execute(),function(component,simulatedEvent){return isDisabled(component,disableConfig)}),loadEvent(disableConfig,disableState,onLoad$5)])},ActiveDisable=Object.freeze({exhibit:exhibit$3,events:events$9}),DisableSchema=[defaulted$1("disabled",!1),defaulted$1("useNative",!0),option("disableClass"),onHandler("onDisabled"),onHandler("onEnabled")],Disabling=create$1({fields:DisableSchema,name:"disabling",active:ActiveDisable,apis:DisableApis}),item=function(disabled){return Disabling.config({disabled:disabled,disableClass:"tox-collection__item--state-disabled"})},button=function(disabled){return Disabling.config({disabled:disabled})},splitButton=function(disabled){return Disabling.config({disabled:disabled,disableClass:"tox-tbtn--disabled"})},toolbarButton=function(disabled){return Disabling.config({disabled:disabled,disableClass:"tox-tbtn--disabled",useNative:!1})},DisablingConfigs={item:item,button:button,splitButton:splitButton,toolbarButton:toolbarButton},runWithApi=function(info,comp){var api=info.getApi(comp);return function(f){f(api)}},onControlAttached=function(info,editorOffCell){return runOnAttached(function(comp){var run=runWithApi(info,comp);run(function(api){var onDestroy=info.onSetup(api);null!=onDestroy&&editorOffCell.set(onDestroy)})})},onControlDetached=function(getApi,editorOffCell){return runOnDetached(function(comp){return runWithApi(getApi,comp)(editorOffCell.get())})};(function(ItemResponse){ItemResponse[ItemResponse.CLOSE_ON_EXECUTE=0]="CLOSE_ON_EXECUTE",ItemResponse[ItemResponse.BUBBLE_TO_SANDBOX=1]="BUBBLE_TO_SANDBOX"})(ItemResponse||(ItemResponse={}));var FocusMode,ItemResponse$1=ItemResponse,onMenuItemExecute=function(info,itemResponse){return runOnExecute(function(comp,simulatedEvent){runWithApi(info,comp)(info.onAction),info.triggersSubmenu||itemResponse!==ItemResponse$1.CLOSE_ON_EXECUTE||(emit(comp,sandboxClose()),simulatedEvent.stop())})},menuItemEventOrder={"alloy.execute":["disabling","alloy.base.behaviour","toggling","item-events"]},componentRenderPipeline=function(xs){return bind(xs,function(o){return o.toArray()})},renderCommonItem=function(spec,structure,itemResponse){var editorOffCell=Cell(noop);return{type:"item",dom:structure.dom,components:componentRenderPipeline(structure.optComponents),data:spec.data,eventOrder:menuItemEventOrder,hasSubmenu:spec.triggersSubmenu,itemBehaviours:derive$1([config("item-events",[onMenuItemExecute(spec,itemResponse),onControlAttached(spec,editorOffCell),onControlDetached(spec,editorOffCell)]),DisablingConfigs.item(spec.disabled),Replacing.config({})].concat(spec.itemBehaviours))}},buildData=function(source){return{value:source.value,meta:merge({text:source.text.getOr("")},source.meta)}},global$7=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),tooltipBehaviour=function(meta,sharedBackstage){return get(meta,"tooltipWorker").map(function(tooltipWorker){return[Tooltipping.config({lazySink:sharedBackstage.getSink,tooltipDom:{tag:"div",classes:["tox-tooltip-worker-container"]},tooltipComponents:[],anchor:function(comp){return{anchor:"submenu",item:comp,overrides:{maxHeightFunction:expandable}}},mode:"follow-highlight",onShow:function(component,_tooltip){tooltipWorker(function(elm){Tooltipping.setComponents(component,[external({element:Element.fromDom(elm)})])})}})]}).getOr([])},escapeRegExp=function(text){return text.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")},encodeText=function(text){return global$7.DOM.encode(text)},replaceText=function(text,matchText){var translated=global$5.translate(text),encoded=encodeText(translated);if(matchText.length>0){var escapedMatchRegex=new RegExp(escapeRegExp(matchText),"gi");return encoded.replace(escapedMatchRegex,function(match){return'<span class="tox-autocompleter-highlight">'+match+"</span>"})}return encoded},renderAutocompleteItem=function(spec,matchText,useText,presets,onItemValueHandler,itemResponse,sharedBackstage,renderIcons){void 0===renderIcons&&(renderIcons=!0);var structure=renderItemStructure({presets:presets,textContent:Option.none(),htmlContent:useText?spec.text.map(function(text){return replaceText(text,matchText)}):Option.none(),ariaLabel:spec.text,iconContent:spec.icon,shortcutContent:Option.none(),checkMark:Option.none(),caret:Option.none(),value:spec.value},sharedBackstage.providers,renderIcons,spec.icon);return renderCommonItem({data:buildData(spec),disabled:spec.disabled,getApi:function(){return{}},onAction:function(_api){return onItemValueHandler(spec.value,spec.meta)},onSetup:function(){return function(){}},triggersSubmenu:!1,itemBehaviours:tooltipBehaviour(spec.meta,sharedBackstage)},structure,itemResponse)},renderChoiceItem=function(spec,useText,presets,onItemValueHandler,isSelected,itemResponse,providersBackstage){var getApi=function(component){return{setActive:function(state){Toggling.set(component,state)},isActive:function(){return Toggling.isOn(component)},isDisabled:function(){return Disabling.isDisabled(component)},setDisabled:function(state){return Disabling.set(component,state)}}},structure=renderItemStructure({presets:presets,textContent:useText?spec.text:Option.none(),htmlContent:Option.none(),ariaLabel:spec.text,iconContent:spec.icon,shortcutContent:useText?spec.shortcut:Option.none(),checkMark:useText?Option.some(renderCheckmark(providersBackstage.icons)):Option.none(),caret:Option.none(),value:spec.value},providersBackstage,!0);return deepMerge(renderCommonItem({data:buildData(spec),disabled:spec.disabled,getApi:getApi,onAction:function(_api){return onItemValueHandler(spec.value)},onSetup:function(api){return api.setActive(isSelected),function(){}},triggersSubmenu:!1,itemBehaviours:[]},structure,itemResponse),{toggling:{toggleClass:tickedClass,toggleOnExecute:!1,selected:spec.active}})},parts$2=constant(generate$4(owner$2(),parts())),cellOverEvent=generate$1("cell-over"),cellExecuteEvent=generate$1("cell-execute"),makeCell=function(row,col,labelId){var _a,emitCellOver=function(c){return emitWith(c,cellOverEvent,{row:row,col:col})},emitExecute=function(c){return emitWith(c,cellExecuteEvent,{row:row,col:col})};return build$1({dom:{tag:"div",attributes:(_a={role:"button"},_a["aria-labelledby"]=labelId,_a)},behaviours:derive$1([config("insert-table-picker-cell",[run(mouseover(),Focusing.focus),run(execute(),emitExecute),run(tapOrClick(),emitExecute)]),Toggling.config({toggleClass:"tox-insert-table-picker__selected",toggleOnExecute:!1}),Focusing.config({onFocus:emitCellOver})])})},makeCells=function(labelId,numRows,numCols){for(var cells=[],i=0;i<numRows;i++){for(var row=[],j=0;j<numCols;j++)row.push(makeCell(i,j,labelId));cells.push(row)}return cells},selectCells=function(cells,selectedRow,selectedColumn,numRows,numColumns){for(var i=0;i<numRows;i++)for(var j=0;j<numColumns;j++)Toggling.set(cells[i][j],i<=selectedRow&&j<=selectedColumn)},makeComponents=function(cells){return bind(cells,function(cellRow){return map(cellRow,premade$1)})},makeLabelText=function(row,col){return text(col+1+"x"+(row+1))},hexColour=function(hexString){return{value:constant(hexString)}},shorthandRegex=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,longformRegex=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i,isHexString=function(hex){return shorthandRegex.test(hex)||longformRegex.test(hex)},getLongForm=function(hex){var hexString=hex.value().replace(shorthandRegex,function(m,r,g,b){return r+r+g+g+b+b});return{value:constant(hexString)}},extractValues=function(hex){var longForm=getLongForm(hex),splitForm=longformRegex.exec(longForm.value());return null===splitForm?["FFFFFF","FF","FF","FF"]:splitForm},toHex=function(component){var hex=component.toString(16);return 1===hex.length?"0"+hex:hex},fromRgba=function(rgbaColour){var value=toHex(rgbaColour.red())+toHex(rgbaColour.green())+toHex(rgbaColour.blue());return hexColour(value)},min=Math.min,max=Math.max,round=Math.round,rgbRegex=/^rgb\((\d+),\s*(\d+),\s*(\d+)\)/,rgbaRegex=/^rgba\((\d+),\s*(\d+),\s*(\d+),\s*(\d?(?:\.\d+)?)\)/,rgbaColour=function(red,green,blue,alpha){return{red:constant(red),green:constant(green),blue:constant(blue),alpha:constant(alpha)}},isRgbaComponent=function(value){var num=parseInt(value,10);return num.toString()===value&&num>=0&&num<=255},fromHsv=function(hsv){var r,g,b,hue=(hsv.hue()||0)%360,saturation=hsv.saturation()/100,brightness=hsv.value()/100;if(saturation=max(0,min(saturation,1)),brightness=max(0,min(brightness,1)),0===saturation)return r=g=b=round(255*brightness),rgbaColour(r,g,b,1);var side=hue/60,chroma=brightness*saturation,x=chroma*(1-Math.abs(side%2-1)),match=brightness-chroma;switch(Math.floor(side)){case 0:r=chroma,g=x,b=0;break;case 1:r=x,g=chroma,b=0;break;case 2:r=0,g=chroma,b=x;break;case 3:r=0,g=x,b=chroma;break;case 4:r=x,g=0,b=chroma;break;case 5:r=chroma,g=0,b=x;break;default:r=g=b=0}return r=round(255*(r+match)),g=round(255*(g+match)),b=round(255*(b+match)),rgbaColour(r,g,b,1)},fromHex=function(hexColour){var result=extractValues(hexColour),red=parseInt(result[1],16),green=parseInt(result[2],16),blue=parseInt(result[3],16);return rgbaColour(red,green,blue,1)},fromStringValues=function(red,green,blue,alpha){var r=parseInt(red,10),g=parseInt(green,10),b=parseInt(blue,10),a=parseFloat(alpha);return rgbaColour(r,g,b,a)},fromString=function(rgbaString){if("transparent"===rgbaString)return Option.some(rgbaColour(0,0,0,0));var rgbMatch=rgbRegex.exec(rgbaString);if(null!==rgbMatch)return Option.some(fromStringValues(rgbMatch[1],rgbMatch[2],rgbMatch[3],"1"));var rgbaMatch=rgbaRegex.exec(rgbaString);return null!==rgbaMatch?Option.some(fromStringValues(rgbaMatch[1],rgbaMatch[2],rgbaMatch[3],rgbaMatch[4])):Option.none()},toString=function(rgba){return"rgba("+rgba.red()+","+rgba.green()+","+rgba.blue()+","+rgba.alpha()+")"},redColour=constant(rgbaColour(255,0,0,1)),global$8=tinymce.util.Tools.resolve("tinymce.util.LocalStorage"),storageName="tinymce-custom-colors",choiceItem="choiceitem",defaultColors=[{type:choiceItem,text:"Light Green",value:"#BFEDD2"},{type:choiceItem,text:"Light Yellow",value:"#FBEEB8"},{type:choiceItem,text:"Light Red",value:"#F8CAC6"},{type:choiceItem,text:"Light Purple",value:"#ECCAFA"},{type:choiceItem,text:"Light Blue",value:"#C2E0F4"},{type:choiceItem,text:"Green",value:"#2DC26B"},{type:choiceItem,text:"Yellow",value:"#F1C40F"},{type:choiceItem,text:"Red",value:"#E03E2D"},{type:choiceItem,text:"Purple",value:"#B96AD9"},{type:choiceItem,text:"Blue",value:"#3598DB"},{type:choiceItem,text:"Dark Turquoise",value:"#169179"},{type:choiceItem,text:"Orange",value:"#E67E23"},{type:choiceItem,text:"Dark Red",value:"#BA372A"},{type:choiceItem,text:"Dark Purple",value:"#843FA1"},{type:choiceItem,text:"Dark Blue",value:"#236FA1"},{type:choiceItem,text:"Light Gray",value:"#ECF0F1"},{type:choiceItem,text:"Medium Gray",value:"#CED4D9"},{type:choiceItem,text:"Gray",value:"#95A5A6"},{type:choiceItem,text:"Dark Gray",value:"#7E8C8D"},{type:choiceItem,text:"Navy Blue",value:"#34495E"},{type:choiceItem,text:"Black",value:"#000000"},{type:choiceItem,text:"White",value:"#ffffff"}],colorCache=ColorCache(10),mapColors=function(colorMap){var colors=[],canvas=domGlobals.document.createElement("canvas");canvas.height=1,canvas.width=1;for(var ctx=canvas.getContext("2d"),byteAsHex=function(colorByte,alphaByte){var bg=255,alpha=alphaByte/255,colorByteWithWhiteBg=Math.round(colorByte*alpha+bg*(1-alpha));return("0"+colorByteWithWhiteBg.toString(16)).slice(-2).toUpperCase()},asHexColor=function(color){if(/^[0-9A-Fa-f]{6}$/.test(color))return"#"+color.toUpperCase();ctx.clearRect(0,0,canvas.width,canvas.height),ctx.fillStyle="#FFFFFF",ctx.fillStyle=color,ctx.fillRect(0,0,1,1);var rgba=ctx.getImageData(0,0,1,1).data,r=rgba[0],g=rgba[1],b=rgba[2],a=rgba[3];return"#"+byteAsHex(r,a)+byteAsHex(g,a)+byteAsHex(b,a)},i=0;i<colorMap.length;i+=2)colors.push({text:colorMap[i+1],value:asHexColor(colorMap[i]),type:"choiceitem"});return colors},getColorCols=function(editor,defaultCols){return editor.getParam("color_cols",defaultCols,"number")},hasCustomColors=function(editor){return!1!==editor.getParam("custom_colors")},getColorMap=function(editor){return editor.getParam("color_map")},getColors=function(editor){var unmapped=getColorMap(editor);return void 0!==unmapped?mapColors(unmapped):defaultColors},getCurrentColors=function(){return map(colorCache.state(),function(color){return{type:choiceItem,text:color,value:color}})},addColor=function(color){colorCache.add(color)},Settings={mapColors:mapColors,getColorCols:getColorCols,hasCustomColors:hasCustomColors,getColorMap:getColorMap,getColors:getColors,getCurrentColors:getCurrentColors,addColor:addColor},fireSkinLoaded=function(editor){return editor.fire("SkinLoaded")},fireResizeEditor=function(editor){return editor.fire("ResizeEditor")},fireBeforeRenderUI=function(editor){return editor.fire("BeforeRenderUI")},fireResizeContent=function(editor){return editor.fire("ResizeContent")},fireTextColorChange=function(editor,data){editor.fire("TextColorChange",data)},Events={fireSkinLoaded:fireSkinLoaded,fireResizeEditor:fireResizeEditor,fireBeforeRenderUI:fireBeforeRenderUI,fireResizeContent:fireResizeContent,fireTextColorChange:fireTextColorChange},getCurrentColor=function(editor,format){var color;return editor.dom.getParents(editor.selection.getStart(),function(elm){var value;(value=elm.style["forecolor"===format?"color":"background-color"])&&(color=color||value)}),color},applyFormat=function(editor,format,value){editor.undoManager.transact(function(){editor.focus(),editor.formatter.apply(format,{value:value}),editor.nodeChanged()})},removeFormat=function(editor,format){editor.undoManager.transact(function(){editor.focus(),editor.formatter.remove(format,{value:null},null,!0),editor.nodeChanged()})},registerCommands=function(editor){editor.addCommand("mceApplyTextcolor",function(format,value){applyFormat(editor,format,value)}),editor.addCommand("mceRemoveTextcolor",function(format){removeFormat(editor,format)})},calcCols=function(colors){return Math.max(5,Math.ceil(Math.sqrt(colors)))},getColorCols$1=function(editor){var colors=Settings.getColors(editor),defaultCols=calcCols(colors.length);return Settings.getColorCols(editor,defaultCols)},getAdditionalColors=function(hasCustom){var type="choiceitem",remove={type:type,text:"Remove color",icon:"color-swatch-remove-color",value:"remove"},custom={type:type,text:"Custom color",icon:"color-picker",value:"custom"};return hasCustom?[remove,custom]:[remove]},applyColor=function(editor,format,value,onChoice){if("custom"===value){var dialog=colorPickerDialog(editor);dialog(function(colorOpt){colorOpt.each(function(color){
Settings.addColor(color),editor.execCommand("mceApplyTextcolor",format,color),onChoice(color)})},"#000000")}else"remove"===value?(onChoice(""),editor.execCommand("mceRemoveTextcolor",format)):(onChoice(value),editor.execCommand("mceApplyTextcolor",format,value))},getMenuColors=function(colors,hasCustom){return colors.concat(Settings.getCurrentColors().concat(getAdditionalColors(hasCustom)))},getFetch=function(colors,hasCustom){return function(callback){callback(getMenuColors(colors,hasCustom))}},setIconColor=function(splitButtonApi,name,newColor){var setIconFillAndStroke=function(pathId,color){splitButtonApi.setIconFill(pathId,color),splitButtonApi.setIconStroke(pathId,color)},id="forecolor"===name?"tox-icon-text-color__color":"tox-icon-highlight-bg-color__color";setIconFillAndStroke(id,newColor)},registerTextColorButton=function(editor,name,format,tooltip,lastColor){editor.ui.registry.addSplitButton(name,{tooltip:tooltip,presets:"color",icon:"forecolor"===name?"text-color":"highlight-bg-color",select:function(value){var optCurrentRgb=Option.from(getCurrentColor(editor,format));return optCurrentRgb.bind(function(currentRgb){return fromString(currentRgb).map(function(rgba){var currentHex=fromRgba(rgba).value();return contains$1(value.toLowerCase(),currentHex)})}).getOr(!1)},columns:getColorCols$1(editor),fetch:getFetch(Settings.getColors(editor),Settings.hasCustomColors(editor)),onAction:function(splitButtonApi){null!==lastColor.get()&&applyColor(editor,format,lastColor.get(),function(){})},onItemAction:function(splitButtonApi,value){applyColor(editor,format,value,function(newColor){lastColor.set(newColor),Events.fireTextColorChange(editor,{name:name,color:newColor})})},onSetup:function(splitButtonApi){null!==lastColor.get()&&setIconColor(splitButtonApi,name,lastColor.get());var handler=function(e){e.name===name&&setIconColor(splitButtonApi,e.name,e.color)};return editor.on("TextColorChange",handler),function(){editor.off("TextColorChange",handler)}}})},registerTextColorMenuItem=function(editor,name,format,text){editor.ui.registry.addNestedMenuItem(name,{text:text,icon:"forecolor"===name?"text-color":"highlight-bg-color",getSubmenuItems:function(){return[{type:"fancymenuitem",fancytype:"colorswatch",onAction:function(data){applyColor(editor,format,data.value,noop)}}]}})},colorPickerDialog=function(editor){return function(callback,value){var getOnSubmit=function(callback){return function(api){var data=api.getData();callback(Option.from(data.colorpicker)),api.close()}},onAction=function(api,details){"hex-valid"===details.name&&(details.value?api.enable("ok"):api.disable("ok"))},initialData={colorpicker:value},submit=getOnSubmit(callback);editor.windowManager.open({title:"Color Picker",size:"normal",body:{type:"panel",items:[{type:"colorpicker",name:"colorpicker",label:"Color"}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],initialData:initialData,onAction:onAction,onSubmit:submit,onClose:function(){},onCancel:function(){callback(Option.none())}})}},register$1=function(editor){registerCommands(editor);var lastForeColor=Cell(null),lastBackColor=Cell(null);registerTextColorButton(editor,"forecolor","forecolor","Text color",lastForeColor),registerTextColorButton(editor,"backcolor","hilitecolor","Background color",lastBackColor),registerTextColorMenuItem(editor,"forecolor","forecolor","Text color"),registerTextColorMenuItem(editor,"backcolor","hilitecolor","Background color")},ColorSwatch={register:register$1,getColors:getMenuColors,getFetch:getFetch,colorPickerDialog:colorPickerDialog,getCurrentColor:getCurrentColor,getColorCols:getColorCols$1,calcCols:calcCols},chunk$1=function(rowDom,numColumns){return function(items){var chunks=chunk(items,numColumns);return map(chunks,function(c){return{dom:rowDom,components:c}})}},forSwatch=function(columns){return{dom:{tag:"div",classes:["tox-menu","tox-swatches-menu"]},components:[{dom:{tag:"div",classes:["tox-swatches"]},components:[Menu.parts().items({preprocess:"auto"!==columns?chunk$1({tag:"div",classes:["tox-swatches__row"]},columns):identity})]}]}},forToolbar=function(columns){return{dom:{tag:"div",classes:["tox-menu","tox-collection","tox-collection--toolbar","tox-collection--toolbar-lg"]},components:[Menu.parts().items({preprocess:chunk$1({tag:"div",classes:["tox-collection__group"]},columns)})]}},preprocessCollection=function(items,isSeparator){var allSplits=[],currentSplit=[];return each(items,function(item,i){isSeparator(item,i)?(currentSplit.length>0&&allSplits.push(currentSplit),currentSplit=[],has(item.dom,"innerHtml")&&currentSplit.push(item)):currentSplit.push(item)}),currentSplit.length>0&&allSplits.push(currentSplit),map(allSplits,function(s){return{dom:{tag:"div",classes:["tox-collection__group"]},components:s}})},forCollection=function(columns,initItems,hasIcons){return{dom:{tag:"div",classes:["tox-menu","tox-collection"].concat(1===columns?["tox-collection--list"]:["tox-collection--grid"])},components:[Menu.parts().items({preprocess:function(items){return"auto"!==columns&&columns>1?chunk$1({tag:"div",classes:["tox-collection__group"]},columns)(items):preprocessCollection(items,function(item,i){return"separator"===initItems[i].type})}})]}},forMenu=function(presets){return"color"===presets?"tox-swatches":"tox-menu"},classes=function(presets){return{backgroundMenu:"tox-background-menu",selectedMenu:"tox-selected-menu",selectedItem:"tox-collection__item--active",hasIcons:"tox-menu--has-icons",menu:forMenu(presets),tieredMenu:"tox-tiered-menu"}},markers$1=function(presets){var menuClasses=classes(presets);return{backgroundMenu:menuClasses.backgroundMenu,selectedMenu:menuClasses.selectedMenu,menu:menuClasses.menu,selectedItem:menuClasses.selectedItem,item:classForPreset(presets)}},dom$1=function(hasIcons,columns,presets){var menuClasses=classes(presets);return{tag:"div",classes:flatten([[menuClasses.menu,"tox-menu-"+columns+"-column"],hasIcons?[menuClasses.hasIcons]:[]])}},components$1=[Menu.parts().items({})],part=function(hasIcons,columns,presets){var menuClasses=classes(presets),d={tag:"div",classes:flatten([[menuClasses.tieredMenu]])};return{dom:d,markers:markers$1(presets)}},hasIcon=function(item){return void 0!==item.icon||"togglemenuitem"===item.type||"choicemenuitem"===item.type},menuHasIcons=function(xs){return exists(xs,hasIcon)},handleError=function(error){return domGlobals.console.error(formatError(error)),domGlobals.console.log(error),Option.none()},createPartialMenuWithAlloyItems=function(value,hasIcons,items,columns,presets){if("color"===presets){var structure=forSwatch(columns);return{value:value,dom:structure.dom,components:structure.components,items:items}}if("normal"===presets&&"auto"===columns){structure=forCollection(columns,items);return{value:value,dom:structure.dom,components:structure.components,items:items}}if("normal"===presets&&1===columns){structure=forCollection(1,items);return{value:value,dom:structure.dom,components:structure.components,items:items}}if("normal"===presets){structure=forCollection(columns,items);return{value:value,dom:structure.dom,components:structure.components,items:items}}if("listpreview"===presets&&"auto"!==columns){structure=forToolbar(columns);return{value:value,dom:structure.dom,components:structure.components,items:items}}return{value:value,dom:dom$1(hasIcons,columns,presets),components:components$1,items:items}},createPartialChoiceMenu=function(value,items,onItemValueHandler,columns,presets,itemResponse,select,providersBackstage){var hasIcons=menuHasIcons(items),presetItemTypes="color"!==presets?"normal":"color",alloyItems=createChoiceItems(items,onItemValueHandler,columns,presetItemTypes,itemResponse,select,providersBackstage);return createPartialMenuWithAlloyItems(value,hasIcons,alloyItems,columns,presets)},createChoiceItems=function(items,onItemValueHandler,columns,itemPresets,itemResponse,select,providersBackstage){return cat(map(items,function(item){return"choiceitem"===item.type?createChoiceMenuItem(item).fold(handleError,function(d){return Option.some(renderChoiceItem(d,1===columns,itemPresets,onItemValueHandler,select(item.value),itemResponse,providersBackstage))}):Option.none()}))},deriveMenuMovement=function(columns,presets){var menuMarkers=markers$1(presets);if(1===columns)return{mode:"menu",moveOnTab:!0};if("auto"===columns)return{mode:"grid",selector:"."+menuMarkers.item,initSize:{numColumns:1,numRows:1}};var rowClass="color"===presets?"tox-swatches__row":"tox-collection__group";return{mode:"matrix",rowSelector:"."+rowClass}},deriveCollectionMovement=function(columns,presets){return 1===columns?{mode:"menu",moveOnTab:!1,selector:".tox-collection__item"}:"auto"===columns?{mode:"flatgrid",selector:".tox-collection__item",initSize:{numColumns:1,numRows:1}}:{mode:"matrix",selectors:{row:"color"===presets?".tox-swatches__row":".tox-collection__group",cell:"color"===presets?"."+colorClass:"."+selectableClass}}},fancyMenuItems={inserttable:renderInsertTableMenuItem,colorswatch:renderColorSwatchItem},valueOpt=function(obj,key){return Object.prototype.hasOwnProperty.call(obj,key)?Option.some(obj[key]):Option.none()},renderFancyMenuItem=function(spec,backstage){return valueOpt(fancyMenuItems,spec.fancytype).map(function(render){return render(spec,backstage)})},renderNormalItem=function(spec,itemResponse,providersBackstage,renderIcons){void 0===renderIcons&&(renderIcons=!0);var getApi=function(component){return{isDisabled:function(){return Disabling.isDisabled(component)},setDisabled:function(state){return Disabling.set(component,state)}}},structure=renderItemStructure({presets:"normal",iconContent:spec.icon,textContent:spec.text,htmlContent:Option.none(),ariaLabel:spec.text,caret:Option.none(),checkMark:Option.none(),shortcutContent:spec.shortcut},providersBackstage,renderIcons);return renderCommonItem({data:buildData(spec),getApi:getApi,disabled:spec.disabled,onAction:spec.onAction,onSetup:spec.onSetup,triggersSubmenu:!1,itemBehaviours:[]},structure,itemResponse)},renderNestedItem=function(spec,itemResponse,providersBackstage,renderIcons){void 0===renderIcons&&(renderIcons=!0);var caret=renderSubmenuCaret(providersBackstage.icons),getApi=function(component){return{isDisabled:function(){return Disabling.isDisabled(component)},setDisabled:function(state){return Disabling.set(component,state)}}},structure=renderItemStructure({presets:"normal",iconContent:spec.icon,textContent:spec.text,htmlContent:Option.none(),ariaLabel:spec.text,caret:Option.some(caret),checkMark:Option.none(),shortcutContent:spec.shortcut},providersBackstage,renderIcons);return renderCommonItem({data:buildData(spec),getApi:getApi,disabled:spec.disabled,onAction:noop,onSetup:spec.onSetup,triggersSubmenu:!0,itemBehaviours:[]},structure,itemResponse)},renderSeparatorItem=function(spec){var innerHtml=spec.text.fold(function(){return{}},function(text){return{innerHtml:text}});return{type:"separator",dom:__assign({tag:"div",classes:[selectableClass,groupHeadingClass]},innerHtml),components:[]}},renderToggleMenuItem=function(spec,itemResponse,providersBackstage){var getApi=function(component){return{setActive:function(state){Toggling.set(component,state)},isActive:function(){return Toggling.isOn(component)},isDisabled:function(){return Disabling.isDisabled(component)},setDisabled:function(state){return Disabling.set(component,state)}}},structure=renderItemStructure({iconContent:Option.none(),textContent:spec.text,htmlContent:Option.none(),ariaLabel:spec.text,checkMark:Option.some(renderCheckmark(providersBackstage.icons)),caret:Option.none(),shortcutContent:spec.shortcut,presets:"normal",meta:spec.meta},providersBackstage,!0);return deepMerge(renderCommonItem({data:buildData(spec),disabled:spec.disabled,getApi:getApi,onAction:spec.onAction,onSetup:spec.onSetup,triggersSubmenu:!1,itemBehaviours:[]},structure,itemResponse),{toggling:{toggleClass:tickedClass,toggleOnExecute:!1,selected:spec.active}})},autocomplete=renderAutocompleteItem,separator=renderSeparatorItem,normal=renderNormalItem,nested=renderNestedItem,toggle$1=renderToggleMenuItem,fancy=renderFancyMenuItem;(function(FocusMode){FocusMode[FocusMode.ContentFocus=0]="ContentFocus",FocusMode[FocusMode.UiFocus=1]="UiFocus"})(FocusMode||(FocusMode={}));var ToolbarDrawer,hasIcon$1=function(item){return void 0!==item.icon||"togglemenuitem"===item.type||"choicemenuitem"===item.type},menuHasIcons$1=function(xs){return exists(xs,hasIcon$1)},createMenuItemFromBridge=function(item,itemResponse,backstage,menuHasIcons){void 0===menuHasIcons&&(menuHasIcons=!0);var providersBackstage=backstage.shared.providers;switch(item.type){case"menuitem":return createMenuItem(item).fold(handleError,function(d){return Option.some(normal(d,itemResponse,providersBackstage,menuHasIcons))});case"nestedmenuitem":return createNestedMenuItem(item).fold(handleError,function(d){return Option.some(nested(d,itemResponse,providersBackstage,menuHasIcons))});case"togglemenuitem":return createToggleMenuItem(item).fold(handleError,function(d){return Option.some(toggle$1(d,itemResponse,providersBackstage))});case"separator":return createSeparatorMenuItem(item).fold(handleError,function(d){return Option.some(separator(d))});case"fancymenuitem":return createFancyMenuItem(item).fold(handleError,function(d){return fancy(d,backstage)});default:return domGlobals.console.error("Unknown item in general menu",item),Option.none()}},createAutocompleteItems=function(items,matchText,onItemValueHandler,columns,itemResponse,sharedBackstage){var renderText=1===columns,renderIcons=!renderText||menuHasIcons$1(items);return cat(map(items,function(item){return"separator"===item.type?createSeparatorItem(item).fold(handleError,function(d){return Option.some(separator(d))}):createAutocompleterItem(item).fold(handleError,function(d){return Option.some(autocomplete(d,matchText,renderText,"normal",onItemValueHandler,itemResponse,sharedBackstage,renderIcons))})}))},createPartialMenu=function(value,items,itemResponse,backstage){var hasIcons=menuHasIcons$1(items),alloyItems=cat(map(items,function(item){var createItem=function(i){return createMenuItemFromBridge(i,itemResponse,backstage,hasIcons)};return"nestedmenuitem"===item.type&&item.getSubmenuItems().length<=0?createItem(merge(item,{disabled:!0})):createItem(item)}));return createPartialMenuWithAlloyItems(value,hasIcons,alloyItems,1,"normal")},createTieredDataFrom=function(partialMenu){return tieredMenu.singleData(partialMenu.value,partialMenu)},createMenuFrom=function(partialMenu,columns,focusMode,presets){var focusManager=focusMode===FocusMode.ContentFocus?highlights():dom(),movement=deriveMenuMovement(columns,presets),menuMarkers=markers$1(presets);return{dom:partialMenu.dom,components:partialMenu.components,items:partialMenu.items,value:partialMenu.value,markers:{selectedItem:menuMarkers.selectedItem,item:menuMarkers.item},movement:movement,fakeFocus:focusMode===FocusMode.ContentFocus,focusManager:focusManager,menuBehaviours:SimpleBehaviours.unnamedEvents("auto"!==columns?[]:[runOnAttached(function(comp,se){detectSize(comp,4,menuMarkers.item).each(function(_a){var numColumns=_a.numColumns,numRows=_a.numRows;Keying.setGridSize(comp,numRows,numColumns)})})])}},register$2=function(editor,sharedBackstage){var activeAutocompleter=Cell(Option.none()),autocompleter=build$1(InlineView.sketch({dom:{tag:"div",classes:["tox-autocompleter"]},components:[],fireDismissalEventInstead:{},inlineBehaviours:derive$1([config("dismissAutocompleter",[run(dismissRequested(),function(){return cancelIfNecessary()})])]),lazySink:sharedBackstage.getSink})),isMenuOpen=function(){return InlineView.isOpen(autocompleter)},isActive=function(){return activeAutocompleter.get().isSome()},hideIfNecessary=function(){isActive()&&InlineView.hide(autocompleter)},cancelIfNecessary=function(){if(isActive()){var lastElement=activeAutocompleter.get().map(function(ac){return ac.element});detect$4(lastElement.getOr(Element.fromDom(editor.selection.getNode()))).each(unwrap),hideIfNecessary(),activeAutocompleter.set(Option.none())}},getAutocompleters=cached(function(){return register(editor)}),getCombinedItems=function(triggerChar,matches){var columns=findMap(matches,function(m){return Option.from(m.columns)}).getOr(1);return bind(matches,function(match){var choices=match.items;return createAutocompleteItems(choices,match.matchText,function(itemValue,itemMeta){var nr=editor.selection.getRng();getContext(editor.dom,nr,triggerChar).fold(function(){return domGlobals.console.error("Lost context. Cursor probably moved")},function(_a){var range=_a.range,autocompleterApi={hide:cancelIfNecessary,reload:function(fetchOptions){hideIfNecessary(),load(fetchOptions)}};match.onAction(autocompleterApi,range,itemValue,itemMeta)})},columns,ItemResponse$1.BUBBLE_TO_SANDBOX,sharedBackstage)})},commenceIfNecessary=function(context){if(!isActive()){var wrapper=create$4(editor,context.range);activeAutocompleter.set(Option.some({triggerChar:context.triggerChar,element:wrapper,matchLength:context.text.length}))}},display=function(ac,context,lookupData,items){ac.matchLength=context.text.length;var columns=findMap(lookupData,function(ld){return Option.from(ld.columns)}).getOr(1);InlineView.showAt(autocompleter,{anchor:"node",root:Element.fromDom(editor.getBody()),node:Option.from(ac.element)},Menu.sketch(createMenuFrom(createPartialMenuWithAlloyItems("autocompleter-value",!0,items,columns,"normal"),columns,FocusMode.ContentFocus,"normal"))),InlineView.getContent(autocompleter).each(Highlighting.highlightFirst)},doLookup=function(fetchOptions){return activeAutocompleter.get().map(function(ac){return getContext(editor.dom,editor.selection.getRng(),ac.triggerChar).bind(function(newContext){return lookupWithContext(editor,getAutocompleters,newContext,fetchOptions)})}).getOrThunk(function(){return lookup(editor,getAutocompleters)})},load=function(fetchOptions){doLookup(fetchOptions).fold(cancelIfNecessary,function(lookupInfo){commenceIfNecessary(lookupInfo.context),lookupInfo.lookupData.then(function(lookupData){activeAutocompleter.get().map(function(ac){var context=lookupInfo.context;if(ac.triggerChar===context.triggerChar){var combinedItems=getCombinedItems(context.triggerChar,lookupData);combinedItems.length>0?display(ac,context,lookupData,combinedItems):context.text.length-ac.matchLength>=10?cancelIfNecessary():hideIfNecessary()}})})})},onKeypress=last$2(function(e){27!==e.which&&load()},50),autocompleterUiApi={onKeypress:onKeypress,cancelIfNecessary:cancelIfNecessary,isMenuOpen:isMenuOpen,isActive:isActive,getView:function(){return InlineView.getContent(autocompleter)}};AutocompleterEditorEvents.setup(autocompleterUiApi,editor)},Autocompleter={register:register$2},mkEvent=function(target,x,y,stop,prevent,kill,raw){return{target:constant(target),x:constant(x),y:constant(y),stop:stop,prevent:prevent,kill:kill,raw:constant(raw)}},handle=function(filter,handler){return function(rawEvent){if(filter(rawEvent)){var target=Element.fromDom(rawEvent.target),stop=function(){rawEvent.stopPropagation()},prevent=function(){rawEvent.preventDefault()},kill=compose(prevent,stop),evt=mkEvent(target,rawEvent.clientX,rawEvent.clientY,stop,prevent,kill,rawEvent);handler(evt)}}},binder=function(element,event,filter,handler,useCapture){var wrapped=handle(filter,handler);return element.dom().addEventListener(event,wrapped,useCapture),{unbind:curry(unbind,element,event,wrapped,useCapture)}},bind$2=function(element,event,filter,handler){return binder(element,event,filter,handler,!1)},capture=function(element,event,filter,handler){return binder(element,event,filter,handler,!0)},unbind=function(element,event,handler,useCapture){element.dom().removeEventListener(event,handler,useCapture)},filter$1=constant(!0),bind$3=function(element,event,handler){return bind$2(element,event,filter$1,handler)},capture$1=function(element,event,handler){return capture(element,event,filter$1,handler)},closest$4=function(scope,selector,isRoot){return closest$3(scope,selector,isRoot).isSome()},SIGNIFICANT_MOVE=5,LONGPRESS_DELAY=400,getTouch=function(event){var raw=event.raw();return void 0===raw.touches||1!==raw.touches.length?Option.none():Option.some(raw.touches[0])},isFarEnough=function(touch,data){var distX=Math.abs(touch.clientX-data.x()),distY=Math.abs(touch.clientY-data.y());return distX>SIGNIFICANT_MOVE||distY>SIGNIFICANT_MOVE},monitor=function(settings){var startData=Cell(Option.none()),longpress$1=DelayedFunction(function(event){startData.set(Option.none()),settings.triggerEvent(longpress(),event)},LONGPRESS_DELAY),handleTouchstart=function(event){return getTouch(event).each(function(touch){longpress$1.cancel();var data={x:constant(touch.clientX),y:constant(touch.clientY),target:event.target};longpress$1.schedule(event),startData.set(Option.some(data))}),Option.none()},handleTouchmove=function(event){return longpress$1.cancel(),getTouch(event).each(function(touch){startData.get().each(function(data){isFarEnough(touch,data)&&startData.set(Option.none())})}),Option.none()},handleTouchend=function(event){longpress$1.cancel();var isSame=function(data){return eq(data.target(),event.target())};return startData.get().filter(isSame).map(function(data){return settings.triggerEvent(tap(),event)})},handlers=wrapAll$1([{key:touchstart(),value:handleTouchstart},{key:touchmove(),value:handleTouchmove},{key:touchend(),value:handleTouchend}]),fireIfReady=function(event,type){return readOptFrom$1(handlers,type).bind(function(handler){return handler(event)})};return{fireIfReady:fireIfReady}},isDangerous=function(event){var keyEv=event.raw();return keyEv.which===BACKSPACE()[0]&&!contains(["input","textarea"],name(event.target()))&&!closest$4(event.target(),'[contenteditable="true"]')},isFirefox=PlatformDetection$1.detect().browser.isFirefox(),settingsSchema=objOfOnly([strictFunction("triggerEvent"),defaulted$1("stopBackspace",!0)]),bindFocus=function(container,handler){return isFirefox?capture$1(container,"focus",handler):bind$3(container,"focusin",handler)},bindBlur=function(container,handler){return isFirefox?capture$1(container,"blur",handler):bind$3(container,"focusout",handler)},setup$1=function(container,rawSettings){var settings=asRawOrDie("Getting GUI events settings",settingsSchema,rawSettings),pointerEvents=PlatformDetection$1.detect().deviceType.isTouch()?["touchstart","touchmove","touchend","gesturestart"]:["mousedown","mouseup","mouseover","mousemove","mouseout","click"],tapEvent=monitor(settings),simpleEvents=map(pointerEvents.concat(["selectstart","input","contextmenu","change","transitionend","drag","dragstart","dragend","dragenter","dragleave","dragover","drop","keyup"]),function(type){return bind$3(container,type,function(event){tapEvent.fireIfReady(event,type).each(function(tapStopped){tapStopped&&event.kill()});var stopped=settings.triggerEvent(type,event);stopped&&event.kill()})}),pasteTimeout=Cell(Option.none()),onPaste=bind$3(container,"paste",function(event){tapEvent.fireIfReady(event,"paste").each(function(tapStopped){tapStopped&&event.kill()});var stopped=settings.triggerEvent("paste",event);stopped&&event.kill(),pasteTimeout.set(Option.some(domGlobals.setTimeout(function(){settings.triggerEvent(postPaste(),event)},0)))}),onKeydown=bind$3(container,"keydown",function(event){var stopped=settings.triggerEvent("keydown",event);stopped?event.kill():!0===settings.stopBackspace&&isDangerous(event)&&event.prevent()}),onFocusIn=bindFocus(container,function(event){var stopped=settings.triggerEvent("focusin",event);stopped&&event.kill()}),focusoutTimeout=Cell(Option.none()),onFocusOut=bindBlur(container,function(event){var stopped=settings.triggerEvent("focusout",event);stopped&&event.kill(),focusoutTimeout.set(Option.some(domGlobals.setTimeout(function(){settings.triggerEvent(postBlur(),event)},0)))}),unbind=function(){each(simpleEvents,function(e){e.unbind()}),onKeydown.unbind(),onFocusIn.unbind(),onFocusOut.unbind(),onPaste.unbind(),pasteTimeout.get().each(domGlobals.clearTimeout),focusoutTimeout.get().each(domGlobals.clearTimeout)};return{unbind:unbind}},derive$2=function(rawEvent,rawTarget){var source=readOptFrom$1(rawEvent,"target").map(function(getTarget){return getTarget()}).getOr(rawTarget);return Cell(source)},fromSource=function(event,source){var stopper=Cell(!1),cutter=Cell(!1),stop=function(){stopper.set(!0)},cut=function(){cutter.set(!0)};return{stop:stop,cut:cut,isStopped:stopper.get,isCut:cutter.get,event:constant(event),setSource:source.set,getSource:source.get}},fromExternal=function(event){var stopper=Cell(!1),stop=function(){stopper.set(!0)};return{stop:stop,cut:noop,isStopped:stopper.get,isCut:constant(!1),event:constant(event),setSource:die("Cannot set source of a broadcasted event"),getSource:die("Cannot get source of a broadcasted event")}},adt$b=Adt.generate([{stopped:[]},{resume:["element"]},{complete:[]}]),doTriggerHandler=function(lookup,eventType,rawEvent,target,source,logger){var handler=lookup(eventType,target),simulatedEvent=fromSource(rawEvent,source);return handler.fold(function(){return logger.logEventNoHandlers(eventType,target),adt$b.complete()},function(handlerInfo){var descHandler=handlerInfo.descHandler(),eventHandler=getCurried(descHandler);return eventHandler(simulatedEvent),simulatedEvent.isStopped()?(logger.logEventStopped(eventType,handlerInfo.element(),descHandler.purpose()),adt$b.stopped()):simulatedEvent.isCut()?(logger.logEventCut(eventType,handlerInfo.element(),descHandler.purpose()),adt$b.complete()):parent(handlerInfo.element()).fold(function(){return logger.logNoParent(eventType,handlerInfo.element(),descHandler.purpose()),adt$b.complete()},function(parent){return logger.logEventResponse(eventType,handlerInfo.element(),descHandler.purpose()),adt$b.resume(parent)})})},doTriggerOnUntilStopped=function(lookup,eventType,rawEvent,rawTarget,source,logger){return doTriggerHandler(lookup,eventType,rawEvent,rawTarget,source,logger).fold(function(){return!0},function(parent){return doTriggerOnUntilStopped(lookup,eventType,rawEvent,parent,source,logger)},function(){return!1})},triggerHandler=function(lookup,eventType,rawEvent,target,logger){var source=derive$2(rawEvent,target);return doTriggerHandler(lookup,eventType,rawEvent,target,source,logger)},broadcast=function(listeners,rawEvent,logger){var simulatedEvent=fromExternal(rawEvent);return each(listeners,function(listener){var descHandler=listener.descHandler(),handler=getCurried(descHandler);handler(simulatedEvent)}),simulatedEvent.isStopped()},triggerUntilStopped=function(lookup,eventType,rawEvent,logger){var rawTarget=rawEvent.target();return triggerOnUntilStopped(lookup,eventType,rawEvent,rawTarget,logger)},triggerOnUntilStopped=function(lookup,eventType,rawEvent,rawTarget,logger){var source=derive$2(rawEvent,rawTarget);return doTriggerOnUntilStopped(lookup,eventType,rawEvent,rawTarget,source,logger)},eventHandler=Immutable("element","descHandler"),broadcastHandler=function(id,handler){return{id:constant(id),descHandler:constant(handler)}},factory$3=function(detail){var _a=detail.dom,attributes=_a.attributes,domWithoutAttributes=__rest(_a,["attributes"]);return{uid:detail.uid,dom:__assign({tag:"div",attributes:__assign({role:"presentation"},attributes)},domWithoutAttributes),components:detail.components,behaviours:get$b(detail.containerBehaviours),events:detail.events,domModification:detail.domModification,eventOrder:detail.eventOrder}},Container=single$2({name:"Container",factory:factory$3,configFields:[defaulted$1("components",[]),field$1("containerBehaviours",[]),defaulted$1("events",{}),defaulted$1("domModification",{}),defaulted$1("eventOrder",{})]}),takeover=function(root){var isAboveRoot=function(el){return parent(root.element()).fold(function(){return!0},function(parent){return eq(el,parent)})},registry=Registry(),lookup=function(eventName,target){return registry.find(isAboveRoot,eventName,target)},domEvents=setup$1(root.element(),{triggerEvent:function(eventName,event){return monitorEvent(eventName,event.target(),function(logger){return triggerUntilStopped(lookup,eventName,event,logger)})}}),systemApi={debugInfo:constant("real"),triggerEvent:function(eventName,target,data){monitorEvent(eventName,target,function(logger){triggerOnUntilStopped(lookup,eventName,data,target,logger)})},triggerFocus:function(target,originator){read$1(target).fold(function(){focus$1(target)},function(_alloyId){monitorEvent(focus(),target,function(logger){triggerHandler(lookup,focus(),{originator:constant(originator),kill:noop,prevent:noop,target:constant(target)},target,logger)})})},triggerEscape:function(comp,simulatedEvent){systemApi.triggerEvent("keydown",comp.element(),simulatedEvent.event())},getByUid:function(uid){return getByUid(uid)},getByDom:function(elem){return getByDom(elem)},build:build$1,addToGui:function(c){add(c)},removeFromGui:function(c){remove$1(c)},addToWorld:function(c){addToWorld(c)},removeFromWorld:function(c){removeFromWorld(c)},broadcast:function(message){broadcast$1(message)},broadcastOn:function(channels,message){broadcastOn(channels,message)},broadcastEvent:function(eventName,event){broadcastEvent(eventName,event)},isConnected:constant(!0)},addToWorld=function(component){component.connect(systemApi),isText(component.element())||(registry.register(component),each(component.components(),addToWorld),systemApi.triggerEvent(systemInit(),component.element(),{target:constant(component.element())}))},removeFromWorld=function(component){isText(component.element())||(each(component.components(),removeFromWorld),registry.unregister(component)),component.disconnect()},add=function(component){attach(root,component)},remove$1=function(component){detach(component)},destroy=function(){domEvents.unbind(),remove(root.element())},broadcastData=function(data){var receivers=registry.filter(receive());each(receivers,function(receiver){var descHandler=receiver.descHandler(),handler=getCurried(descHandler);handler(data)})},broadcast$1=function(message){broadcastData({universal:constant(!0),data:constant(message)})},broadcastOn=function(channels,message){broadcastData({universal:constant(!1),channels:constant(channels),data:constant(message)})},broadcastEvent=function(eventName,event){var listeners=registry.filter(eventName);return broadcast(listeners,event)},getByUid=function(uid){return registry.getById(uid).fold(function(){return Result.error(new Error('Could not find component with uid: "'+uid+'" in system.'))},Result.value)},getByDom=function(elem){var uid=read$1(elem).getOr("not found");return getByUid(uid)};return addToWorld(root),{root:constant(root),element:root.element,destroy:destroy,add:add,remove:remove$1,getByUid:getByUid,getByDom:getByDom,addToWorld:addToWorld,removeFromWorld:removeFromWorld,broadcast:broadcast$1,broadcastOn:broadcastOn,broadcastEvent:broadcastEvent}},global$9=tinymce.util.Tools.resolve("tinymce.EditorManager"),getSkinUrl=function(editor){var settings=editor.settings,skin=settings.skin,skinUrl=settings.skin_url;if(!1!==skin){var skinName=skin||"oxide";skinUrl=skinUrl?editor.documentBaseURI.toAbsolute(skinUrl):global$9.baseURL+"/skins/ui/"+skinName}return skinUrl},isReadOnly=function(editor){return editor.getParam("readonly",!1,"boolean")},isSkinDisabled=function(editor){return!1===editor.getParam("skin")},getHeightSetting=function(editor){return editor.getParam("height",Math.max(editor.getElement().offsetHeight,200))},getMinWidthSetting=function(editor){return Option.from(editor.settings.min_width).filter(isNumber)},getMinHeightSetting=function(editor){return Option.from(editor.settings.min_height).filter(isNumber)},getMaxWidthSetting=function(editor){return Option.from(editor.getParam("max_width")).filter(isNumber)},getMaxHeightSetting=function(editor){return Option.from(editor.getParam("max_height")).filter(isNumber)},getUserStyleFormats=function(editor){return Option.from(editor.getParam("style_formats")).filter(isArray)},isMergeStyleFormats=function(editor){
return editor.getParam("style_formats_merge",!1,"boolean")},getRemovedMenuItems=function(editor){return editor.getParam("removed_menuitems","")},isMenubarEnabled=function(editor){return!1!==editor.getParam("menubar",!0,"boolean")},isToolbarEnabled=function(editor){var toolbar=editor.getParam("toolbar",!0),isToolbarTrue=!0===toolbar,isToolbarString=isString(toolbar),isToolbarObjectArray=isArray(toolbar)&&toolbar.length>0;return!isMultipleToolbars(editor)&&(isToolbarObjectArray||isToolbarString||isToolbarTrue)},getMultipleToolbarsSetting=function(editor){var keys$1=keys(editor.settings),toolbarKeys=filter(keys$1,function(key){return/^toolbar([1-9])$/.test(key)}),toolbars=map(toolbarKeys,function(key){return editor.getParam(key,!1,"string")}),toolbarArray=filter(toolbars,function(toolbar){return"string"==typeof toolbar});return toolbarArray.length>0?Option.some(toolbarArray):Option.none()},isMultipleToolbars=function(editor){return getMultipleToolbarsSetting(editor).fold(function(){var toolbar=editor.getParam("toolbar",[],"string[]");return toolbar.length>0},function(){return!0})};(function(ToolbarDrawer){ToolbarDrawer.default="",ToolbarDrawer.floating="floating",ToolbarDrawer.sliding="sliding"})(ToolbarDrawer||(ToolbarDrawer={}));var getToolbarDrawer=function(editor){return editor.getParam("toolbar_drawer","","string")},fixedContainerSelector=function(editor){return editor.getParam("fixed_toolbar_container","","string")},fixedContainerElement=function(editor){var selector=fixedContainerSelector(editor),isInline=editor.getParam("inline",!1,"boolean");return selector.length>0&&isInline?descendant$1(body(),selector):Option.none()},useFixedContainer=function(editor){return editor.getParam("inline",!1,"boolean")&&fixedContainerElement(editor).isSome()},getUiContainer=function(editor){var fixedContainer=fixedContainerElement(editor);return fixedContainer.getOr(body())},isDraggableModal=function(editor){return editor.getParam("draggable_modal",!1,"boolean")},formChangeEvent=generate$1("form-component-change"),formCloseEvent=generate$1("form-close"),formCancelEvent=generate$1("form-cancel"),formActionEvent=generate$1("form-action"),formSubmitEvent=generate$1("form-submit"),formBlockEvent=generate$1("form-block"),formUnblockEvent=generate$1("form-unblock"),formTabChangeEvent=generate$1("form-tabchange"),formResizeEvent=generate$1("form-resize"),renderAlertBanner=function(spec,providersBackstage){return Container.sketch({dom:{tag:"div",attributes:{role:"alert"},classes:["tox-notification","tox-notification--in","tox-notification--"+spec.level]},components:[{dom:{tag:"div",classes:["tox-notification__icon"]},components:[Button.sketch({dom:{tag:"button",classes:["tox-button","tox-button--naked","tox-button--icon"],innerHtml:get$c(spec.icon,providersBackstage.icons),attributes:{title:providersBackstage.translate(spec.iconTooltip)}},action:function(comp){emitWith(comp,formActionEvent,{name:"alert-banner",value:spec.url})}})]},{dom:{tag:"div",classes:["tox-notification__body"],innerHtml:providersBackstage.translate(spec.text)}}]})},schema$d=constant([defaulted$1("prefix","form-field"),field$1("fieldBehaviours",[Composing,Representing])]),parts$3=constant([optional({schema:[strict$1("dom")],name:"label"}),optional({factory:{sketch:function(spec){return{uid:spec.uid,dom:{tag:"span",styles:{display:"none"},attributes:{"aria-hidden":"true"},innerHtml:spec.text}}}},schema:[strict$1("text")],name:"aria-descriptor"}),required({factory:{sketch:function(spec){var excludeFactory=exclude$1(spec,["factory"]);return spec.factory.sketch(excludeFactory)}},schema:[strict$1("factory")],name:"field"})]),factory$4=function(detail,components,spec,externals){var behaviours=augment(detail.fieldBehaviours,[Composing.config({find:function(container){return getPart(container,detail,"field")}}),Representing.config({store:{mode:"manual",getValue:function(field){return Composing.getCurrent(field).bind(Representing.getValue)},setValue:function(field,value){Composing.getCurrent(field).each(function(current){Representing.setValue(current,value)})}}})]),events=derive([runOnAttached(function(component,simulatedEvent){var ps=getParts(component,detail,["label","field","aria-descriptor"]);ps.field().each(function(field){var id=generate$1(detail.prefix);ps.label().each(function(label){set$1(label.element(),"for",id),set$1(field.element(),"id",id)}),ps["aria-descriptor"]().each(function(descriptor){var descriptorId=generate$1(detail.prefix);set$1(descriptor.element(),"id",descriptorId),set$1(field.element(),"aria-describedby",descriptorId)})})})]),apis={getField:function(container){return getPart(container,detail,"field")},getLabel:function(container){return getPart(container,detail,"label")}};return{uid:detail.uid,dom:detail.dom,components:components,behaviours:behaviours,events:events,apis:apis}},FormField=composite$1({name:"FormField",configFields:schema$d(),partFields:parts$3(),factory:factory$4,apis:{getField:function(apis,comp){return apis.getField(comp)},getLabel:function(apis,comp){return apis.getLabel(comp)}}}),getCoupled=function(component,coupleConfig,coupleState,name){return coupleState.getOrCreate(component,coupleConfig,name)},CouplingApis=Object.freeze({getCoupled:getCoupled}),CouplingSchema=[strictOf("others",setOf$1(Result.value,anyValue$1()))],init$5=function(spec){var coupled={},getOrCreate=function(component,coupleConfig,name){var available=keys(coupleConfig.others);if(available)return readOptFrom$1(coupled,name).getOrThunk(function(){var builder=readOptFrom$1(coupleConfig.others,name).getOrDie("No information found for coupled component: "+name),spec=builder(component),built=component.getSystem().build(spec);return coupled[name]=built,built});throw new Error("Cannot find coupled component: "+name+". Known coupled components: "+JSON.stringify(available,null,2))},readState=constant({});return nu$5({readState:readState,getOrCreate:getOrCreate})},CouplingState=Object.freeze({init:init$5}),Coupling=create$1({fields:CouplingSchema,name:"coupling",apis:CouplingApis,state:CouplingState}),events$a=function(streamConfig,streamState){var streams=streamConfig.stream.streams,processor=streams.setup(streamConfig,streamState);return derive([run(streamConfig.event,processor),runOnDetached(function(){return streamState.cancel()})].concat(streamConfig.cancelEvent.map(function(e){return[run(e,function(){return streamState.cancel()})]}).getOr([])))},ActiveStreaming=Object.freeze({events:events$a}),throttle=function(_config){var state=Cell(null),readState=function(){return{timer:null!==state.get()?"set":"unset"}},setTimer=function(t){state.set(t)},cancel=function(){var t=state.get();null!==t&&t.cancel()};return nu$5({readState:readState,setTimer:setTimer,cancel:cancel})},init$6=function(spec){return spec.stream.streams.state(spec)},StreamingState=Object.freeze({throttle:throttle,init:init$6}),setup$2=function(streamInfo,streamState){var sInfo=streamInfo.stream,throttler=last$2(streamInfo.onStream,sInfo.delay);return streamState.setTimer(throttler),function(component,simulatedEvent){throttler.throttle(component,simulatedEvent),sInfo.stopEvent&&simulatedEvent.stop()}},StreamingSchema=[strictOf("stream",choose$1("mode",{throttle:[strict$1("delay"),defaulted$1("stopEvent",!0),output("streams",{setup:setup$2,state:throttle})]})),defaulted$1("event","input"),option("cancelEvent"),onStrictHandler("onStream")],Streaming=create$1({fields:StreamingSchema,name:"streaming",active:ActiveStreaming,state:StreamingState}),exports$1={},module={exports:exports$1};(function(define,exports,module,require){(function(f){if("object"==typeof exports&&void 0!==module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.EphoxContactWrapper=f()}})(function(){return function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r}()({1:[function(require,module,exports){function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(fun){if(cachedSetTimeout===setTimeout)return setTimeout(fun,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(fun,0);try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout)return clearTimeout(marker);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(marker);try{return cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var timeout=runTimeout(cleanUpNextTick);draining=!0;for(var len=queue.length;len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,runClearTimeout(timeout)}}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}var cachedSetTimeout,cachedClearTimeout,process=module.exports={};(function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}})();var currentQueue,queue=[],draining=!1,queueIndex=-1;process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(name){return[]},process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")},process.umask=function(){return 0}},{}],2:[function(require,module,exports){(function(setImmediate){(function(root){function noop(){}function bind(fn,thisArg){return function(){fn.apply(thisArg,arguments)}}function Promise(fn){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof fn)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],doResolve(fn,this)}function handle(self,deferred){for(;3===self._state;)self=self._value;0!==self._state?(self._handled=!0,Promise._immediateFn(function(){var cb=1===self._state?deferred.onFulfilled:deferred.onRejected;if(null!==cb){var ret;try{ret=cb(self._value)}catch(e){return void reject(deferred.promise,e)}resolve(deferred.promise,ret)}else(1===self._state?resolve:reject)(deferred.promise,self._value)})):self._deferreds.push(deferred)}function resolve(self,newValue){try{if(newValue===self)throw new TypeError("A promise cannot be resolved with itself.");if(newValue&&("object"==typeof newValue||"function"==typeof newValue)){var then=newValue.then;if(newValue instanceof Promise)return self._state=3,self._value=newValue,void finale(self);if("function"==typeof then)return void doResolve(bind(then,newValue),self)}self._state=1,self._value=newValue,finale(self)}catch(e){reject(self,e)}}function reject(self,newValue){self._state=2,self._value=newValue,finale(self)}function finale(self){2===self._state&&0===self._deferreds.length&&Promise._immediateFn(function(){self._handled||Promise._unhandledRejectionFn(self._value)});for(var i=0,len=self._deferreds.length;i<len;i++)handle(self,self._deferreds[i]);self._deferreds=null}function Handler(onFulfilled,onRejected,promise){this.onFulfilled="function"==typeof onFulfilled?onFulfilled:null,this.onRejected="function"==typeof onRejected?onRejected:null,this.promise=promise}function doResolve(fn,self){var done=!1;try{fn(function(value){done||(done=!0,resolve(self,value))},function(reason){done||(done=!0,reject(self,reason))})}catch(ex){if(done)return;done=!0,reject(self,ex)}}var setTimeoutFunc=setTimeout;Promise.prototype.catch=function(onRejected){return this.then(null,onRejected)},Promise.prototype.then=function(onFulfilled,onRejected){var prom=new this.constructor(noop);return handle(this,new Handler(onFulfilled,onRejected,prom)),prom},Promise.all=function(arr){var args=Array.prototype.slice.call(arr);return new Promise(function(resolve,reject){function res(i,val){try{if(val&&("object"==typeof val||"function"==typeof val)){var then=val.then;if("function"==typeof then)return void then.call(val,function(val){res(i,val)},reject)}args[i]=val,0==--remaining&&resolve(args)}catch(ex){reject(ex)}}if(0===args.length)return resolve([]);for(var remaining=args.length,i=0;i<args.length;i++)res(i,args[i])})},Promise.resolve=function(value){return value&&"object"==typeof value&&value.constructor===Promise?value:new Promise(function(resolve){resolve(value)})},Promise.reject=function(value){return new Promise(function(resolve,reject){reject(value)})},Promise.race=function(values){return new Promise(function(resolve,reject){for(var i=0,len=values.length;i<len;i++)values[i].then(resolve,reject)})},Promise._immediateFn="function"==typeof setImmediate?function(fn){setImmediate(fn)}:function(fn){setTimeoutFunc(fn,0)},Promise._unhandledRejectionFn=function(err){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",err)},Promise._setImmediateFn=function(fn){Promise._immediateFn=fn},Promise._setUnhandledRejectionFn=function(fn){Promise._unhandledRejectionFn=fn},void 0!==module&&module.exports?module.exports=Promise:root.Promise||(root.Promise=Promise)})(this)}).call(this,require("timers").setImmediate)},{timers:3}],3:[function(require,module,exports){(function(setImmediate,clearImmediate){function Timeout(id,clearFn){this._id=id,this._clearFn=clearFn}var nextTick=require("process/browser.js").nextTick,apply=Function.prototype.apply,slice=Array.prototype.slice,immediateIds={},nextImmediateId=0;exports.setTimeout=function(){return new Timeout(apply.call(setTimeout,window,arguments),clearTimeout)},exports.setInterval=function(){return new Timeout(apply.call(setInterval,window,arguments),clearInterval)},exports.clearTimeout=exports.clearInterval=function(timeout){timeout.close()},Timeout.prototype.unref=Timeout.prototype.ref=function(){},Timeout.prototype.close=function(){this._clearFn.call(window,this._id)},exports.enroll=function(item,msecs){clearTimeout(item._idleTimeoutId),item._idleTimeout=msecs},exports.unenroll=function(item){clearTimeout(item._idleTimeoutId),item._idleTimeout=-1},exports._unrefActive=exports.active=function(item){clearTimeout(item._idleTimeoutId);var msecs=item._idleTimeout;msecs>=0&&(item._idleTimeoutId=setTimeout(function(){item._onTimeout&&item._onTimeout()},msecs))},exports.setImmediate="function"==typeof setImmediate?setImmediate:function(fn){var id=nextImmediateId++,args=!(arguments.length<2)&&slice.call(arguments,1);return immediateIds[id]=!0,nextTick(function(){immediateIds[id]&&(args?fn.apply(null,args):fn.call(null),exports.clearImmediate(id))}),id},exports.clearImmediate="function"==typeof clearImmediate?clearImmediate:function(id){delete immediateIds[id]}}).call(this,require("timers").setImmediate,require("timers").clearImmediate)},{"process/browser.js":1,timers:3}],4:[function(require,module,exports){var promisePolyfill=require("promise-polyfill"),Global="undefined"!=typeof window?window:Function("return this;")();module.exports={boltExport:Global.Promise||promisePolyfill}},{"promise-polyfill":2}]},{},[4])(4)})})(void 0,exports$1,module,void 0);var HighlightOnOpen,Promise=module.exports.boltExport,nu$a=function(baseFn){var data=Option.none(),callbacks=[],map=function(f){return nu$a(function(nCallback){get(function(data){nCallback(f(data))})})},get=function(nCallback){isReady()?call(nCallback):callbacks.push(nCallback)},set=function(x){data=Option.some(x),run(callbacks),callbacks=[]},isReady=function(){return data.isSome()},run=function(cbs){each(cbs,call)},call=function(cb){data.each(function(x){domGlobals.setTimeout(function(){cb(x)},0)})};return baseFn(set),{get:get,map:map,isReady:isReady}},pure$1=function(a){return nu$a(function(callback){callback(a)})},LazyValue={nu:nu$a,pure:pure$1},errorReporter=function(err){domGlobals.setTimeout(function(){throw err},0)},make$3=function(run){var get=function(callback){run().then(callback,errorReporter)},map=function(fab){return make$3(function(){return run().then(fab)})},bind=function(aFutureB){return make$3(function(){return run().then(function(v){return aFutureB(v).toPromise()})})},anonBind=function(futureB){return make$3(function(){return run().then(function(){return futureB.toPromise()})})},toLazy=function(){return LazyValue.nu(get)},toCached=function(){var cache=null;return make$3(function(){return null===cache&&(cache=run()),cache})},toPromise=run;return{map:map,bind:bind,anonBind:anonBind,toLazy:toLazy,toCached:toCached,toPromise:toPromise,get:get}},nu$b=function(baseFn){return make$3(function(){return new Promise(baseFn)})},pure$2=function(a){return make$3(function(){return Promise.resolve(a)})},Future={nu:nu$b,pure:pure$2},suffix=constant("sink"),partType=constant(optional({name:suffix(),overrides:constant({dom:{tag:"div"},behaviours:derive$1([Positioning.config({useFixed:!0})]),events:derive([cutter(keydown()),cutter(mousedown()),cutter(click())])})}));(function(HighlightOnOpen){HighlightOnOpen[HighlightOnOpen.HighlightFirst=0]="HighlightFirst",HighlightOnOpen[HighlightOnOpen.HighlightNone=1]="HighlightNone"})(HighlightOnOpen||(HighlightOnOpen={}));var Delimiter,getAnchor=function(detail,component){var hotspot=detail.getHotspot(component).getOr(component),anchor="hotspot",overrides=detail.getAnchorOverrides();return detail.layouts.fold(function(){return{anchor:anchor,hotspot:hotspot,overrides:overrides}},function(layouts){return{anchor:anchor,hotspot:hotspot,overrides:overrides,layouts:layouts}})},fetch=function(detail,mapFetch,component){var fetcher=detail.fetch;return fetcher(component).map(mapFetch)},openF=function(detail,mapFetch,anchor,component,sandbox,externals,highlightOnOpen){var futureData=fetch(detail,mapFetch,component),getLazySink=getSink(component,detail);return futureData.map(function(tdata){return tdata.bind(function(data){return Option.from(tieredMenu.sketch(__assign({},externals.menu(),{uid:generate$2(""),data:data,highlightImmediately:highlightOnOpen===HighlightOnOpen.HighlightFirst,onOpenMenu:function(tmenu,menu){var sink=getLazySink().getOrDie();Positioning.position(sink,anchor,menu),Sandboxing.decloak(sandbox)},onOpenSubmenu:function(tmenu,item,submenu){var sink=getLazySink().getOrDie();Positioning.position(sink,{anchor:"submenu",item:item},submenu),Sandboxing.decloak(sandbox)},onEscape:function(){return Focusing.focus(component),Sandboxing.close(sandbox),Option.some(!0)}})))})})},open$1=function(detail,mapFetch,hotspot,sandbox,externals,onOpenSync,highlightOnOpen){var anchor=getAnchor(detail,hotspot),processed=openF(detail,mapFetch,anchor,hotspot,sandbox,externals,highlightOnOpen);return processed.map(function(tdata){return tdata.fold(function(){Sandboxing.isOpen(sandbox)&&Sandboxing.close(sandbox)},function(data){Sandboxing.cloak(sandbox),Sandboxing.open(sandbox,data),onOpenSync(sandbox)}),sandbox})},close$1=function(detail,mapFetch,component,sandbox,_externals,_onOpenSync,_highlightOnOpen){return Sandboxing.close(sandbox),Future.pure(sandbox)},togglePopup=function(detail,mapFetch,hotspot,externals,onOpenSync,highlightOnOpen){var sandbox=Coupling.getCoupled(hotspot,"sandbox"),showing=Sandboxing.isOpen(sandbox),action=showing?close$1:open$1;return action(detail,mapFetch,hotspot,sandbox,externals,onOpenSync,highlightOnOpen)},matchWidth=function(hotspot,container,useMinWidth){var menu=Composing.getCurrent(container).getOr(container),buttonWidth=get$7(hotspot.element());useMinWidth?set$2(menu.element(),"min-width",buttonWidth+"px"):set$4(menu.element(),buttonWidth)},getSink=function(anyInSystem,sinkDetail){return anyInSystem.getSystem().getByUid(sinkDetail.uid+"-"+suffix()).map(function(internalSink){return function(){return Result.value(internalSink)}}).getOrThunk(function(){return sinkDetail.lazySink.fold(function(){return function(){return Result.error(new Error("No internal sink is specified, nor could an external sink be found"))}},function(lazySinkFn){return function(){return lazySinkFn(anyInSystem)}})})},makeSandbox=function(detail,hotspot,extras){var ariaOwner=manager(),onOpen=function(component,menu){var anchor=getAnchor(detail,hotspot);ariaOwner.link(hotspot.element()),detail.matchWidth&&matchWidth(anchor.hotspot,menu,detail.useMinWidth),detail.onOpen(anchor,component,menu),void 0!==extras&&void 0!==extras.onOpen&&extras.onOpen(component,menu)},onClose=function(component,menu){ariaOwner.unlink(hotspot.element()),void 0!==extras&&void 0!==extras.onClose&&extras.onClose(component,menu)},lazySink=getSink(hotspot,detail);return{dom:{tag:"div",classes:detail.sandboxClasses,attributes:{id:ariaOwner.id(),role:"listbox"}},behaviours:SketchBehaviours.augment(detail.sandboxBehaviours,[Representing.config({store:{mode:"memory",initialValue:hotspot}}),Sandboxing.config({onOpen:onOpen,onClose:onClose,isPartOf:function(container,data,queryElem){return isPartOf(data,queryElem)||isPartOf(hotspot,queryElem)},getAttachPoint:function(){return lazySink().getOrDie()}}),Composing.config({find:function(sandbox){return Sandboxing.getState(sandbox).bind(function(menu){return Composing.getCurrent(menu)})}}),receivingConfig({isExtraPart:constant(!1)})])}},setValueFromItem=function(model,input,item){var itemData=Representing.getValue(item);Representing.setValue(input,itemData),setCursorAtEnd(input)},setSelectionOn=function(input,f){var el=input.element(),value=get$5(el),node=el.dom();"number"!==get$2(el,"type")&&f(node,value)},setCursorAtEnd=function(input){setSelectionOn(input,function(node,value){return node.setSelectionRange(value.length,value.length)})},setSelectionToEnd=function(input,startOffset){setSelectionOn(input,function(node,value){return node.setSelectionRange(startOffset,value.length)})},attemptSelectOver=function(model,input,item){if(model.selectsOver){var currentValue=Representing.getValue(input),inputDisplay_1=model.getDisplayText(currentValue),itemValue=Representing.getValue(item),itemDisplay=model.getDisplayText(itemValue);return 0===itemDisplay.indexOf(inputDisplay_1)?Option.some(function(){setValueFromItem(model,input,item),setSelectionToEnd(input,inputDisplay_1.length)}):Option.none()}return Option.none()},schema$e=constant([option("data"),defaulted$1("inputAttributes",{}),defaulted$1("inputStyles",{}),defaulted$1("tag","input"),defaulted$1("inputClasses",[]),onHandler("onSetValue"),defaulted$1("styles",{}),defaulted$1("eventOrder",{}),field$1("inputBehaviours",[Representing,Focusing]),defaulted$1("selectOnFocus",!0)]),focusBehaviours=function(detail){return derive$1([Focusing.config({onFocus:!1===detail.selectOnFocus?noop:function(component){var input=component.element(),value=get$5(input);input.dom().setSelectionRange(0,value.length)}})])},behaviours=function(detail){return __assign({},focusBehaviours(detail),augment(detail.inputBehaviours,[Representing.config({store:{mode:"manual",initialValue:detail.data.getOr(void 0),getValue:function(input){return get$5(input.element())},setValue:function(input,data){var current=get$5(input.element());current!==data&&set$3(input.element(),data)}},onSetValue:detail.onSetValue})]))},dom$2=function(detail){return{tag:detail.tag,attributes:__assign({type:"text"},detail.inputAttributes),styles:detail.inputStyles,classes:detail.inputClasses}},itemExecute=constant("alloy.typeahead.itemexecute"),make$4=function(detail,components,spec,externals){var navigateList=function(comp,simulatedEvent,highlighter){detail.previewing.set(!1);var sandbox=Coupling.getCoupled(comp,"sandbox");if(Sandboxing.isOpen(sandbox))Composing.getCurrent(sandbox).each(function(menu){Highlighting.getHighlighted(menu).fold(function(){highlighter(menu)},function(){dispatchEvent(sandbox,menu.element(),"keydown",simulatedEvent)})});else{var onOpenSync=function(sandbox){Composing.getCurrent(sandbox).each(highlighter)};open$1(detail,mapFetch(comp),comp,sandbox,externals,onOpenSync,HighlightOnOpen.HighlightFirst).get(noop)}},focusBehaviours$1=focusBehaviours(detail),mapFetch=function(comp){return function(tdata){return tdata.map(function(data){var menus=values(data.menus),items=bind(menus,function(menu){return filter(menu.items,function(item){return"item"===item.type})}),repState=Representing.getState(comp);return repState.update(map(items,function(item){return item.data})),data})}},behaviours=[Focusing.config({}),Representing.config({onSetValue:detail.onSetValue,store:__assign({mode:"dataset",getDataKey:function(comp){return get$5(comp.element())},getFallbackEntry:function(itemString){return{value:itemString,meta:{}}},setValue:function(comp,data){set$3(comp.element(),detail.model.getDisplayText(data))}},detail.initialData.map(function(d){return wrap$1("initialValue",d)}).getOr({}))}),Streaming.config({stream:{mode:"throttle",delay:detail.responseTime,stopEvent:!1},onStream:function(component,simulatedEvent){var sandbox=Coupling.getCoupled(component,"sandbox"),focusInInput=Focusing.isFocused(component);if(focusInInput&&get$5(component.element()).length>=detail.minChars){var previousValue_1=Composing.getCurrent(sandbox).bind(function(menu){return Highlighting.getHighlighted(menu).map(Representing.getValue)});detail.previewing.set(!0);var onOpenSync=function(_sandbox){Composing.getCurrent(sandbox).each(function(menu){previousValue_1.fold(function(){detail.model.selectsOver&&Highlighting.highlightFirst(menu)},function(pv){Highlighting.highlightBy(menu,function(item){var itemData=Representing.getValue(item);return itemData.value===pv.value}),Highlighting.getHighlighted(menu).orThunk(function(){return Highlighting.highlightFirst(menu),Option.none()})})})};open$1(detail,mapFetch(component),component,sandbox,externals,onOpenSync,HighlightOnOpen.HighlightFirst).get(noop)}},cancelEvent:typeaheadCancel()}),Keying.config({mode:"special",onDown:function(comp,simulatedEvent){return navigateList(comp,simulatedEvent,Highlighting.highlightFirst),Option.some(!0)},onEscape:function(comp){var sandbox=Coupling.getCoupled(comp,"sandbox");return Sandboxing.isOpen(sandbox)?(Sandboxing.close(sandbox),Option.some(!0)):Option.none()},onUp:function(comp,simulatedEvent){return navigateList(comp,simulatedEvent,Highlighting.highlightLast),Option.some(!0)},onEnter:function(comp){var sandbox=Coupling.getCoupled(comp,"sandbox"),sandboxIsOpen=Sandboxing.isOpen(sandbox);if(sandboxIsOpen&&!detail.previewing.get())return Composing.getCurrent(sandbox).bind(function(menu){return Highlighting.getHighlighted(menu)}).map(function(item){return emitWith(comp,itemExecute(),{item:item}),!0});var currentValue=Representing.getValue(comp);return emit(comp,typeaheadCancel()),detail.onExecute(sandbox,comp,currentValue),sandboxIsOpen&&Sandboxing.close(sandbox),Option.some(!0)}}),Toggling.config({toggleClass:detail.markers.openClass,aria:{mode:"expanded"}}),Coupling.config({others:{sandbox:function(hotspot){return makeSandbox(detail,hotspot,{onOpen:function(){return Toggling.on(hotspot)},onClose:function(){return Toggling.off(hotspot)}})}}}),config("typeaheadevents",[runOnExecute(function(comp){var onOpenSync=noop;togglePopup(detail,mapFetch(comp),comp,externals,onOpenSync,HighlightOnOpen.HighlightFirst).get(noop)}),run(itemExecute(),function(comp,se){var sandbox=Coupling.getCoupled(comp,"sandbox");setValueFromItem(detail.model,comp,se.event().item()),emit(comp,typeaheadCancel()),detail.onItemExecute(comp,sandbox,se.event().item(),Representing.getValue(comp)),Sandboxing.close(sandbox),setCursorAtEnd(comp)})].concat(detail.dismissOnBlur?[run(postBlur(),function(typeahead){var sandbox=Coupling.getCoupled(typeahead,"sandbox");search$1(sandbox.element()).isNone()&&Sandboxing.close(sandbox)})]:[]))];return{uid:detail.uid,dom:dom$2(deepMerge(detail,{inputAttributes:{role:"combobox","aria-autocomplete":"list","aria-haspopup":"true"}})),behaviours:__assign({},focusBehaviours$1,augment(detail.typeaheadBehaviours,behaviours)),eventOrder:detail.eventOrder}},sandboxFields=function(){return[defaulted$1("sandboxClasses",[]),SketchBehaviours.field("sandboxBehaviours",[Composing,Receiving,Sandboxing,Representing])]},schema$f=constant([option("lazySink"),strict$1("fetch"),defaulted$1("minChars",5),defaulted$1("responseTime",1e3),onHandler("onOpen"),defaulted$1("getHotspot",Option.some),defaulted$1("getAnchorOverrides",constant({})),defaulted$1("layouts",Option.none()),defaulted$1("eventOrder",{}),defaultedObjOf("model",{},[defaulted$1("getDisplayText",function(itemData){return void 0!==itemData.meta&&void 0!==itemData.meta.text?itemData.meta.text:itemData.value}),defaulted$1("selectsOver",!0),defaulted$1("populateFromBrowse",!0)]),onHandler("onSetValue"),onKeyboardHandler("onExecute"),onHandler("onItemExecute"),defaulted$1("inputClasses",[]),defaulted$1("inputAttributes",{}),defaulted$1("inputStyles",{}),defaulted$1("matchWidth",!0),defaulted$1("useMinWidth",!1),defaulted$1("dismissOnBlur",!0),markers(["openClass"]),option("initialData"),field$1("typeaheadBehaviours",[Focusing,Representing,Streaming,Keying,Toggling,Coupling]),state$1("previewing",function(){return Cell(!0)})].concat(schema$e()).concat(sandboxFields())),parts$4=constant([external$1({schema:[tieredMenuMarkers()],name:"menu",overrides:function(detail){return{fakeFocus:!0,onHighlight:function(menu,item){detail.previewing.get()?menu.getSystem().getByUid(detail.uid).each(function(input){attemptSelectOver(detail.model,input,item).fold(function(){return Highlighting.dehighlight(menu,item)},function(fn){return fn()})}):menu.getSystem().getByUid(detail.uid).each(function(input){detail.model.populateFromBrowse&&setValueFromItem(detail.model,input,item)}),detail.previewing.set(!1)},onExecute:function(menu,item){return menu.getSystem().getByUid(detail.uid).toOption().map(function(typeahead){return emitWith(typeahead,itemExecute(),{item:item}),!0})},onHover:function(menu,item){detail.previewing.set(!1),menu.getSystem().getByUid(detail.uid).each(function(input){detail.model.populateFromBrowse&&setValueFromItem(detail.model,input,item)})}}}})]),Typeahead=composite$1({name:"Typeahead",configFields:schema$f(),partFields:parts$4(),factory:make$4}),renderFormFieldWith=function(pLabel,pField,extraClasses,extraBehaviours){var spec=renderFormFieldSpecWith(pLabel,pField,extraClasses,extraBehaviours);return FormField.sketch(spec)},renderFormField=function(pLabel,pField){return renderFormFieldWith(pLabel,pField,[],[])},renderFormFieldSpecWith=function(pLabel,pField,extraClasses,extraBehaviours){return{dom:renderFormFieldDomWith(extraClasses),
components:pLabel.toArray().concat([pField]),fieldBehaviours:derive$1(extraBehaviours)}},renderFormFieldDom=function(){return renderFormFieldDomWith([])},renderFormFieldDomWith=function(extraClasses){return{tag:"div",classes:["tox-form__group"].concat(extraClasses)}},renderLabel=function(label,providersBackstage){return FormField.parts().label({dom:{tag:"label",classes:["tox-label"],innerHtml:providersBackstage.translate(label)}})},isMenuItemReference=function(item){return isString(item)},isSeparator=function(item){return"separator"===item.type},isExpandingMenuItem=function(item){return has(item,"getSubmenuItems")},separator$1={type:"separator"},unwrapReferences=function(items,menuItems){var realItems=foldl(items,function(acc,item){return isMenuItemReference(item)?""===item?acc:"|"===item?acc.length>0&&!isSeparator(acc[acc.length-1])?acc.concat([separator$1]):acc:has(menuItems,item.toLowerCase())?acc.concat([menuItems[item.toLowerCase()]]):acc:acc.concat([item])},[]);return realItems.length>0&&isSeparator(realItems[realItems.length-1])&&realItems.pop(),realItems},getFromExpandingItem=function(item,menuItems){var submenuItems=item.getSubmenuItems(),rest=expand(submenuItems,menuItems),newMenus=deepMerge(rest.menus,wrap$1(item.value,rest.items)),newExpansions=deepMerge(rest.expansions,wrap$1(item.value,item.value));return{item:item,menus:newMenus,expansions:newExpansions}},getFromItem=function(item,menuItems){return isExpandingMenuItem(item)?getFromExpandingItem(item,menuItems):{item:item,menus:{},expansions:{}}},generateValueIfRequired=function(item){if(isSeparator(item))return item;var itemValue=readOptFrom$1(item,"value").getOrThunk(function(){return generate$1("generated-menu-item")});return deepMerge({value:itemValue},item)},expand=function(items,menuItems){var realItems=unwrapReferences(isString(items)?items.split(" "):items,menuItems);return foldr(realItems,function(acc,item){var itemWithValue=generateValueIfRequired(item),newData=getFromItem(itemWithValue,menuItems);return{menus:deepMerge(acc.menus,newData.menus),items:[newData.item].concat(acc.items),expansions:deepMerge(acc.expansions,newData.expansions)}},{menus:{},expansions:{},items:[]})},build$2=function(items,itemResponse,backstage){var primary=generate$1("primary-menu"),data=expand(items,backstage.shared.providers.menuItems());if(0===data.items.length)return Option.none();var mainMenu=createPartialMenu(primary,data.items,itemResponse,backstage),submenus=map$1(data.menus,function(menuItems,menuName){return createPartialMenu(menuName,menuItems,itemResponse,backstage)}),menus=deepMerge(submenus,wrap$1(primary,mainMenu));return Option.from(tieredMenu.tieredData(primary,menus,data.expansions))},renderAutocomplete=function(spec,backstage){var pLabel=renderLabel(spec.label.getOr("?"),backstage.shared.providers),pField=FormField.parts().field({factory:Typeahead,dismissOnBlur:!1,inputClasses:["tox-textfield"],minChars:1,fetch:function(input){var value=Representing.getValue(input),items=spec.getItems(value),tdata=build$2(items,ItemResponse$1.BUBBLE_TO_SANDBOX,backstage);return Future.pure(tdata)},markers:{openClass:"dog"},lazySink:backstage.shared.getSink,parts:{menu:part(!1,1,"normal")}});return renderFormField(Option.some(pLabel),pField)},renderBar=function(spec,backstage){return{dom:{tag:"div",classes:["tox-bar","tox-form__controls-h-stack"]},components:map(spec.items,backstage.interpreter)}},factory$5=function(detail,spec){return{uid:detail.uid,dom:dom$2(detail),components:[],behaviours:behaviours(detail),eventOrder:detail.eventOrder}},Input=single$2({name:"Input",configFields:schema$e(),factory:factory$5}),ariaElements=["input","textarea"],isAriaElement=function(elem){var name$1=name(elem);return contains(ariaElements,name$1)},markValid=function(component,invalidConfig){var elem=invalidConfig.getRoot(component).getOr(component.element());remove$4(elem,invalidConfig.invalidClass),invalidConfig.notify.each(function(notifyInfo){isAriaElement(component.element())&&set$1(component.element(),"aria-invalid",!1),notifyInfo.getContainer(component).each(function(container){set(container,notifyInfo.validHtml)}),notifyInfo.onValid(component)})},markInvalid=function(component,invalidConfig,invalidState,text){var elem=invalidConfig.getRoot(component).getOr(component.element());add$2(elem,invalidConfig.invalidClass),invalidConfig.notify.each(function(notifyInfo){isAriaElement(component.element())&&set$1(component.element(),"aria-invalid",!0),notifyInfo.getContainer(component).each(function(container){set(container,text)}),notifyInfo.onInvalid(component,text)})},query=function(component,invalidConfig,invalidState){return invalidConfig.validator.fold(function(){return Future.pure(Result.value(!0))},function(validatorInfo){return validatorInfo.validate(component)})},run$1=function(component,invalidConfig,invalidState){return invalidConfig.notify.each(function(notifyInfo){notifyInfo.onValidate(component)}),query(component,invalidConfig).map(function(valid){return component.getSystem().isConnected()?valid.fold(function(err){return markInvalid(component,invalidConfig,invalidState,err),Result.error(err)},function(v){return markValid(component,invalidConfig),Result.value(v)}):Result.error("No longer in system")})},isInvalid=function(component,invalidConfig){var elem=invalidConfig.getRoot(component).getOr(component.element());return has$2(elem,invalidConfig.invalidClass)},InvalidateApis=Object.freeze({markValid:markValid,markInvalid:markInvalid,query:query,run:run$1,isInvalid:isInvalid}),events$b=function(invalidConfig,invalidState){return invalidConfig.validator.map(function(validatorInfo){return derive([run(validatorInfo.onEvent,function(component){run$1(component,invalidConfig,invalidState).get(identity)})].concat(validatorInfo.validateOnLoad?[runOnAttached(function(component){run$1(component,invalidConfig,invalidState).get(noop)})]:[]))}).getOr({})},ActiveInvalidate=Object.freeze({events:events$b}),InvalidateSchema=[strict$1("invalidClass"),defaulted$1("getRoot",Option.none),optionObjOf("notify",[defaulted$1("aria","alert"),defaulted$1("getContainer",Option.none),defaulted$1("validHtml",""),onHandler("onValid"),onHandler("onInvalid"),onHandler("onValidate")]),optionObjOf("validator",[strict$1("validate"),defaulted$1("onEvent","input"),defaulted$1("validateOnLoad",!0)])],Invalidating=create$1({fields:InvalidateSchema,name:"invalidating",active:ActiveInvalidate,apis:InvalidateApis,extra:{validation:function(validator){return function(component){var v=Representing.getValue(component);return Future.pure(validator(v))}}}}),exhibit$4=function(base,tabConfig){return nu$6({attributes:wrapAll$1([{key:tabConfig.tabAttr,value:"true"}])})},ActiveTabstopping=Object.freeze({exhibit:exhibit$4}),TabstopSchema=[defaulted$1("tabAttr","data-alloy-tabstop")],Tabstopping=create$1({fields:TabstopSchema,name:"tabstopping",active:ActiveTabstopping}),schema$g=constant([strict$1("dom"),strict$1("fetch"),onHandler("onOpen"),onKeyboardHandler("onExecute"),defaulted$1("getHotspot",Option.some),defaulted$1("getAnchorOverrides",constant({})),defaulted$1("layouts",Option.none()),field$1("dropdownBehaviours",[Toggling,Coupling,Keying,Focusing]),strict$1("toggleClass"),defaulted$1("eventOrder",{}),option("lazySink"),defaulted$1("matchWidth",!1),defaulted$1("useMinWidth",!1),option("role")].concat(sandboxFields())),parts$5=constant([external$1({schema:[tieredMenuMarkers()],name:"menu",defaults:function(detail){return{onExecute:detail.onExecute}}}),partType()]),factory$6=function(detail,components,_spec,externals){var _a,lookupAttr=function(attr){return readOptFrom$1(detail.dom,"attributes").bind(function(attrs){return readOptFrom$1(attrs,attr)})},switchToMenu=function(sandbox){Sandboxing.getState(sandbox).each(function(tmenu){tieredMenu.highlightPrimary(tmenu)})},action=function(component){var onOpenSync=switchToMenu;togglePopup(detail,function(x){return x},component,externals,onOpenSync,HighlightOnOpen.HighlightFirst).get(noop)},apis={expand:function(comp){Toggling.isOn(comp)||togglePopup(detail,function(x){return x},comp,externals,noop,HighlightOnOpen.HighlightNone).get(noop)},open:function(comp){Toggling.isOn(comp)||togglePopup(detail,function(x){return x},comp,externals,noop,HighlightOnOpen.HighlightFirst).get(noop)},isOpen:Toggling.isOn,close:function(comp){Toggling.isOn(comp)&&togglePopup(detail,function(x){return x},comp,externals,noop,HighlightOnOpen.HighlightFirst).get(noop)}},triggerExecute=function(comp,se){return emitExecute(comp),Option.some(!0)};return{uid:detail.uid,dom:detail.dom,components:components,behaviours:augment(detail.dropdownBehaviours,[Toggling.config({toggleClass:detail.toggleClass,aria:{mode:"expanded"}}),Coupling.config({others:{sandbox:function(hotspot){return makeSandbox(detail,hotspot,{onOpen:function(){Toggling.on(hotspot)},onClose:function(){Toggling.off(hotspot)}})}}}),Keying.config({mode:"special",onSpace:triggerExecute,onEnter:triggerExecute,onDown:function(comp,se){if(Dropdown.isOpen(comp)){var sandbox=Coupling.getCoupled(comp,"sandbox");switchToMenu(sandbox)}else Dropdown.open(comp);return Option.some(!0)},onEscape:function(comp,se){return Dropdown.isOpen(comp)?(Dropdown.close(comp),Option.some(!0)):Option.none()}}),Focusing.config({})]),events:events$7(Option.some(action)),eventOrder:__assign({},detail.eventOrder,(_a={},_a[execute()]=["disabling","toggling","alloy.base.behaviour"],_a)),apis:apis,domModification:{attributes:__assign({"aria-haspopup":"true"},detail.role.fold(function(){return{}},function(role){return{role:role}}),"button"===detail.dom.tag?{type:lookupAttr("type").getOr("button")}:{})}}},Dropdown=composite$1({name:"Dropdown",configFields:schema$g(),partFields:parts$5(),factory:factory$6,apis:{open:function(apis,comp){return apis.open(comp)},expand:function(apis,comp){return apis.expand(comp)},close:function(apis,comp){return apis.close(comp)},isOpen:function(apis,comp){return apis.isOpen(comp)}}}),exhibit$5=function(base,unselectConfig){return nu$6({styles:{"-webkit-user-select":"none","user-select":"none","-ms-user-select":"none","-moz-user-select":"-moz-none"},attributes:{unselectable:"on"}})},events$c=function(unselectConfig){return derive([abort(selectstart(),constant(!0))])},ActiveUnselecting=Object.freeze({events:events$c,exhibit:exhibit$5}),Unselecting=create$1({fields:[],name:"unselecting",active:ActiveUnselecting}),renderPanelButton=function(spec,sharedBackstage){return Dropdown.sketch({dom:spec.dom,components:spec.components,toggleClass:"mce-active",dropdownBehaviours:derive$1([Unselecting.config({}),Tabstopping.config({})]),layouts:spec.layouts,sandboxClasses:["tox-dialog__popups"],lazySink:sharedBackstage.getSink,fetch:function(comp){return Future.nu(function(callback){return spec.fetch(callback)}).map(function(items){return Option.from(createTieredDataFrom(deepMerge(createPartialChoiceMenu(generate$1("menu-value"),items,function(value){spec.onItemAction(comp,value)},spec.columns,spec.presets,ItemResponse$1.CLOSE_ON_EXECUTE,function(){return!1},sharedBackstage.providers),{movement:deriveMenuMovement(spec.columns,spec.presets)})))})},parts:{menu:part(!1,1,spec.presets)}})},colorInputChangeEvent=generate$1("color-input-change"),colorSwatchChangeEvent=generate$1("color-swatch-change"),colorPickerCancelEvent=generate$1("color-picker-cancel"),renderColorInput=function(spec,sharedBackstage,colorInputBackstage){var pField=FormField.parts().field({factory:Input,inputClasses:["tox-textfield"],onSetValue:function(c){return Invalidating.run(c).get(function(){})},inputBehaviours:derive$1([Tabstopping.config({}),Invalidating.config({invalidClass:"tox-textbox-field-invalid",getRoot:function(comp){return parent(comp.element())},notify:{onValid:function(comp){var val=Representing.getValue(comp);emitWith(comp,colorInputChangeEvent,{color:val})}},validator:{validateOnLoad:!1,validate:function(input){var inputValue=Representing.getValue(input);if(0===inputValue.length)return Future.pure(Result.value(!0));var span=Element.fromTag("span");set$2(span,"background-color",inputValue);var res=getRaw(span,"background-color").fold(function(){return Result.error("blah")},function(_){return Result.value(inputValue)});return Future.pure(res)}}})]),selectOnFocus:!1}),pLabel=spec.label.map(function(label){return renderLabel(label,sharedBackstage.providers)}),emitSwatchChange=function(colorBit,value){emitWith(colorBit,colorSwatchChangeEvent,{value:value})},onItemAction=function(comp,value){memColorButton.getOpt(comp).each(function(colorBit){"custom"===value?colorInputBackstage.colorPicker(function(valueOpt){valueOpt.fold(function(){return emit(colorBit,colorPickerCancelEvent)},function(value){emitSwatchChange(colorBit,value),Settings.addColor(value)})},"#ffffff"):emitSwatchChange(colorBit,"remove"===value?"":value)})},memColorButton=record(renderPanelButton({dom:{tag:"span",attributes:{"aria-label":sharedBackstage.providers.translate("Color swatch")}},layouts:Option.some({onRtl:function(){return[southeast$1]},onLtr:function(){return[southwest$1]}}),components:[],fetch:ColorSwatch.getFetch(colorInputBackstage.getColors(),colorInputBackstage.hasCustomColors()),columns:colorInputBackstage.getColorCols(),presets:"color",onItemAction:onItemAction},sharedBackstage));return FormField.sketch({dom:{tag:"div",classes:["tox-form__group"]},components:pLabel.toArray().concat([{dom:{tag:"div",classes:["tox-color-input"]},components:[pField,memColorButton.asSpec()]}]),fieldBehaviours:derive$1([config("form-field-events",[run(colorInputChangeEvent,function(comp,se){memColorButton.getOpt(comp).each(function(colorButton){set$2(colorButton.element(),"background-color",se.event().color())}),emitWith(comp,formChangeEvent,{name:spec.name})}),run(colorSwatchChangeEvent,function(comp,se){FormField.getField(comp).each(function(field){Representing.setValue(field,se.event().value()),Composing.getCurrent(comp).each(Focusing.focus)})}),run(colorPickerCancelEvent,function(comp,se){FormField.getField(comp).each(function(field){Composing.getCurrent(comp).each(Focusing.focus)})})])])})},hsvColour=function(hue,saturation,value){return{hue:constant(hue),saturation:constant(saturation),value:constant(value)}},fromRgb=function(rgbaColour){var h=0,s=0,v=0,r=rgbaColour.red()/255,g=rgbaColour.green()/255,b=rgbaColour.blue()/255,minRGB=Math.min(r,Math.min(g,b)),maxRGB=Math.max(r,Math.max(g,b));if(minRGB===maxRGB)return v=minRGB,hsvColour(0,0,100*v);var d=r===minRGB?g-b:b===minRGB?r-g:b-r;return h=r===minRGB?3:b===minRGB?1:5,h=60*(h-d/(maxRGB-minRGB)),s=(maxRGB-minRGB)/maxRGB,v=maxRGB,hsvColour(Math.round(h),Math.round(100*s),Math.round(100*v))},calcHex=function(value){var hue=(100-value)/100*360,hsv=hsvColour(hue,100,100),rgb=fromHsv(hsv);return fromRgba(rgb)},fieldsUpdate=constant(generate$1("rgb-hex-update")),sliderUpdate=constant(generate$1("slider-update")),paletteUpdate=constant(generate$1("palette-update")),platform=PlatformDetection$1.detect(),isTouch=platform.deviceType.isTouch(),labelPart=optional({schema:[strict$1("dom")],name:"label"}),edgePart=function(name){return optional({name:name+"-edge",overrides:function(detail){var action=detail.model.manager.edgeActions[name];return action.fold(function(){return{}},function(a){var touchEvents=derive([runActionExtra(touchstart(),a,[detail])]),mouseEvents=derive([runActionExtra(mousedown(),a,[detail]),runActionExtra(mousemove(),function(l,det){det.mouseIsDown.get()&&a(l,det)},[detail])]);return{events:isTouch?touchEvents:mouseEvents}})}})},tlEdgePart=edgePart("top-left"),tedgePart=edgePart("top"),trEdgePart=edgePart("top-right"),redgePart=edgePart("right"),brEdgePart=edgePart("bottom-right"),bedgePart=edgePart("bottom"),blEdgePart=edgePart("bottom-left"),ledgePart=edgePart("left"),thumbPart=required({name:"thumb",defaults:constant({dom:{styles:{position:"absolute"}}}),overrides:function(detail){return{events:derive([redirectToPart(touchstart(),detail,"spectrum"),redirectToPart(touchmove(),detail,"spectrum"),redirectToPart(touchend(),detail,"spectrum"),redirectToPart(mousedown(),detail,"spectrum"),redirectToPart(mousemove(),detail,"spectrum"),redirectToPart(mouseup(),detail,"spectrum")])}}}),spectrumPart=required({schema:[state$1("mouseIsDown",function(){return Cell(!1)})],name:"spectrum",overrides:function(detail){var modelDetail=detail.model,model=modelDetail.manager,setValueFrom=function(component,simulatedEvent){return model.getValueFromEvent(simulatedEvent).map(function(value){return model.setValueFrom(component,detail,value)})},touchEvents=derive([run(touchstart(),setValueFrom),run(touchmove(),setValueFrom)]),mouseEvents=derive([run(mousedown(),setValueFrom),run(mousemove(),function(spectrum,se){detail.mouseIsDown.get()&&setValueFrom(spectrum,se)})]);return{behaviours:derive$1(isTouch?[]:[Keying.config({mode:"special",onLeft:function(spectrum){return model.onLeft(spectrum,detail)},onRight:function(spectrum){return model.onRight(spectrum,detail)},onUp:function(spectrum){return model.onUp(spectrum,detail)},onDown:function(spectrum){return model.onDown(spectrum,detail)}}),Focusing.config({})]),events:isTouch?touchEvents:mouseEvents}}}),SliderParts=[labelPart,ledgePart,redgePart,tedgePart,bedgePart,tlEdgePart,trEdgePart,blEdgePart,brEdgePart,thumbPart,spectrumPart],isTouch$1=PlatformDetection$1.detect().deviceType.isTouch(),_sliderChangeEvent="slider.change.value",sliderChangeEvent=constant(_sliderChangeEvent),getEventSource=function(simulatedEvent){var evt=simulatedEvent.event().raw();if(isTouch$1){var touchEvent=evt;return void 0!==touchEvent.touches&&1===touchEvent.touches.length?Option.some(touchEvent.touches[0]).map(function(t){return Position(t.clientX,t.clientY)}):Option.none()}var mouseEvent=evt;return void 0!==mouseEvent.clientX?Option.some(mouseEvent).map(function(me){return Position(me.clientX,me.clientY)}):Option.none()},t="top",r$1="right",b="bottom",l="left",minX=function(detail){return detail.model.minX},minY=function(detail){return detail.model.minY},min1X=function(detail){return detail.model.minX-1},min1Y=function(detail){return detail.model.minY-1},maxX=function(detail){return detail.model.maxX},maxY=function(detail){return detail.model.maxY},max1X=function(detail){return detail.model.maxX+1},max1Y=function(detail){return detail.model.maxY+1},range$2=function(detail,max,min){return max(detail)-min(detail)},xRange=function(detail){return range$2(detail,maxX,minX)},yRange=function(detail){return range$2(detail,maxY,minY)},halfX=function(detail){return xRange(detail)/2},halfY=function(detail){return yRange(detail)/2},step=function(detail){return detail.stepSize},snap=function(detail){return detail.snapToGrid},snapStart=function(detail){return detail.snapStart},rounded=function(detail){return detail.rounded},hasEdge=function(detail,edgeName){return void 0!==detail[edgeName+"-edge"]},hasLEdge=function(detail){return hasEdge(detail,l)},hasREdge=function(detail){return hasEdge(detail,r$1)},hasTEdge=function(detail){return hasEdge(detail,t)},hasBEdge=function(detail){return hasEdge(detail,b)},currentValue=function(detail){return detail.model.value.get()},xValue=function(x){return{x:constant(x)}},yValue=function(y){return{y:constant(y)}},xyValue=function(x,y){return{x:constant(x),y:constant(y)}},fireSliderChange=function(component,value){emitWith(component,sliderChangeEvent(),{value:value})},setToTLEdgeXY=function(edge,detail){fireSliderChange(edge,xyValue(min1X(detail),min1Y(detail)))},setToTEdge=function(edge,detail){fireSliderChange(edge,yValue(min1Y(detail)))},setToTEdgeXY=function(edge,detail){fireSliderChange(edge,xyValue(halfX(detail),min1Y(detail)))},setToTREdgeXY=function(edge,detail){fireSliderChange(edge,xyValue(max1X(detail),min1Y(detail)))},setToREdge=function(edge,detail){fireSliderChange(edge,xValue(max1X(detail)))},setToREdgeXY=function(edge,detail){fireSliderChange(edge,xyValue(max1X(detail),halfY(detail)))},setToBREdgeXY=function(edge,detail){fireSliderChange(edge,xyValue(max1X(detail),max1Y(detail)))},setToBEdge=function(edge,detail){fireSliderChange(edge,yValue(max1Y(detail)))},setToBEdgeXY=function(edge,detail){fireSliderChange(edge,xyValue(halfX(detail),max1Y(detail)))},setToBLEdgeXY=function(edge,detail){fireSliderChange(edge,xyValue(min1X(detail),max1Y(detail)))},setToLEdge=function(edge,detail){fireSliderChange(edge,xValue(min1X(detail)))},setToLEdgeXY=function(edge,detail){fireSliderChange(edge,xyValue(min1X(detail),halfY(detail)))},reduceBy=function(value,min,max,step){return value<min?value:value>max?max:value===min?min-1:Math.max(min,value-step)},increaseBy=function(value,min,max,step){return value>max?value:value<min?min:value===max?max+1:Math.min(max,value+step)},capValue=function(value,min,max){return Math.max(min,Math.min(max,value))},snapValueOf=function(value,min,max,step,snapStart){return snapStart.fold(function(){var initValue=value-min,extraValue=Math.round(initValue/step)*step;return capValue(min+extraValue,min-1,max+1)},function(start){var remainder=(value-start)%step,adjustment=Math.round(remainder/step),rawSteps=Math.floor((value-start)/step),maxSteps=Math.floor((max-start)/step),numSteps=Math.min(maxSteps,rawSteps+adjustment),r=start+numSteps*step;return Math.max(start,r)})},findOffsetOf=function(value,min,max){return Math.min(max,Math.max(value,min))-min},findValueOf=function(args){var min=args.min,max=args.max,range=args.range,value=args.value,step=args.step,snap=args.snap,snapStart=args.snapStart,rounded=args.rounded,hasMinEdge=args.hasMinEdge,hasMaxEdge=args.hasMaxEdge,minBound=args.minBound,maxBound=args.maxBound,screenRange=args.screenRange,capMin=hasMinEdge?min-1:min,capMax=hasMaxEdge?max+1:max;if(value<minBound)return capMin;if(value>maxBound)return capMax;var offset=findOffsetOf(value,minBound,maxBound),newValue=capValue(offset/screenRange*range+min,capMin,capMax);return snap&&newValue>=min&&newValue<=max?snapValueOf(newValue,min,max,step,snapStart):rounded?Math.round(newValue):newValue},findOffsetOfValue=function(args){var min=args.min,max=args.max,range=args.range,value=args.value,hasMinEdge=args.hasMinEdge,hasMaxEdge=args.hasMaxEdge,maxBound=args.maxBound,maxOffset=args.maxOffset,centerMinEdge=args.centerMinEdge,centerMaxEdge=args.centerMaxEdge;return value<min?hasMinEdge?0:centerMinEdge:value>max?hasMaxEdge?maxBound:centerMaxEdge:(value-min)/range*maxOffset},top="top",right="right",bottom="bottom",left="left",width="width",height="height",getBounds=function(component){return component.element().dom().getBoundingClientRect()},getBoundsProperty=function(bounds,property){return bounds[property]},getMinXBounds=function(component){var bounds=getBounds(component);return getBoundsProperty(bounds,left)},getMaxXBounds=function(component){var bounds=getBounds(component);return getBoundsProperty(bounds,right)},getMinYBounds=function(component){var bounds=getBounds(component);return getBoundsProperty(bounds,top)},getMaxYBounds=function(component){var bounds=getBounds(component);return getBoundsProperty(bounds,bottom)},getXScreenRange=function(component){var bounds=getBounds(component);return getBoundsProperty(bounds,width)},getYScreenRange=function(component){var bounds=getBounds(component);return getBoundsProperty(bounds,height)},getCenterOffsetOf=function(componentMinEdge,componentMaxEdge,spectrumMinEdge){return(componentMinEdge+componentMaxEdge)/2-spectrumMinEdge},getXCenterOffSetOf=function(component,spectrum){var componentBounds=getBounds(component),spectrumBounds=getBounds(spectrum),componentMinEdge=getBoundsProperty(componentBounds,left),componentMaxEdge=getBoundsProperty(componentBounds,right),spectrumMinEdge=getBoundsProperty(spectrumBounds,left);return getCenterOffsetOf(componentMinEdge,componentMaxEdge,spectrumMinEdge)},getYCenterOffSetOf=function(component,spectrum){var componentBounds=getBounds(component),spectrumBounds=getBounds(spectrum),componentMinEdge=getBoundsProperty(componentBounds,top),componentMaxEdge=getBoundsProperty(componentBounds,bottom),spectrumMinEdge=getBoundsProperty(spectrumBounds,top);return getCenterOffsetOf(componentMinEdge,componentMaxEdge,spectrumMinEdge)},fireSliderChange$1=function(spectrum,value){emitWith(spectrum,sliderChangeEvent(),{value:value})},sliderValue=function(x){return{x:constant(x)}},findValueOfOffset=function(spectrum,detail,left){var args={min:minX(detail),max:maxX(detail),range:xRange(detail),value:left,step:step(detail),snap:snap(detail),snapStart:snapStart(detail),rounded:rounded(detail),hasMinEdge:hasLEdge(detail),hasMaxEdge:hasREdge(detail),minBound:getMinXBounds(spectrum),maxBound:getMaxXBounds(spectrum),screenRange:getXScreenRange(spectrum)};return findValueOf(args)},setValueFrom=function(spectrum,detail,value){var xValue=findValueOfOffset(spectrum,detail,value),sliderVal=sliderValue(xValue);return fireSliderChange$1(spectrum,sliderVal),xValue},setToMin=function(spectrum,detail){var min=minX(detail);fireSliderChange$1(spectrum,sliderValue(min))},setToMax=function(spectrum,detail){var max=maxX(detail);fireSliderChange$1(spectrum,sliderValue(max))},moveBy=function(direction,spectrum,detail){var f=direction>0?increaseBy:reduceBy,xValue=f(currentValue(detail).x(),minX(detail),maxX(detail),step(detail));return fireSliderChange$1(spectrum,sliderValue(xValue)),Option.some(xValue)},handleMovement=function(direction){return function(spectrum,detail){return moveBy(direction,spectrum,detail).map(function(){return!0})}},getValueFromEvent=function(simulatedEvent){var pos=getEventSource(simulatedEvent);return pos.map(function(p){return p.left()})},findOffsetOfValue$1=function(spectrum,detail,value,minEdge,maxEdge){var minOffset=0,maxOffset=getXScreenRange(spectrum),centerMinEdge=minEdge.bind(function(edge){return Option.some(getXCenterOffSetOf(edge,spectrum))}).getOr(minOffset),centerMaxEdge=maxEdge.bind(function(edge){return Option.some(getXCenterOffSetOf(edge,spectrum))}).getOr(maxOffset),args={min:minX(detail),max:maxX(detail),range:xRange(detail),value:value,hasMinEdge:hasLEdge(detail),hasMaxEdge:hasREdge(detail),minBound:getMinXBounds(spectrum),minOffset:minOffset,maxBound:getMaxXBounds(spectrum),maxOffset:maxOffset,centerMinEdge:centerMinEdge,centerMaxEdge:centerMaxEdge};return findOffsetOfValue(args)},findPositionOfValue=function(slider,spectrum,value,minEdge,maxEdge,detail){var offset=findOffsetOfValue$1(spectrum,detail,value,minEdge,maxEdge);return getMinXBounds(spectrum)-getMinXBounds(slider)+offset},setPositionFromValue=function(slider,thumb,detail,edges){var value=currentValue(detail),pos=findPositionOfValue(slider,edges.getSpectrum(slider),value.x(),edges.getLeftEdge(slider),edges.getRightEdge(slider),detail),thumbRadius=get$7(thumb.element())/2;set$2(thumb.element(),"left",pos-thumbRadius+"px")},onLeft=handleMovement(-1),onRight=handleMovement(1),onUp=Option.none,onDown=Option.none,edgeActions={"top-left":Option.none(),top:Option.none(),"top-right":Option.none(),right:Option.some(setToREdge),"bottom-right":Option.none(),bottom:Option.none(),"bottom-left":Option.none(),left:Option.some(setToLEdge)},HorizontalModel=Object.freeze({setValueFrom:setValueFrom,setToMin:setToMin,setToMax:setToMax,findValueOfOffset:findValueOfOffset,getValueFromEvent:getValueFromEvent,findPositionOfValue:findPositionOfValue,setPositionFromValue:setPositionFromValue,onLeft:onLeft,onRight:onRight,onUp:onUp,onDown:onDown,edgeActions:edgeActions}),fireSliderChange$2=function(spectrum,value){emitWith(spectrum,sliderChangeEvent(),{value:value})},sliderValue$1=function(y){return{y:constant(y)}},findValueOfOffset$1=function(spectrum,detail,top){var args={min:minY(detail),max:maxY(detail),range:yRange(detail),value:top,step:step(detail),snap:snap(detail),snapStart:snapStart(detail),rounded:rounded(detail),hasMinEdge:hasTEdge(detail),hasMaxEdge:hasBEdge(detail),minBound:getMinYBounds(spectrum),maxBound:getMaxYBounds(spectrum),screenRange:getYScreenRange(spectrum)};return findValueOf(args)},setValueFrom$1=function(spectrum,detail,value){var yValue=findValueOfOffset$1(spectrum,detail,value),sliderVal=sliderValue$1(yValue);return fireSliderChange$2(spectrum,sliderVal),yValue},setToMin$1=function(spectrum,detail){var min=minY(detail);fireSliderChange$2(spectrum,sliderValue$1(min))},setToMax$1=function(spectrum,detail){var max=maxY(detail);fireSliderChange$2(spectrum,sliderValue$1(max))},moveBy$1=function(direction,spectrum,detail){var f=direction>0?increaseBy:reduceBy,yValue=f(currentValue(detail).y(),minY(detail),maxY(detail),step(detail));return fireSliderChange$2(spectrum,sliderValue$1(yValue)),Option.some(yValue)},handleMovement$1=function(direction){return function(spectrum,detail){return moveBy$1(direction,spectrum,detail).map(function(){return!0})}},getValueFromEvent$1=function(simulatedEvent){var pos=getEventSource(simulatedEvent);return pos.map(function(p){return p.top()})},findOffsetOfValue$2=function(spectrum,detail,value,minEdge,maxEdge){var minOffset=0,maxOffset=getYScreenRange(spectrum),centerMinEdge=minEdge.bind(function(edge){return Option.some(getYCenterOffSetOf(edge,spectrum))}).getOr(minOffset),centerMaxEdge=maxEdge.bind(function(edge){return Option.some(getYCenterOffSetOf(edge,spectrum))}).getOr(maxOffset),args={min:minY(detail),max:maxY(detail),range:yRange(detail),value:value,hasMinEdge:hasTEdge(detail),hasMaxEdge:hasBEdge(detail),minBound:getMinYBounds(spectrum),minOffset:minOffset,maxBound:getMaxYBounds(spectrum),maxOffset:maxOffset,centerMinEdge:centerMinEdge,centerMaxEdge:centerMaxEdge};return findOffsetOfValue(args)},findPositionOfValue$1=function(slider,spectrum,value,minEdge,maxEdge,detail){var offset=findOffsetOfValue$2(spectrum,detail,value,minEdge,maxEdge);return getMinYBounds(spectrum)-getMinYBounds(slider)+offset},setPositionFromValue$1=function(slider,thumb,detail,edges){var value=currentValue(detail),pos=findPositionOfValue$1(slider,edges.getSpectrum(slider),value.y(),edges.getTopEdge(slider),edges.getBottomEdge(slider),detail),thumbRadius=get$6(thumb.element())/2;set$2(thumb.element(),"top",pos-thumbRadius+"px")},onLeft$1=Option.none,onRight$1=Option.none,onUp$1=handleMovement$1(-1),onDown$1=handleMovement$1(1),edgeActions$1={"top-left":Option.none(),top:Option.some(setToTEdge),"top-right":Option.none(),right:Option.none(),"bottom-right":Option.none(),bottom:Option.some(setToBEdge),"bottom-left":Option.none(),left:Option.none()},VerticalModel=Object.freeze({setValueFrom:setValueFrom$1,setToMin:setToMin$1,setToMax:setToMax$1,findValueOfOffset:findValueOfOffset$1,getValueFromEvent:getValueFromEvent$1,findPositionOfValue:findPositionOfValue$1,setPositionFromValue:setPositionFromValue$1,onLeft:onLeft$1,onRight:onRight$1,onUp:onUp$1,onDown:onDown$1,edgeActions:edgeActions$1}),fireSliderChange$3=function(spectrum,value){emitWith(spectrum,sliderChangeEvent(),{value:value})},sliderValue$2=function(x,y){return{x:constant(x),y:constant(y)}},setValueFrom$2=function(spectrum,detail,value){var xValue=findValueOfOffset(spectrum,detail,value.left()),yValue=findValueOfOffset$1(spectrum,detail,value.top()),val=sliderValue$2(xValue,yValue);return fireSliderChange$3(spectrum,val),val},moveBy$2=function(direction,isVerticalMovement,spectrum,detail){var f=direction>0?increaseBy:reduceBy,xValue=isVerticalMovement?currentValue(detail).x():f(currentValue(detail).x(),minX(detail),maxX(detail),step(detail)),yValue=isVerticalMovement?f(currentValue(detail).y(),minY(detail),maxY(detail),step(detail)):currentValue(detail).y();return fireSliderChange$3(spectrum,sliderValue$2(xValue,yValue)),Option.some(xValue)},handleMovement$2=function(direction,isVerticalMovement){return function(spectrum,detail){return moveBy$2(direction,isVerticalMovement,spectrum,detail).map(function(){return!0})}},setToMin$2=function(spectrum,detail){var mX=minX(detail),mY=minY(detail);fireSliderChange$3(spectrum,sliderValue$2(mX,mY))},setToMax$2=function(spectrum,detail){var mX=maxX(detail),mY=maxY(detail);fireSliderChange$3(spectrum,sliderValue$2(mX,mY))},getValueFromEvent$2=function(simulatedEvent){return getEventSource(simulatedEvent)
},setPositionFromValue$2=function(slider,thumb,detail,edges){var value=currentValue(detail),xPos=findPositionOfValue(slider,edges.getSpectrum(slider),value.x(),edges.getLeftEdge(slider),edges.getRightEdge(slider),detail),yPos=findPositionOfValue$1(slider,edges.getSpectrum(slider),value.y(),edges.getTopEdge(slider),edges.getBottomEdge(slider),detail),thumbXRadius=get$7(thumb.element())/2,thumbYRadius=get$6(thumb.element())/2;set$2(thumb.element(),"left",xPos-thumbXRadius+"px"),set$2(thumb.element(),"top",yPos-thumbYRadius+"px")},onLeft$2=handleMovement$2(-1,!1),onRight$2=handleMovement$2(1,!1),onUp$2=handleMovement$2(-1,!0),onDown$2=handleMovement$2(1,!0),edgeActions$2={"top-left":Option.some(setToTLEdgeXY),top:Option.some(setToTEdgeXY),"top-right":Option.some(setToTREdgeXY),right:Option.some(setToREdgeXY),"bottom-right":Option.some(setToBREdgeXY),bottom:Option.some(setToBEdgeXY),"bottom-left":Option.some(setToBLEdgeXY),left:Option.some(setToLEdgeXY)},TwoDModel=Object.freeze({setValueFrom:setValueFrom$2,setToMin:setToMin$2,setToMax:setToMax$2,getValueFromEvent:getValueFromEvent$2,setPositionFromValue:setPositionFromValue$2,onLeft:onLeft$2,onRight:onRight$2,onUp:onUp$2,onDown:onDown$2,edgeActions:edgeActions$2}),isTouch$2=PlatformDetection$1.detect().deviceType.isTouch(),SliderSchema=[defaulted$1("stepSize",1),defaulted$1("onChange",noop),defaulted$1("onChoose",noop),defaulted$1("onInit",noop),defaulted$1("onDragStart",noop),defaulted$1("onDragEnd",noop),defaulted$1("snapToGrid",!1),defaulted$1("rounded",!0),option("snapStart"),strictOf("model",choose$1("mode",{x:[defaulted$1("minX",0),defaulted$1("maxX",100),state$1("value",function(spec){return Cell(spec.mode.minX)}),strict$1("getInitialValue"),output("manager",HorizontalModel)],y:[defaulted$1("minY",0),defaulted$1("maxY",100),state$1("value",function(spec){return Cell(spec.mode.minY)}),strict$1("getInitialValue"),output("manager",VerticalModel)],xy:[defaulted$1("minX",0),defaulted$1("maxX",100),defaulted$1("minY",0),defaulted$1("maxY",100),state$1("value",function(spec){return Cell({x:constant(spec.mode.minX),y:constant(spec.mode.minY)})}),strict$1("getInitialValue"),output("manager",TwoDModel)]})),field$1("sliderBehaviours",[Keying,Representing])].concat(isTouch$2?[]:[state$1("mouseIsDown",function(){return Cell(!1)})]),isTouch$3=PlatformDetection$1.detect().deviceType.isTouch(),sketch=function(detail,components,_spec,_externals){var getThumb=function(component){return getPartOrDie(component,detail,"thumb")},getSpectrum=function(component){return getPartOrDie(component,detail,"spectrum")},getLeftEdge=function(component){return getPart(component,detail,"left-edge")},getRightEdge=function(component){return getPart(component,detail,"right-edge")},getTopEdge=function(component){return getPart(component,detail,"top-edge")},getBottomEdge=function(component){return getPart(component,detail,"bottom-edge")},modelDetail=detail.model,model=modelDetail.manager,refresh=function(slider,thumb){model.setPositionFromValue(slider,thumb,detail,{getLeftEdge:getLeftEdge,getRightEdge:getRightEdge,getTopEdge:getTopEdge,getBottomEdge:getBottomEdge,getSpectrum:getSpectrum})},changeValue=function(slider,newValue){modelDetail.value.set(newValue);var thumb=getThumb(slider);return refresh(slider,thumb),detail.onChange(slider,thumb,newValue),Option.some(!0)},resetToMin=function(slider){model.setToMin(slider,detail)},resetToMax=function(slider){model.setToMax(slider,detail)},touchEvents=[run(touchstart(),function(slider,_simulatedEvent){detail.onDragStart(slider,getThumb(slider))}),run(touchend(),function(slider,_simulatedEvent){detail.onDragEnd(slider,getThumb(slider))})],mouseEvents=[run(mousedown(),function(slider,simulatedEvent){simulatedEvent.stop(),detail.onDragStart(slider,getThumb(slider)),detail.mouseIsDown.set(!0)}),run(mouseup(),function(slider,_simulatedEvent){detail.onDragEnd(slider,getThumb(slider))})],uiEventsArr=isTouch$3?touchEvents:mouseEvents;return{uid:detail.uid,dom:detail.dom,components:components,behaviours:augment(detail.sliderBehaviours,flatten([isTouch$3?[]:[Keying.config({mode:"special",focusIn:function(slider){return getPart(slider,detail,"spectrum").map(Keying.focusIn).map(constant(!0))}})],[Representing.config({store:{mode:"manual",getValue:function(_){return modelDetail.value.get()}}}),Receiving.config({channels:{"mouse.released":{onReceive:function(slider,se){var wasDown=detail.mouseIsDown.get();detail.mouseIsDown.set(!1),wasDown&&getPart(slider,detail,"thumb").each(function(thumb){var value=modelDetail.value.get();detail.onChoose(slider,thumb,value)})}}}})]])),events:derive([run(sliderChangeEvent(),function(slider,simulatedEvent){changeValue(slider,simulatedEvent.event().value())}),runOnAttached(function(slider,simulatedEvent){var getInitial=modelDetail.getInitialValue();modelDetail.value.set(getInitial);var thumb=getThumb(slider);refresh(slider,thumb);var spectrum=getSpectrum(slider);detail.onInit(slider,thumb,spectrum,modelDetail.value.get())})].concat(uiEventsArr)),apis:{resetToMin:resetToMin,resetToMax:resetToMax,changeValue:changeValue,refresh:refresh},domModification:{styles:{position:"relative"}}}},Slider=composite$1({name:"Slider",configFields:SliderSchema,partFields:SliderParts,factory:sketch,apis:{resetToMin:function(apis,slider){apis.resetToMin(slider)},resetToMax:function(apis,slider){apis.resetToMax(slider)},refresh:function(apis,slider){apis.refresh(slider)}}}),sliderFactory=function(translate,getClass){var spectrum=Slider.parts().spectrum({dom:{tag:"div",classes:[getClass("hue-slider-spectrum")],attributes:{role:"presentation"}}}),thumb=Slider.parts().thumb({dom:{tag:"div",classes:[getClass("hue-slider-thumb")],attributes:{role:"presentation"}}});return Slider.sketch({dom:{tag:"div",classes:[getClass("hue-slider")],attributes:{role:"presentation"}},rounded:!1,model:{mode:"y",getInitialValue:constant({y:constant(0)})},components:[spectrum,thumb],sliderBehaviours:derive$1([Focusing.config({})]),onChange:function(slider,_thumb,value){emitWith(slider,sliderUpdate(),{value:value})}})},HueSlider={sliderFactory:sliderFactory},owner$3="form",schema$h=[field$1("formBehaviours",[Representing])],getPartName=function(name){return"<alloy.field."+name+">"},sketch$1=function(fSpec){var record,field,parts=(record=[],field=function(name,config){return record.push(name),generateOne(owner$3,getPartName(name),config)},{field:field,record:function(){return record}}),spec=fSpec(parts),partNames=parts.record(),fieldParts=map(partNames,function(n){return required({name:n,pname:getPartName(n)})});return composite(owner$3,schema$h,fieldParts,make$5,spec)},toResult$1=function(o,e){return o.fold(function(){return Result.error(e)},Result.value)},make$5=function(detail,components,spec){return{uid:detail.uid,dom:detail.dom,components:components,behaviours:augment(detail.formBehaviours,[Representing.config({store:{mode:"manual",getValue:function(form){var resPs=getAllParts(form,detail);return map$1(resPs,function(resPThunk,pName){return resPThunk().bind(function(v){var opt=Composing.getCurrent(v);return toResult$1(opt,"missing current")}).map(Representing.getValue)})},setValue:function(form,values){each$1(values,function(newValue,key){getPart(form,detail,key).each(function(wrapper){Composing.getCurrent(wrapper).each(function(field){Representing.setValue(field,newValue)})})})}}})]),apis:{getField:function(form,key){return getPart(form,detail,key).bind(Composing.getCurrent)}}}},Form={getField:makeApi(function(apis,component,key){return apis.getField(component,key)}),sketch:sketch$1},validInput=generate$1("valid-input"),invalidInput=generate$1("invalid-input"),validatingInput=generate$1("validating-input"),translatePrefix="colorcustom.rgb.",rgbFormFactory=function(translate,getClass,onValidHexx,onInvalidHexx){var invalidation=function(label,isValid){return Invalidating.config({invalidClass:getClass("invalid"),notify:{onValidate:function(comp){emitWith(comp,validatingInput,{type:label})},onValid:function(comp){emitWith(comp,validInput,{type:label,value:Representing.getValue(comp)})},onInvalid:function(comp){emitWith(comp,invalidInput,{type:label,value:Representing.getValue(comp)})}},validator:{validate:function(comp){var value=Representing.getValue(comp),res=isValid(value)?Result.value(!0):Result.error(translate("aria.input.invalid"));return Future.pure(res)},validateOnLoad:!1}})},renderTextField=function(isValid,name,label,description,data){var helptext=translate(translatePrefix+"range"),pLabel=FormField.parts().label({dom:{tag:"label",innerHtml:label,attributes:{"aria-label":description}}}),pField=FormField.parts().field({data:data,factory:Input,inputAttributes:__assign({type:"text"},"hex"===name?{"aria-live":"polite"}:{}),inputClasses:[getClass("textfield")],inputBehaviours:derive$1([invalidation(name,isValid),Tabstopping.config({})]),onSetValue:function(input){if(Invalidating.isInvalid(input)){var run=Invalidating.run(input);run.get(noop)}}}),comps=[pLabel,pField],concats="hex"!==name?[FormField.parts()["aria-descriptor"]({text:helptext})]:[],components=comps.concat(concats);return{dom:{tag:"div",attributes:{role:"presentation"}},components:components}},copyRgbToHex=function(form,rgba){var hex=fromRgba(rgba);return Form.getField(form,"hex").each(function(hexField){Focusing.isFocused(hexField)||Representing.setValue(form,{hex:hex.value()})}),hex},copyRgbToForm=function(form,rgb){var red=rgb.red(),green=rgb.green(),blue=rgb.blue();Representing.setValue(form,{red:red,green:green,blue:blue})},memPreview=record({dom:{tag:"div",classes:[getClass("rgba-preview")],styles:{"background-color":"white"},attributes:{role:"presentation"}}}),updatePreview=function(anyInSystem,hex){memPreview.getOpt(anyInSystem).each(function(preview){set$2(preview.element(),"background-color","#"+hex.value())})},factory=function(){var state={red:constant(Cell(Option.some(255))),green:constant(Cell(Option.some(255))),blue:constant(Cell(Option.some(255))),hex:constant(Cell(Option.some("ffffff")))},copyHexToRgb=function(form,hex){var rgb=fromHex(hex);copyRgbToForm(form,rgb),setValueRgb(rgb)},get=function(prop){return state[prop]().get()},set=function(prop,value){state[prop]().set(value)},getValueRgb=function(){return get("red").bind(function(red){return get("green").bind(function(green){return get("blue").map(function(blue){return rgbaColour(red,green,blue,1)})})})},setValueRgb=function(rgb){var red=rgb.red(),green=rgb.green(),blue=rgb.blue();set("red",Option.some(red)),set("green",Option.some(green)),set("blue",Option.some(blue))},onInvalidInput=function(form,simulatedEvent){var data=simulatedEvent.event();"hex"!==data.type()?set(data.type(),Option.none()):onInvalidHexx(form)},onValidHex=function(form,value){onValidHexx(form);var hex=hexColour(value);set("hex",Option.some(value));var rgb=fromHex(hex);copyRgbToForm(form,rgb),setValueRgb(rgb),emitWith(form,fieldsUpdate(),{hex:hex}),updatePreview(form,hex)},onValidRgb=function(form,prop,value){var val=parseInt(value,10);set(prop,Option.some(val)),getValueRgb().each(function(rgb){var hex=copyRgbToHex(form,rgb);updatePreview(form,hex)})},isHexInputEvent=function(data){return"hex"===data.type()},onValidInput=function(form,simulatedEvent){var data=simulatedEvent.event();isHexInputEvent(data)?onValidHex(form,data.value()):onValidRgb(form,data.type(),data.value())},formPartStrings=function(key){return{label:translate(translatePrefix+key+".label"),description:translate(translatePrefix+key+".description")}},redStrings=formPartStrings("red"),greenStrings=formPartStrings("green"),blueStrings=formPartStrings("blue"),hexStrings=formPartStrings("hex");return deepMerge(Form.sketch(function(parts){return{dom:{tag:"form",classes:[getClass("rgb-form")],attributes:{"aria-label":translate("aria.color.picker")}},components:[parts.field("red",FormField.sketch(renderTextField(isRgbaComponent,"red",redStrings.label,redStrings.description,255))),parts.field("green",FormField.sketch(renderTextField(isRgbaComponent,"green",greenStrings.label,greenStrings.description,255))),parts.field("blue",FormField.sketch(renderTextField(isRgbaComponent,"blue",blueStrings.label,blueStrings.description,255))),parts.field("hex",FormField.sketch(renderTextField(isHexString,"hex",hexStrings.label,hexStrings.description,"ffffff"))),memPreview.asSpec()],formBehaviours:derive$1([Invalidating.config({invalidClass:getClass("form-invalid")}),config("rgb-form-events",[run(validInput,onValidInput),run(invalidInput,onInvalidInput),run(validatingInput,onInvalidInput)])])}}),{apis:{updateHex:function(form,hex){Representing.setValue(form,{hex:hex.value()}),copyHexToRgb(form,hex),updatePreview(form,hex)}}})},rgbFormSketcher=single$2({factory:factory,name:"RgbForm",configFields:[],apis:{updateHex:function(apis,form,hex){apis.updateHex(form,hex)}},extraApis:{}});return rgbFormSketcher},RgbForm={rgbFormFactory:rgbFormFactory},paletteFactory=function(_translate,getClass){var spectrumPart=Slider.parts().spectrum({dom:{tag:"canvas",attributes:{role:"presentation"},classes:[getClass("sv-palette-spectrum")]}}),thumbPart=Slider.parts().thumb({dom:{tag:"div",attributes:{role:"presentation"},classes:[getClass("sv-palette-thumb")],innerHtml:"<div class="+getClass("sv-palette-inner-thumb")+' role="presentation"></div>'}}),setColour=function(canvas,rgba){var width=canvas.width,height=canvas.height,ctx=canvas.getContext("2d");if(null!==ctx){ctx.fillStyle=rgba,ctx.fillRect(0,0,width,height);var grdWhite=ctx.createLinearGradient(0,0,width,0);grdWhite.addColorStop(0,"rgba(255,255,255,1)"),grdWhite.addColorStop(1,"rgba(255,255,255,0)"),ctx.fillStyle=grdWhite,ctx.fillRect(0,0,width,height);var grdBlack=ctx.createLinearGradient(0,0,0,height);grdBlack.addColorStop(0,"rgba(0,0,0,0)"),grdBlack.addColorStop(1,"rgba(0,0,0,1)"),ctx.fillStyle=grdBlack,ctx.fillRect(0,0,width,height)}},setSliderColour=function(slider,rgba){var canvas=slider.components()[0].element().dom();setColour(canvas,toString(rgba))},factory=function(_detail){var getInitialValue=constant({x:constant(0),y:constant(0)}),onChange=function(slider,_thumb,value){emitWith(slider,paletteUpdate(),{value:value})},onInit=function(_slider,_thumb,spectrum,_value){setColour(spectrum.element().dom(),toString(redColour()))},sliderBehaviours=derive$1([Composing.config({find:Option.some}),Focusing.config({})]);return Slider.sketch({dom:{tag:"div",attributes:{role:"presentation"},classes:[getClass("sv-palette")]},model:{mode:"xy",getInitialValue:getInitialValue},rounded:!1,components:[spectrumPart,thumbPart],onChange:onChange,onInit:onInit,sliderBehaviours:sliderBehaviours})},saturationBrightnessPaletteSketcher=single$2({factory:factory,name:"SaturationBrightnessPalette",configFields:[],apis:{setRgba:function(_apis,slider,rgba){setSliderColour(slider,rgba)}},extraApis:{}});return saturationBrightnessPaletteSketcher},SaturationBrightnessPalette={paletteFactory:paletteFactory},makeFactory=function(translate,getClass){var factory=function(detail){var rgbForm=RgbForm.rgbFormFactory(translate,getClass,detail.onValidHex,detail.onInvalidHex),sbPalette=SaturationBrightnessPalette.paletteFactory(translate,getClass),state={paletteRgba:constant(Cell(redColour()))},memPalette=record(sbPalette.sketch({})),memRgb=record(rgbForm.sketch({})),updatePalette=function(anyInSystem,hex){memPalette.getOpt(anyInSystem).each(function(palette){var rgba=fromHex(hex);state.paletteRgba().set(rgba),sbPalette.setRgba(palette,rgba)})},updateFields=function(anyInSystem,hex){memRgb.getOpt(anyInSystem).each(function(form){rgbForm.updateHex(form,hex)})},runUpdates=function(anyInSystem,hex,updates){each(updates,function(update){update(anyInSystem,hex)})},paletteUpdates=function(){var updates=[updateFields];return function(form,simulatedEvent){var value=simulatedEvent.event().value(),oldRgb=state.paletteRgba().get(),hsvColour$1=fromRgb(oldRgb),newHsvColour=hsvColour(hsvColour$1.hue(),value.x(),100-value.y()),rgb=fromHsv(newHsvColour),nuHex=fromRgba(rgb);runUpdates(form,nuHex,updates)}},sliderUpdates=function(){var updates=[updatePalette,updateFields];return function(form,simulatedEvent){var value=simulatedEvent.event().value(),hex=calcHex(value.y());runUpdates(form,hex,updates)}};return{uid:detail.uid,dom:detail.dom,components:[memPalette.asSpec(),HueSlider.sliderFactory(translate,getClass),memRgb.asSpec()],behaviours:derive$1([config("colour-picker-events",[run(paletteUpdate(),paletteUpdates()),run(sliderUpdate(),sliderUpdates())]),Composing.config({find:function(comp){return memRgb.getOpt(comp)}}),Keying.config({mode:"acyclic"})])}},colourPickerSketcher=single$2({name:"ColourPicker",configFields:[strict$1("dom"),defaulted$1("onValidHex",noop),defaulted$1("onInvalidHex",noop)],factory:factory});return colourPickerSketcher},ColourPicker={makeFactory:makeFactory},self$1=function(){return Composing.config({find:Option.some})},memento=function(mem){return Composing.config({find:mem.getOpt})},childAt=function(index){return Composing.config({find:function(comp){return child(comp.element(),index).bind(function(element){return comp.getSystem().getByDom(element).toOption()})}})},ComposingConfigs={self:self$1,memento:memento,childAt:childAt},english={"colorcustom.rgb.red.label":"R","colorcustom.rgb.red.description":"Red component","colorcustom.rgb.green.label":"G","colorcustom.rgb.green.description":"Green component","colorcustom.rgb.blue.label":"B","colorcustom.rgb.blue.description":"Blue component","colorcustom.rgb.hex.label":"#","colorcustom.rgb.hex.description":"Hex color code","colorcustom.rgb.range":"Range 0 to 255","colorcustom.sb.saturation":"Saturation","colorcustom.sb.brightness":"Brightness","colorcustom.sb.picker":"Saturation and Brightness Picker","colorcustom.sb.palette":"Saturation and Brightness Palette","colorcustom.sb.instructions":"Use arrow keys to select saturation and brightness, on x and y axes","colorcustom.hue.hue":"Hue","colorcustom.hue.slider":"Hue Slider","colorcustom.hue.palette":"Hue Palette","colorcustom.hue.instructions":"Use arrow keys to select a hue","aria.color.picker":"Color Picker","aria.input.invalid":"Invalid input"},getEnglishText=function(key){return english[key]},translate=function(key){return getEnglishText(key)},renderColorPicker=function(spec){var getClass=function(key){return"tox-"+key},colourPickerFactory=ColourPicker.makeFactory(translate,getClass),onValidHex=function(form){emitWith(form,formActionEvent,{name:"hex-valid",value:!0})},onInvalidHex=function(form){emitWith(form,formActionEvent,{name:"hex-valid",value:!1})},memPicker=record(colourPickerFactory.sketch({dom:{tag:"div",classes:[getClass("color-picker-container")],attributes:{role:"presentation"}},onValidHex:onValidHex,onInvalidHex:onInvalidHex}));return{dom:{tag:"div"},components:[memPicker.asSpec()],behaviours:derive$1([Representing.config({store:{mode:"manual",getValue:function(comp){var picker=memPicker.get(comp),optRgbForm=Composing.getCurrent(picker),optHex=optRgbForm.bind(function(rgbForm){var formValues=Representing.getValue(rgbForm);return formValues.hex});return optHex.map(function(hex){return"#"+hex}).getOr("")},setValue:function(comp,newValue){var pattern=/^#([a-fA-F0-9]{3}(?:[a-fA-F0-9]{3})?)/,m=pattern.exec(newValue),picker=memPicker.get(comp),optRgbForm=Composing.getCurrent(picker);optRgbForm.fold(function(){domGlobals.console.log("Can not find form")},function(rgbForm){Representing.setValue(rgbForm,{hex:Option.from(m[1]).getOr("")}),Form.getField(rgbForm,"hex").each(function(hexField){emit(hexField,input())})})}}}),ComposingConfigs.self()])}},global$a=tinymce.util.Tools.resolve("tinymce.Resource"),isOldCustomEditor=function(spec){return Object.prototype.hasOwnProperty.call(spec,"init")},renderCustomEditor=function(spec){var editorApi=Cell(Option.none()),memReplaced=record({dom:{tag:spec.tag}}),initialValue=Cell(Option.none());return{dom:{tag:"div",classes:["tox-custom-editor"]},behaviours:derive$1([config("editor-foo-events",[runOnAttached(function(component){memReplaced.getOpt(component).each(function(ta){(isOldCustomEditor(spec)?spec.init(ta.element().dom()):global$a.load(spec.scriptId,spec.scriptUrl).then(function(init){return init(ta.element().dom(),spec.settings)})).then(function(ea){initialValue.get().each(function(cvalue){ea.setValue(cvalue)}),initialValue.set(Option.none()),editorApi.set(Option.some(ea))})})})]),Representing.config({store:{mode:"manual",getValue:function(){return editorApi.get().fold(function(){return initialValue.get().getOr("")},function(ed){return ed.getValue()})},setValue:function(component,value){editorApi.get().fold(function(){initialValue.set(Option.some(value))},function(ed){return ed.setValue(value)})}}}),ComposingConfigs.self()]),components:[memReplaced.asSpec()]}},processors=objOf([defaulted$1("preprocess",identity),defaulted$1("postprocess",identity)]),memento$1=function(mem,rawProcessors){var ps=asRawOrDie("RepresentingConfigs.memento processors",processors,rawProcessors);return Representing.config({store:{mode:"manual",getValue:function(comp){var other=mem.get(comp),rawValue=Representing.getValue(other);return ps.postprocess(rawValue)},setValue:function(comp,rawValue){var newValue=ps.preprocess(rawValue),other=mem.get(comp);Representing.setValue(other,newValue)}}})},withComp=function(optInitialValue,getter,setter){return Representing.config(deepMerge({store:{mode:"manual",getValue:getter,setValue:setter}},optInitialValue.map(function(initialValue){return{store:{initialValue:initialValue}}}).getOr({})))},withElement=function(initialValue,getter,setter){return withComp(initialValue,function(c){return getter(c.element())},function(c,v){return setter(c.element(),v)})},domValue=function(optInitialValue){return withElement(optInitialValue,get$5,set$3)},domHtml=function(optInitialValue){return withElement(optInitialValue,get$1,set)},memory$1=function(initialValue){return Representing.config({store:{mode:"memory",initialValue:initialValue}})},RepresentingConfigs={memento:memento$1,withElement:withElement,withComp:withComp,domValue:domValue,domHtml:domHtml,memory:memory$1},extensionsAccepted=".jpg,.jpeg,.png,.gif",filterByExtension=function(files){var re=new RegExp("("+extensionsAccepted.split(/\s*,\s*/).join("|")+")$","i");return filter(from$1(files),function(file){return re.test(file.name)})},renderDropZone=function(spec,providersBackstage){var stopper=function(_,se){se.stop()},sequence=function(actions){return function(comp,se){each(actions,function(a){a(comp,se)})}},onDrop=function(comp,se){if(!Disabling.isDisabled(comp)){var transferEvent=se.event().raw();handleFiles(comp,transferEvent.dataTransfer.files)}},onSelect=function(component,simulatedEvent){var files=simulatedEvent.event().raw().target.files;handleFiles(component,files)},handleFiles=function(component,files){Representing.setValue(component,filterByExtension(files)),emitWith(component,formChangeEvent,{name:spec.name})},memInput=record({dom:{tag:"input",attributes:{type:"file",accept:"image/*"},styles:{display:"none"}},behaviours:derive$1([config("input-file-events",[cutter(tapOrClick())])])}),renderField=function(s){return{uid:s.uid,dom:{tag:"div",classes:["tox-dropzone-container"]},behaviours:derive$1([RepresentingConfigs.memory([]),ComposingConfigs.self(),Disabling.config({}),Toggling.config({toggleClass:"dragenter",toggleOnExecute:!1}),config("dropzone-events",[run("dragenter",sequence([stopper,Toggling.toggle])),run("dragleave",sequence([stopper,Toggling.toggle])),run("dragover",stopper),run("drop",sequence([stopper,onDrop])),run(change(),onSelect)])]),components:[{dom:{tag:"div",classes:["tox-dropzone"],styles:{}},components:[{dom:{tag:"p",innerHtml:providersBackstage.translate("Drop an image here")}},Button.sketch({dom:{tag:"button",innerHtml:providersBackstage.translate("Browse for an image"),styles:{position:"relative"},classes:["tox-button","tox-button--secondary"]},components:[memInput.asSpec()],action:function(comp){var inputComp=memInput.get(comp);inputComp.element().dom().click()},buttonBehaviours:derive$1([Tabstopping.config({})])})]}]}},pLabel=spec.label.map(function(label){return renderLabel(label,providersBackstage)}),pField=FormField.parts().field({factory:{sketch:renderField}});return renderFormFieldWith(pLabel,pField,["tox-form__group--stretched"],[])},renderGrid=function(spec,backstage){return{dom:{tag:"div",classes:["tox-form__grid","tox-form__grid--"+spec.columns+"col"]},components:map(spec.items,backstage.interpreter)}},beforeObject=generate$1("alloy-fake-before-tabstop"),afterObject=generate$1("alloy-fake-after-tabstop"),craftWithClasses=function(classes){return{dom:{tag:"div",styles:{width:"1px",height:"1px",outline:"none"},attributes:{tabindex:"0"},classes:classes},behaviours:derive$1([Focusing.config({ignore:!0}),Tabstopping.config({})])}},craft=function(spec){return{dom:{tag:"div",classes:["tox-navobj"]},components:[craftWithClasses([beforeObject]),spec,craftWithClasses([afterObject])],behaviours:derive$1([ComposingConfigs.childAt(1)])}},triggerTab=function(placeholder,shiftKey){emitWith(placeholder,keydown(),{raw:{which:9,shiftKey:shiftKey}})},onFocus$1=function(container,targetComp){var target=targetComp.element();has$2(target,beforeObject)?triggerTab(container,!0):has$2(target,afterObject)&&triggerTab(container,!1)},isPseudoStop=function(element){return closest$4(element,["."+beforeObject,"."+afterObject].join(","),constant(!1))},NavigableObject={isPseudoStop:isPseudoStop,onFocus:onFocus$1,craft:craft},platformNeedsSandboxing=!(PlatformDetection$1.detect().browser.isIE()||PlatformDetection$1.detect().browser.isEdge()),getDynamicSource=function(isSandbox){var cachedValue=Cell("");return{getValue:function(frameComponent){return cachedValue.get()},setValue:function(frameComponent,html){if(isSandbox)set$1(frameComponent.element(),"srcdoc",html);else{set$1(frameComponent.element(),"src","javascript:''");var doc=frameComponent.element().dom().contentWindow.document;doc.open(),doc.write(html),doc.close()}cachedValue.set(html)}}},renderIFrame=function(spec,providersBackstage){var isSandbox=platformNeedsSandboxing&&spec.sandboxed,attributes=__assign({},spec.label.map(function(title){return{title:title}}).getOr({}),isSandbox?{sandbox:"allow-scripts allow-same-origin"}:{}),sourcing=getDynamicSource(isSandbox),pLabel=spec.label.map(function(label){return renderLabel(label,providersBackstage)}),factory=function(newSpec){return NavigableObject.craft({uid:newSpec.uid,dom:{tag:"iframe",attributes:attributes},behaviours:derive$1([Tabstopping.config({}),Focusing.config({}),RepresentingConfigs.withComp(Option.none(),sourcing.getValue,sourcing.setValue)])})},pField=FormField.parts().field({factory:{sketch:factory}});return renderFormFieldWith(pLabel,pField,["tox-form__group--stretched"],[])},promise=function(){function bind(fn,thisArg){return function(){return fn.apply(thisArg,arguments)}}function handle(deferred){var me=this;null!==this._state?asap(function(){var cb=me._state?deferred.onFulfilled:deferred.onRejected;if(null!==cb){var ret;try{ret=cb(me._value)}catch(e){return void deferred.reject(e)}deferred.resolve(ret)}else(me._state?deferred.resolve:deferred.reject)(me._value)}):this._deferreds.push(deferred)}function resolve(newValue){try{if(newValue===this)throw new TypeError("A promise cannot be resolved with itself.");if(newValue&&("object"==typeof newValue||"function"==typeof newValue)){var then=newValue.then;if("function"==typeof then)return void doResolve(bind(then,newValue),bind(resolve,this),bind(reject,this))}this._state=!0,this._value=newValue,finale.call(this)}catch(e){reject.call(this,e)}}function reject(newValue){this._state=!1,this._value=newValue,finale.call(this)}function finale(){for(var _i=0,_a=this._deferreds;_i<_a.length;_i++){var deferred=_a[_i];handle.call(this,deferred)}this._deferreds=[]}function Handler(onFulfilled,onRejected,resolve,reject){this.onFulfilled="function"==typeof onFulfilled?onFulfilled:null,this.onRejected="function"==typeof onRejected?onRejected:null,this.resolve=resolve,this.reject=reject}function doResolve(fn,onFulfilled,onRejected){var done=!1;try{fn(function(value){done||(done=!0,onFulfilled(value))},function(reason){done||(done=!0,onRejected(reason))})}catch(ex){if(done)return;done=!0,onRejected(ex)}}var Promise=function(fn){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof fn)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],doResolve(fn,bind(resolve,this),bind(reject,this))},asap=Promise.immediateFn||"function"==typeof window.setImmediate&&window.setImmediate||function(fn){domGlobals.setTimeout(fn,1)},isArray=Array.isArray||function(value){return"[object Array]"===Object.prototype.toString.call(value)};return Promise.prototype.catch=function(onRejected){return this.then(null,onRejected)},Promise.prototype.then=function(onFulfilled,onRejected){var me=this;return new Promise(function(resolve,reject){handle.call(me,new Handler(onFulfilled,onRejected,resolve,reject))})},Promise.all=function(){for(var values=[],_i=0;_i<arguments.length;_i++)values[_i]=arguments[_i];var args=Array.prototype.slice.call(1===values.length&&isArray(values[0])?values[0]:values);return new Promise(function(resolve,reject){function res(i,val){try{if(val&&("object"==typeof val||"function"==typeof val)){var then=val.then;if("function"==typeof then)return void then.call(val,function(val){res(i,val)},reject)}args[i]=val,0==--remaining&&resolve(args)}catch(ex){reject(ex)}}if(0===args.length)return resolve([]);for(var remaining=args.length,i=0;i<args.length;i++)res(i,args[i])})},Promise.resolve=function(value){return value&&"object"==typeof value&&value.constructor===Promise?value:new Promise(function(resolve){resolve(value)})},Promise.reject=function(reason){return new Promise(function(resolve,reject){reject(reason)})},Promise.race=function(values){return new Promise(function(resolve,reject){for(var _i=0,values_1=values;_i<values_1.length;_i++){var value=values_1[_i];value.then(resolve,reject)}})},Promise},Promise$1=window.Promise?window.Promise:promise(),blobToImageResult=function(blob){return fromBlob(blob)},DELTA_INDEX=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10],invert=basicColorFilter([-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0,0,0,0,0,1]),brightness=complexAdjustableColorFilter(adjustBrightness),contrast=complexAdjustableColorFilter(adjustContrast),colorize=function(ir,adjustR,adjustG,adjustB){return colorFilter(ir,adjustColors(identity$1(),adjustR,adjustG,adjustB))},sharpen=basicConvolutionFilter([0,-1,0,-1,5,-1,0,-1,0]),gamma=functionColorFilter(function(color,value){return 255*Math.pow(color/255,1-value)}),invert$1=function(ir){return invert(ir)},sharpen$1=function(ir){return sharpen(ir)},gamma$1=function(ir,value){return gamma(ir,value)},colorize$1=function(ir,adjustR,adjustG,adjustB){return colorize(ir,adjustR,adjustG,adjustB)},brightness$1=function(ir,adjust){return brightness(ir,adjust)},contrast$1=function(ir,adjust){return contrast(ir,adjust)},flip$1=function(ir,axis){return flip(ir,axis)},crop$1=function(ir,x,y,w,h){return crop(ir,x,y,w,h)},resize$2=function(ir,w,h){return resize$1(ir,w,h)},rotate$1=function(ir,angle){return rotate(ir,angle)},renderIcon$1=function(iconHtml,behaviours){return __assign({dom:{tag:"span",innerHtml:iconHtml,classes:["tox-icon","tox-tbtn__icon-wrap"]}},behaviours)},renderIconFromPack=function(iconName,iconsProvider){return renderIcon$1(get$c(iconName,iconsProvider),{})},renderReplacableIconFromPack=function(iconName,iconsProvider){return renderIcon$1(get$c(iconName,iconsProvider),{behaviours:derive$1([Replacing.config({})])})
},renderLabel$1=function(text,prefix,providersBackstage){return{dom:{tag:"span",innerHtml:providersBackstage.translate(text),classes:[prefix+"__select-label"]},behaviours:derive$1([Replacing.config({})])}},internalToolbarButtonExecute=generate$1("toolbar.button.execute"),onToolbarButtonExecute=function(info){return runOnExecute(function(comp,simulatedEvent){runWithApi(info,comp)(function(itemApi){emitWith(comp,internalToolbarButtonExecute,{buttonApi:itemApi}),info.onAction(itemApi)})})},toolbarButtonEventOrder={"alloy.execute":["disabling","alloy.base.behaviour","toggling","toolbar-button-events"]},updateMenuText=generate$1("update-menu-text"),updateMenuIcon=generate$1("update-menu-icon"),renderCommonDropdown=function(spec,prefix,sharedBackstage){var editorOffCell=Cell(noop),optMemDisplayText=spec.text.map(function(text){return record(renderLabel$1(text,prefix,sharedBackstage.providers))}),optMemDisplayIcon=spec.icon.map(function(iconName){return record(renderReplacableIconFromPack(iconName,sharedBackstage.providers.icons))}),onLeftOrRightInMenu=function(comp,se){var dropdown=Representing.getValue(comp);return Focusing.focus(dropdown),emitWith(dropdown,"keydown",{raw:se.event().raw()}),Dropdown.close(dropdown),Option.some(!0)},role=spec.role.fold(function(){return{}},function(role){return{role:role}}),tooltipAttributes=spec.tooltip.fold(function(){return{}},function(tooltip){var translatedTooltip=sharedBackstage.providers.translate(tooltip);return{title:translatedTooltip,"aria-label":translatedTooltip}}),memDropdown=record(Dropdown.sketch(__assign({},role,{dom:{tag:"button",classes:[prefix,prefix+"--select"].concat(map(spec.classes,function(c){return prefix+"--"+c})),attributes:__assign({},tooltipAttributes)},components:componentRenderPipeline([optMemDisplayIcon.map(function(mem){return mem.asSpec()}),optMemDisplayText.map(function(mem){return mem.asSpec()}),Option.some({dom:{tag:"div",classes:[prefix+"__select-chevron"],innerHtml:get$c("chevron-down",sharedBackstage.providers.icons)}})]),matchWidth:!0,useMinWidth:!0,dropdownBehaviours:derive$1(spec.dropdownBehaviours.concat([DisablingConfigs.button(spec.disabled),Unselecting.config({}),Replacing.config({}),config("dropdown-events",[onControlAttached(spec,editorOffCell),onControlDetached(spec,editorOffCell)]),config("menubutton-update-display-text",[run(updateMenuText,function(comp,se){optMemDisplayText.bind(function(mem){return mem.getOpt(comp)}).each(function(displayText){Replacing.set(displayText,[text(sharedBackstage.providers.translate(se.event().text()))])})}),run(updateMenuIcon,function(comp,se){optMemDisplayIcon.bind(function(mem){return mem.getOpt(comp)}).each(function(displayIcon){Replacing.set(displayIcon,[renderReplacableIconFromPack(se.event().icon(),sharedBackstage.providers.icons)])})})])])),eventOrder:deepMerge(toolbarButtonEventOrder,{mousedown:["focusing","alloy.base.behaviour","item-type-events","normal-dropdown-events"]}),sandboxBehaviours:derive$1([Keying.config({mode:"special",onLeft:onLeftOrRightInMenu,onRight:onLeftOrRightInMenu})]),lazySink:sharedBackstage.getSink,toggleClass:prefix+"--active",parts:{menu:part(!1,spec.columns,spec.presets)},fetch:function(){return Future.nu(spec.fetch)}})));return memDropdown.asSpec()},getMenuButtonApi=function(component){return{isDisabled:function(){return Disabling.isDisabled(component)},setDisabled:function(state){return Disabling.set(component,state)},setActive:function(state){var elm=component.element();state?(add$2(elm,"tox-tbtn--enabled"),set$1(elm,"aria-pressed",!0)):(remove$4(elm,"tox-tbtn--enabled"),remove$1(elm,"aria-pressed"))},isActive:function(){return has$2(component.element(),"tox-tbtn--enabled")}}},renderMenuButton=function(spec,prefix,backstage,role){return renderCommonDropdown({text:spec.text,icon:spec.icon,tooltip:spec.tooltip,role:role,fetch:function(callback){spec.fetch(function(items){callback(build$2(items,ItemResponse$1.CLOSE_ON_EXECUTE,backstage))})},onSetup:spec.onSetup,getApi:getMenuButtonApi,columns:1,presets:"normal",classes:[],dropdownBehaviours:[Tabstopping.config({})]},prefix,backstage.shared)},renderCommonSpec=function(spec,actionOpt,extraBehaviours,dom,components){void 0===extraBehaviours&&(extraBehaviours=[]);var action=actionOpt.fold(function(){return{}},function(action){return{action:action}}),common=__assign({buttonBehaviours:derive$1([DisablingConfigs.button(spec.disabled),Tabstopping.config({}),config("button press",[preventDefault("click"),preventDefault("mousedown")])].concat(extraBehaviours)),eventOrder:{click:["button press","alloy.base.behaviour"],mousedown:["button press","alloy.base.behaviour"]}},action),domFinal=deepMerge(common,{dom:dom});return deepMerge(domFinal,{components:components})},renderIconButtonSpec=function(spec,action,providersBackstage,extraBehaviours){void 0===extraBehaviours&&(extraBehaviours=[]);var tooltipAttributes=spec.tooltip.map(function(tooltip){return{"aria-label":providersBackstage.translate(tooltip),title:providersBackstage.translate(tooltip)}}).getOr({}),dom={tag:"button",classes:["tox-tbtn"],attributes:tooltipAttributes},icon=spec.icon.map(function(iconName){return renderIconFromPack(iconName,providersBackstage.icons)}),components=componentRenderPipeline([icon]);return renderCommonSpec(spec,action,extraBehaviours,dom,components)},renderIconButton=function(spec,action,providersBackstage,extraBehaviours){void 0===extraBehaviours&&(extraBehaviours=[]);var iconButtonSpec=renderIconButtonSpec(spec,Option.some(action),providersBackstage,extraBehaviours);return Button.sketch(iconButtonSpec)},renderButtonSpec=function(spec,action,providersBackstage,extraBehaviours,extraClasses){void 0===extraBehaviours&&(extraBehaviours=[]),void 0===extraClasses&&(extraClasses=[]);var translatedText=providersBackstage.translate(spec.text),icon=spec.icon?spec.icon.map(function(iconName){return renderIconFromPack(iconName,providersBackstage.icons)}):Option.none(),components=icon.isSome()?componentRenderPipeline([icon]):[],innerHtml=icon.isSome()?{}:{innerHtml:translatedText},classes=(spec.primary||spec.borderless?["tox-button"]:["tox-button","tox-button--secondary"]).concat(icon.isSome()?["tox-button--icon"]:[],spec.borderless?["tox-button--naked"]:[],extraClasses),dom=__assign({tag:"button",classes:classes},innerHtml,{attributes:{title:translatedText}});return renderCommonSpec(spec,action,extraBehaviours,dom,components)},renderButton=function(spec,action,providersBackstage,extraBehaviours,extraClasses){void 0===extraBehaviours&&(extraBehaviours=[]),void 0===extraClasses&&(extraClasses=[]);var buttonSpec=renderButtonSpec(spec,Option.some(action),providersBackstage,extraBehaviours,extraClasses);return Button.sketch(buttonSpec)},getAction=function(name,buttonType){return function(comp){"custom"===buttonType?emitWith(comp,formActionEvent,{name:name,value:{}}):"submit"===buttonType?emit(comp,formSubmitEvent):"cancel"===buttonType?emit(comp,formCancelEvent):domGlobals.console.error("Unknown button type: ",buttonType)}},isMenuFooterButtonSpec=function(spec,buttonType){return"menu"===buttonType},isNormalFooterButtonSpec=function(spec,buttonType){return"custom"===buttonType||"cancel"===buttonType||"submit"===buttonType},renderFooterButton=function(spec,buttonType,backstage){if(isMenuFooterButtonSpec(spec,buttonType))return renderMenuButton(spec,"tox-tbtn",backstage,Option.none());if(isNormalFooterButtonSpec(spec,buttonType)){var action=getAction(spec.name,buttonType),buttonSpec=__assign({},spec,{borderless:!1});return renderButton(buttonSpec,action,backstage.shared.providers,[])}domGlobals.console.error("Unknown footer button type: ",buttonType)},renderDialogButton=function(spec,providersBackstage){var action=getAction(spec.name,"custom");return renderFormField(Option.none(),FormField.parts().field(__assign({factory:Button},renderButtonSpec(spec,Option.some(action),providersBackstage,[RepresentingConfigs.memory(""),ComposingConfigs.self()]))))},schema$i=constant([defaulted$1("field1Name","field1"),defaulted$1("field2Name","field2"),onStrictHandler("onLockedChange"),markers(["lockClass"]),defaulted$1("locked",!1),SketchBehaviours.field("coupledFieldBehaviours",[Composing,Representing])]),getField=function(comp,detail,partName){return getPart(comp,detail,partName).bind(Composing.getCurrent)},coupledPart=function(selfName,otherName){return required({factory:FormField,name:selfName,overrides:function(detail){return{fieldBehaviours:derive$1([config("coupled-input-behaviour",[run(input(),function(me){getField(me,detail,otherName).each(function(other){getPart(me,detail,"lock").each(function(lock){Toggling.isOn(lock)&&detail.onLockedChange(me,other,lock)})})})])])}}})},parts$6=constant([coupledPart("field1","field2"),coupledPart("field2","field1"),required({factory:Button,schema:[strict$1("dom")],name:"lock",overrides:function(detail){return{buttonBehaviours:derive$1([Toggling.config({selected:detail.locked,toggleClass:detail.markers.lockClass,aria:{mode:"pressed"}})])}}})]),factory$7=function(detail,components,spec,externals){return{uid:detail.uid,dom:detail.dom,components:components,behaviours:SketchBehaviours.augment(detail.coupledFieldBehaviours,[Composing.config({find:Option.some}),Representing.config({store:{mode:"manual",getValue:function(comp){var _a,parts=getPartsOrDie(comp,detail,["field1","field2"]);return _a={},_a[detail.field1Name]=Representing.getValue(parts.field1()),_a[detail.field2Name]=Representing.getValue(parts.field2()),_a},setValue:function(comp,value){var parts=getPartsOrDie(comp,detail,["field1","field2"]);hasKey$1(value,detail.field1Name)&&Representing.setValue(parts.field1(),value[detail.field1Name]),hasKey$1(value,detail.field2Name)&&Representing.setValue(parts.field2(),value[detail.field2Name])}}})]),apis:{getField1:function(component){return getPart(component,detail,"field1")},getField2:function(component){return getPart(component,detail,"field2")},getLock:function(component){return getPart(component,detail,"lock")}}}},FormCoupledInputs=composite$1({name:"FormCoupledInputs",configFields:schema$i(),partFields:parts$6(),factory:factory$7,apis:{getField1:function(apis,component){return apis.getField1(component)},getField2:function(apis,component){return apis.getField2(component)},getLock:function(apis,component){return apis.getLock(component)}}}),formatSize=function(size){var unitDec={"":0,px:0,pt:1,mm:1,pc:2,ex:2,em:2,ch:2,rem:2,cm:3,in:4,"%":4},maxDecimal=function(unit){return unit in unitDec?unitDec[unit]:1},numText=size.value.toFixed(maxDecimal(size.unit));return-1!==numText.indexOf(".")&&(numText=numText.replace(/\.?0*$/,"")),numText+size.unit},parseSize=function(sizeText){var numPattern=/^\s*(\d+(?:\.\d+)?)\s*(|cm|mm|in|px|pt|pc|em|ex|ch|rem|vw|vh|vmin|vmax|%)\s*$/,match=numPattern.exec(sizeText);if(null!==match){var value=parseFloat(match[1]),unit=match[2];return Result.value({value:value,unit:unit})}return Result.error(sizeText)},convertUnit=function(size,unit){var inInch={"":96,px:96,pt:72,cm:2.54,pc:12,mm:25.4,in:1},supported=function(u){return Object.prototype.hasOwnProperty.call(inInch,u)};return size.unit===unit?Option.some(size.value):supported(size.unit)&&supported(unit)?inInch[size.unit]===inInch[unit]?Option.some(size.value):Option.some(size.value/inInch[size.unit]*inInch[unit]):Option.none()},noSizeConversion=function(input){return Option.none()},ratioSizeConversion=function(scale,unit){return function(size){return convertUnit(size,unit).map(function(value){return{value:value*scale,unit:unit}})}},makeRatioConverter=function(currentFieldText,otherFieldText){var cValue=parseSize(currentFieldText).toOption(),oValue=parseSize(otherFieldText).toOption();return liftN([cValue,oValue],function(cSize,oSize){return convertUnit(cSize,oSize.unit).map(function(val){return oSize.value/val}).map(function(r){return ratioSizeConversion(r,oSize.unit)}).getOr(noSizeConversion)}).getOr(noSizeConversion)},renderSizeInput=function(spec,providersBackstage){var converter=noSizeConversion,ratioEvent=generate$1("ratio-event"),pLock=FormCoupledInputs.parts().lock({dom:{tag:"button",classes:["tox-lock","tox-button","tox-button--naked","tox-button--icon"],attributes:{title:providersBackstage.translate(spec.label.getOr("Constrain proportions"))}},components:[{dom:{tag:"span",classes:["tox-icon","tox-lock-icon__lock"],innerHtml:get$c("lock",providersBackstage.icons)}},{dom:{tag:"span",classes:["tox-icon","tox-lock-icon__unlock"],innerHtml:get$c("unlock",providersBackstage.icons)}}],buttonBehaviours:derive$1([DisablingConfigs.button(spec.disabled),Tabstopping.config({})])}),formGroup=function(components){return{dom:{tag:"div",classes:["tox-form__group"]},components:components}},getFieldPart=function(isField1){return FormField.parts().field({factory:Input,inputClasses:["tox-textfield"],inputBehaviours:derive$1([Disabling.config({disabled:spec.disabled}),Tabstopping.config({}),config("size-input-events",[run(focusin(),function(component,simulatedEvent){emitWith(component,ratioEvent,{isField1:isField1})}),run(change(),function(component,simulatedEvent){emitWith(component,formChangeEvent,{name:spec.name})})])]),selectOnFocus:!1})},getLabel=function(label){return{dom:{tag:"label",classes:["tox-label"],innerHtml:providersBackstage.translate(label)}}},widthField=FormCoupledInputs.parts().field1(formGroup([FormField.parts().label(getLabel("Width")),getFieldPart(!0)])),heightField=FormCoupledInputs.parts().field2(formGroup([FormField.parts().label(getLabel("Height")),getFieldPart(!1)]));return FormCoupledInputs.sketch({dom:{tag:"div",classes:["tox-form__group"]},components:[{dom:{tag:"div",classes:["tox-form__controls-h-stack"]},components:[widthField,heightField,formGroup([getLabel("&nbsp;"),pLock])]}],field1Name:"width",field2Name:"height",locked:!0,markers:{lockClass:"tox-locked"},onLockedChange:function(current,other,lock){parseSize(Representing.getValue(current)).each(function(size){converter(size).each(function(newSize){Representing.setValue(other,formatSize(newSize))})})},coupledFieldBehaviours:derive$1([Disabling.config({disabled:spec.disabled,onDisabled:function(comp){FormCoupledInputs.getField1(comp).bind(FormField.getField).each(Disabling.disable),FormCoupledInputs.getField2(comp).bind(FormField.getField).each(Disabling.disable),FormCoupledInputs.getLock(comp).each(Disabling.disable)},onEnabled:function(comp){FormCoupledInputs.getField1(comp).bind(FormField.getField).each(Disabling.enable),FormCoupledInputs.getField2(comp).bind(FormField.getField).each(Disabling.enable),FormCoupledInputs.getLock(comp).each(Disabling.enable)}}),config("size-input-events2",[run(ratioEvent,function(component,simulatedEvent){var isField1=simulatedEvent.event().isField1(),optCurrent=isField1?FormCoupledInputs.getField1(component):FormCoupledInputs.getField2(component),optOther=isField1?FormCoupledInputs.getField2(component):FormCoupledInputs.getField1(component),value1=optCurrent.map(Representing.getValue).getOr(""),value2=optOther.map(Representing.getValue).getOr("");converter=makeRatioConverter(value1,value2)})])])})},undo=constant(generate$1("undo")),redo=constant(generate$1("redo")),zoom=constant(generate$1("zoom")),back=constant(generate$1("back")),apply=constant(generate$1("apply")),swap=constant(generate$1("swap")),transform=constant(generate$1("transform")),tempTransform=constant(generate$1("temp-transform")),transformApply=constant(generate$1("transform-apply")),internal={undo:undo,redo:redo,zoom:zoom,back:back,apply:apply,swap:swap,transform:transform,tempTransform:tempTransform,transformApply:transformApply},saveState=constant("save-state"),disable$1=constant("disable"),enable$1=constant("enable"),external$2={formActionEvent:formActionEvent,saveState:saveState,disable:disable$1,enable:enable$1},renderEditPanel=function(imagePanel,providersBackstage){var createButton=function(text,action,disabled,primary){return record(renderButton({name:text,text:text,disabled:disabled,primary:primary,icon:Option.none(),borderless:!1},action,providersBackstage))},createIconButton=function(icon,tooltip,action,disabled){return record(renderIconButton({name:icon,icon:Option.some(icon),tooltip:Option.some(tooltip),disabled:disabled,primary:!1,borderless:!1},action,providersBackstage))},disableAllComponents=function(comps,eventcomp){comps.map(function(mem){var component=mem.get(eventcomp);component.hasConfigured(Disabling)&&Disabling.disable(component)})},enableAllComponents=function(comps,eventcomp){comps.map(function(mem){var component=mem.get(eventcomp);component.hasConfigured(Disabling)&&Disabling.enable(component)})},panelDom={tag:"div",classes:["tox-image-tools__toolbar","tox-image-tools-edit-panel"]},none=Option.none(),noop$1=noop,emit$1=function(comp,event,data){emitWith(comp,event,data)},emitDisable=function(component){return emit(component,external$2.disable())},emitEnable=function(component){return emit(component,external$2.enable())},emitTransform=function(comp,transform){emitDisable(comp),emit$1(comp,internal.transform(),{transform:transform}),emitEnable(comp)},emitTempTransform=function(comp,transform){emitDisable(comp),emit$1(comp,internal.tempTransform(),{transform:transform}),emitEnable(comp)},getBackSwap=function(anyInSystem){return function(){memContainer.getOpt(anyInSystem).each(function(container){Replacing.set(container,[ButtonPanel])})}},emitTransformApply=function(comp,transform){emitDisable(comp),emit$1(comp,internal.transformApply(),{transform:transform,swap:getBackSwap(comp)}),emitEnable(comp)},createBackButton=function(){return createButton("Back",function(button){return emit$1(button,internal.back(),{swap:getBackSwap(button)})},!1,!1)},createSpacer=function(){return record({dom:{tag:"div",classes:["tox-spacer"]},behaviours:derive$1([Disabling.config({})])})},createApplyButton=function(){return createButton("Apply",function(button){return emit$1(button,internal.apply(),{swap:getBackSwap(button)})},!0,!0)},makeCropTransform=function(){return function(ir){var rect=imagePanel.getRect();return crop$1(ir,rect.x,rect.y,rect.w,rect.h)}},cropPanelComponents=[createBackButton(),createSpacer(),createButton("Apply",function(button){var transform=makeCropTransform();emitTransformApply(button,transform),imagePanel.hideCrop()},!1,!0)],CropPanel=Container.sketch({dom:panelDom,components:cropPanelComponents.map(function(mem){return mem.asSpec()}),containerBehaviours:derive$1([config("image-tools-crop-buttons-events",[run(external$2.disable(),function(comp,se){disableAllComponents(cropPanelComponents,comp)}),run(external$2.enable(),function(comp,se){enableAllComponents(cropPanelComponents,comp)})])])}),memSize=record(renderSizeInput({name:"size",label:none,constrain:!0,disabled:!1},providersBackstage)),makeResizeTransform=function(width,height){return function(ir){return resize$2(ir,width,height)}},resizePanelComponents=[createBackButton(),createSpacer(),memSize,createSpacer(),createButton("Apply",function(button){memSize.getOpt(button).each(function(sizeInput){var value=Representing.getValue(sizeInput),width=parseInt(value.width,10),height=parseInt(value.height,10),transform=makeResizeTransform(width,height);emitTransformApply(button,transform)})},!1,!0)],ResizePanel=Container.sketch({dom:panelDom,components:resizePanelComponents.map(function(mem){return mem.asSpec()}),containerBehaviours:derive$1([config("image-tools-resize-buttons-events",[run(external$2.disable(),function(comp,se){disableAllComponents(resizePanelComponents,comp)}),run(external$2.enable(),function(comp,se){enableAllComponents(resizePanelComponents,comp)})])])}),makeValueTransform=function(transform,value){return function(ir){return transform(ir,value)}},horizontalFlip=makeValueTransform(flip$1,"h"),verticalFlip=makeValueTransform(flip$1,"v"),counterclockwiseRotate=makeValueTransform(rotate$1,-90),clockwiseRotate=makeValueTransform(rotate$1,90),flipRotateOnAction=function(comp,operation){emitTempTransform(comp,operation)},flipRotateComponents=[createBackButton(),createSpacer(),createIconButton("flip-horizontally","Flip horizontally",function(button){flipRotateOnAction(button,horizontalFlip)},!1),createIconButton("flip-vertically","Flip vertically",function(button){flipRotateOnAction(button,verticalFlip)},!1),createIconButton("rotate-left","Rotate counterclockwise",function(button){flipRotateOnAction(button,counterclockwiseRotate)},!1),createIconButton("rotate-right","Rotate clockwise",function(button){flipRotateOnAction(button,clockwiseRotate)},!1),createSpacer(),createApplyButton()],FlipRotatePanel=Container.sketch({dom:panelDom,components:flipRotateComponents.map(function(mem){return mem.asSpec()}),containerBehaviours:derive$1([config("image-tools-fliprotate-buttons-events",[run(external$2.disable(),function(comp,se){disableAllComponents(flipRotateComponents,comp)}),run(external$2.enable(),function(comp,se){enableAllComponents(flipRotateComponents,comp)})])])}),makeSlider=function(label,onChoose,min,value,max){var labelPart=Slider.parts().label({dom:{tag:"label",classes:["tox-label"],innerHtml:providersBackstage.translate(label)}}),spectrum=Slider.parts().spectrum({dom:{tag:"div",classes:["tox-slider__rail"],attributes:{role:"presentation"}}}),thumb=Slider.parts().thumb({dom:{tag:"div",classes:["tox-slider__handle"],attributes:{role:"presentation"}}});return record(Slider.sketch({dom:{tag:"div",classes:["tox-slider"],attributes:{role:"presentation"}},model:{mode:"x",minX:min,maxX:max,getInitialValue:constant({x:constant(value)})},components:[labelPart,spectrum,thumb],sliderBehaviours:derive$1([Focusing.config({})]),onChoose:onChoose}))},makeVariableSlider=function(label,transform,min,value,max){var onChoose=function(slider,thumb,value){var valTransform=makeValueTransform(transform,value.x()/100);emitTransform(slider,valTransform)};return makeSlider(label,onChoose,min,value,max)},variableFilterPanelComponents=function(label,transform,min,value,max){return[createBackButton(),makeVariableSlider(label,transform,min,value,max),createApplyButton()]},createVariableFilterPanel=function(label,transform,min,value,max){var filterPanelComponents=variableFilterPanelComponents(label,transform,min,value,max);return Container.sketch({dom:panelDom,components:filterPanelComponents.map(function(mem){return mem.asSpec()}),containerBehaviours:derive$1([config("image-tools-filter-panel-buttons-events",[run(external$2.disable(),function(comp,se){disableAllComponents(filterPanelComponents,comp)}),run(external$2.enable(),function(comp,se){enableAllComponents(filterPanelComponents,comp)})])])})},filterPanelComponents=[createBackButton(),createSpacer(),createApplyButton()],FilterPanel=Container.sketch({dom:panelDom,components:filterPanelComponents.map(function(mem){return mem.asSpec()})}),BrightnessPanel=createVariableFilterPanel("Brightness",brightness$1,-100,0,100),ContrastPanel=createVariableFilterPanel("Contrast",contrast$1,-100,0,100),GammaPanel=createVariableFilterPanel("Gamma",gamma$1,-100,0,100),makeColorTransform=function(red,green,blue){return function(ir){return colorize$1(ir,red,green,blue)}},makeColorSlider=function(label){var onChoose=function(slider,thumb,value){var redOpt=memRed.getOpt(slider),blueOpt=memBlue.getOpt(slider),greenOpt=memGreen.getOpt(slider);redOpt.each(function(red){blueOpt.each(function(blue){greenOpt.each(function(green){var r=Representing.getValue(red).x()/100,g=Representing.getValue(green).x()/100,b=Representing.getValue(blue).x()/100,transform=makeColorTransform(r,g,b);emitTransform(slider,transform)})})})};return makeSlider(label,onChoose,0,100,200)},memRed=makeColorSlider("R"),memGreen=makeColorSlider("G"),memBlue=makeColorSlider("B"),colorizePanelComponents=[createBackButton(),memRed,memGreen,memBlue,createApplyButton()],ColorizePanel=Container.sketch({dom:panelDom,components:colorizePanelComponents.map(function(mem){return mem.asSpec()})}),getTransformPanelEvent=function(panel,transform,update){return function(button){var swap=function(){memContainer.getOpt(button).each(function(container){Replacing.set(container,[panel]),update(container)})};emit$1(button,internal.swap(),{transform:transform,swap:swap})}},cropPanelUpdate=function(_anyInSystem){imagePanel.showCrop()},resizePanelUpdate=function(anyInSystem){memSize.getOpt(anyInSystem).each(function(sizeInput){var measurements=imagePanel.getMeasurements(),width=measurements.width,height=measurements.height;Representing.setValue(sizeInput,{width:width,height:height})})},sharpenTransform=Option.some(sharpen$1),invertTransform=Option.some(invert$1),buttonPanelComponents=[createIconButton("crop","Crop",getTransformPanelEvent(CropPanel,none,cropPanelUpdate),!1),createIconButton("resize","Resize",getTransformPanelEvent(ResizePanel,none,resizePanelUpdate),!1),createIconButton("orientation","Orientation",getTransformPanelEvent(FlipRotatePanel,none,noop$1),!1),createIconButton("brightness","Brightness",getTransformPanelEvent(BrightnessPanel,none,noop$1),!1),createIconButton("sharpen","Sharpen",getTransformPanelEvent(FilterPanel,sharpenTransform,noop$1),!1),createIconButton("contrast","Contrast",getTransformPanelEvent(ContrastPanel,none,noop$1),!1),createIconButton("color-levels","Color levels",getTransformPanelEvent(ColorizePanel,none,noop$1),!1),createIconButton("gamma","Gamma",getTransformPanelEvent(GammaPanel,none,noop$1),!1),createIconButton("invert","Invert",getTransformPanelEvent(FilterPanel,invertTransform,noop$1),!1)],ButtonPanel=Container.sketch({dom:panelDom,components:buttonPanelComponents.map(function(mem){return mem.asSpec()})}),container=Container.sketch({dom:{tag:"div"},components:[ButtonPanel],containerBehaviours:derive$1([Replacing.config({})])}),memContainer=record(container),getApplyButton=function(anyInSystem){return memContainer.getOpt(anyInSystem).map(function(container){var panel=container.components()[0];return panel.components()[panel.components().length-1]})};return{memContainer:memContainer,getApplyButton:getApplyButton}},global$b=tinymce.util.Tools.resolve("tinymce.dom.DomQuery"),global$c=tinymce.util.Tools.resolve("tinymce.geom.Rect"),global$d=tinymce.util.Tools.resolve("tinymce.util.Observable"),global$e=tinymce.util.Tools.resolve("tinymce.util.Tools"),global$f=tinymce.util.Tools.resolve("tinymce.util.VK"),count=0,loadImage=function(image){return new global$4(function(resolve){var loaded=function(){image.removeEventListener("load",loaded),resolve(image)};image.complete?resolve(image):image.addEventListener("load",loaded)})},renderImagePanel=function(initialUrl){var memBg=record({dom:{tag:"div",classes:["tox-image-tools__image-bg"],attributes:{role:"presentation"}}}),zoomState=Cell(1),cropRect=Cell(Option.none()),rectState=Cell({x:0,y:0,w:1,h:1}),viewRectState=Cell({x:0,y:0,w:1,h:1}),repaintImg=function(anyInSystem,img){memContainer.getOpt(anyInSystem).each(function(panel){var zoom=zoomState.get(),panelW=get$7(panel.element()),panelH=get$6(panel.element()),width=img.dom().naturalWidth*zoom,height=img.dom().naturalHeight*zoom,left=Math.max(0,panelW/2-width/2),top=Math.max(0,panelH/2-height/2),css={left:left.toString()+"px",top:top.toString()+"px",width:width.toString()+"px",height:height.toString()+"px",position:"absolute"};setAll$1(img,css),memBg.getOpt(panel).each(function(bg){setAll$1(bg.element(),css)}),cropRect.get().each(function(cRect){var rect=rectState.get();cRect.setRect({x:rect.x*zoom+left,y:rect.y*zoom+top,w:rect.w*zoom,h:rect.h*zoom}),cRect.setClampRect({x:left,y:top,w:width,h:height}),cRect.setViewPortRect({x:0,y:0,w:panelW,h:panelH})})})},zoomFit=function(anyInSystem,img){memContainer.getOpt(anyInSystem).each(function(panel){var panelW=get$7(panel.element()),panelH=get$6(panel.element()),width=img.dom().naturalWidth,height=img.dom().naturalHeight,zoom=Math.min(panelW/width,panelH/height);zoom>=1?zoomState.set(1):zoomState.set(zoom)})},updateSrc=function(anyInSystem,url){var img=Element.fromTag("img");return set$1(img,"src",url),loadImage(img.dom()).then(function(){return memContainer.getOpt(anyInSystem).map(function(panel){var aImg=external({element:img});Replacing.replaceAt(panel,1,Option.some(aImg));var lastViewRect=viewRectState.get(),viewRect={x:0,y:0,w:img.dom().naturalWidth,h:img.dom().naturalHeight};viewRectState.set(viewRect);var rect=global$c.inflate(viewRect,-20,-20);return rectState.set(rect),lastViewRect.w===viewRect.w&&lastViewRect.h===viewRect.h||zoomFit(panel,img),repaintImg(panel,img),img})})},zoom=function(anyInSystem,direction){var currentZoom=zoomState.get(),newZoom=direction>0?Math.min(2,currentZoom+.1):Math.max(.1,currentZoom-.1);zoomState.set(newZoom),memContainer.getOpt(anyInSystem).each(function(panel){var img=panel.components()[1].element();repaintImg(panel,img)})},showCrop=function(){cropRect.get().each(function(cRect){cRect.toggleVisibility(!0)})},hideCrop=function(){cropRect.get().each(function(cRect){cRect.toggleVisibility(!1)})},getRect=function(){return rectState.get()},container=Container.sketch({dom:{tag:"div",classes:["tox-image-tools__image"]},components:[memBg.asSpec(),{dom:{tag:"img",attributes:{src:initialUrl}}},{dom:{tag:"div"},behaviours:derive$1([config("image-panel-crop-events",[runOnAttached(function(comp){memContainer.getOpt(comp).each(function(container){var el=container.element().dom(),cRect=CropRect({x:10,y:10,w:100,h:100},{x:0,y:0,w:200,h:200},{x:0,y:0,w:200,h:200},el,function(){});cRect.toggleVisibility(!1),cRect.on("updateRect",function(e){var rect=e.rect,zoom=zoomState.get(),newRect={x:Math.round(rect.x/zoom),y:Math.round(rect.y/zoom),w:Math.round(rect.w/zoom),h:Math.round(rect.h/zoom)};rectState.set(newRect)}),cropRect.set(Option.some(cRect))})})])])}],containerBehaviours:derive$1([Replacing.config({}),config("image-panel-events",[runOnAttached(function(comp){updateSrc(comp,initialUrl)})])])}),memContainer=record(container),getMeasurements=function(){var viewRect=viewRectState.get();return{width:viewRect.w,height:viewRect.h}};return{memContainer:memContainer,updateSrc:updateSrc,zoom:zoom,showCrop:showCrop,hideCrop:hideCrop,getRect:getRect,getMeasurements:getMeasurements}},createButton=function(innerHtml,icon,disabled,action,providersBackstage){return renderIconButton({name:innerHtml,icon:Option.some(icon),disabled:disabled,tooltip:Option.some(innerHtml),primary:!1,borderless:!1},action,providersBackstage)},setButtonEnabled=function(button,enabled){enabled?Disabling.enable(button):Disabling.disable(button)},renderSideBar=function(providersBackstage){var updateButtonUndoStates=function(anyInSystem,undoEnabled,redoEnabled){memUndo.getOpt(anyInSystem).each(function(undo){setButtonEnabled(undo,undoEnabled)}),memRedo.getOpt(anyInSystem).each(function(redo){setButtonEnabled(redo,redoEnabled)})},memUndo=record(createButton("Undo","undo",!0,function(button){emitWith(button,internal.undo(),{direction:1})},providersBackstage)),memRedo=record(createButton("Redo","redo",!0,function(button){emitWith(button,internal.redo(),{direction:1})},providersBackstage)),container=Container.sketch({dom:{tag:"div",classes:["tox-image-tools__toolbar","tox-image-tools__sidebar"]},components:[memUndo.asSpec(),memRedo.asSpec(),createButton("Zoom in","zoom-in",!1,function(button){emitWith(button,internal.zoom(),{direction:1})},providersBackstage),createButton("Zoom out","zoom-out",!1,function(button){emitWith(button,internal.zoom(),{direction:-1})},providersBackstage)]});return{container:container,updateButtonUndoStates:updateButtonUndoStates}},makeState=function(initialState){var blobState=Cell(initialState),tempState=Cell(Option.none()),undoStack=UndoStack();undoStack.add(initialState);var getBlobState=function(){return blobState.get()},setBlobState=function(state){blobState.set(state)},getTempState=function(){return tempState.get().fold(function(){return blobState.get()},function(temp){return temp})},updateTempState=function(blob){var newTempState=createState(blob);return destroyTempState(),tempState.set(Option.some(newTempState)),newTempState.url},createState=function(blob){return{blob:blob,url:domGlobals.URL.createObjectURL(blob)}
},destroyState=function(state){domGlobals.URL.revokeObjectURL(state.url)},destroyStates=function(states){global$e.each(states,destroyState)},destroyTempState=function(){tempState.get().each(destroyState),tempState.set(Option.none())},addBlobState=function(blob){var newState=createState(blob);setBlobState(newState);var removed=undoStack.add(newState).removed;return destroyStates(removed),newState.url},addTempState=function(blob){var newState=createState(blob);return tempState.set(Option.some(newState)),newState.url},applyTempState=function(postApply){return tempState.get().fold(function(){},function(temp){addBlobState(temp.blob),postApply()})},undo=function(){var currentState=undoStack.undo();return setBlobState(currentState),currentState.url},redo=function(){var currentState=undoStack.redo();return setBlobState(currentState),currentState.url},getHistoryStates=function(){var undoEnabled=undoStack.canUndo(),redoEnabled=undoStack.canRedo();return{undoEnabled:undoEnabled,redoEnabled:redoEnabled}};return{getBlobState:getBlobState,setBlobState:setBlobState,addBlobState:addBlobState,getTempState:getTempState,updateTempState:updateTempState,addTempState:addTempState,applyTempState:applyTempState,destroyTempState:destroyTempState,undo:undo,redo:redo,getHistoryStates:getHistoryStates}},renderImageTools=function(detail,providersBackstage){var state=makeState(detail.currentState),zoom=function(anyInSystem,simulatedEvent){var direction=simulatedEvent.event().direction();imagePanel.zoom(anyInSystem,direction)},updateButtonUndoStates=function(anyInSystem){var historyStates=state.getHistoryStates();sideBar.updateButtonUndoStates(anyInSystem,historyStates.undoEnabled,historyStates.redoEnabled),emitWith(anyInSystem,external$2.formActionEvent,{name:external$2.saveState(),value:historyStates.undoEnabled})},disableUndoRedo=function(anyInSystem){sideBar.updateButtonUndoStates(anyInSystem,!1,!1)},undo=function(anyInSystem,_simulatedEvent){var url=state.undo();updateSrc(anyInSystem,url).then(function(oImg){unblock(anyInSystem),updateButtonUndoStates(anyInSystem)})},redo=function(anyInSystem,_simulatedEvent){var url=state.redo();updateSrc(anyInSystem,url).then(function(oImg){unblock(anyInSystem),updateButtonUndoStates(anyInSystem)})},imageResultToBlob=function(ir){return ir.toBlob()},block=function(anyInSystem){emitWith(anyInSystem,external$2.formActionEvent,{name:external$2.disable(),value:{}})},unblock=function(anyInSystem){editPanel.getApplyButton(anyInSystem).each(function(applyButton){Disabling.enable(applyButton)}),emitWith(anyInSystem,external$2.formActionEvent,{name:external$2.enable(),value:{}})},updateSrc=function(anyInSystem,src){return block(anyInSystem),imagePanel.updateSrc(anyInSystem,src)},blobManipulate=function(anyInSystem,blob,filter,action,swap){return block(anyInSystem),blobToImageResult(blob).then(filter).then(imageResultToBlob).then(action).then(function(url){return updateSrc(anyInSystem,url).then(function(oImg){return updateButtonUndoStates(anyInSystem),swap(),unblock(anyInSystem),oImg})}).catch(function(err){return domGlobals.console.log(err),unblock(anyInSystem),err})},manipulate=function(anyInSystem,filter,swap){var blob=state.getBlobState().blob,action=function(blob){return state.updateTempState(blob)};blobManipulate(anyInSystem,blob,filter,action,swap)},tempManipulate=function(anyInSystem,filter){var blob=state.getTempState().blob,action=function(blob){return state.addTempState(blob)};blobManipulate(anyInSystem,blob,filter,action,noop)},manipulateApply=function(anyInSystem,filter,swap){var blob=state.getBlobState().blob,action=function(blob){var url=state.addBlobState(blob);return destroyTempState(anyInSystem),url};blobManipulate(anyInSystem,blob,filter,action,swap)},apply=function(anyInSystem,simulatedEvent){var postApply=function(){destroyTempState(anyInSystem);var swap=simulatedEvent.event().swap();swap()};state.applyTempState(postApply)},destroyTempState=function(anyInSystem){var currentUrl=state.getBlobState().url;return state.destroyTempState(),updateButtonUndoStates(anyInSystem),currentUrl},cancel=function(anyInSystem){var currentUrl=destroyTempState(anyInSystem);updateSrc(anyInSystem,currentUrl).then(function(oImg){unblock(anyInSystem)})},back=function(anyInSystem,simulatedEvent){cancel(anyInSystem);var swap=simulatedEvent.event().swap();swap(),imagePanel.hideCrop()},transform=function(anyInSystem,simulatedEvent){return manipulate(anyInSystem,simulatedEvent.event().transform(),noop)},tempTransform=function(anyInSystem,simulatedEvent){return tempManipulate(anyInSystem,simulatedEvent.event().transform())},transformApply=function(anyInSystem,simulatedEvent){return manipulateApply(anyInSystem,simulatedEvent.event().transform(),simulatedEvent.event().swap())},imagePanel=renderImagePanel(detail.currentState.url),sideBar=renderSideBar(providersBackstage),editPanel=renderEditPanel(imagePanel,providersBackstage),swap=function(anyInSystem,simulatedEvent){disableUndoRedo(anyInSystem);var transform=simulatedEvent.event().transform(),swap=simulatedEvent.event().swap();transform.fold(function(){swap()},function(transform){manipulate(anyInSystem,transform,swap)})};return{dom:{tag:"div",attributes:{role:"presentation"}},components:[editPanel.memContainer.asSpec(),imagePanel.memContainer.asSpec(),sideBar.container],behaviours:derive$1([Representing.config({store:{mode:"manual",getValue:function(){return state.getBlobState()}}}),config("image-tools-events",[run(internal.undo(),undo),run(internal.redo(),redo),run(internal.zoom(),zoom),run(internal.back(),back),run(internal.apply(),apply),run(internal.transform(),transform),run(internal.tempTransform(),tempTransform),run(internal.transformApply(),transformApply),run(internal.swap(),swap)]),ComposingConfigs.self()])}},factory$8=function(detail,spec){var options=map(detail.options,function(option){return{dom:{tag:"option",value:option.value,innerHtml:option.text}}}),initialValues=detail.data.map(function(v){return wrap$1("initialValue",v)}).getOr({});return{uid:detail.uid,dom:{tag:"select",classes:detail.selectClasses,attributes:detail.selectAttributes},components:options,behaviours:augment(detail.selectBehaviours,[Focusing.config({}),Representing.config({store:__assign({mode:"manual",getValue:function(select){return get$5(select.element())},setValue:function(select,newValue){var found=find(detail.options,function(opt){return opt.value===newValue});found.isSome()&&set$3(select.element(),newValue)}},initialValues)})])}},HtmlSelect=single$2({name:"HtmlSelect",configFields:[strict$1("options"),field$1("selectBehaviours",[Focusing,Representing]),defaulted$1("selectClasses",[]),defaulted$1("selectAttributes",{}),option("data")],factory:factory$8}),renderSelectBox=function(spec,providersBackstage){var translatedOptions=map(spec.items,function(item){return{text:providersBackstage.translate(item.text),value:item.value}}),pLabel=spec.label.map(function(label){return renderLabel(label,providersBackstage)}),pField=FormField.parts().field({dom:{},selectAttributes:{size:spec.size},options:translatedOptions,factory:HtmlSelect,selectBehaviours:derive$1([Disabling.config({disabled:spec.disabled}),Tabstopping.config({}),config("selectbox-change",[run(change(),function(component,_){emitWith(component,formChangeEvent,{name:spec.name})})])])}),chevron=spec.size>1?Option.none():Option.some({dom:{tag:"div",classes:["tox-selectfield__icon-js"],innerHtml:get$c("chevron-down",providersBackstage.icons)}}),selectWrap={dom:{tag:"div",classes:["tox-selectfield"]},components:flatten([[pField],chevron.toArray()])};return FormField.sketch({dom:{tag:"div",classes:["tox-form__group"]},components:flatten([pLabel.toArray(),[selectWrap]]),fieldBehaviours:derive$1([Disabling.config({disabled:spec.disabled,onDisabled:function(comp){FormField.getField(comp).each(Disabling.disable)},onEnabled:function(comp){FormField.getField(comp).each(Disabling.enable)}})])})},renderTextField=function(spec,providersBackstage){var pLabel=spec.label.map(function(label){return renderLabel(label,providersBackstage)}),baseInputBehaviours=[Disabling.config({disabled:spec.disabled}),Keying.config({mode:"execution",useEnter:!0!==spec.multiline,useControlEnter:!0===spec.multiline,execute:function(comp){return emit(comp,formSubmitEvent),Option.some(!0)}}),config("textfield-change",[run(input(),function(component,_){emitWith(component,formChangeEvent,{name:spec.name})}),run(postPaste(),function(component,_){emitWith(component,formChangeEvent,{name:spec.name})})]),Tabstopping.config({})],validatingBehaviours=spec.validation.map(function(vl){return Invalidating.config({getRoot:function(input){return parent(input.element())},invalidClass:"tox-invalid",validator:{validate:function(input){var v=Representing.getValue(input),result=vl.validator(v);return Future.pure(!0===result?Result.value(v):Result.error(result))},validateOnLoad:vl.validateOnLoad}})}).toArray(),pField=FormField.parts().field({tag:!0===spec.multiline?"textarea":"input",inputAttributes:spec.placeholder.fold(function(){},function(placeholder){return{placeholder:providersBackstage.translate(placeholder)}}),inputClasses:[spec.classname],inputBehaviours:derive$1(flatten([baseInputBehaviours,validatingBehaviours])),selectOnFocus:!1,factory:Input}),extraClasses=spec.flex?["tox-form__group--stretched"]:[],extraClasses2=extraClasses.concat(spec.maximized?["tox-form-group--maximize"]:[]),extraBehaviours=[Disabling.config({disabled:spec.disabled,onDisabled:function(comp){FormField.getField(comp).each(Disabling.disable)},onEnabled:function(comp){FormField.getField(comp).each(Disabling.enable)}})];return renderFormFieldWith(pLabel,pField,extraClasses2,extraBehaviours)},renderInput=function(spec,providersBackstage){return renderTextField({name:spec.name,multiline:!1,label:spec.label,placeholder:spec.placeholder,flex:!1,disabled:spec.disabled,classname:"tox-textfield",validation:Option.none(),maximized:spec.maximized},providersBackstage)},renderTextarea=function(spec,providersBackstage){return renderTextField({name:spec.name,multiline:!0,label:spec.label,placeholder:spec.placeholder,flex:!0,disabled:spec.disabled,classname:"tox-textarea",validation:Option.none(),maximized:spec.maximized},providersBackstage)},wrap$2=function(delegate){var toCached=function(){return wrap$2(delegate.toCached())},bindFuture=function(f){return wrap$2(delegate.bind(function(resA){return resA.fold(function(err){return Future.pure(Result.error(err))},function(a){return f(a)})}))},bindResult=function(f){return wrap$2(delegate.map(function(resA){return resA.bind(f)}))},mapResult=function(f){return wrap$2(delegate.map(function(resA){return resA.map(f)}))},mapError=function(f){return wrap$2(delegate.map(function(resA){return resA.mapError(f)}))},foldResult=function(whenError,whenValue){return delegate.map(function(res){return res.fold(whenError,whenValue)})},withTimeout=function(timeout,errorThunk){return wrap$2(Future.nu(function(callback){var timedOut=!1,timer=domGlobals.setTimeout(function(){timedOut=!0,callback(Result.error(errorThunk()))},timeout);delegate.get(function(result){timedOut||(domGlobals.clearTimeout(timer),callback(result))})}))};return __assign({},delegate,{toCached:toCached,bindFuture:bindFuture,bindResult:bindResult,mapResult:mapResult,mapError:mapError,foldResult:foldResult,withTimeout:withTimeout})},nu$c=function(worker){return wrap$2(Future.nu(worker))},value$2=function(value){return wrap$2(Future.pure(Result.value(value)))},error$1=function(error){return wrap$2(Future.pure(Result.error(error)))},fromResult$1=function(result){return wrap$2(Future.pure(result))},fromFuture=function(future){return wrap$2(future.map(Result.value))},fromPromise=function(promise){return nu$c(function(completer){promise.then(function(value){completer(Result.value(value))},function(error){completer(Result.error(error))})})},FutureResult={nu:nu$c,wrap:wrap$2,pure:value$2,value:value$2,error:error$1,fromResult:fromResult$1,fromFuture:fromFuture,fromPromise:fromPromise},separator$2={type:"separator"},toMenuItem=function(target){return{type:"menuitem",value:target.url,text:target.title,meta:{attach:target.attach},onAction:function(){}}},staticMenuItem=function(title,url){return{type:"menuitem",value:url,text:title,meta:{attach:void 0},onAction:function(){}}},toMenuItems=function(targets){return map(targets,toMenuItem)},filterLinkTargets=function(type,targets){return filter(targets,function(target){return target.type===type})},filteredTargets=function(type,targets){return toMenuItems(filterLinkTargets(type,targets))},headerTargets=function(linkInfo){return filteredTargets("header",linkInfo.targets)},anchorTargets=function(linkInfo){return filteredTargets("anchor",linkInfo.targets)},anchorTargetTop=function(linkInfo){return Option.from(linkInfo.anchorTop).map(function(url){return staticMenuItem("<top>",url)}).toArray()},anchorTargetBottom=function(linkInfo){return Option.from(linkInfo.anchorBottom).map(function(url){return staticMenuItem("<bottom>",url)}).toArray()},historyTargets=function(history){return map(history,function(url){return staticMenuItem(url,url)})},joinMenuLists=function(items){return foldl(items,function(a,b){var bothEmpty=0===a.length||0===b.length;return bothEmpty?a.concat(b):a.concat(separator$2,b)},[])},filterByQuery=function(term,menuItems){var lowerCaseTerm=term.toLowerCase();return filter(menuItems,function(item){var text=void 0!==item.meta&&void 0!==item.meta.text?item.meta.text:item.text;return contains$1(text.toLowerCase(),lowerCaseTerm)||contains$1(item.value.toLowerCase(),lowerCaseTerm)})},getItems=function(fileType,input,urlBackstage){var urlInputValue=Representing.getValue(input),term=void 0!==urlInputValue.meta.text?urlInputValue.meta.text:urlInputValue.value,info=urlBackstage.getLinkInformation();return info.fold(function(){return[]},function(linkInfo){var history=filterByQuery(term,historyTargets(urlBackstage.getHistory(fileType)));return"file"===fileType?joinMenuLists([history,filterByQuery(term,headerTargets(linkInfo)),filterByQuery(term,flatten([anchorTargetTop(linkInfo),anchorTargets(linkInfo),anchorTargetBottom(linkInfo)]))]):history})},errorId=generate$1("aria-invalid"),renderUrlInput=function(spec,backstage,urlBackstage){var _a,providersBackstage=backstage.shared.providers,updateHistory=function(component){var urlEntry=Representing.getValue(component);urlBackstage.addToHistory(urlEntry.value,spec.filetype)},pField=FormField.parts().field({factory:Typeahead,dismissOnBlur:!0,inputClasses:["tox-textfield"],sandboxClasses:["tox-dialog__popups"],inputAttributes:{"aria-errormessage":errorId},minChars:0,responseTime:0,fetch:function(input){var items=getItems(spec.filetype,input,urlBackstage),tdata=build$2(items,ItemResponse$1.BUBBLE_TO_SANDBOX,backstage);return Future.pure(tdata)},getHotspot:function(comp){return memUrlBox.getOpt(comp)},onSetValue:function(comp,newValue){comp.hasConfigured(Invalidating)&&Invalidating.run(comp).get(noop)},typeaheadBehaviours:derive$1(flatten([urlBackstage.getValidationHandler().map(function(handler){return Invalidating.config({getRoot:function(comp){return parent(comp.element())},invalidClass:"tox-control-wrap--status-invalid",notify:{onInvalid:function(comp,err){memInvalidIcon.getOpt(comp).each(function(invalidComp){set$1(invalidComp.element(),"title",providersBackstage.translate(err))})}},validator:{validate:function(input){var urlEntry=Representing.getValue(input);return FutureResult.nu(function(completer){handler({type:spec.filetype,url:urlEntry.value},function(validation){completer(("invalid"===validation.status?Result.error:Result.value)(validation.message))})})},validateOnLoad:!1}})}).toArray(),[Disabling.config({disabled:spec.disabled}),Tabstopping.config({}),config("urlinput-events",flatten(["file"===spec.filetype?[run(input(),function(comp){emitWith(comp,formChangeEvent,{name:spec.name})})]:[],[run(change(),function(comp){emitWith(comp,formChangeEvent,{name:spec.name}),updateHistory(comp)}),run(postPaste(),function(comp){emitWith(comp,formChangeEvent,{name:spec.name}),updateHistory(comp)})]]))]])),eventOrder:(_a={},_a[input()]=["streaming","urlinput-events","invalidating"],_a),model:{getDisplayText:function(itemData){return itemData.value},selectsOver:!1,populateFromBrowse:!1},markers:{openClass:"dog"},lazySink:backstage.shared.getSink,parts:{menu:part(!1,1,"normal")},onExecute:function(_menu,component,_entry){emitWith(component,formSubmitEvent,{})},onItemExecute:function(typeahead,_sandbox,_item,_value){updateHistory(typeahead),emitWith(typeahead,formChangeEvent,{name:spec.name})}}),pLabel=spec.label.map(function(label){return renderLabel(label,providersBackstage)}),makeIcon=function(name,errId,icon,label){return void 0===icon&&(icon=name),void 0===label&&(label=name),{dom:{tag:"div",classes:["tox-icon","tox-control-wrap__status-icon-"+name],innerHtml:get$c(icon,providersBackstage.icons),attributes:__assign({title:providersBackstage.translate(label),"aria-live":"polite"},errId.fold(function(){return{}},function(id){return{id:id}}))}}},memInvalidIcon=record(makeIcon("invalid",Option.some(errorId),"warning")),memStatus=record({dom:{tag:"div",classes:["tox-control-wrap__status-icon-wrap"]},components:[memInvalidIcon.asSpec()]}),optUrlPicker=urlBackstage.getUrlPicker(spec.filetype),browseUrlEvent=generate$1("browser.url.event"),memUrlBox=record({dom:{tag:"div",classes:["tox-control-wrap"]},components:[pField,memStatus.asSpec()],behaviours:derive$1([Disabling.config({disabled:spec.disabled})])}),memUrlPickerButton=record(renderButton({name:spec.name,icon:Option.some("browse"),text:spec.label.getOr(""),disabled:spec.disabled,primary:!1,borderless:!0},function(component){return emit(component,browseUrlEvent)},providersBackstage,[],["tox-browse-url"])),controlHWrapper=function(){return{dom:{tag:"div",classes:["tox-form__controls-h-stack"]},components:flatten([[memUrlBox.asSpec()],optUrlPicker.map(function(){return memUrlPickerButton.asSpec()}).toArray()])}},openUrlPicker=function(comp){Composing.getCurrent(comp).each(function(field){var urlData=Representing.getValue(field);optUrlPicker.each(function(picker){picker(urlData).get(function(chosenData){Representing.setValue(field,chosenData),emitWith(comp,formChangeEvent,{name:spec.name})})})})};return FormField.sketch({dom:renderFormFieldDom(),components:pLabel.toArray().concat([controlHWrapper()]),fieldBehaviours:derive$1([Disabling.config({disabled:spec.disabled,onDisabled:function(comp){FormField.getField(comp).each(Disabling.disable),memUrlPickerButton.getOpt(comp).each(Disabling.disable)},onEnabled:function(comp){FormField.getField(comp).each(Disabling.enable),memUrlPickerButton.getOpt(comp).each(Disabling.enable)}}),config("url-input-events",[run(browseUrlEvent,openUrlPicker)])])})},renderCheckbox=function(spec,providerBackstage){var repBehaviour=Representing.config({store:{mode:"manual",getValue:function(comp){var el=comp.element().dom();return el.checked},setValue:function(comp,value){var el=comp.element().dom();el.checked=value}}}),toggleCheckboxHandler=function(comp){return comp.element().dom().click(),Option.some(!0)},pField=FormField.parts().field({factory:{sketch:identity},dom:{tag:"input",classes:["tox-checkbox__input"],attributes:{type:"checkbox"}},behaviours:derive$1([ComposingConfigs.self(),Disabling.config({disabled:spec.disabled}),Tabstopping.config({}),Focusing.config({}),repBehaviour,Keying.config({mode:"special",onEnter:toggleCheckboxHandler,onSpace:toggleCheckboxHandler,stopSpaceKeyup:!0}),config("checkbox-events",[run(change(),function(component,_){emitWith(component,formChangeEvent,{name:spec.name})})])])}),pLabel=FormField.parts().label({dom:{tag:"span",classes:["tox-checkbox__label"],innerHtml:providerBackstage.translate(spec.label)},behaviours:derive$1([Unselecting.config({})])}),makeIcon=function(className){var iconName="checked"===className?"selected":"unselected";return{dom:{tag:"span",classes:["tox-icon","tox-checkbox-icon__"+className],innerHtml:get$c(iconName,providerBackstage.icons)}}},memIcons=record({dom:{tag:"div",classes:["tox-checkbox__icons"]},components:[makeIcon("checked"),makeIcon("unchecked")]});return FormField.sketch({dom:{tag:"label",classes:["tox-checkbox"]},components:[pField,memIcons.asSpec(),pLabel],fieldBehaviours:derive$1([Disabling.config({disabled:spec.disabled,disableClass:"tox-checkbox--disabled",onDisabled:function(comp){FormField.getField(comp).each(Disabling.disable)},onEnabled:function(comp){FormField.getField(comp).each(Disabling.enable)}})])})},renderHtmlPanel=function(spec){return"presentation"===spec.presets?Container.sketch({dom:{tag:"div",classes:["tox-form__group"],innerHtml:spec.html}}):Container.sketch({dom:{tag:"div",classes:["tox-form__group"],innerHtml:spec.html,attributes:{role:"document"}},containerBehaviours:derive$1([Tabstopping.config({}),Focusing.config({})])})},renderListbox=function(spec,providersBackstage){var pLabel=renderLabel(spec.label,providersBackstage),pField=FormField.parts().field({factory:HtmlSelect,dom:{classes:["mce-select-field"]},selectBehaviours:derive$1([Tabstopping.config({})]),options:spec.values,data:spec.initialValue.getOr(void 0)});return renderFormField(Option.some(pLabel),pField)},renderLabel$2=function(spec,backstageShared){var label={dom:{tag:"label",innerHtml:backstageShared.providers.translate(spec.label),classes:["tox-label"]}},comps=map(spec.items,backstageShared.interpreter);return{dom:{tag:"div",classes:["tox-form__group"]},components:[label].concat(comps),behaviours:derive$1([ComposingConfigs.self(),Replacing.config({}),RepresentingConfigs.domHtml(Option.none()),Keying.config({mode:"acyclic"})])}},renderCollection=function(spec,providersBackstage){var pLabel=spec.label.map(function(label){return renderLabel(label,providersBackstage)}),runOnItem=function(f){return function(comp,se){closest$3(se.event().target(),"[data-collection-item-value]").each(function(target){f(comp,target,get$2(target,"data-collection-item-value"))})}},escapeAttribute=function(ch){return'"'===ch?"&quot;":ch},setContents=function(comp,items){var htmlLines=map(items,function(item){var itemText=global$5.translate(item.text),textContent=1===spec.columns?'<div class="tox-collection__item-label">'+itemText+"</div>":"",iconContent='<div class="tox-collection__item-icon">'+item.icon+"</div>",mapItemName={_:" "," - ":" ","-":" "},ariaLabel=itemText.replace(/\_| \- |\-/g,function(match){return mapItemName[match]});return'<div class="tox-collection__item" tabindex="-1" data-collection-item-value="'+escapeAttribute(item.value)+'" title="'+ariaLabel+'" aria-label="'+ariaLabel+'">'+iconContent+textContent+"</div>"}),chunks=spec.columns>1&&"auto"!==spec.columns?chunk(htmlLines,spec.columns):[htmlLines],html=map(chunks,function(ch){return'<div class="tox-collection__group">'+ch.join("")+"</div>"});set(comp.element(),html.join(""))},collectionEvents=[run(mouseover(),runOnItem(function(comp,tgt){focus$1(tgt)})),run(tapOrClick(),runOnItem(function(comp,tgt,itemValue){emitWith(comp,formActionEvent,{name:spec.name,value:itemValue})})),run(focusin(),runOnItem(function(comp,tgt,itemValue){descendant$1(comp.element(),"."+activeClass).each(function(currentActive){remove$4(currentActive,activeClass)}),add$2(tgt,activeClass)})),run(focusout(),runOnItem(function(comp,tgt,itemValue){descendant$1(comp.element(),"."+activeClass).each(function(currentActive){remove$4(currentActive,activeClass)})})),runOnExecute(runOnItem(function(comp,tgt,itemValue){emitWith(comp,formActionEvent,{name:spec.name,value:itemValue})}))],pField=FormField.parts().field({dom:{tag:"div",classes:["tox-collection"].concat(1!==spec.columns?["tox-collection--grid"]:["tox-collection--list"])},components:[],factory:{sketch:identity},behaviours:derive$1([Replacing.config({}),Representing.config({store:{mode:"memory",initialValue:[]},onSetValue:function(comp,items){setContents(comp,items),"auto"===spec.columns&&detectSize(comp,5,"tox-collection__item").each(function(_a){var numRows=_a.numRows,numColumns=_a.numColumns;Keying.setGridSize(comp,numRows,numColumns)}),emit(comp,formResizeEvent)}}),Tabstopping.config({}),Keying.config(deriveCollectionMovement(spec.columns,"normal")),config("collection-events",collectionEvents)])}),extraClasses=["tox-form__group--collection"];return renderFormFieldWith(pLabel,pField,extraClasses,[])},renderTable=function(spec,providersBackstage){var renderTh=function(text){return{dom:{tag:"th",innerHtml:providersBackstage.translate(text)}}},renderHeader=function(header){return{dom:{tag:"thead"},components:[{dom:{tag:"tr"},components:map(header,renderTh)}]}},renderTd=function(text){return{dom:{tag:"td",innerHtml:providersBackstage.translate(text)}}},renderTr=function(row){return{dom:{tag:"tr"},components:map(row,renderTd)}},renderRows=function(rows){return{dom:{tag:"tbody"},components:map(rows,renderTr)}};return{dom:{tag:"table",classes:["tox-dialog__table"]},components:[renderHeader(spec.header),renderRows(spec.cells)],behaviours:derive$1([Tabstopping.config({}),Focusing.config({})])}},renderPanel=function(spec,backstage){return{dom:{tag:"div",classes:spec.classes},components:map(spec.items,backstage.shared.interpreter)}},make$6=function(render){return function(parts,spec,backstage){return readOptFrom$1(spec,"name").fold(function(){return render(spec,backstage)},function(fieldName){return parts.field(fieldName,render(spec,backstage))})}},makeIframe=function(render){return function(parts,spec,backstage){var iframeSpec=deepMerge(spec,{source:"dynamic"});return make$6(render)(parts,iframeSpec,backstage)}},factories={bar:make$6(function(spec,backstage){return renderBar(spec,backstage.shared)}),collection:make$6(function(spec,backstage){return renderCollection(spec,backstage.shared.providers)}),alloy:make$6(identity),alertbanner:make$6(function(spec,backstage){return renderAlertBanner(spec,backstage.shared.providers)}),input:make$6(function(spec,backstage){return renderInput(spec,backstage.shared.providers)}),textarea:make$6(function(spec,backstage){return renderTextarea(spec,backstage.shared.providers)}),listbox:make$6(function(spec,backstage){return renderListbox(spec,backstage.shared.providers)}),label:make$6(function(spec,backstage){return renderLabel$2(spec,backstage.shared)}),iframe:makeIframe(function(spec,backstage){return renderIFrame(spec,backstage.shared.providers)}),autocomplete:make$6(function(spec,backstage){return renderAutocomplete(spec,backstage)}),button:make$6(function(spec,backstage){return renderDialogButton(spec,backstage.shared.providers)}),checkbox:make$6(function(spec,backstage){return renderCheckbox(spec,backstage.shared.providers)}),colorinput:make$6(function(spec,backstage){return renderColorInput(spec,backstage.shared,backstage.colorinput)}),colorpicker:make$6(renderColorPicker),dropzone:make$6(function(spec,backstage){return renderDropZone(spec,backstage.shared.providers)}),grid:make$6(function(spec,backstage){return renderGrid(spec,backstage.shared)}),selectbox:make$6(function(spec,backstage){return renderSelectBox(spec,backstage.shared.providers)}),sizeinput:make$6(function(spec,backstage){return renderSizeInput(spec,backstage.shared.providers)}),urlinput:make$6(function(spec,backstage){return renderUrlInput(spec,backstage,backstage.urlinput)}),customeditor:make$6(renderCustomEditor),htmlpanel:make$6(renderHtmlPanel),imagetools:make$6(function(spec,backstage){return renderImageTools(spec,backstage.shared.providers)}),table:make$6(function(spec,backstage){return renderTable(spec,backstage.shared.providers)}),panel:make$6(function(spec,backstage){return renderPanel(spec,backstage)})},noFormParts={field:function(_name,spec){return spec}},interpretInForm=function(parts,spec,oldBackstage){var newBackstage=deepMerge(oldBackstage,{shared:{interpreter:function(childSpec){return interpretParts(parts,childSpec,newBackstage)}}});return interpretParts(parts,spec,newBackstage)},interpretParts=function(parts,spec,backstage){return readOptFrom$1(factories,spec.type).fold(function(){return domGlobals.console.error('Unknown factory type "'+spec.type+'", defaulting to container: ',spec),spec},function(factory){return factory(parts,spec,backstage)})},interpretWithoutForm=function(spec,backstage){var parts=noFormParts;return interpretParts(parts,spec,backstage)},westEdgeX$1=function(anchor){return anchor.x()},middleX$1=function(anchor,element){return anchor.x()+anchor.width()/2-element.width()/2},eastEdgeX$1=function(anchor,element){return anchor.x()+anchor.width()-element.width()},northY$2=function(anchor){return anchor.y()},southY$2=function(anchor,element){return anchor.y()+anchor.height()-element.height()},southeast$3=function(anchor,element,bubbles){return nu$8(westEdgeX$1(anchor),southY$2(anchor,element),bubbles.innerSoutheast(),southeast(),"layout-se")},southwest$3=function(anchor,element,bubbles){return nu$8(eastEdgeX$1(anchor,element),southY$2(anchor,element),bubbles.innerSouthwest(),southwest(),"layout-sw")},northeast$3=function(anchor,element,bubbles){return nu$8(westEdgeX$1(anchor),northY$2(anchor),bubbles.innerNortheast(),northeast(),"layout-ne")},northwest$3=function(anchor,element,bubbles){return nu$8(eastEdgeX$1(anchor,element),northY$2(anchor),bubbles.innerNorthwest(),northwest(),"layout-nw")},north$3=function(anchor,element,bubbles){return nu$8(middleX$1(anchor,element),northY$2(anchor),bubbles.innerNorth(),north(),"layout-n")},south$3=function(anchor,element,bubbles){return nu$8(middleX$1(anchor,element),southY$2(anchor,element),bubbles.innerSouth(),south(),"layout-s")},bubbleAlignments={valignCentre:[],alignCentre:[],alignLeft:[],alignRight:[],right:[],left:[],bottom:[],top:[]},getToolbarAnchor=function(bodyElement,lazyAnchorbar,useFixedToolbarContainer){var fixedToolbarAnchor=function(){return{anchor:"node",root:bodyElement(),node:Option.from(bodyElement()),bubble:nu$7(-12,-12,bubbleAlignments),layouts:{onRtl:function(){return[northeast$3]},onLtr:function(){return[northwest$3]}}}},standardAnchor=function(){return{anchor:"hotspot",hotspot:lazyAnchorbar(),bubble:nu$7(-12,12,bubbleAlignments),layouts:{onRtl:function(){return[southeast$1]},onLtr:function(){return[southwest$1]}}}};return useFixedToolbarContainer?fixedToolbarAnchor:standardAnchor},getBannerAnchor=function(bodyElement,lazyAnchorbar,useFixedToolbarContainer){var fixedToolbarAnchor=function(){return{anchor:"node",root:bodyElement(),node:Option.from(bodyElement()),layouts:{onRtl:function(){return[north$3]},onLtr:function(){return[north$3]}}}},standardAnchor=function(){return{anchor:"hotspot",hotspot:lazyAnchorbar(),layouts:{onRtl:function(){return[south$1]},onLtr:function(){return[south$1]}}}};return useFixedToolbarContainer?fixedToolbarAnchor:standardAnchor},getToolbarOverflowAnchor=function(lazyMoreButton){return function(){return{anchor:"hotspot",hotspot:lazyMoreButton(),layouts:{onRtl:function(){return[southeast$1]},onLtr:function(){return[southwest$1]}}}}},getCursorAnchor=function(editor,bodyElement){return function(){return{anchor:"selection",root:bodyElement(),getSelection:function(){var rng=editor.selection.getRng();return Option.some(Selection.range(Element.fromDom(rng.startContainer),rng.startOffset,Element.fromDom(rng.endContainer),rng.endOffset))}}}},getNodeAnchor=function(bodyElement){return function(element){return{anchor:"node",root:bodyElement(),node:element}}},getAnchors=function(editor,lazyAnchorbar,lazyMoreButton){var useFixedToolbarContainer=useFixedContainer(editor),bodyElement=function(){return Element.fromDom(editor.getBody())};return{toolbar:getToolbarAnchor(bodyElement,lazyAnchorbar,useFixedToolbarContainer),toolbarOverflow:getToolbarOverflowAnchor(lazyMoreButton),banner:getBannerAnchor(bodyElement,lazyAnchorbar,lazyMoreButton),cursor:getCursorAnchor(editor,bodyElement),node:getNodeAnchor(bodyElement)}},Anchors={getAnchors:getAnchors},colorPicker=function(editor){return function(callback,value){var dialog=ColorSwatch.colorPickerDialog(editor);dialog(callback,value)}},hasCustomColors$1=function(editor){return function(){
return Settings.hasCustomColors(editor)}},getColors$1=function(editor){return function(){return Settings.getColors(editor)}},getColorCols$2=function(editor){return function(){return ColorSwatch.getColorCols(editor)}},ColorInputBackstage=function(editor){return{colorPicker:colorPicker(editor),hasCustomColors:hasCustomColors$1(editor),getColors:getColors$1(editor),getColorCols:getColorCols$2(editor)}},defaultStyleFormats=[{title:"Headings",items:[{title:"Heading 1",format:"h1"},{title:"Heading 2",format:"h2"},{title:"Heading 3",format:"h3"},{title:"Heading 4",format:"h4"},{title:"Heading 5",format:"h5"},{title:"Heading 6",format:"h6"}]},{title:"Inline",items:[{title:"Bold",icon:"bold",format:"bold"},{title:"Italic",icon:"italic",format:"italic"},{title:"Underline",icon:"underline",format:"underline"},{title:"Strikethrough",icon:"strike-through",format:"strikethrough"},{title:"Superscript",icon:"superscript",format:"superscript"},{title:"Subscript",icon:"subscript",format:"subscript"},{title:"Code",icon:"code",format:"code"}]},{title:"Blocks",items:[{title:"Paragraph",format:"p"},{title:"Blockquote",format:"blockquote"},{title:"Div",format:"div"},{title:"Pre",format:"pre"}]},{title:"Align",items:[{title:"Left",icon:"align-left",format:"alignleft"},{title:"Center",icon:"align-center",format:"aligncenter"},{title:"Right",icon:"align-right",format:"alignright"},{title:"Justify",icon:"align-justify",format:"alignjustify"}]}],isNestedFormat=function(format){return has(format,"items")},isBlockFormat=function(format){return has(format,"block")},isInlineFormat=function(format){return has(format,"inline")},isSelectorFormat=function(format){return has(format,"selector")},mapFormats=function(userFormats){return foldl(userFormats,function(acc,fmt){if(isNestedFormat(fmt)){var result=mapFormats(fmt.items);return{customFormats:acc.customFormats.concat(result.customFormats),formats:acc.formats.concat([{title:fmt.title,items:result.formats}])}}if(isInlineFormat(fmt)||isBlockFormat(fmt)||isSelectorFormat(fmt)){var formatName="custom-"+fmt.title.toLowerCase();return{customFormats:acc.customFormats.concat([{name:formatName,format:fmt}]),formats:acc.formats.concat([{title:fmt.title,format:formatName,icon:fmt.icon}])}}return __assign({},acc,{formats:acc.formats.concat(fmt)})},{customFormats:[],formats:[]})},registerCustomFormats=function(editor,userFormats){var result=mapFormats(userFormats),registerFormats=function(customFormats){each(customFormats,function(fmt){editor.formatter.has(fmt.name)||editor.formatter.register(fmt.name,fmt.format)})};return editor.formatter?registerFormats(result.customFormats):editor.on("init",function(){registerFormats(result.customFormats)}),result.formats},getStyleFormats=function(editor){return getUserStyleFormats(editor).map(function(userFormats){var registeredUserFormats=registerCustomFormats(editor,userFormats);return isMergeStyleFormats(editor)?defaultStyleFormats.concat(registeredUserFormats):registeredUserFormats}).getOr(defaultStyleFormats)},processBasic=function(item,isSelectedFor,getPreviewFor){var formatterSpec={type:"formatter",isSelected:isSelectedFor(item.format),getStylePreview:getPreviewFor(item.format)};return deepMerge(item,formatterSpec)},register$3=function(editor,formats,isSelectedFor,getPreviewFor){var enrichSupported=function(item){return processBasic(item,isSelectedFor,getPreviewFor)},enrichMenu=function(item){var submenuSpec={type:"submenu",isSelected:constant(!1),getStylePreview:function(){return Option.none()}};return deepMerge(item,submenuSpec)},enrichCustom=function(item){var formatName=generate$1(item.title),customSpec={type:"formatter",format:formatName,isSelected:isSelectedFor(formatName),getStylePreview:getPreviewFor(formatName)},newItem=deepMerge(item,customSpec);return editor.formatter.register(formatName,newItem),newItem},doEnrich=function(items){return map(items,function(item){var keys$1=keys(item);if(hasKey$1(item,"items")){var newItems_1=doEnrich(item.items);return deepMerge(enrichMenu(item),{getStyleItems:function(){return newItems_1}})}return hasKey$1(item,"format")?enrichSupported(item):1===keys$1.length&&contains(keys$1,"title")?deepMerge(item,{type:"separator"}):enrichCustom(item)})};return doEnrich(formats)},init$7=function(editor){var isSelectedFor=function(format){return function(){return editor.formatter.match(format)}},getPreviewFor=function(format){return function(){var fmt=editor.formatter.get(format);return void 0!==fmt?Option.some({tag:fmt.length>0&&(fmt[0].inline||fmt[0].block)||"div",styleAttr:editor.formatter.getCssText(format)}):Option.none()}},flatten=function(fmt){var subs=fmt.items;return void 0!==subs&&subs.length>0?bind(subs,flatten):[fmt.format]},settingsFormats=Cell([]),settingsFlattenedFormats=Cell([]),eventsFormats=Cell([]),eventsFlattenedFormats=Cell([]),replaceSettings=Cell(!1);editor.on("init",function(){var formats=getStyleFormats(editor),enriched=register$3(editor,formats,isSelectedFor,getPreviewFor);settingsFormats.set(enriched),settingsFlattenedFormats.set(bind(enriched,flatten))}),editor.on("addStyleModifications",function(e){var modifications=register$3(editor,e.items,isSelectedFor,getPreviewFor);eventsFormats.set(modifications),replaceSettings.set(e.replace),eventsFlattenedFormats.set(bind(modifications,flatten))});var getData=function(){var fromSettings=replaceSettings.get()?[]:settingsFormats.get(),fromEvents=eventsFormats.get();return fromSettings.concat(fromEvents)},getFlattenedKeys=function(){var fromSettings=replaceSettings.get()?[]:settingsFlattenedFormats.get(),fromEvents=eventsFlattenedFormats.get();return fromSettings.concat(fromEvents)};return{getData:getData,getFlattenedKeys:getFlattenedKeys}},trim$1=global$e.trim,hasContentEditableState=function(value){return function(node){if(node&&1===node.nodeType){if(node.contentEditable===value)return!0;if(node.getAttribute("data-mce-contenteditable")===value)return!0}return!1}},isContentEditableTrue=hasContentEditableState("true"),isContentEditableFalse=hasContentEditableState("false"),create$7=function(type,title,url,level,attach){return{type:type,title:title,url:url,level:level,attach:attach}},isChildOfContentEditableTrue=function(node){for(;node=node.parentNode;){var value=node.contentEditable;if(value&&"inherit"!==value)return isContentEditableTrue(node)}return!1},select=function(selector,root){return map(descendants(Element.fromDom(root),selector),function(element){return element.dom()})},getElementText=function(elm){return elm.innerText||elm.textContent},getOrGenerateId=function(elm){return elm.id?elm.id:generate$1("h")},isAnchor=function(elm){return elm&&"A"===elm.nodeName&&void 0!==(elm.id||elm.name)},isValidAnchor=function(elm){return isAnchor(elm)&&isEditable(elm)},isHeader=function(elm){return elm&&/^(H[1-6])$/.test(elm.nodeName)},isEditable=function(elm){return isChildOfContentEditableTrue(elm)&&!isContentEditableFalse(elm)},isValidHeader=function(elm){return isHeader(elm)&&isEditable(elm)},getLevel=function(elm){return isHeader(elm)?parseInt(elm.nodeName.substr(1),10):0},headerTarget=function(elm){var headerId=getOrGenerateId(elm),attach=function(){elm.id=headerId};return create$7("header",getElementText(elm),"#"+headerId,getLevel(elm),attach)},anchorTarget=function(elm){var anchorId=elm.id||elm.name,anchorText=getElementText(elm);return create$7("anchor",anchorText||"#"+anchorId,"#"+anchorId,0,noop)},getHeaderTargets=function(elms){return map(filter(elms,isValidHeader),headerTarget)},getAnchorTargets=function(elms){return map(filter(elms,isValidAnchor),anchorTarget)},getTargetElements=function(elm){var elms=select("h1,h2,h3,h4,h5,h6,a:not([href])",elm);return elms},hasTitle=function(target){return trim$1(target.title).length>0},find$5=function(elm){var elms=getTargetElements(elm);return filter(getHeaderTargets(elms).concat(getAnchorTargets(elms)),hasTitle)},LinkTargets={find:find$5},STORAGE_KEY="tinymce-url-history",HISTORY_LENGTH=5,isHttpUrl=function(url){return isString(url)&&/^https?/.test(url)},isArrayOfUrl=function(a){return isArray(a)&&a.length<=HISTORY_LENGTH&&forall(a,isHttpUrl)},isRecordOfUrlArray=function(r){return isObject(r)&&find$1(r,function(value){return!isArrayOfUrl(value)}).isNone()},getAllHistory=function(){var history,unparsedHistory=domGlobals.localStorage.getItem(STORAGE_KEY);if(null===unparsedHistory)return{};try{history=JSON.parse(unparsedHistory)}catch(e){if(e instanceof SyntaxError)return domGlobals.console.log("Local storage "+STORAGE_KEY+" was not valid JSON",e),{};throw e}return isRecordOfUrlArray(history)?history:(domGlobals.console.log("Local storage "+STORAGE_KEY+" was not valid format",history),{})},setAllHistory=function(history){if(!isRecordOfUrlArray(history))throw new Error("Bad format for history:\n"+JSON.stringify(history));domGlobals.localStorage.setItem(STORAGE_KEY,JSON.stringify(history))},getHistory=function(fileType){var history=getAllHistory();return Object.prototype.hasOwnProperty.call(history,fileType)?history[fileType]:[]},addToHistory=function(url,fileType){if(isHttpUrl(url)){var history=getAllHistory(),items=Object.prototype.hasOwnProperty.call(history,fileType)?history[fileType]:[],itemsWithoutUrl=filter(items,function(item){return item!==url});history[fileType]=[url].concat(itemsWithoutUrl).slice(0,HISTORY_LENGTH),setAllHistory(history)}},hasOwnProperty$2=Object.prototype.hasOwnProperty,isTruthy=function(value){return!!value},makeMap=function(value){return map$1(global$e.makeMap(value,/[, ]/),isTruthy)},getOpt=function(obj,key){return hasOwnProperty$2.call(obj,key)?Option.some(obj[key]):Option.none()},getTextSetting=function(settings,name,defaultValue){var value=getOpt(settings,name).getOr(defaultValue);return isString(value)?Option.some(value):Option.none()},getPicker=function(settings){return Option.some(settings.file_picker_callback).filter(isFunction)},getPickerTypes=function(settings){var optFileTypes=Option.some(settings.file_picker_types).filter(isTruthy),optLegacyTypes=Option.some(settings.file_browser_callback_types).filter(isTruthy),optTypes=optFileTypes.or(optLegacyTypes).map(makeMap);return getPicker(settings).fold(function(){return!1},function(_picker){return optTypes.fold(function(){return!0},function(types){return keys(types).length>0&&types})})},getPickerSetting=function(settings,filetype){var pickerTypes=getPickerTypes(settings);return isBoolean(pickerTypes)?pickerTypes?getPicker(settings):Option.none():pickerTypes[filetype]?getPicker(settings):Option.none()},getUrlPicker=function(editor,filetype){return getPickerSetting(editor.settings,filetype).map(function(picker){return function(entry){return Future.nu(function(completer){var handler=function(value,meta){if(!isString(value))throw new Error("Expected value to be string");if(void 0!==meta&&!isObject(meta))throw new Error("Expected meta to be a object");var r={value:value,meta:meta};completer(r)},meta=global$e.extend({filetype:filetype},Option.from(entry.meta).getOr({}));picker.call(editor,handler,entry.value,meta)})}})},getLinkInformation=function(editor){return!1===editor.settings.typeahead_urls?Option.none():Option.some({targets:LinkTargets.find(editor.getBody()),anchorTop:getTextSetting(editor.settings,"anchor_top","#top").getOrUndefined(),anchorBottom:getTextSetting(editor.settings,"anchor_bottom","#bottom").getOrUndefined()})},getValidationHandler=function(editor){var optValidator=Option.from(editor.settings.file_picker_validator_handler).filter(isFunction);return optValidator.orThunk(function(){return Option.from(editor.settings.filepicker_validator_handler).filter(isFunction)})},UrlInputBackstage=function(editor){return{getHistory:getHistory,addToHistory:addToHistory,getLinkInformation:function(){return getLinkInformation(editor)},getValidationHandler:function(){return getValidationHandler(editor)},getUrlPicker:function(filetype){return getUrlPicker(editor,filetype)}}},isDraggableModal$1=function(editor){return function(){return isDraggableModal(editor)}},DialogBackstage=function(editor){return{isDraggableModal:isDraggableModal$1(editor)}},init$8=function(sink,editor,lazyAnchorbar,lazyMoreButton){var backstage={shared:{providers:{icons:function(){return editor.ui.registry.getAll().icons},menuItems:function(){return editor.ui.registry.getAll().menuItems},translate:global$5.translate},interpreter:function(s){return interpretWithoutForm(s,backstage)},anchors:Anchors.getAnchors(editor,lazyAnchorbar,lazyMoreButton),getSink:function(){return Result.value(sink)}},urlinput:UrlInputBackstage(editor),styleselect:init$7(editor),colorinput:ColorInputBackstage(editor),dialog:DialogBackstage(editor)};return backstage},showContextToolbarEvent="contexttoolbar-show",schema$j=constant([strict$1("dom"),defaulted$1("shell",!0),field$1("toolbarBehaviours",[Replacing])]),enhanceGroups=function(detail){return{behaviours:derive$1([Replacing.config({})])}},parts$7=constant([optional({name:"groups",overrides:enhanceGroups})]),factory$9=function(detail,components,spec,_externals){var setGroups=function(toolbar,groups){getGroupContainer(toolbar).fold(function(){throw domGlobals.console.error("Toolbar was defined to not be a shell, but no groups container was specified in components"),new Error("Toolbar was defined to not be a shell, but no groups container was specified in components")},function(container){Replacing.set(container,groups)})},getGroupContainer=function(component){return detail.shell?Option.some(component):getPart(component,detail,"groups")},extra=detail.shell?{behaviours:[Replacing.config({})],components:[]}:{behaviours:[],components:components};return{uid:detail.uid,dom:detail.dom,components:extra.components,behaviours:augment(detail.toolbarBehaviours,extra.behaviours),apis:{setGroups:setGroups},domModification:{attributes:{role:"group"}}}},Toolbar=composite$1({name:"Toolbar",configFields:schema$j(),partFields:parts$7(),factory:factory$9,apis:{setGroups:function(apis,toolbar,groups){apis.setGroups(toolbar,groups)}}}),generate$6=function(xs,f){var init={len:0,list:[]},r=foldl(xs,function(b,a){var value=f(a,b.len);return value.fold(constant(b),function(v){return{len:v.finish(),list:b.list.concat([v])}})},init);return r.list},output$1=Immutable("within","extra","withinWidth"),apportion=function(units,total,len){var parray=generate$6(units,function(unit,current){var width=len(unit);return Option.some({element:constant(unit),start:constant(current),finish:constant(current+width),width:constant(width)})}),within=filter(parray,function(unit){return unit.finish()<=total}),withinWidth=foldr(within,function(acc,el){return acc+el.width()},0),extra=parray.slice(within.length);return{within:constant(within),extra:constant(extra),withinWidth:constant(withinWidth)}},toUnit=function(parray){return map(parray,function(unit){return unit.element()})},fitLast=function(within,extra,withinWidth){var fits=toUnit(within.concat(extra));return output$1(fits,[],withinWidth)},overflow=function(within,extra,overflower,withinWidth){var fits=toUnit(within).concat([overflower]);return output$1(fits,toUnit(extra),withinWidth)},fitAll=function(within,extra,withinWidth){return output$1(toUnit(within),[],withinWidth)},tryFit=function(total,units,len){var divide=apportion(units,total,len);return 0===divide.extra().length?Option.some(divide):Option.none()},partition$3=function(total,units,len,overflower){var divide=tryFit(total,units,len).getOrThunk(function(){return apportion(units,total-len(overflower),len)}),within=divide.within(),extra=divide.extra(),withinWidth=divide.withinWidth();return 1===extra.length&&extra[0].width()<=len(overflower)?fitLast(within,extra,withinWidth):extra.length>=1?overflow(within,extra,overflower,withinWidth):fitAll(within,extra,withinWidth)},setStoredGroups=function(toolbar,storedGroups){var bGroups=map(storedGroups,function(g){return premade$1(g)});Toolbar.setGroups(toolbar,bGroups)},findFocusedComp=function(overflow,overflowButton){return overflow.bind(function(overf){return search$1(overf.element()).bind(function(focusedElm){return overf.getSystem().getByDom(focusedElm).toOption()})}).orThunk(function(){return overflowButton.filter(Focusing.isFocused)})},refresh=function(toolbar,detail,overflow,isOpen){var primary=getPartOrDie(toolbar,detail,"primary"),overflowButton=getPart(toolbar,detail,"overflow-button"),overflowGroup=Coupling.getCoupled(toolbar,"overflowGroup");set$2(primary.element(),"visibility","hidden");var focusedComp=findFocusedComp(overflow,overflowButton);overflow.each(function(overf){Toolbar.setGroups(overf,[])});var groups=detail.builtGroups.get();setStoredGroups(primary,groups.concat([overflowGroup]));var total=get$7(primary.element()),overflows=partition$3(total,groups,function(comp){return get$7(comp.element())},overflowGroup);0===overflows.extra().length?(Replacing.remove(primary,overflowGroup),overflow.each(function(overf){Toolbar.setGroups(overf,[])})):(setStoredGroups(primary,overflows.within()),overflow.each(function(overf){setStoredGroups(overf,overflows.extra())})),remove$6(primary.element(),"visibility"),reflow(primary.element()),overflow.each(function(overf){overflowButton.each(function(button){return Toggling.set(button,isOpen(overf))}),focusedComp.each(Focusing.focus)})},schema$k=constant([strict$1("items"),markers(["itemSelector"]),field$1("tgroupBehaviours",[Keying])]),parts$8=constant([group({name:"items",unit:"item"})]),factory$a=function(detail,components,spec,_externals){return{uid:detail.uid,dom:detail.dom,components:components,behaviours:augment(detail.tgroupBehaviours,[Keying.config({mode:"flow",selector:detail.markers.itemSelector})]),domModification:{attributes:{role:"toolbar"}}}},ToolbarGroup=composite$1({name:"ToolbarGroup",configFields:schema$k(),partFields:parts$8(),factory:factory$a}),schema$l=constant([field$1("splitToolbarBehaviours",[]),state$1("builtGroups",function(){return Cell([])})]),spec=function(detail,components,spec,externals,extras){var toolbarToggleEvent="alloy.toolbar.toggle",doSetGroups=function(toolbar,groups){var built=map(groups,toolbar.getSystem().build);detail.builtGroups.set(built)},setGroups=function(toolbar,groups){doSetGroups(toolbar,groups),extras.refresh(toolbar,detail)},getMoreButton=function(toolbar){return getPart(toolbar,detail,"overflow-button")},getOverflow=function(toolbar){return extras.getOverflow(toolbar)};return{uid:detail.uid,dom:detail.dom,components:components,behaviours:augment(detail.splitToolbarBehaviours,[Coupling.config({others:__assign({},extras.coupling,{overflowGroup:function(toolbar){return ToolbarGroup.sketch(__assign({},externals["overflow-group"](),{items:[Button.sketch(__assign({},externals["overflow-button"](),{action:function(_button){emit(toolbar,toolbarToggleEvent)}}))]}))}})}),config("toolbar-toggle-events",[run(toolbarToggleEvent,function(toolbar){extras.toggleToolbar(toolbar,detail,externals)})])]),apis:{setGroups:setGroups,refresh:function(toolbar){extras.refresh(toolbar,detail)},getMoreButton:function(toolbar){return getMoreButton(toolbar)},getOverflow:function(toolbar){return getOverflow(toolbar)},toggle:function(toolbar){extras.toggleToolbar(toolbar,detail,externals)}},domModification:{attributes:{role:"group"}}}},schema$m=constant([markers(["overflowToggledClass"]),strict$1("getAnchor"),strict$1("lazySink")].concat(schema$l())),parts$9=constant([required({factory:Toolbar,schema:schema$j(),name:"primary"}),external$1({factory:Toolbar,schema:schema$j(),name:"overflow",overrides:function(detail){return{toolbarBehaviours:derive$1([Keying.config({mode:"cyclic",onEscape:function(comp){return getPart(comp,detail,"overflow-button").each(Focusing.focus),Option.none()}})])}}}),external$1({name:"overflow-button",overrides:function(detail){return{dom:{attributes:{"aria-haspopup":"true"}},buttonBehaviours:derive$1([Toggling.config({toggleClass:detail.markers.overflowToggledClass,aria:{mode:"expanded"},toggleOnExecute:!1})])}}}),external$1({name:"overflow-group"})]),toggleToolbar=function(toolbar,detail,externals){var sandbox=Coupling.getCoupled(toolbar,"sandbox");Sandboxing.isOpen(sandbox)?Sandboxing.close(sandbox):Sandboxing.open(sandbox,externals.overflow())},isOpen$1=function(over){return over.getSystem().isConnected()},refresh$1=function(toolbar,detail){var overflow=Sandboxing.getState(Coupling.getCoupled(toolbar,"sandbox"));refresh(toolbar,detail,overflow,isOpen$1),overflow.each(function(overf){var sink=detail.lazySink(toolbar).getOrDie(),anchor=detail.getAnchor(toolbar);Positioning.position(sink,anchor,overf)})},makeSandbox$1=function(toolbar,detail){var ariaOwner=manager(),onOpen=function(sandbox,overf){refresh$1(toolbar,detail),getPart(toolbar,detail,"overflow-button").each(function(button){Toggling.on(button),ariaOwner.link(button.element())}),Keying.focusIn(overf)},onClose=function(){getPart(toolbar,detail,"overflow-button").each(function(button){Toggling.off(button),Focusing.focus(button),ariaOwner.unlink(button.element())})};return{dom:{tag:"div",attributes:{id:ariaOwner.id()}},behaviours:derive$1([Keying.config({mode:"special",onEscape:function(comp){return Sandboxing.close(comp),Option.some(!0)}}),Sandboxing.config({onOpen:onOpen,onClose:onClose,isPartOf:function(container,data,queryElem){return isPartOf(data,queryElem)||isPartOf(toolbar,queryElem)},getAttachPoint:function(){return detail.lazySink(toolbar).getOrDie()}})])}},factory$b=function(detail,components,spec$1,externals){return spec(detail,components,spec$1,externals,{refresh:refresh$1,toggleToolbar:toggleToolbar,getOverflow:function(toolbar){return Sandboxing.getState(Coupling.getCoupled(toolbar,"sandbox"))},coupling:{sandbox:function(toolbar){return makeSandbox$1(toolbar,detail)}}})},SplitFloatingToolbar=composite$1({name:"SplitFloatingToolbar",configFields:schema$m(),partFields:parts$9(),factory:factory$b,apis:{setGroups:function(apis,toolbar,groups){apis.setGroups(toolbar,groups)},refresh:function(apis,toolbar){apis.refresh(toolbar)},getMoreButton:function(apis,toolbar){return apis.getMoreButton(toolbar)},getOverflow:function(apis,toolbar){return apis.getOverflow(toolbar)},toggle:function(apis,toolbar){apis.toggle(toolbar)}}}),getAnimationRoot=function(component,slideConfig){return slideConfig.getAnimationRoot.fold(function(){return component.element()},function(get){return get(component)})},getDimensionProperty=function(slideConfig){return slideConfig.dimension.property},getDimension=function(slideConfig,elem){return slideConfig.dimension.getDimension(elem)},disableTransitions=function(component,slideConfig){var root=getAnimationRoot(component,slideConfig);remove$5(root,[slideConfig.shrinkingClass,slideConfig.growingClass])},setShrunk=function(component,slideConfig){remove$4(component.element(),slideConfig.openClass),add$2(component.element(),slideConfig.closedClass),set$2(component.element(),getDimensionProperty(slideConfig),"0px"),reflow(component.element())},setGrown=function(component,slideConfig){remove$4(component.element(),slideConfig.closedClass),add$2(component.element(),slideConfig.openClass),remove$6(component.element(),getDimensionProperty(slideConfig))},doImmediateShrink=function(component,slideConfig,slideState,_calculatedSize){slideState.setCollapsed(),set$2(component.element(),getDimensionProperty(slideConfig),getDimension(slideConfig,component.element())),reflow(component.element()),disableTransitions(component,slideConfig),setShrunk(component,slideConfig),slideConfig.onStartShrink(component),slideConfig.onShrunk(component)},doStartShrink=function(component,slideConfig,slideState,calculatedSize){var size=calculatedSize.getOrThunk(function(){return getDimension(slideConfig,component.element())});slideState.setCollapsed(),set$2(component.element(),getDimensionProperty(slideConfig),size),reflow(component.element());var root=getAnimationRoot(component,slideConfig);remove$4(root,slideConfig.growingClass),add$2(root,slideConfig.shrinkingClass),setShrunk(component,slideConfig),slideConfig.onStartShrink(component)},doStartSmartShrink=function(component,slideConfig,slideState){var size=getDimension(slideConfig,component.element()),shrinker="0px"===size?doImmediateShrink:doStartShrink;shrinker(component,slideConfig,slideState,Option.some(size))},doStartGrow=function(component,slideConfig,slideState){var root=getAnimationRoot(component,slideConfig),wasShrinking=has$2(root,slideConfig.shrinkingClass),beforeSize=getDimension(slideConfig,component.element());setGrown(component,slideConfig);var fullSize=getDimension(slideConfig,component.element()),startPartialGrow=function(){set$2(component.element(),getDimensionProperty(slideConfig),beforeSize),reflow(component.element())},startCompleteGrow=function(){setShrunk(component,slideConfig)},setStartSize=wasShrinking?startPartialGrow:startCompleteGrow;setStartSize(),remove$4(root,slideConfig.shrinkingClass),add$2(root,slideConfig.growingClass),setGrown(component,slideConfig),set$2(component.element(),getDimensionProperty(slideConfig),fullSize),slideState.setExpanded(),slideConfig.onStartGrow(component)},refresh$2=function(component,slideConfig,slideState){if(slideState.isExpanded()){remove$6(component.element(),getDimensionProperty(slideConfig));var fullSize=getDimension(slideConfig,component.element());set$2(component.element(),getDimensionProperty(slideConfig),fullSize)}},grow=function(component,slideConfig,slideState){slideState.isExpanded()||doStartGrow(component,slideConfig,slideState)},shrink=function(component,slideConfig,slideState){slideState.isExpanded()&&doStartSmartShrink(component,slideConfig,slideState)},immediateShrink=function(component,slideConfig,slideState){slideState.isExpanded()&&doImmediateShrink(component,slideConfig,slideState)},hasGrown=function(component,slideConfig,slideState){return slideState.isExpanded()},hasShrunk=function(component,slideConfig,slideState){return slideState.isCollapsed()},isGrowing=function(component,slideConfig,slideState){var root=getAnimationRoot(component,slideConfig);return!0===has$2(root,slideConfig.growingClass)},isShrinking=function(component,slideConfig,slideState){var root=getAnimationRoot(component,slideConfig);return!0===has$2(root,slideConfig.shrinkingClass)},isTransitioning=function(component,slideConfig,slideState){return!0===isGrowing(component,slideConfig)||!0===isShrinking(component,slideConfig)},toggleGrow=function(component,slideConfig,slideState){var f=slideState.isExpanded()?doStartSmartShrink:doStartGrow;f(component,slideConfig,slideState)},SlidingApis=Object.freeze({refresh:refresh$2,grow:grow,shrink:shrink,immediateShrink:immediateShrink,hasGrown:hasGrown,hasShrunk:hasShrunk,isGrowing:isGrowing,isShrinking:isShrinking,isTransitioning:isTransitioning,toggleGrow:toggleGrow,disableTransitions:disableTransitions}),exhibit$6=function(base,slideConfig){var expanded=slideConfig.expanded;return nu$6(expanded?{classes:[slideConfig.openClass],styles:{}}:{classes:[slideConfig.closedClass],styles:wrap$1(slideConfig.dimension.property,"0px")})},events$d=function(slideConfig,slideState){return derive([runOnSource(transitionend(),function(component,simulatedEvent){var raw=simulatedEvent.event().raw();if(raw.propertyName===slideConfig.dimension.property){disableTransitions(component,slideConfig),slideState.isExpanded()&&remove$6(component.element(),slideConfig.dimension.property);var notify=slideState.isExpanded()?slideConfig.onGrown:slideConfig.onShrunk;notify(component)}})])},ActiveSliding=Object.freeze({exhibit:exhibit$6,events:events$d}),SlidingSchema=[strict$1("closedClass"),strict$1("openClass"),strict$1("shrinkingClass"),strict$1("growingClass"),option("getAnimationRoot"),onHandler("onShrunk"),onHandler("onStartShrink"),onHandler("onGrown"),onHandler("onStartGrow"),defaulted$1("expanded",!1),strictOf("dimension",choose$1("property",{width:[output("property","width"),output("getDimension",function(elem){return get$7(elem)+"px"})],height:[output("property","height"),output("getDimension",function(elem){return get$6(elem)+"px"})]}))],init$9=function(spec){var state=Cell(spec.expanded),readState=function(){return"expanded: "+state.get()};return nu$5({isExpanded:function(){return!0===state.get()},isCollapsed:function(){return!1===state.get()},setCollapsed:curry(state.set,!1),setExpanded:curry(state.set,!0),readState:readState})},SlidingState=Object.freeze({init:init$9}),Sliding=create$1({fields:SlidingSchema,name:"sliding",active:ActiveSliding,apis:SlidingApis,state:SlidingState}),schema$n=constant([markers(["closedClass","openClass","shrinkingClass","growingClass","overflowToggledClass"])].concat(schema$l())),parts$a=constant([required({factory:Toolbar,schema:schema$j(),name:"primary"}),required({factory:Toolbar,schema:schema$j(),name:"overflow",overrides:function(detail){return{toolbarBehaviours:derive$1([Sliding.config({dimension:{property:"height"},closedClass:detail.markers.closedClass,openClass:detail.markers.openClass,shrinkingClass:detail.markers.shrinkingClass,growingClass:detail.markers.growingClass,onShrunk:function(comp){getPart(comp,detail,"overflow-button").each(function(button){Toggling.off(button),Focusing.focus(button)})},onGrown:function(comp){Keying.focusIn(comp)},onStartGrow:function(comp){getPart(comp,detail,"overflow-button").each(Toggling.on)}}),Keying.config({mode:"acyclic",onEscape:function(comp){return getPart(comp,detail,"overflow-button").each(Focusing.focus),Option.some(!0)}})])}}}),external$1({name:"overflow-button",overrides:function(detail){return{buttonBehaviours:derive$1([Toggling.config({toggleClass:detail.markers.overflowToggledClass,aria:{mode:"pressed"},toggleOnExecute:!1})])}}}),external$1({name:"overflow-group"})]),toggleToolbar$1=function(toolbar,detail){getPart(toolbar,detail,"overflow").each(function(overf){refresh$3(toolbar,detail),Sliding.toggleGrow(overf)})},isOpen$2=function(overf){return Sliding.hasGrown(overf)},refresh$3=function(toolbar,detail){var overflow=getPart(toolbar,detail,"overflow");refresh(toolbar,detail,overflow,isOpen$2),overflow.each(Sliding.refresh)},factory$c=function(detail,components,spec$1,externals){return spec(detail,components,spec$1,externals,{refresh:refresh$3,toggleToolbar:toggleToolbar$1,getOverflow:function(toolbar){return getPart(toolbar,detail,"overflow")},coupling:{}})},SplitSlidingToolbar=composite$1({name:"SplitSlidingToolbar",configFields:schema$n(),partFields:parts$a(),factory:factory$c,apis:{setGroups:function(apis,toolbar,groups){apis.setGroups(toolbar,groups)},refresh:function(apis,toolbar){apis.refresh(toolbar)},getMoreButton:function(apis,toolbar){return apis.getMoreButton(toolbar)},getOverflow:function(apis,toolbar){return apis.getOverflow(toolbar)},toggle:function(apis,toolbar){apis.toggle(toolbar)}}}),ReadOnlyChannel="silver.readonly",ReadOnlyDataSchema=objOf([strictBoolean("readonly")]),setDisabledAll=function(element,state){all("*",element.element()).forEach(function(elm){element.getSystem().getByDom(elm).each(function(comp){comp.hasConfigured(Disabling)&&Disabling.set(comp,state)})})},broadcastReadonly=function(uiComponents,readonly){var outerContainer=uiComponents.outerContainer,target=outerContainer.element();readonly&&(uiComponents.mothership.broadcastOn([dismissPopups()],{target:target}),uiComponents.uiMothership.broadcastOn([dismissPopups()],{target:target})),uiComponents.mothership.broadcastOn([ReadOnlyChannel],{readonly:readonly}),uiComponents.uiMothership.broadcastOn([ReadOnlyChannel],{readonly:readonly})},toggleToReadOnly=function(uiComponents,readonly){var outerContainer=uiComponents.outerContainer;broadcastReadonly(uiComponents,readonly),all("*",outerContainer.element()).forEach(function(elm){outerContainer.getSystem().getByDom(elm).each(function(comp){comp.hasConfigured(Disabling)&&Disabling.set(comp,readonly)})})},setupReadonlyModeSwitch=function(editor,uiComponents){editor.on("init",function(){editor.readonly&&toggleToReadOnly(uiComponents,!0)}),editor.on("SwitchMode",function(){return toggleToReadOnly(uiComponents,editor.readonly)}),isReadOnly(editor)&&editor.setMode("readonly")},createReadonlyReceivingForOverflow=function(getOverflow){
var _a;return Receiving.config({channels:(_a={},_a[ReadOnlyChannel]={schema:ReadOnlyDataSchema,onReceive:function(comp,data){getOverflow(comp).each(function(toolbar){setDisabledAll(toolbar,data.readonly)})}},_a)})},renderToolbarGroupCommon=function(toolbarGroup){var attributes=toolbarGroup.title.fold(function(){return{}},function(title){return{attributes:{title:title}}});return{dom:__assign({tag:"div",classes:["tox-toolbar__group"]},attributes),components:[ToolbarGroup.parts().items({})],items:toolbarGroup.items,markers:{itemSelector:"*:not(.tox-split-button) > .tox-tbtn:not([disabled]), .tox-split-button:not([disabled]), .tox-toolbar-nav-js:not([disabled])"},tgroupBehaviours:derive$1([Tabstopping.config({}),Focusing.config({})])}},renderToolbarGroup=function(toolbarGroup){return ToolbarGroup.sketch(renderToolbarGroupCommon(toolbarGroup))},getToolbarbehaviours=function(toolbarSpec,modeName,getOverflow){var onAttached=runOnAttached(function(component){var groups=map(toolbarSpec.initGroups,renderToolbarGroup);Toolbar.setGroups(component,groups)});return derive$1([Keying.config({mode:modeName,onEscape:toolbarSpec.onEscape,selector:".tox-toolbar__group"}),config("toolbar-events",[onAttached]),createReadonlyReceivingForOverflow(getOverflow)])},renderMoreToolbarCommon=function(toolbarSpec,getOverflow){var modeName=toolbarSpec.cyclicKeying?"cyclic":"acyclic";return{uid:toolbarSpec.uid,dom:{tag:"div",classes:["tox-toolbar-overlord"]},parts:{"overflow-group":renderToolbarGroupCommon({title:Option.none(),items:[]}),"overflow-button":renderIconButtonSpec({name:"more",icon:Option.some("more-drawer"),disabled:!1,tooltip:Option.some("More..."),primary:!1,borderless:!1},Option.none(),toolbarSpec.backstage.shared.providers)},splitToolbarBehaviours:getToolbarbehaviours(toolbarSpec,modeName,getOverflow)}},renderFloatingMoreToolbar=function(toolbarSpec){var baseSpec=renderMoreToolbarCommon(toolbarSpec,SplitFloatingToolbar.getOverflow),primary=SplitFloatingToolbar.parts().primary({dom:{tag:"div",classes:["tox-toolbar__primary"]}});return SplitFloatingToolbar.sketch(__assign({},baseSpec,{lazySink:toolbarSpec.getSink,getAnchor:function(){return toolbarSpec.backstage.shared.anchors.toolbarOverflow()},parts:__assign({},baseSpec.parts,{overflow:{dom:{tag:"div",classes:["tox-toolbar__overflow"]}}}),components:[primary],markers:{overflowToggledClass:"tox-tbtn--enabled"}}))},renderSlidingMoreToolbar=function(toolbarSpec){var primary=SplitSlidingToolbar.parts().primary({dom:{tag:"div",classes:["tox-toolbar__primary"]}}),overflow=SplitSlidingToolbar.parts().overflow({dom:{tag:"div",classes:["tox-toolbar__overflow"]}}),baseSpec=renderMoreToolbarCommon(toolbarSpec,SplitSlidingToolbar.getOverflow);return SplitSlidingToolbar.sketch(__assign({},baseSpec,{components:[primary,overflow],markers:{openClass:"tox-toolbar__overflow--open",closedClass:"tox-toolbar__overflow--closed",growingClass:"tox-toolbar__overflow--growing",shrinkingClass:"tox-toolbar__overflow--shrinking",overflowToggledClass:"tox-tbtn--enabled"}}))},renderToolbar=function(toolbarSpec){var modeName=toolbarSpec.cyclicKeying?"cyclic":"acyclic";return Toolbar.sketch({uid:toolbarSpec.uid,dom:{tag:"div",classes:["tox-toolbar"]},components:[Toolbar.parts().groups({})],toolbarBehaviours:getToolbarbehaviours(toolbarSpec,modeName,constant(Option.none()))})},baseToolbarButtonFields=[defaultedBoolean("disabled",!1),optionString("tooltip"),optionString("icon"),optionString("text"),defaultedFunction("onSetup",function(){return noop})],toolbarButtonSchema=objOf([strictString("type"),strictFunction("onAction")].concat(baseToolbarButtonFields)),createToolbarButton=function(spec){return asRaw("toolbarbutton",toolbarButtonSchema,spec)},baseMenuButtonFields=[optionString("text"),optionString("tooltip"),optionString("icon"),strictFunction("fetch"),defaultedFunction("onSetup",function(){return noop})],MenuButtonSchema=objOf([strictString("type")].concat(baseMenuButtonFields)),createMenuButton=function(spec){return asRaw("menubutton",MenuButtonSchema,spec)},splitButtonSchema=objOf([strictString("type"),optionString("tooltip"),optionString("icon"),optionString("text"),optionFunction("select"),strictFunction("fetch"),defaultedFunction("onSetup",function(){return noop}),defaultedStringEnum("presets","normal",["normal","color","listpreview"]),defaulted$1("columns",1),strictFunction("onAction"),strictFunction("onItemAction")]),createSplitButton=function(spec){return asRaw("SplitButton",splitButtonSchema,spec)},baseToolbarToggleButtonFields=[defaultedBoolean("active",!1)].concat(baseToolbarButtonFields),toggleButtonSchema=objOf(baseToolbarToggleButtonFields.concat([strictString("type"),strictFunction("onAction")])),createToggleButton=function(spec){return asRaw("ToggleButton",toggleButtonSchema,spec)},contextBarFields=[defaultedFunction("predicate",function(){return!1}),defaultedStringEnum("scope","node",["node","editor"]),defaultedStringEnum("position","selection",["node","selection","line"])],contextButtonFields=baseToolbarButtonFields.concat([defaulted$1("type","contextformbutton"),defaulted$1("primary",!1),strictFunction("onAction"),state$1("original",identity)]),contextToggleButtonFields=baseToolbarToggleButtonFields.concat([defaulted$1("type","contextformbutton"),defaulted$1("primary",!1),strictFunction("onAction"),state$1("original",identity)]),launchButtonFields=baseToolbarButtonFields.concat([defaulted$1("type","contextformbutton")]),launchToggleButtonFields=baseToolbarToggleButtonFields.concat([defaulted$1("type","contextformtogglebutton")]),toggleOrNormal=choose$1("type",{contextformbutton:contextButtonFields,contextformtogglebutton:contextToggleButtonFields}),contextFormSchema=objOf([defaulted$1("type","contextform"),defaultedFunction("initValue",function(){return""}),optionString("label"),strictArrayOf("commands",toggleOrNormal),optionOf("launch",choose$1("type",{contextformbutton:launchButtonFields,contextformtogglebutton:launchToggleButtonFields}))].concat(contextBarFields)),contextToolbarSchema=objOf([defaulted$1("type","contexttoolbar"),strictString("items")].concat(contextBarFields)),createContextToolbar=function(spec){return asRaw("ContextToolbar",contextToolbarSchema,spec)},createContextForm=function(spec){return asRaw("ContextForm",contextFormSchema,spec)},getState$2=function(component,replaceConfig,reflectState){return reflectState},ReflectingApis=Object.freeze({getState:getState$2}),events$e=function(reflectingConfig,reflectingState){var update=function(component,data){reflectingConfig.updateState.each(function(updateState){var newState=updateState(component,data);reflectingState.set(newState)}),reflectingConfig.renderComponents.each(function(renderComponents){var newComponents=renderComponents(data,reflectingState.get());detachChildren(component),each(newComponents,function(c){attach(component,component.getSystem().build(c))})})};return derive([run(receive(),function(component,message){var channel=reflectingConfig.channel;contains(message.channels(),channel)&&update(component,message.data())}),runOnAttached(function(comp,se){reflectingConfig.initialData.each(function(rawData){update(comp,rawData)})})])},ActiveReflecting=Object.freeze({events:events$e}),init$a=function(spec){var cell=Cell(Option.none()),set=function(optS){return cell.set(optS)},clear=function(){return cell.set(Option.none())},get=function(){return cell.get()},readState=function(){return cell.get().fold(function(){return"none"},function(x){return x})};return{readState:readState,get:get,set:set,clear:clear}},ReflectingState=Object.freeze({init:init$a}),ReflectingSchema=[strict$1("channel"),option("renderComponents"),option("updateState"),option("initialData")],Reflecting=create$1({fields:ReflectingSchema,name:"reflecting",active:ActiveReflecting,apis:ReflectingApis,state:ReflectingState}),schema$o=constant([strict$1("toggleClass"),strict$1("fetch"),onStrictHandler("onExecute"),defaulted$1("getHotspot",Option.some),defaulted$1("getAnchorOverrides",constant({})),defaulted$1("layouts",Option.none()),onStrictHandler("onItemExecute"),option("lazySink"),strict$1("dom"),onHandler("onOpen"),field$1("splitDropdownBehaviours",[Coupling,Keying,Focusing]),defaulted$1("matchWidth",!1),defaulted$1("useMinWidth",!1),defaulted$1("eventOrder",{}),option("role")].concat(sandboxFields())),arrowPart=required({factory:Button,schema:[strict$1("dom")],name:"arrow",defaults:function(detail){return{buttonBehaviours:derive$1([Focusing.revoke()])}},overrides:function(detail){return{dom:{tag:"span",attributes:{role:"presentation"}},action:function(arrow){arrow.getSystem().getByUid(detail.uid).each(emitExecute)},buttonBehaviours:derive$1([Toggling.config({toggleOnExecute:!1,toggleClass:detail.toggleClass})])}}}),buttonPart=required({factory:Button,schema:[strict$1("dom")],name:"button",defaults:function(detail){return{buttonBehaviours:derive$1([Focusing.revoke()])}},overrides:function(detail){return{dom:{tag:"span",attributes:{role:"presentation"}},action:function(btn){btn.getSystem().getByUid(detail.uid).each(function(splitDropdown){detail.onExecute(splitDropdown,btn)})}}}}),parts$b=constant([arrowPart,buttonPart,optional({factory:{sketch:function(spec){return{uid:spec.uid,dom:{tag:"span",styles:{display:"none"},attributes:{"aria-hidden":"true"},innerHtml:spec.text}}}},schema:[strict$1("text")],name:"aria-descriptor"}),external$1({schema:[tieredMenuMarkers()],name:"menu",defaults:function(detail){return{onExecute:function(tmenu,item){tmenu.getSystem().getByUid(detail.uid).each(function(splitDropdown){detail.onItemExecute(splitDropdown,tmenu,item)})}}}}),partType()]),factory$d=function(detail,components,spec,externals){var switchToMenu=function(sandbox){Composing.getCurrent(sandbox).each(function(current){Highlighting.highlightFirst(current),Keying.focusIn(current)})},action=function(component){var onOpenSync=switchToMenu;togglePopup(detail,function(x){return x},component,externals,onOpenSync,HighlightOnOpen.HighlightFirst).get(noop)},openMenu=function(comp){return action(comp),Option.some(!0)},executeOnButton=function(comp){var button=getPartOrDie(comp,detail,"button");return emitExecute(button),Option.some(!0)},buttonEvents=merge(derive([runOnAttached(function(component,simulatedEvent){var ariaDescriptor=getPart(component,detail,"aria-descriptor");ariaDescriptor.each(function(descriptor){var descriptorId=generate$1("aria");set$1(descriptor.element(),"id",descriptorId),set$1(component.element(),"aria-describedby",descriptorId)})})]),events$7(Option.some(action)));return{uid:detail.uid,dom:detail.dom,components:components,eventOrder:__assign({},detail.eventOrder,{"alloy.execute":["disabling","toggling","alloy.base.behaviour"]}),events:buttonEvents,behaviours:augment(detail.splitDropdownBehaviours,[Coupling.config({others:{sandbox:function(hotspot){var arrow=getPartOrDie(hotspot,detail,"arrow"),extras={onOpen:function(){Toggling.on(arrow),Toggling.on(hotspot)},onClose:function(){Toggling.off(arrow),Toggling.off(hotspot)}};return makeSandbox(detail,hotspot,extras)}}}),Keying.config({mode:"special",onSpace:executeOnButton,onEnter:executeOnButton,onDown:openMenu}),Focusing.config({}),Toggling.config({toggleOnExecute:!1,aria:{mode:"expanded"}})]),domModification:{attributes:{role:detail.role.getOr("button"),"aria-haspopup":!0}}}},SplitDropdown=composite$1({name:"SplitDropdown",configFields:schema$o(),partFields:parts$b(),factory:factory$d}),getButtonApi=function(component){return{isDisabled:function(){return Disabling.isDisabled(component)},setDisabled:function(state){return Disabling.set(component,state)}}},getToggleApi=function(component){return{setActive:function(state){Toggling.set(component,state)},isActive:function(){return Toggling.isOn(component)},isDisabled:function(){return Disabling.isDisabled(component)},setDisabled:function(state){return Disabling.set(component,state)}}},getTooltipAttributes=function(tooltip,providersBackstage){return tooltip.map(function(tooltip){return{"aria-label":providersBackstage.translate(tooltip),title:providersBackstage.translate(tooltip)}}).getOr({})},focusButtonEvent=generate$1("focus-button"),rtlIcon$1=["checklist","ordered-list"],rtlTransform$1=["indent","outdent","table-insert-column-after","table-insert-column-before","unordered-list"],renderCommonStructure=function(icon,text,tooltip,receiver,behaviours,providersBackstage){var _a,getIconName=function(iconName){return global$5.isRtl()&&contains(rtlIcon$1,iconName)?iconName+"-rtl":iconName},needsRtlClass=global$5.isRtl()&&icon.exists(function(name){return contains(rtlTransform$1,name)});return{dom:{tag:"button",classes:["tox-tbtn"].concat(text.isSome()?["tox-tbtn--select"]:[]).concat(needsRtlClass?["tox-tbtn__icon-rtl"]:[]),attributes:getTooltipAttributes(tooltip,providersBackstage)},components:componentRenderPipeline([icon.map(function(iconName){return renderIconFromPack(getIconName(iconName),providersBackstage.icons)}),text.map(function(text){return renderLabel$1(text,"tox-tbtn",providersBackstage)})]),eventOrder:(_a={},_a[mousedown()]=["focusing","alloy.base.behaviour","common-button-display-events"],_a),buttonBehaviours:derive$1([config("common-button-display-events",[run(mousedown(),function(button,se){se.event().prevent(),emit(button,focusButtonEvent)})])].concat(receiver.map(function(r){return Reflecting.config({channel:r,initialData:{icon:icon,text:text},renderComponents:function(data,_state){return componentRenderPipeline([data.icon.map(function(iconName){return renderIconFromPack(getIconName(iconName),providersBackstage.icons)}),data.text.map(function(text){return renderLabel$1(text,"tox-tbtn",providersBackstage)})])}})}).toArray()).concat(behaviours.getOr([])))}},renderCommonToolbarButton=function(spec,specialisation,providersBackstage){var editorOffCell=Cell(noop),structure=renderCommonStructure(spec.icon,spec.text,spec.tooltip,Option.none(),Option.none(),providersBackstage);return Button.sketch({dom:structure.dom,components:structure.components,eventOrder:toolbarButtonEventOrder,buttonBehaviours:derive$1([config("toolbar-button-events",[onToolbarButtonExecute({onAction:spec.onAction,getApi:specialisation.getApi}),onControlAttached(specialisation,editorOffCell),onControlDetached(specialisation,editorOffCell)]),DisablingConfigs.toolbarButton(spec.disabled)].concat(specialisation.toolbarButtonBehaviours))})},renderToolbarButton=function(spec,providersBackstage){return renderToolbarButtonWith(spec,providersBackstage,[])},renderToolbarButtonWith=function(spec,providersBackstage,bonusEvents){return renderCommonToolbarButton(spec,{toolbarButtonBehaviours:[].concat(bonusEvents.length>0?[config("toolbarButtonWith",bonusEvents)]:[]),getApi:getButtonApi,onSetup:spec.onSetup},providersBackstage)},renderToolbarToggleButton=function(spec,providersBackstage){return renderToolbarToggleButtonWith(spec,providersBackstage,[])},renderToolbarToggleButtonWith=function(spec,providersBackstage,bonusEvents){return deepMerge(renderCommonToolbarButton(spec,{toolbarButtonBehaviours:[Replacing.config({}),Toggling.config({toggleClass:"tox-tbtn--enabled",aria:{mode:"pressed"},toggleOnExecute:!1})].concat(bonusEvents.length>0?[config("toolbarToggleButtonWith",bonusEvents)]:[]),getApi:getToggleApi,onSetup:spec.onSetup},providersBackstage))},fetchChoices=function(getApi,spec,providersBackstage){return function(comp){return Future.nu(function(callback){return spec.fetch(callback)}).map(function(items){return Option.from(createTieredDataFrom(deepMerge(createPartialChoiceMenu(generate$1("menu-value"),items,function(value){spec.onItemAction(getApi(comp),value)},spec.columns,spec.presets,ItemResponse$1.CLOSE_ON_EXECUTE,spec.select.getOr(function(){return!1}),providersBackstage),{movement:deriveMenuMovement(spec.columns,spec.presets),menuBehaviours:SimpleBehaviours.unnamedEvents("auto"!==spec.columns?[]:[runOnAttached(function(comp,se){detectSize(comp,4,classForPreset(spec.presets)).each(function(_a){var numRows=_a.numRows,numColumns=_a.numColumns;Keying.setGridSize(comp,numRows,numColumns)})})])})))})}},renderSplitButton=function(spec,sharedBackstage){var _a,displayChannel=generate$1("channel-update-split-dropdown-display"),getApi=function(comp){return{isDisabled:function(){return Disabling.isDisabled(comp)},setDisabled:function(state){return Disabling.set(comp,state)},setIconFill:function(id,value){descendant$1(comp.element(),'svg path[id="'+id+'"], rect[id="'+id+'"]').each(function(underlinePath){set$1(underlinePath,"fill",value)})},setIconStroke:function(id,value){descendant$1(comp.element(),'svg path[id="'+id+'"], rect[id="'+id+'"]').each(function(underlinePath){set$1(underlinePath,"stroke",value)})},setActive:function(state){set$1(comp.element(),"aria-pressed",state),descendant$1(comp.element(),"span").each(function(button){comp.getSystem().getByDom(button).each(function(buttonComp){return Toggling.set(buttonComp,state)})})},isActive:function(){return descendant$1(comp.element(),"span").exists(function(button){return comp.getSystem().getByDom(button).exists(Toggling.isOn)})}}},editorOffCell=Cell(noop),specialisation={getApi:getApi,onSetup:spec.onSetup};return SplitDropdown.sketch({dom:{tag:"div",classes:["tox-split-button"],attributes:merge({"aria-pressed":!1},getTooltipAttributes(spec.tooltip,sharedBackstage.providers))},onExecute:function(button){spec.onAction(getApi(button))},onItemExecute:function(a,b,c){},splitDropdownBehaviours:derive$1([DisablingConfigs.splitButton(!1),config("split-dropdown-events",[run(focusButtonEvent,Focusing.focus),onControlAttached(specialisation,editorOffCell),onControlDetached(specialisation,editorOffCell)])]),eventOrder:(_a={},_a[attachedToDom()]=["alloy.base.behaviour","split-dropdown-events"],_a),toggleClass:"tox-tbtn--enabled",lazySink:sharedBackstage.getSink,fetch:fetchChoices(getApi,spec,sharedBackstage.providers),parts:{menu:part(!1,spec.columns,spec.presets)},components:[SplitDropdown.parts().button(renderCommonStructure(spec.icon,spec.text,Option.none(),Option.some(displayChannel),Option.some([Toggling.config({toggleClass:"tox-tbtn--enabled",toggleOnExecute:!1})]),sharedBackstage.providers)),SplitDropdown.parts().arrow({dom:{tag:"button",classes:["tox-tbtn","tox-split-button__chevron"],innerHtml:get$c("chevron-down",sharedBackstage.providers.icons)}}),SplitDropdown.parts()["aria-descriptor"]({text:sharedBackstage.providers.translate("To open the popup, press Shift+Enter")})]})},getFormApi=function(input){return{hide:function(){return emit(input,sandboxClose())},getValue:function(){return Representing.getValue(input)}}},runOnExecute$1=function(memInput,original){return run(internalToolbarButtonExecute,function(comp,se){var input=memInput.get(comp),formApi=getFormApi(input);original.onAction(formApi,se.event().buttonApi())})},renderContextButton=function(memInput,button,extras){var _a=button.original,rest=(_a.primary,__rest(_a,["primary"])),bridged=getOrDie(createToolbarButton(__assign({},rest,{type:"button",onAction:function(){}})));return renderToolbarButtonWith(bridged,extras.backstage.shared.providers,[runOnExecute$1(memInput,button)])},renderContextToggleButton=function(memInput,button,extras){var _a=button.original,rest=(_a.primary,__rest(_a,["primary"])),bridged=getOrDie(createToggleButton(__assign({},rest,{type:"togglebutton",onAction:function(){}})));return renderToolbarToggleButtonWith(bridged,extras.backstage.shared.providers,[runOnExecute$1(memInput,button)])},generateOne$1=function(memInput,button,providersBackstage){var extras={backstage:{shared:{providers:providersBackstage}}};return"contextformtogglebutton"===button.type?renderContextToggleButton(memInput,button,extras):renderContextButton(memInput,button,extras)},generate$7=function(memInput,buttons,providersBackstage){var mementos=map(buttons,function(button){return record(generateOne$1(memInput,button,providersBackstage))}),asSpecs=function(){return map(mementos,function(mem){return mem.asSpec()})},findPrimary=function(compInSystem){return findMap(buttons,function(button,i){return button.primary?Option.from(mementos[i]).bind(function(mem){return mem.getOpt(compInSystem)}).filter(not(Disabling.isDisabled)):Option.none()})};return{asSpecs:asSpecs,findPrimary:findPrimary}},renderContextForm=function(ctx,backstage){var inputAttributes=ctx.label.fold(function(){return{}},function(label){return{"aria-label":label}}),memInput=record(Input.sketch({inputClasses:["tox-toolbar-textfield","tox-toolbar-nav-js"],data:ctx.initValue(),inputAttributes:inputAttributes,selectOnFocus:!0,inputBehaviours:derive$1([Keying.config({mode:"special",onEnter:function(input){return commands.findPrimary(input).map(function(primary){return emitExecute(primary),!0})},onLeft:function(comp,se){return se.cut(),Option.none()},onRight:function(comp,se){return se.cut(),Option.none()}})])})),commands=generate$7(memInput,ctx.commands,backstage.shared.providers);return renderToolbar({uid:generate$1("context-toolbar"),initGroups:[{title:Option.none(),items:[memInput.asSpec()]},{title:Option.none(),items:commands.asSpecs()}],onEscape:Option.none,cyclicKeying:!0,backstage:backstage,getSink:function(){return Result.error("")}})},ContextForm={renderContextForm:renderContextForm},forwardSlideEvent=generate$1("forward-slide"),backSlideEvent=generate$1("backward-slide"),changeSlideEvent=generate$1("change-slide-event"),resizingClass="tox-pop--resizing",renderContextToolbar=function(spec){var stack=Cell([]);return InlineView.sketch({dom:{tag:"div",classes:["tox-pop"]},fireDismissalEventInstead:{event:"doNotDismissYet"},onShow:function(comp){stack.set([]),InlineView.getContent(comp).each(function(c){remove$6(c.element(),"visibility")}),remove$4(comp.element(),resizingClass),remove$6(comp.element(),"width")},inlineBehaviours:derive$1([config("context-toolbar-events",[runOnSource(transitionend(),function(comp,se){InlineView.getContent(comp).each(function(c){}),remove$4(comp.element(),resizingClass),remove$6(comp.element(),"width")}),run(changeSlideEvent,function(comp,se){remove$6(comp.element(),"width");var currentWidth=get$7(comp.element());InlineView.setContent(comp,se.event().contents()),add$2(comp.element(),resizingClass);var newWidth=get$7(comp.element());set$2(comp.element(),"width",currentWidth+"px"),InlineView.getContent(comp).each(function(newContents){se.event().focus().bind(function(f){return focus$1(f),search$1(comp.element())}).orThunk(function(){return Keying.focusIn(newContents),active()})}),global$2.setTimeout(function(){set$2(comp.element(),"width",newWidth+"px")},0)}),run(forwardSlideEvent,function(comp,se){InlineView.getContent(comp).each(function(oldContents){stack.set(stack.get().concat([{bar:oldContents,focus:active()}]))}),emitWith(comp,changeSlideEvent,{contents:se.event().forwardContents(),focus:Option.none()})}),run(backSlideEvent,function(comp,se){last(stack.get()).each(function(last){stack.set(stack.get().slice(0,stack.get().length-1)),emitWith(comp,changeSlideEvent,{contents:premade$1(last.bar),focus:last.focus})})})]),Keying.config({mode:"special",onEscape:function(comp){return last(stack.get()).fold(function(){return spec.onEscape()},function(_){return emit(comp,backSlideEvent),Option.some(!0)})}})]),lazySink:function(){return Result.value(spec.sink)}})},getHorizontalBounds=function(editor,scroll,contentAreaBox){var x=Math.max(scroll.left(),contentAreaBox.x()),contentBoxWidth=contentAreaBox.right()-x,maxViewportWidth=domGlobals.window.innerWidth-(x-scroll.left()),width=Math.min(contentBoxWidth,maxViewportWidth);return{x:x,width:width}},getIframeBounds=function(editor,scroll,contentAreaBox){var _a=getHorizontalBounds(editor,scroll,contentAreaBox),x=_a.x,width=_a.width,containerBox=box(Element.fromDom(editor.getContainer())),y=Math.max(scroll.top(),contentAreaBox.y()),contentBoxHeight=containerBox.bottom()-y,maxViewportHeight=domGlobals.window.innerHeight-(y-scroll.top()),height=Math.min(contentBoxHeight,maxViewportHeight);return bounds(x,y,width,height)},getInlineBounds=function(editor,scroll,contentAreaBox){var _a=getHorizontalBounds(editor,scroll,contentAreaBox),x=_a.x,width=_a.width,containerBox=box(Element.fromDom(editor.getContainer())),windowHeight=domGlobals.window.innerHeight,scrollTop=scroll.top();if(containerBox.y()>=contentAreaBox.bottom()){var bottom=Math.min(windowHeight+scrollTop,containerBox.y()),height=bottom-scrollTop;return bounds(x,scrollTop,width,height)}var y=Math.max(scrollTop,containerBox.bottom());height=windowHeight-(y-scrollTop);return bounds(x,y,width,height)},getDistractionFreeBounds=function(editor,scroll,contentAreaBox){var _a=getHorizontalBounds(editor,scroll,contentAreaBox),x=_a.x,width=_a.width;return bounds(x,scroll.top(),width,domGlobals.window.innerHeight)},ancestor$2=function(scope,transform,isRoot){for(var element=scope.dom(),stop=isFunction(isRoot)?isRoot:constant(!1);element.parentNode;){element=element.parentNode;var el=Element.fromDom(element),transformed=transform(el);if(transformed.isSome())return transformed;if(stop(el))break}return Option.none()},matchTargetWith=function(elem,toolbars){return findMap(toolbars,function(toolbarApi){return toolbarApi.predicate(elem.dom())?Option.some({toolbarApi:toolbarApi,elem:elem}):Option.none()})},lookup$1=function(scopes,editor){var isRoot=function(elem){return elem.dom()===editor.getBody()},startNode=Element.fromDom(editor.selection.getNode());return matchTargetWith(startNode,scopes.inNodeScope).orThunk(function(){return matchTargetWith(startNode,scopes.inEditorScope).orThunk(function(){return ancestor$2(startNode,function(elem){return matchTargetWith(elem,scopes.inNodeScope)},isRoot)})})},ToolbarLookup={lookup:lookup$1},categorise=function(contextToolbars,navigate){var forms={},inNodeScope=[],inEditorScope=[],formNavigators={},lookupTable={},registerForm=function(key,toolbarApi){var contextForm=getOrDie(createContextForm(toolbarApi));forms[key]=contextForm,contextForm.launch.map(function(launch){formNavigators["form:"+key]=__assign({},toolbarApi.launch,{type:"contextformtogglebutton"===launch.type?"togglebutton":"button",onAction:function(){navigate(contextForm)}})}),"editor"===contextForm.scope?inEditorScope.push(contextForm):inNodeScope.push(contextForm),lookupTable[key]=contextForm},registerToolbar=function(key,toolbarApi){createContextToolbar(toolbarApi).each(function(contextToolbar){"editor"===toolbarApi.scope?inEditorScope.push(contextToolbar):inNodeScope.push(contextToolbar),lookupTable[key]=contextToolbar})},keys$1=keys(contextToolbars);return each(keys$1,function(key){var toolbarApi=contextToolbars[key];"contextform"===toolbarApi.type?registerForm(key,toolbarApi):"contexttoolbar"===toolbarApi.type&&registerToolbar(key,toolbarApi)}),{forms:forms,inNodeScope:inNodeScope,inEditorScope:inEditorScope,lookupTable:lookupTable,formNavigators:formNavigators}},ToolbarScopes={categorise:categorise},onSetupFormatToggle=function(editor,name){return function(api){var unbindCell=Cell(Option.none()),init=function(){api.setActive(editor.formatter.match(name));var unbind=editor.formatter.formatChanged(name,api.setActive).unbind;unbindCell.set(Option.some(unbind))};return editor.initialized?init():editor.on("init",init),function(){return unbindCell.get().each(function(unbind){return unbind()})}}},onActionToggleFormat=function(editor){return function(rawItem){return function(){editor.undoManager.transact(function(){editor.focus(),editor.execCommand("mceToggleFormat",!1,rawItem.format)})}}},generateSelectItems=function(editor,backstage,spec){var generateItem=function(rawItem,response,disabled,value){var translatedText=backstage.shared.providers.translate(rawItem.title);if("separator"===rawItem.type)return Option.some({type:"separator",text:translatedText});if("submenu"===rawItem.type){var items=bind(rawItem.getStyleItems(),function(si){return validate(si,response,value)});return 0===response&&items.length<=0?Option.none():Option.some({type:"nestedmenuitem",text:translatedText,disabled:items.length<=0,getSubmenuItems:function(){return bind(rawItem.getStyleItems(),function(si){return validate(si,response,value)})}})}return Option.some(__assign({type:"togglemenuitem",text:translatedText,active:rawItem.isSelected(value),disabled:disabled,onAction:spec.onAction(rawItem)},rawItem.getStylePreview().fold(function(){return{}},function(preview){return{meta:{style:preview}}})))},validate=function(item,response,value){var invalid="formatter"===item.type&&spec.isInvalid(item);return 0===response?invalid?[]:generateItem(item,response,!1,value).toArray():generateItem(item,response,invalid,value).toArray()},validateItems=function(preItems){var value=spec.getCurrentValue(),response=spec.shouldHide?0:1;return bind(preItems,function(item){return validate(item,response,value)})},getFetch=function(backstage,getStyleItems){return function(callback){var preItems=getStyleItems(),items=validateItems(preItems),menu=build$2(items,ItemResponse$1.CLOSE_ON_EXECUTE,backstage);callback(menu)}};return{validateItems:validateItems,getFetch:getFetch}},createMenuItems=function(editor,backstage,dataset,spec){var getStyleItems="basic"===dataset.type?function(){return map(dataset.data,function(d){return processBasic(d,spec.isSelectedFor,spec.getPreviewFor)})}:dataset.getData;return{items:generateSelectItems(editor,backstage,spec),getStyleItems:getStyleItems}},createSelectButton=function(editor,backstage,dataset,spec){var _a=createMenuItems(editor,backstage,dataset,spec),items=_a.items,getStyleItems=_a.getStyleItems,getApi=function(comp){return{getComponent:function(){return comp}}},onSetup=function(api){return spec.setInitialValue.each(function(f){return f(api.getComponent())}),spec.nodeChangeHandler.map(function(f){var handler=f(api.getComponent());return editor.on("NodeChange",handler),function(){editor.off("NodeChange",handler)}}).getOr(noop)};return renderCommonDropdown({text:spec.icon.isSome()?Option.none():Option.some(""),icon:spec.icon,tooltip:Option.from(spec.tooltip),role:Option.none(),fetch:items.getFetch(backstage,getStyleItems),onSetup:onSetup,getApi:getApi,columns:1,presets:"normal",classes:spec.icon.isSome()?[]:["bespoke"],dropdownBehaviours:[]},"tox-tbtn",backstage.shared)},process=function(rawFormats){return map(rawFormats,function(item){var title=item,format=item,values=item.split("=");return values.length>1&&(title=values[0],format=values[1]),{title:title,format:format}})},buildBasicStaticDataset=function(data){return{type:"basic",data:data}};(function(Delimiter){Delimiter[Delimiter.SemiColon=0]="SemiColon",Delimiter[Delimiter.Space=1]="Space"})(Delimiter||(Delimiter={}));var ResizeTypes,split=function(rawFormats,delimiter){return delimiter===Delimiter.SemiColon?rawFormats.replace(/;$/,"").split(";"):rawFormats.split(" ")},buildBasicSettingsDataset=function(editor,settingName,defaults,delimiter){var rawFormats=readOptFrom$1(editor.settings,settingName).getOr(defaults),data=process(split(rawFormats,delimiter));return{type:"basic",data:data}},alignMenuItems=[{title:"Left",icon:"align-left",format:"alignleft"},{title:"Center",icon:"align-center",format:"aligncenter"},{title:"Right",icon:"align-right",format:"alignright"},{title:"Justify",icon:"align-justify",format:"alignjustify"}],getSpec=function(editor){var getMatchingValue=function(){return find(alignMenuItems,function(item){return editor.formatter.match(item.format)})},isSelectedFor=function(format){return function(){return editor.formatter.match(format)}},getPreviewFor=function(format){return function(){return Option.none()}},updateSelectMenuIcon=function(comp){var match=getMatchingValue(),alignment=match.fold(function(){return"left"},function(item){return item.title.toLowerCase()});emitWith(comp,updateMenuIcon,{icon:"align-"+alignment})},nodeChangeHandler=Option.some(function(comp){return function(){return updateSelectMenuIcon(comp)}}),setInitialValue=Option.some(function(comp){return updateSelectMenuIcon(comp)}),dataset=buildBasicStaticDataset(alignMenuItems);return{tooltip:"Align",icon:Option.some("align-left"),isSelectedFor:isSelectedFor,
getCurrentValue:constant(Option.none()),getPreviewFor:getPreviewFor,onAction:onActionToggleFormat(editor),setInitialValue:setInitialValue,nodeChangeHandler:nodeChangeHandler,dataset:dataset,shouldHide:!1,isInvalid:function(item){return!editor.formatter.canApply(item.format)}}},createAlignSelect=function(editor,backstage){var spec=getSpec(editor);return createSelectButton(editor,backstage,spec.dataset,spec)},alignSelectMenu=function(editor,backstage){var spec=getSpec(editor),menuItems=createMenuItems(editor,backstage,spec.dataset,spec);editor.ui.registry.addNestedMenuItem("align",{text:backstage.shared.providers.translate("Align"),getSubmenuItems:function(){return menuItems.items.validateItems(menuItems.getStyleItems())}})},defaultFontsFormats="Andale Mono=andale mono,monospace;Arial=arial,helvetica,sans-serif;Arial Black=arial black,sans-serif;Book Antiqua=book antiqua,palatino,serif;Comic Sans MS=comic sans ms,sans-serif;Courier New=courier new,courier,monospace;Georgia=georgia,palatino,serif;Helvetica=helvetica,arial,sans-serif;Impact=impact,sans-serif;Symbol=symbol;Tahoma=tahoma,arial,helvetica,sans-serif;Terminal=terminal,monaco,monospace;Times New Roman=times new roman,times,serif;Trebuchet MS=trebuchet ms,geneva,sans-serif;Verdana=verdana,geneva,sans-serif;Webdings=webdings;Wingdings=wingdings,zapf dingbats",systemStackFonts=["-apple-system","Segoe UI","Roboto","Helvetica Neue","sans-serif"],splitFonts=function(fontFamily){var fonts=fontFamily.split(/\s*,\s*/);return map(fonts,function(font){return font.replace(/^['"]+|['"]+$/g,"")})},isSystemFontStack=function(fontFamily){var matchesSystemStack=function(){var fonts=splitFonts(fontFamily.toLowerCase());return forall(systemStackFonts,function(font){return fonts.indexOf(font.toLowerCase())>-1})};return 0===fontFamily.indexOf("-apple-system")&&matchesSystemStack()},getSpec$1=function(editor){var getMatchingValue=function(){var getFirstFont=function(fontFamily){return fontFamily?splitFonts(fontFamily)[0]:""},fontFamily=editor.queryCommandValue("FontName"),items=dataset.data,font=fontFamily?fontFamily.toLowerCase():"",matchOpt=find(items,function(item){var format=item.format;return format.toLowerCase()===font||getFirstFont(format).toLowerCase()===getFirstFont(font).toLowerCase()}).orThunk(function(){return isSystemFontStack(font)?Option.from({title:"System Font",format:font}):Option.none()});return{matchOpt:matchOpt,font:fontFamily}},isSelectedFor=function(item){return function(valueOpt){return valueOpt.exists(function(value){return value.format===item})}},getCurrentValue=function(){var matchOpt=getMatchingValue().matchOpt;return matchOpt},getPreviewFor=function(item){return function(){return Option.some({tag:"div",styleAttr:-1===item.indexOf("dings")?"font-family:"+item:""})}},onAction=function(rawItem){return function(){editor.undoManager.transact(function(){editor.focus(),editor.execCommand("FontName",!1,rawItem.format)})}},updateSelectMenuText=function(comp){var _a=getMatchingValue(),matchOpt=_a.matchOpt,font=_a.font,text=matchOpt.fold(function(){return font},function(item){return item.title});emitWith(comp,updateMenuText,{text:text})},nodeChangeHandler=Option.some(function(comp){return function(){return updateSelectMenuText(comp)}}),setInitialValue=Option.some(function(comp){return updateSelectMenuText(comp)}),dataset=buildBasicSettingsDataset(editor,"font_formats",defaultFontsFormats,Delimiter.SemiColon);return{tooltip:"Fonts",icon:Option.none(),isSelectedFor:isSelectedFor,getCurrentValue:getCurrentValue,getPreviewFor:getPreviewFor,onAction:onAction,setInitialValue:setInitialValue,nodeChangeHandler:nodeChangeHandler,dataset:dataset,shouldHide:!1,isInvalid:function(){return!1}}},createFontSelect=function(editor,backstage){var spec=getSpec$1(editor);return createSelectButton(editor,backstage,spec.dataset,spec)},fontSelectMenu=function(editor,backstage){var spec=getSpec$1(editor),menuItems=createMenuItems(editor,backstage,spec.dataset,spec);editor.ui.registry.addNestedMenuItem("fontformats",{text:backstage.shared.providers.translate("Fonts"),getSubmenuItems:function(){return menuItems.items.validateItems(menuItems.getStyleItems())}})},defaultFontsizeFormats="8pt 10pt 12pt 14pt 18pt 24pt 36pt",legacyFontSizes={"8pt":"1","10pt":"2","12pt":"3","14pt":"4","18pt":"5","24pt":"6","36pt":"7"},round$1=function(number,precision){var factor=Math.pow(10,precision);return Math.round(number*factor)/factor},toPt=function(fontSize,precision){return/[0-9.]+px$/.test(fontSize)?round$1(72*parseInt(fontSize,10)/96,precision||0)+"pt":fontSize},toLegacy=function(fontSize){return get(legacyFontSizes,fontSize).getOr("")},getSpec$2=function(editor){var getMatchingValue=function(){var matchOpt=Option.none(),items=dataset.data,px=editor.queryCommandValue("FontSize");if(px)for(var _loop_1=function(precision){var pt=toPt(px,precision),legacy=toLegacy(pt);matchOpt=find(items,function(item){return item.format===px||item.format===pt||item.format===legacy})},precision=3;matchOpt.isNone()&&precision>=0;precision--)_loop_1(precision);return{matchOpt:matchOpt,px:px}},isSelectedFor=function(item){return function(valueOpt){return valueOpt.exists(function(value){return value.format===item})}},getCurrentValue=function(){var matchOpt=getMatchingValue().matchOpt;return matchOpt},getPreviewFor=function(){return constant(Option.none())},onAction=function(rawItem){return function(){editor.undoManager.transact(function(){editor.focus(),editor.execCommand("FontSize",!1,rawItem.format)})}},updateSelectMenuText=function(comp){var _a=getMatchingValue(),matchOpt=_a.matchOpt,px=_a.px,text=matchOpt.fold(function(){return px},function(match){return match.title});emitWith(comp,updateMenuText,{text:text})},nodeChangeHandler=Option.some(function(comp){return function(){return updateSelectMenuText(comp)}}),setInitialValue=Option.some(function(comp){return updateSelectMenuText(comp)}),dataset=buildBasicSettingsDataset(editor,"fontsize_formats",defaultFontsizeFormats,Delimiter.Space);return{tooltip:"Font sizes",icon:Option.none(),isSelectedFor:isSelectedFor,getPreviewFor:getPreviewFor,getCurrentValue:getCurrentValue,onAction:onAction,setInitialValue:setInitialValue,nodeChangeHandler:nodeChangeHandler,dataset:dataset,shouldHide:!1,isInvalid:function(){return!1}}},createFontsizeSelect=function(editor,backstage){var spec=getSpec$2(editor);return createSelectButton(editor,backstage,spec.dataset,spec)},fontsizeSelectMenu=function(editor,backstage){var spec=getSpec$2(editor),menuItems=createMenuItems(editor,backstage,spec.dataset,spec);editor.ui.registry.addNestedMenuItem("fontsizes",{text:"Font sizes",getSubmenuItems:function(){return menuItems.items.validateItems(menuItems.getStyleItems())}})},findNearest=function(editor,getStyles,parents){var styles=getStyles();return findMap(parents,function(parent){return find(styles,function(fmt){return editor.formatter.matchNode(parent,fmt.format)})}).orThunk(function(){return editor.formatter.match("p")?Option.some({title:"Paragraph",format:"p"}):Option.none()})},getCurrentSelectionParents=function(editor){var currentNode=editor.selection.getStart(!0)||editor.getBody();return editor.dom.getParents(currentNode,function(){return!0},editor.getBody())},defaultBlocks="Paragraph=p;Heading 1=h1;Heading 2=h2;Heading 3=h3;Heading 4=h4;Heading 5=h5;Heading 6=h6;Preformatted=pre",getSpec$3=function(editor){var getMatchingValue=function(nodeChangeEvent){return findNearest(editor,function(){return dataset.data},nodeChangeEvent)},isSelectedFor=function(format){return function(){return editor.formatter.match(format)}},getPreviewFor=function(format){return function(){var fmt=editor.formatter.get(format);return Option.some({tag:fmt.length>0&&(fmt[0].inline||fmt[0].block)||"div",styleAttr:editor.formatter.getCssText(format)})}},updateSelectMenuText=function(parents,comp){var detectedFormat=getMatchingValue(parents),text=detectedFormat.fold(function(){return"Paragraph"},function(fmt){return fmt.title});emitWith(comp,updateMenuText,{text:text})},nodeChangeHandler=Option.some(function(comp){return function(e){return updateSelectMenuText(e.parents,comp)}}),setInitialValue=Option.some(function(comp){var parents=getCurrentSelectionParents(editor);updateSelectMenuText(parents,comp)}),dataset=buildBasicSettingsDataset(editor,"block_formats",defaultBlocks,Delimiter.SemiColon);return{tooltip:"Blocks",icon:Option.none(),isSelectedFor:isSelectedFor,getCurrentValue:constant(Option.none()),getPreviewFor:getPreviewFor,onAction:onActionToggleFormat(editor),setInitialValue:setInitialValue,nodeChangeHandler:nodeChangeHandler,dataset:dataset,shouldHide:!1,isInvalid:function(item){return!editor.formatter.canApply(item.format)}}},createFormatSelect=function(editor,backstage){var spec=getSpec$3(editor);return createSelectButton(editor,backstage,spec.dataset,spec)},formatSelectMenu=function(editor,backstage){var spec=getSpec$3(editor),menuItems=createMenuItems(editor,backstage,spec.dataset,spec);editor.ui.registry.addNestedMenuItem("blockformats",{text:"Blocks",getSubmenuItems:function(){return menuItems.items.validateItems(menuItems.getStyleItems())}})},getSpec$4=function(editor){var isSelectedFor=function(format){return function(){return editor.formatter.match(format)}},getPreviewFor=function(format){return function(){var fmt=editor.formatter.get(format);return void 0!==fmt?Option.some({tag:fmt.length>0&&(fmt[0].inline||fmt[0].block)||"div",styleAttr:editor.formatter.getCssText(format)}):Option.none()}},updateSelectMenuText=function(parents,comp){var getFormatItems=function(fmt){var subs=fmt.items;return void 0!==subs&&subs.length>0?bind(subs,getFormatItems):[{title:fmt.title,format:fmt.format}]},flattenedItems=bind(getStyleFormats(editor),getFormatItems),detectedFormat=findNearest(editor,function(){return flattenedItems},parents),text=detectedFormat.fold(function(){return"Paragraph"},function(fmt){return fmt.title});emitWith(comp,updateMenuText,{text:text})},nodeChangeHandler=Option.some(function(comp){return function(e){return updateSelectMenuText(e.parents,comp)}}),setInitialValue=Option.some(function(comp){var parents=getCurrentSelectionParents(editor);updateSelectMenuText(parents,comp)});return{tooltip:"Formats",icon:Option.none(),isSelectedFor:isSelectedFor,getCurrentValue:constant(Option.none()),getPreviewFor:getPreviewFor,onAction:onActionToggleFormat(editor),setInitialValue:setInitialValue,nodeChangeHandler:nodeChangeHandler,shouldHide:editor.getParam("style_formats_autohide",!1,"boolean"),isInvalid:function(item){return!editor.formatter.canApply(item.format)}}},createStyleSelect=function(editor,backstage){var data=backstage.styleselect;return createSelectButton(editor,backstage,data,getSpec$4(editor))},styleSelectMenu=function(editor,backstage){var data=backstage.styleselect,menuItems=createMenuItems(editor,backstage,data,getSpec$4(editor));editor.ui.registry.addNestedMenuItem("formats",{text:"Formats",getSubmenuItems:function(){return menuItems.items.validateItems(menuItems.getStyleItems())}})},defaultToolbar=[{name:"history",items:["undo","redo"]},{name:"styles",items:["styleselect"]},{name:"formatting",items:["bold","italic"]},{name:"alignment",items:["alignleft","aligncenter","alignright","alignjustify"]},{name:"indentation",items:["outdent","indent"]},{name:"permanent pen",items:["permanentpen"]},{name:"comments",items:["addcomment"]}],renderFromBridge=function(bridgeBuilder,render){return function(spec,extras){var internal=bridgeBuilder(spec).mapError(function(errInfo){return formatError(errInfo)}).getOrDie();return render(internal,extras)}},types={button:renderFromBridge(createToolbarButton,function(s,extras){return renderToolbarButton(s,extras.backstage.shared.providers)}),togglebutton:renderFromBridge(createToggleButton,function(s,extras){return renderToolbarToggleButton(s,extras.backstage.shared.providers)}),menubutton:renderFromBridge(createMenuButton,function(s,extras){return renderMenuButton(s,"tox-tbtn",extras.backstage,Option.none())}),splitbutton:renderFromBridge(createSplitButton,function(s,extras){return renderSplitButton(s,extras.backstage.shared)}),styleSelectButton:function(editor,extras){return createStyleSelect(editor,extras.backstage)},fontsizeSelectButton:function(editor,extras){return createFontsizeSelect(editor,extras.backstage)},fontSelectButton:function(editor,extras){return createFontSelect(editor,extras.backstage)},formatButton:function(editor,extras){return createFormatSelect(editor,extras.backstage)},alignMenuButton:function(editor,extras){return createAlignSelect(editor,extras.backstage)}},extractFrom=function(spec,extras){return get(types,spec.type).fold(function(){return domGlobals.console.error("skipping button defined by",spec),Option.none()},function(render){return Option.some(render(spec,extras))})},bespokeButtons={styleselect:types.styleSelectButton,fontsizeselect:types.fontsizeSelectButton,fontselect:types.fontSelectButton,formatselect:types.formatButton,align:types.alignMenuButton},removeUnusedDefaults=function(buttons){var filteredItemGroups=map(defaultToolbar,function(group){var items=filter(group.items,function(subItem){return has(buttons,subItem)||has(bespokeButtons,subItem)});return{name:group.name,items:items}});return filter(filteredItemGroups,function(group){return group.items.length>0})},convertStringToolbar=function(strToolbar){var groupsStrings=strToolbar.split("|");return map(groupsStrings,function(g){return{items:g.trim().split(" ")}})},isToolbarGroupSettingArray=function(toolbar){return isArrayOf(toolbar,function(t){return has(t,"name")&&has(t,"items")})},createToolbar=function(toolbarConfig){var toolbar=toolbarConfig.toolbar,buttons=toolbarConfig.buttons;return!1===toolbar?[]:void 0===toolbar||!0===toolbar?removeUnusedDefaults(buttons):isString(toolbar)?convertStringToolbar(toolbar):isToolbarGroupSettingArray(toolbar)?toolbar:(domGlobals.console.error("Toolbar type should be string, string[], boolean or ToolbarGroup[]"),[])},lookupButton=function(editor,buttons,toolbarItem,extras,prefixes){return get(buttons,toolbarItem.toLowerCase()).orThunk(function(){return prefixes.bind(function(ps){return findMap(ps,function(prefix){return get(buttons,prefix+toolbarItem.toLowerCase())})})}).fold(function(){return get(bespokeButtons,toolbarItem.toLowerCase()).map(function(r){return r(editor,extras)}).orThunk(function(){return Option.none()})},function(spec){return extractFrom(spec,extras)})},identifyButtons=function(editor,toolbarConfig,extras,prefixes){var toolbarGroups=createToolbar(toolbarConfig),groups=map(toolbarGroups,function(group){var items=bind(group.items,function(toolbarItem){return 0===toolbarItem.trim().length?[]:lookupButton(editor,toolbarConfig.buttons,toolbarItem,extras,prefixes).toArray()});return{title:Option.from(editor.translate(group.name)),items:items}});return filter(groups,function(group){return group.items.length>0})},register$4=function(editor,registryContextToolbars,sink,extras){var contextbar=build$1(renderContextToolbar({sink:sink,onEscape:function(){return editor.focus(),Option.some(!0)}})),toolbarOrMenubarEnabled=isMenubarEnabled(editor)||isToolbarEnabled(editor)||isMultipleToolbars(editor),getBounds=function(){var scroll=get$8(),contentAreaBox=box(Element.fromDom(editor.getContentAreaContainer()));return editor.inline&&!toolbarOrMenubarEnabled?Option.some(getDistractionFreeBounds(editor,scroll,contentAreaBox)):editor.inline?Option.some(getInlineBounds(editor,scroll,contentAreaBox)):Option.some(getIframeBounds(editor,scroll,contentAreaBox))},getViewportTop=function(){var isToolbarDocked="fixed"===get$4(Element.fromDom(editor.getContainer()),"position");return editor.inline&&toolbarOrMenubarEnabled&&isToolbarDocked?editor.getContainer().getBoundingClientRect().bottom:0},shouldContextToolbarHide=function(){var nodeBounds=lastElement.get().map(function(ele){return ele.getBoundingClientRect()}).getOr(editor.selection.getRng().getBoundingClientRect()),viewportHeight=defaultView(Element.fromDom(editor.getBody())).dom().innerHeight,aboveViewport=nodeBounds.bottom<getViewportTop(),belowViewport=nodeBounds.top>viewportHeight;return aboveViewport||belowViewport},hideOrRepositionIfNecessary=function(){lastAnchor.get().each(function(anchor){var contextBarEle=contextbar.element();remove$6(contextBarEle,"display"),shouldContextToolbarHide()?set$2(contextBarEle,"display","none"):Positioning.positionWithinBounds(sink,anchor,contextbar,getBounds())})};editor.on("init",function(){if(editor.on("ScrollWindow",hideOrRepositionIfNecessary),!editor.inline){var scroller=defaultView(Element.fromDom(editor.getBody())),onScroll_1=bind$3(scroller,"scroll",hideOrRepositionIfNecessary);editor.on("remove",function(){onScroll_1.unbind()})}});var lastAnchor=Cell(Option.none()),lastElement=Cell(Option.none()),timer=Cell(null),wrapInPopDialog=function(toolbarSpec){return{dom:{tag:"div",classes:["tox-pop__dialog"]},components:[toolbarSpec],behaviours:derive$1([Keying.config({mode:"acyclic"}),config("pop-dialog-wrap-events",[runOnAttached(function(comp){editor.shortcuts.add("ctrl+F9","focus statusbar",function(){return Keying.focusIn(comp)})}),runOnDetached(function(comp){editor.shortcuts.remove("ctrl+F9")})])])}},getScopes=cached(function(){return ToolbarScopes.categorise(registryContextToolbars,function(toolbarApi){var alloySpec=buildToolbar(toolbarApi);emitWith(contextbar,forwardSlideEvent,{forwardContents:wrapInPopDialog(alloySpec)})})}),buildToolbar=function(ctx){var allButtons,initGroups,buttons=editor.ui.registry.getAll().buttons,scopes=getScopes();return"contexttoolbar"===ctx.type?(allButtons=merge(buttons,scopes.formNavigators),initGroups=identifyButtons(editor,{buttons:allButtons,toolbar:ctx.items},extras,Option.some(["form:"])),renderToolbar({uid:generate$1("context-toolbar"),initGroups:initGroups,onEscape:Option.none,cyclicKeying:!0,backstage:extras.backstage,getSink:function(){return Result.error("")}})):ContextForm.renderContextForm(ctx,extras.backstage)};editor.on(showContextToolbarEvent,function(e){var scopes=getScopes();readOptFrom$1(scopes.lookupTable,e.toolbarKey).each(function(ctx){launchContext(ctx,e.target===editor?Option.none():Option.some(e)),InlineView.getContent(contextbar).each(Keying.focusIn)})});var bubbleSize=12,bubbleAlignments={valignCentre:[],alignCentre:[],alignLeft:["tox-pop--align-left"],alignRight:["tox-pop--align-right"],right:["tox-pop--right"],left:["tox-pop--left"],bottom:["tox-pop--bottom"],top:["tox-pop--top"]},anchorOverrides={maxHeightFunction:expandable()},lineAnchorSpec={bubble:nu$7(bubbleSize,0,bubbleAlignments),layouts:{onLtr:function(){return[east$1]},onRtl:function(){return[west$1]}},overrides:anchorOverrides},anchorSpec={bubble:nu$7(0,bubbleSize,bubbleAlignments),layouts:{onLtr:function(){return[north$1,south$1,northeast$1,southeast$1,northwest$1,southwest$1,north$3,south$3,northeast$3,southeast$3,northwest$3,southwest$3]},onRtl:function(){return[north$1,south$1,northwest$1,southwest$1,northeast$1,southeast$1,north$3,south$3,northwest$3,southwest$3,northeast$3,southeast$3]}},overrides:anchorOverrides},getAnchor=function(position,element){var anchorage="node"===position?extras.backstage.shared.anchors.node(element):extras.backstage.shared.anchors.cursor(),anchor=deepMerge(anchorage,"line"===position?lineAnchorSpec:anchorSpec);return anchor},launchContext=function(toolbarApi,elem){clearTimer();var toolbarSpec=buildToolbar(toolbarApi),sElem=elem.map(Element.fromDom),anchor=getAnchor(toolbarApi.position,sElem);lastAnchor.set(Option.some(anchor)),lastElement.set(elem);var contextBarEle=contextbar.element();remove$6(contextBarEle,"display"),InlineView.showWithinBounds(contextbar,anchor,wrapInPopDialog(toolbarSpec),getBounds()),shouldContextToolbarHide()&&set$2(contextBarEle,"display","none")},launchContextToolbar=function(){var scopes=getScopes();ToolbarLookup.lookup(scopes,editor).fold(function(){lastAnchor.set(Option.none()),InlineView.hide(contextbar)},function(info){launchContext(info.toolbarApi,Option.some(info.elem.dom()))})},clearTimer=function(){var current=timer.get();null!==current&&(global$2.clearTimeout(current),timer.set(null))},resetTimer=function(t){clearTimer(),timer.set(t)};editor.on("init",function(){editor.on("click keyup SetContent ObjectResized ResizeEditor",function(e){resetTimer(global$2.setEditorTimeout(editor,launchContextToolbar,0))}),editor.on("focusout",function(e){global$2.setEditorTimeout(editor,function(){search$1(sink.element()).isNone()&&search$1(contextbar.element()).isNone()&&(lastAnchor.set(Option.none()),InlineView.hide(contextbar))},0)}),editor.on("SwitchMode",function(){editor.readonly&&(lastAnchor.set(Option.none()),InlineView.hide(contextbar))}),editor.on("NodeChange",function(e){search$1(contextbar.element()).fold(function(){resetTimer(global$2.setEditorTimeout(editor,launchContextToolbar,0))},function(_){})})})},ContextToolbar={register:register$4},setup$3=function(editor,mothership,uiMothership){var onMousedown=bind$3(Element.fromDom(domGlobals.document),"mousedown",function(evt){each([mothership,uiMothership],function(ship){ship.broadcastOn([dismissPopups()],{target:evt.target()})})}),onTouchstart=bind$3(Element.fromDom(domGlobals.document),"touchstart",function(evt){each([mothership,uiMothership],function(ship){ship.broadcastOn([dismissPopups()],{target:evt.target()})})}),onMouseup=bind$3(Element.fromDom(domGlobals.document),"mouseup",function(evt){0===evt.raw().button&&each([mothership,uiMothership],function(ship){ship.broadcastOn([mouseReleased()],{target:evt.target()})})}),onContentMousedown=function(raw){each([mothership,uiMothership],function(ship){ship.broadcastOn([dismissPopups()],{target:Element.fromDom(raw.target)})})};editor.on("mousedown",onContentMousedown),editor.on("touchstart",onContentMousedown);var onContentMouseup=function(raw){0===raw.button&&each([mothership,uiMothership],function(ship){ship.broadcastOn([mouseReleased()],{target:Element.fromDom(raw.target)})})};editor.on("mouseup",onContentMouseup);var onWindowScroll=function(evt){each([mothership,uiMothership],function(ship){ship.broadcastEvent(windowScroll(),evt)})};editor.on("ScrollWindow",onWindowScroll);var onWindowResize=function(evt){each([mothership,uiMothership],function(ship){ship.broadcastEvent(windowResize(),evt)})};editor.on("ResizeWindow",onWindowResize),editor.on("remove",function(){editor.off("mousedown",onContentMousedown),editor.off("touchstart",onContentMousedown),editor.off("mouseup",onContentMouseup),editor.off("ResizeWindow",onWindowResize),editor.off("ScrollWindow",onWindowScroll),onMousedown.unbind(),onTouchstart.unbind(),onMouseup.unbind()}),editor.on("detach",function(){detachSystem(mothership),detachSystem(uiMothership),mothership.destroy(),uiMothership.destroy()})},Events$1={setup:setup$3},schema$p=constant([defaulted$1("shell",!1),strict$1("makeItem"),defaulted$1("setupItem",noop),SketchBehaviours.field("listBehaviours",[Replacing])]),customListDetail=function(detail){return{behaviours:derive$1([Replacing.config({})])}},itemsPart=optional({name:"items",overrides:customListDetail}),parts$c=constant([itemsPart]),name$2=constant("CustomList"),factory$e=function(detail,components,spec,external){var setItems=function(list,items){getListContainer(list).fold(function(){throw domGlobals.console.error("Custom List was defined to not be a shell, but no item container was specified in components"),new Error("Custom List was defined to not be a shell, but no item container was specified in components")},function(container){var itemComps=Replacing.contents(container),numListsRequired=items.length,numListsToAdd=numListsRequired-itemComps.length,itemsToAdd=numListsToAdd>0?range(numListsToAdd,function(){return detail.makeItem()}):[],itemsToRemove=itemComps.slice(numListsRequired);each(itemsToRemove,function(item){return Replacing.remove(container,item)}),each(itemsToAdd,function(item){return Replacing.append(container,item)});var builtLists=Replacing.contents(container);each(builtLists,function(item,i){detail.setupItem(list,item,items[i],i)})})},extra=detail.shell?{behaviours:[Replacing.config({})],components:[]}:{behaviours:[],components:components},getListContainer=function(component){return detail.shell?Option.some(component):getPart(component,detail,"items")};return{uid:detail.uid,dom:detail.dom,components:extra.components,behaviours:augment(detail.listBehaviours,extra.behaviours),apis:{setItems:setItems}}},CustomList=composite$1({name:name$2(),configFields:schema$p(),partFields:parts$c(),factory:factory$e,apis:{setItems:function(apis,list,items){apis.setItems(list,items)}}}),parts$d=AlloyParts,partType$1=PartType,factory$f=function(detail,spec){var setMenus=function(comp,menus){var newMenus=map(menus,function(m){var buttonSpec={type:"menubutton",text:m.text,fetch:function(callback){callback(m.getItems())}},internal=createMenuButton(buttonSpec).mapError(function(errInfo){return formatError(errInfo)}).getOrDie();return renderMenuButton(internal,"tox-mbtn",spec.backstage,Option.some("menuitem"))});Replacing.set(comp,newMenus)},apis={focus:Keying.focusIn,setMenus:setMenus};return{uid:detail.uid,dom:detail.dom,components:[],behaviours:derive$1([Replacing.config({}),config("menubar-events",[runOnAttached(function(component){detail.onSetup(component)}),run(mouseover(),function(comp,se){descendant$1(comp.element(),".tox-mbtn--active").each(function(activeButton){closest$3(se.event().target(),".tox-mbtn").each(function(hoveredButton){eq(activeButton,hoveredButton)||comp.getSystem().getByDom(activeButton).each(function(activeComp){comp.getSystem().getByDom(hoveredButton).each(function(hoveredComp){Dropdown.expand(hoveredComp),Dropdown.close(activeComp),Focusing.focus(hoveredComp)})})})})}),run(focusShifted(),function(comp,se){se.event().prevFocus().bind(function(prev){return comp.getSystem().getByDom(prev).toOption()}).each(function(prev){se.event().newFocus().bind(function(nu){return comp.getSystem().getByDom(nu).toOption()}).each(function(nu){Dropdown.isOpen(prev)&&(Dropdown.expand(nu),Dropdown.close(prev))})})})]),Keying.config({mode:"flow",selector:".tox-mbtn",onEscape:function(comp){return detail.onEscape(comp),Option.some(!0)}}),Tabstopping.config({})]),apis:apis,domModification:{attributes:{role:"menubar"}}}},SilverMenubar=single$2({factory:factory$f,name:"silver.Menubar",configFields:[strict$1("dom"),strict$1("uid"),strict$1("onEscape"),strict$1("backstage"),defaulted$1("onSetup",noop)],apis:{focus:function(apis,comp){apis.focus(comp)},setMenus:function(apis,comp,menus){apis.setMenus(comp,menus)}}}),owner$4="container",schema$q=[field$1("slotBehaviours",[])],getPartName$1=function(name){return"<alloy.field."+name+">"},sketch$2=function(sSpec){var record,slot,parts=(record=[],slot=function(name,config){return record.push(name),generateOne(owner$4,getPartName$1(name),config)},{slot:slot,record:function(){return record}}),spec=sSpec(parts),partNames=parts.record(),fieldParts=map(partNames,function(n){return required({name:n,pname:getPartName$1(n)})});return composite(owner$4,schema$q,fieldParts,make$7,spec)},make$7=function(detail,components,spec){var getSlotNames=function(_){return getAllPartNames(detail)},getSlot=function(container,key){return getPart(container,detail,key)},onSlot=function(f,def){return void 0===def&&(def=void 0),function(container,key){return getPart(container,detail,key).map(function(slot){return f(slot,key)}).getOr(def)}},onSlots=function(f){return function(container,keys){each(keys,function(key){return f(container,key)})}},doShowing=function(comp,key){return"true"!==get$2(comp.element(),"aria-hidden")},doShow=function(comp,key){if(!doShowing(comp)){var element=comp.element();remove$6(element,"display"),remove$1(element,"aria-hidden"),emitWith(comp,slotVisibility(),{name:key,visible:!0})}},doHide=function(comp,key){if(doShowing(comp)){var element=comp.element();set$2(element,"display","none"),set$1(element,"aria-hidden","true"),emitWith(comp,slotVisibility(),{name:key,visible:!1})}},isShowing=onSlot(doShowing,!1),hideSlot=onSlot(doHide),hideSlots=onSlots(hideSlot),hideAllSlots=function(container){return hideSlots(container,getSlotNames())},showSlot=onSlot(doShow),apis={getSlotNames:getSlotNames,getSlot:getSlot,isShowing:isShowing,hideSlot:hideSlot,hideAllSlots:hideAllSlots,showSlot:showSlot};return{uid:detail.uid,dom:detail.dom,components:components,behaviours:get$b(detail.slotBehaviours),apis:apis}},slotApis=map$1({getSlotNames:function(apis,c){return apis.getSlotNames(c)},getSlot:function(apis,c,key){return apis.getSlot(c,key)},isShowing:function(apis,c,key){return apis.isShowing(c,key)},hideSlot:function(apis,c,key){return apis.hideSlot(c,key)},hideAllSlots:function(apis,c){return apis.hideAllSlots(c)},showSlot:function(apis,c,key){return apis.showSlot(c,key)}},makeApi),SlotContainer=__assign({},slotApis,{sketch:sketch$2}),sidebarSchema=objOf([optionString("icon"),optionString("tooltip"),defaultedFunction("onShow",noop),defaultedFunction("onHide",noop),defaultedFunction("onSetup",function(){return noop})]),createSidebar=function(spec){return asRaw("sidebar",sidebarSchema,spec)},setup$4=function(editor){var sidebars=editor.ui.registry.getAll().sidebars;each(keys(sidebars),function(name){var spec=sidebars[name],isActive=function(){return Option.from(editor.queryCommandValue("ToggleSidebar")).is(name)};editor.ui.registry.addToggleButton(name,{icon:spec.icon,tooltip:spec.tooltip,onAction:function(buttonApi){editor.execCommand("ToggleSidebar",!1,name),buttonApi.setActive(isActive())},onSetup:function(buttonApi){var handleToggle=function(){return buttonApi.setActive(isActive())};return editor.on("ToggleSidebar",handleToggle),function(){editor.off("ToggleSidebar",handleToggle)}}})})},getApi=function(comp){return{element:function(){return comp.element().dom()}}},makePanels=function(parts,panelConfigs){var specs=map(keys(panelConfigs),function(name){var spec=panelConfigs[name],bridged=getOrDie(createSidebar(spec));return{name:name,getApi:getApi,onSetup:bridged.onSetup,onShow:bridged.onShow,onHide:bridged.onHide}});return map(specs,function(spec){var editorOffCell=Cell(noop);return parts.slot(spec.name,{dom:{tag:"div",classes:["tox-sidebar__pane"]},behaviours:SimpleBehaviours.unnamedEvents([onControlAttached(spec,editorOffCell),onControlDetached(spec,editorOffCell),run(slotVisibility(),function(sidepanel,se){var data=se.event(),optSidePanelSpec=find(specs,function(config){return config.name===data.name()});optSidePanelSpec.each(function(sidePanelSpec){var handler=data.visible()?sidePanelSpec.onShow:sidePanelSpec.onHide;handler(sidePanelSpec.getApi(sidepanel))})})])})})},makeSidebar=function(panelConfigs){return SlotContainer.sketch(function(parts){return{dom:{tag:"div",classes:["tox-sidebar__pane-container"]},components:makePanels(parts,panelConfigs),slotBehaviours:SimpleBehaviours.unnamedEvents([runOnAttached(function(slotContainer){return SlotContainer.hideAllSlots(slotContainer)})])}})},setSidebar=function(sidebar,panelConfigs){var optSlider=Composing.getCurrent(sidebar);optSlider.each(function(slider){return Replacing.set(slider,[makeSidebar(panelConfigs)])})},toggleSidebar=function(sidebar,name){var optSlider=Composing.getCurrent(sidebar);optSlider.each(function(slider){var optSlotContainer=Composing.getCurrent(slider);optSlotContainer.each(function(slotContainer){Sliding.hasGrown(slider)?SlotContainer.isShowing(slotContainer,name)?Sliding.shrink(slider):(SlotContainer.hideAllSlots(slotContainer),SlotContainer.showSlot(slotContainer,name)):(SlotContainer.hideAllSlots(slotContainer),SlotContainer.showSlot(slotContainer,name),Sliding.grow(slider))})})},whichSidebar=function(sidebar){var optSlider=Composing.getCurrent(sidebar);return optSlider.bind(function(slider){var sidebarOpen=Sliding.isGrowing(slider)||Sliding.hasGrown(slider);if(sidebarOpen){var optSlotContainer=Composing.getCurrent(slider);return optSlotContainer.bind(function(slotContainer){return find(SlotContainer.getSlotNames(slotContainer),function(name){
return SlotContainer.isShowing(slotContainer,name)})})}return Option.none()})},fixSize=generate$1("FixSizeEvent"),autoSize=generate$1("AutoSizeEvent"),renderSidebar=function(spec){return{uid:spec.uid,dom:{tag:"div",classes:["tox-sidebar"],attributes:{role:"complementary"}},components:[{dom:{tag:"div",classes:["tox-sidebar__slider"]},components:[],behaviours:derive$1([Tabstopping.config({}),Focusing.config({}),Sliding.config({dimension:{property:"width"},closedClass:"tox-sidebar--sliding-closed",openClass:"tox-sidebar--sliding-open",shrinkingClass:"tox-sidebar--sliding-shrinking",growingClass:"tox-sidebar--sliding-growing",onShrunk:function(slider){var optSlotContainer=Composing.getCurrent(slider);optSlotContainer.each(SlotContainer.hideAllSlots),emit(slider,autoSize)},onGrown:function(slider){emit(slider,autoSize)},onStartGrow:function(slider){emitWith(slider,fixSize,{width:getRaw(slider.element(),"width").getOr("")})},onStartShrink:function(slider){emitWith(slider,fixSize,{width:get$7(slider.element())+"px"})}}),Replacing.config({}),Composing.config({find:function(comp){var children=Replacing.contents(comp);return head(children)}})])}],behaviours:derive$1([ComposingConfigs.childAt(0),config("sidebar-sliding-events",[run(fixSize,function(comp,se){set$2(comp.element(),"width",se.event().width())}),run(autoSize,function(comp,se){remove$6(comp.element(),"width")})])])}},renderSpinner=function(providerBackstage){return{dom:{tag:"div",attributes:{"aria-label":providerBackstage.translate("Loading...")},classes:["tox-throbber__busy-spinner"]},components:[{dom:fromHtml$2('<div class="tox-spinner"><div></div><div></div><div></div></div>')}],behaviours:derive$1([Keying.config({mode:"special",onTab:function(){return Option.some(!0)},onShiftTab:function(){return Option.some(!0)}}),Focusing.config({})])}},toggleThrobber=function(comp,state,providerBackstage){var element=comp.element();!0===state?(Replacing.set(comp,[renderSpinner(providerBackstage)]),remove$6(element,"display"),remove$1(element,"aria-hidden")):(Replacing.set(comp,[]),set$2(element,"display","none"),set$1(element,"aria-hidden","true"))},renderThrobber=function(spec){return{uid:spec.uid,dom:{tag:"div",attributes:{"aria-hidden":"true"},classes:["tox-throbber"],styles:{display:"none"}},behaviours:derive$1([Replacing.config({})]),components:[]}},setup$5=function(editor,lazyThrobber,sharedBackstage){var throbberState=Cell(!1),timer=Cell(Option.none()),toggle=function(state){state!==throbberState.get()&&(toggleThrobber(lazyThrobber(),state,sharedBackstage.providers),throbberState.set(state))};editor.on("ProgressState",function(e){if(timer.get().each(global$2.clearTimeout),isNumber(e.time)){var timerId=global$2.setEditorTimeout(editor,function(){return toggle(e.state)},e.time);timer.set(Option.some(timerId))}else toggle(e.state),timer.set(Option.none())})},factory$g=function(detail,components,spec){var apis={getSocket:function(comp){return parts$d.getPart(comp,detail,"socket")},setSidebar:function(comp,panelConfigs){parts$d.getPart(comp,detail,"sidebar").each(function(sidebar){return setSidebar(sidebar,panelConfigs)})},toggleSidebar:function(comp,name){parts$d.getPart(comp,detail,"sidebar").each(function(sidebar){return toggleSidebar(sidebar,name)})},whichSidebar:function(comp){return parts$d.getPart(comp,detail,"sidebar").bind(whichSidebar).getOrNull()},getToolbar:function(comp){return parts$d.getPart(comp,detail,"toolbar")},setToolbar:function(comp,groups){parts$d.getPart(comp,detail,"toolbar").each(function(toolbar){toolbar.getApis().setGroups(toolbar,groups)})},setToolbars:function(comp,toolbars){parts$d.getPart(comp,detail,"multiple-toolbar").each(function(mToolbar){CustomList.setItems(mToolbar,toolbars)})},refreshToolbar:function(comp){var toolbar=parts$d.getPart(comp,detail,"toolbar");toolbar.each(function(toolbar){return toolbar.getApis().refresh(toolbar)})},getMoreButton:function(comp){var toolbar=parts$d.getPart(comp,detail,"toolbar");return toolbar.bind(function(toolbar){return toolbar.getApis().getMoreButton(toolbar)})},getThrobber:function(comp){return parts$d.getPart(comp,detail,"throbber")},focusToolbar:function(comp){var optToolbar=parts$d.getPart(comp,detail,"toolbar").orThunk(function(){return parts$d.getPart(comp,detail,"multiple-toolbar")});optToolbar.each(function(toolbar){Keying.focusIn(toolbar)})},setMenubar:function(comp,menus){parts$d.getPart(comp,detail,"menubar").each(function(menubar){SilverMenubar.setMenus(menubar,menus)})},focusMenubar:function(comp){parts$d.getPart(comp,detail,"menubar").each(function(menubar){SilverMenubar.focus(menubar)})}};return{uid:detail.uid,dom:detail.dom,components:components,apis:apis,behaviours:detail.behaviours}},partMenubar=partType$1.optional({factory:SilverMenubar,name:"menubar",schema:[strict$1("backstage")]}),toolbarFactory=function(spec){return spec.split===ToolbarDrawer.sliding?renderSlidingMoreToolbar:spec.split===ToolbarDrawer.floating?renderFloatingMoreToolbar:renderToolbar},partMultipleToolbar=partType$1.optional({factory:{sketch:function(spec){return CustomList.sketch({uid:spec.uid,dom:spec.dom,listBehaviours:derive$1([Keying.config({mode:"acyclic",selector:".tox-toolbar"})]),makeItem:function(){return renderToolbar({uid:generate$1("multiple-toolbar-item"),backstage:spec.backstage,cyclicKeying:!1,getSink:spec.getSink,initGroups:[],onEscape:function(){return Option.none()}})},setupItem:function(mToolbar,tc,data,index){Toolbar.setGroups(tc,data)},shell:!0})}},name:"multiple-toolbar",schema:[strict$1("dom"),strict$1("onEscape")]}),partToolbar=partType$1.optional({factory:{sketch:function(spec){var renderer=toolbarFactory(spec),toolbarSpec={uid:spec.uid,onEscape:function(){return spec.onEscape(),Option.some(!0)},cyclicKeying:!1,initGroups:[],getSink:spec.getSink,backstage:spec.backstage,moreDrawerData:{lazyToolbar:spec.lazyToolbar,lazyMoreButton:spec.lazyMoreButton}};return renderer(toolbarSpec)}},name:"toolbar",schema:[strict$1("dom"),strict$1("onEscape"),strict$1("getSink")]}),partSocket=partType$1.optional({name:"socket",schema:[strict$1("dom")]}),partSidebar=partType$1.optional({factory:{sketch:renderSidebar},name:"sidebar",schema:[strict$1("dom")]}),partThrobber=partType$1.optional({factory:{sketch:renderThrobber},name:"throbber",schema:[strict$1("dom")]}),OuterContainer=composite$1({name:"OuterContainer",factory:factory$g,configFields:[strict$1("dom"),strict$1("behaviours")],partFields:[partMenubar,partToolbar,partMultipleToolbar,partSocket,partSidebar,partThrobber],apis:{getSocket:function(apis,comp){return apis.getSocket(comp)},setSidebar:function(apis,comp,panelConfigs){apis.setSidebar(comp,panelConfigs)},toggleSidebar:function(apis,comp,name){apis.toggleSidebar(comp,name)},whichSidebar:function(apis,comp){return apis.whichSidebar(comp)},getToolbar:function(apis,comp){return apis.getToolbar(comp)},setToolbar:function(apis,comp,grps){var groups=map(grps,function(grp){return renderToolbarGroup(grp)});apis.setToolbar(comp,groups)},setToolbars:function(apis,comp,ts){var renderedToolbars=map(ts,function(g){return map(g,renderToolbarGroup)});apis.setToolbars(comp,renderedToolbars)},getMoreButton:function(apis,comp){return apis.getMoreButton(comp)},refreshToolbar:function(apis,comp){return apis.refreshToolbar(comp)},getThrobber:function(apis,comp){return apis.getThrobber(comp)},setMenubar:function(apis,comp,menus){apis.setMenubar(comp,menus)},focusMenubar:function(apis,comp){apis.focusMenubar(comp)},focusToolbar:function(apis,comp){apis.focusToolbar(comp)}}}),defaultMenubar="file edit view insert format tools table help",defaultMenus={file:{title:"File",items:"newdocument restoredraft | preview | print | deleteallconversations"},edit:{title:"Edit",items:"undo redo | cut copy paste pastetext | selectall | searchreplace"},view:{title:"View",items:"code | visualaid visualchars visualblocks | spellchecker | preview fullscreen | showcomments"},insert:{title:"Insert",items:"image link media addcomment pageembed template codesample inserttable | charmap emoticons hr | pagebreak nonbreaking anchor toc | insertdatetime"},format:{title:"Format",items:"bold italic underline strikethrough superscript subscript codeformat | formats blockformats fontformats fontsizes align | forecolor backcolor | removeformat"},tools:{title:"Tools",items:"spellchecker spellcheckerlanguage | a11ycheck code wordcount"},table:{title:"Table",items:"inserttable tableprops deletetable row column cell"},help:{title:"Help",items:"help"}},make$8=function(menu,registry,editor){var removedMenuItems=getRemovedMenuItems(editor).split(/[ ,]/);return{text:menu.title,getItems:function(){return bind(menu.items,function(i){var itemName=i.toLowerCase();return 0===itemName.trim().length?[]:exists(removedMenuItems,function(removedMenuItem){return removedMenuItem===itemName})?[]:"separator"===itemName||"|"===itemName?[{type:"separator"}]:registry.menuItems[itemName]?[registry.menuItems[itemName]]:[]})}}},parseItemsString=function(items){return"string"==typeof items?items.split(" "):items},identifyMenus=function(editor,registry){var rawMenuData=merge(defaultMenus,registry.menus),userDefinedMenus=keys(registry.menus).length>0,menubar=void 0===registry.menubar||!0===registry.menubar?parseItemsString(defaultMenubar):parseItemsString(!1===registry.menubar?"":registry.menubar),validMenus=filter(menubar,function(menuName){return userDefinedMenus&&registry.menus.hasOwnProperty(menuName)&&registry.menus[menuName].hasOwnProperty("items")||defaultMenus.hasOwnProperty(menuName)}),menus=map(validMenus,function(menuName){var menuData=rawMenuData[menuName];return make$8({title:menuData.title,items:parseItemsString(menuData.items)},registry,editor)});return filter(menus,function(menu){var isNotSeparator=function(item){return"separator"!==item.type};return menu.getItems().length>0&&exists(menu.getItems(),isNotSeparator)})},fireSkinLoaded$1=function(editor){var done=function(){editor._skinLoaded=!0,Events.fireSkinLoaded(editor)};return function(){editor.initialized?done():editor.on("init",done)}},SkinLoaded={fireSkinLoaded:fireSkinLoaded$1},loadSkin=function(isInline,editor){var skinUiCss,skinUrl=getSkinUrl(editor);skinUrl&&(skinUiCss=skinUrl+"/skin.min.css",editor.contentCSS.push(skinUrl+(isInline?"/content.inline":"/content")+".min.css")),!1===isSkinDisabled(editor)&&skinUiCss?global$7.DOM.styleSheetLoader.load(skinUiCss,SkinLoaded.fireSkinLoaded(editor)):SkinLoaded.fireSkinLoaded(editor)()},iframe=curry(loadSkin,!1),inline=curry(loadSkin,!0),setToolbar=function(editor,uiComponents,rawUiConfig,backstage){var comp=uiComponents.outerContainer,toolbarConfig=rawUiConfig.toolbar,toolbarButtonsConfig=rawUiConfig.buttons;if(isArrayOf(toolbarConfig,isString)){var toolbars=toolbarConfig.map(function(t){var config={toolbar:t,buttons:toolbarButtonsConfig};return identifyButtons(editor,config,{backstage:backstage},Option.none())});OuterContainer.setToolbars(comp,toolbars)}else OuterContainer.setToolbar(comp,identifyButtons(editor,rawUiConfig,{backstage:backstage},Option.none()))},DOM=global$7.DOM,detection=PlatformDetection$1.detect(),isTouch$4=detection.deviceType.isTouch(),setupEvents=function(editor){var contentWindow=editor.getWin(),initialDocEle=editor.getDoc().documentElement,lastWindowDimensions=Cell(Position(contentWindow.innerWidth,contentWindow.innerHeight)),lastDocumentDimensions=Cell(Position(initialDocEle.offsetWidth,initialDocEle.offsetHeight)),resize=function(){var docEle=editor.getDoc().documentElement,outer=lastWindowDimensions.get(),inner=lastDocumentDimensions.get();outer.left()!==contentWindow.innerWidth||outer.top()!==contentWindow.innerHeight?(lastWindowDimensions.set(Position(contentWindow.innerWidth,contentWindow.innerHeight)),Events.fireResizeContent(editor)):inner.left()===docEle.offsetWidth&&inner.top()===docEle.offsetHeight||(lastDocumentDimensions.set(Position(docEle.offsetWidth,docEle.offsetHeight)),Events.fireResizeContent(editor))};DOM.bind(contentWindow,"resize",resize);var elementLoad=capture$1(Element.fromDom(editor.getBody()),"load",resize);editor.on("remove",function(){elementLoad.unbind(),DOM.unbind(contentWindow,"resize",resize)})},render=function(editor,uiComponents,rawUiConfig,backstage,args){var lastToolbarWidth=Cell(0);iframe(editor),attachSystemAfter(Element.fromDom(args.targetNode),uiComponents.mothership),attachSystem(body(),uiComponents.uiMothership),editor.on("init",function(){setToolbar(editor,uiComponents,rawUiConfig,backstage),lastToolbarWidth.set(editor.getWin().innerWidth),OuterContainer.setMenubar(uiComponents.outerContainer,identifyMenus(editor,rawUiConfig)),OuterContainer.setSidebar(uiComponents.outerContainer,rawUiConfig.sidebar),setupEvents(editor)});var socket=OuterContainer.getSocket(uiComponents.outerContainer).getOrDie("Could not find expected socket element");!0===isTouch$4&&setAll$1(socket.element(),{overflow:"scroll","-webkit-overflow-scrolling":"touch"}),setupReadonlyModeSwitch(editor,uiComponents),editor.addCommand("ToggleSidebar",function(ui,value){OuterContainer.toggleSidebar(uiComponents.outerContainer,value),editor.fire("ToggleSidebar")}),editor.addQueryValueHandler("ToggleSidebar",function(){return OuterContainer.whichSidebar(uiComponents.outerContainer)});var drawer=getToolbarDrawer(editor),refreshDrawer=function(){OuterContainer.refreshToolbar(uiComponents.outerContainer)};return drawer!==ToolbarDrawer.sliding&&drawer!==ToolbarDrawer.floating||editor.on("ResizeContent",function(){var width=editor.getWin().innerWidth;width!==lastToolbarWidth.get()&&refreshDrawer(),lastToolbarWidth.set(width)}),{iframeContainer:socket.element().dom(),editorContainer:uiComponents.outerContainer.element().dom()}},Iframe={render:render,getBehaviours:function(_){return[]}},getOrigin=function(element,scroll){return offsetParent(element).orThunk(function(){var marker=Element.fromTag("span");before(element,marker);var offsetParent$1=offsetParent(marker);return remove(marker),offsetParent$1}).map(function(offsetP){var loc=absolute(offsetP);return loc.translate(-scroll.left(),-scroll.top())}).getOrThunk(function(){return Position(0,0)})},adt$c=Adt.generate([{offset:["x","y"]},{absolute:["x","y"]},{fixed:["x","y"]}]),subtract=function(change){return function(point){return point.translate(-change.left(),-change.top())}},add$4=function(change){return function(point){return point.translate(change.left(),change.top())}},transform$1=function(changes){return function(x,y){return foldl(changes,function(rest,f){return f(rest)},Position(x,y))}},asFixed=function(coord,scroll,origin){return coord.fold(transform$1([add$4(origin),subtract(scroll)]),transform$1([subtract(scroll)]),transform$1([]))},asAbsolute=function(coord,scroll,origin){return coord.fold(transform$1([add$4(origin)]),transform$1([]),transform$1([add$4(scroll)]))},asOffset=function(coord,scroll,origin){return coord.fold(transform$1([]),transform$1([subtract(origin)]),transform$1([add$4(scroll),subtract(origin)]))},withinRange=function(coord1,coord2,xRange,yRange,scroll,origin){var a1=asAbsolute(coord1,scroll,origin),a2=asAbsolute(coord2,scroll,origin);return Math.abs(a1.left()-a2.left())<=xRange&&Math.abs(a1.top()-a2.top())<=yRange},toStyles=function(coord,scroll,origin){return coord.fold(function(x,y){return{position:"absolute",left:x+"px",top:y+"px"}},function(x,y){return{position:"absolute",left:x-origin.left()+"px",top:y-origin.top()+"px"}},function(x,y){return{position:"fixed",left:x+"px",top:y+"px"}})},translate$1=function(coord,deltaX,deltaY){return coord.fold(function(x,y){return adt$c.offset(x+deltaX,y+deltaY)},function(x,y){return adt$c.absolute(x+deltaX,y+deltaY)},function(x,y){return adt$c.fixed(x+deltaX,y+deltaY)})},absorb=function(partialCoord,originalCoord,scroll,origin){var absorbOne=function(stencil,nu){return function(optX,optY){var original=stencil(originalCoord,scroll,origin);return nu(optX.getOr(original.left()),optY.getOr(original.top()))}};return partialCoord.fold(absorbOne(asOffset,adt$c.offset),absorbOne(asAbsolute,adt$c.absolute),absorbOne(asFixed,adt$c.fixed))},offset=adt$c.offset,absolute$2=adt$c.absolute,fixed$1=adt$c.fixed,appear=function(component,contextualInfo){add$2(component.element(),contextualInfo.transitionClass),remove$4(component.element(),contextualInfo.fadeOutClass),add$2(component.element(),contextualInfo.fadeInClass)},disappear=function(component,contextualInfo){add$2(component.element(),contextualInfo.transitionClass),remove$4(component.element(),contextualInfo.fadeInClass),add$2(component.element(),contextualInfo.fadeOutClass)},isPartiallyVisible=function(box,viewport){return box.y()<viewport.bottom()&&box.bottom()>viewport.y()},isCompletelyVisible=function(box,viewport){return box.y()>=viewport.y()&&box.bottom()<=viewport.bottom()},getAttr=function(elem,attr){return has$1(elem,attr)?Option.some(parseInt(get$2(elem,attr),10)):Option.none()},getPrior=function(component,dockInfo){var elem=component.element();return getAttr(elem,dockInfo.leftAttr).bind(function(left){return getAttr(elem,dockInfo.topAttr).map(function(top){var w=get$7(component.element()),h=get$6(component.element());return bounds(left,top,w,h)})})},setPrior=function(component,dockInfo,absLeft,absTop){var elem=component.element();set$1(elem,dockInfo.leftAttr,absLeft),set$1(elem,dockInfo.topAttr,absTop)},clearPrior=function(component,dockInfo){var elem=component.element();remove$1(elem,dockInfo.leftAttr),remove$1(elem,dockInfo.topAttr)},morphToAbsolute=function(component,dockInfo,viewport){return getPrior(component,dockInfo).bind(function(box){return isCompletelyVisible(box,viewport)?(clearPrior(component,dockInfo),Option.some(absolute$2(box.x(),box.y()))):Option.none()})},morphToFixed=function(component,dockInfo,viewport,scroll,origin){var loc=absolute(component.element()),box=bounds(loc.left(),loc.top(),get$7(component.element()),get$6(component.element()));if(isCompletelyVisible(box,viewport))return Option.none();setPrior(component,dockInfo,loc.left(),loc.top());var coord=absolute$2(loc.left(),loc.top()),asFixed$1=asFixed(coord,scroll,origin),viewportPt=absolute$2(viewport.x(),viewport.y()),fixedViewport=asFixed(viewportPt,scroll,origin),fixedY=box.y()<=viewport.y()?fixedViewport.top():fixedViewport.top()+viewport.height()-box.height();return Option.some(fixed$1(asFixed$1.left(),fixedY))},getMorph=function(component,dockInfo,viewport,scroll,origin){var isDocked=getRaw(component.element(),"position").is("fixed");return isDocked?morphToAbsolute(component,dockInfo,viewport):morphToFixed(component,dockInfo,viewport,scroll,origin)},refresh$4=function(component,config,state){var viewport=config.lazyViewport(component);config.contextual.each(function(contextInfo){contextInfo.lazyContext(component).each(function(elem){var box$1=box(elem),isVisible=isPartiallyVisible(box$1,viewport),method=isVisible?appear:disappear;method(component,contextInfo)})});var doc=owner(component.element()),scroll=get$8(doc),origin=getOrigin(component.element(),scroll);getMorph(component,config,viewport,scroll,origin).each(function(morph){var styles=toStyles(morph,scroll,origin);setAll$1(component.element(),styles)})},DockingApis=Object.freeze({refresh:refresh$4}),events$f=function(dockInfo,dockState){return derive([run(transitionend(),function(component,simulatedEvent){dockInfo.contextual.each(function(contextInfo){eq(component.element(),simulatedEvent.event().target())&&(remove$4(component.element(),contextInfo.transitionClass),simulatedEvent.stop())})}),run(windowScroll(),function(component,_){refresh$4(component,dockInfo)})])},ActiveDocking=Object.freeze({events:events$f}),defaultLazyViewport=function(_component){var scroll=get$8();return bounds(scroll.left(),scroll.top(),domGlobals.window.innerWidth,domGlobals.window.innerHeight)},DockingSchema=[optionObjOf("contextual",[strict$1("fadeInClass"),strict$1("fadeOutClass"),strict$1("transitionClass"),strict$1("lazyContext")]),defaulted$1("lazyViewport",defaultLazyViewport),strict$1("leftAttr"),strict$1("topAttr")],Docking=create$1({fields:DockingSchema,name:"docking",active:ActiveDocking,apis:DockingApis}),render$1=function(editor,uiComponents,rawUiConfig,backstage,args){var floatContainer,DOM=global$7.DOM,useFixedToolbarContainer=useFixedContainer(editor),splitSetting=getToolbarDrawer(editor),split=splitSetting===ToolbarDrawer.sliding||splitSetting===ToolbarDrawer.floating;inline(editor);var calcPosition=function(offset){void 0===offset&&(offset=0);var location=absolute(Element.fromDom(editor.getBody()));return{top:Math.round(location.top()-get$6(floatContainer.element()))+offset,left:Math.round(location.left())}},setChromePosition=function(toolbar){var isDocked=getRaw(floatContainer.element(),"position").is("fixed"),offset=split?toolbar.fold(function(){return 0},function(tbar){return tbar.components().length>1?get$6(tbar.components()[1].element()):0}):0,position=calcPosition(offset);isDocked?setAll(floatContainer.element(),tupleMap(position,function(value,key){return{k:"data-dock-"+key,v:value}})):setAll$1(floatContainer.element(),map$1(position,function(value){return value+"px"})),Docking.refresh(floatContainer)},updateChromeUi=function(){var toolbar=OuterContainer.getToolbar(uiComponents.outerContainer);split&&OuterContainer.refreshToolbar(uiComponents.outerContainer),useFixedToolbarContainer||setChromePosition(toolbar)},show=function(){set$2(uiComponents.outerContainer.element(),"display","flex"),DOM.addClass(editor.getBody(),"mce-edit-focus"),remove$6(uiComponents.uiMothership.element(),"display"),updateChromeUi()},hide=function(){uiComponents.outerContainer&&(set$2(uiComponents.outerContainer.element(),"display","none"),DOM.removeClass(editor.getBody(),"mce-edit-focus")),set$2(uiComponents.uiMothership.element(),"display","none")},render=function(){if(floatContainer)show();else{floatContainer=uiComponents.outerContainer;var uiContainer=getUiContainer(editor);attachSystem(uiContainer,uiComponents.mothership),attachSystem(uiContainer,uiComponents.uiMothership),setToolbar(editor,uiComponents,rawUiConfig,backstage),OuterContainer.setMenubar(uiComponents.outerContainer,identifyMenus(editor,rawUiConfig)),useFixedToolbarContainer||set$2(floatContainer.element(),"position","absolute"),updateChromeUi(),show(),editor.on("NodeChange ResizeWindow",updateChromeUi),editor.on("activate",show),editor.on("deactivate",hide),editor.nodeChanged()}};return editor.on("focus",render),editor.on("blur hide",hide),editor.on("init",function(){editor.hasFocus()&&render()}),setupReadonlyModeSwitch(editor,uiComponents),{editorContainer:uiComponents.outerContainer.element().dom()}},getBehaviours$2=function(editor){return useFixedContainer(editor)?[]:[Docking.config({leftAttr:"data-dock-left",topAttr:"data-dock-top",contextual:{lazyContext:function(_){return Option.from(editor).map(function(ed){return Element.fromDom(ed.getBody())})},fadeInClass:"tox-toolbar-dock-fadein",fadeOutClass:"tox-toolbar-dock-fadeout",transitionClass:"tox-toolbar-dock-transition"}}),Focusing.config({})]},Inline={render:render$1,getBehaviours:getBehaviours$2},register$5=function(editor){var alignToolbarButtons=[{name:"alignleft",text:"Align left",cmd:"JustifyLeft",icon:"align-left"},{name:"aligncenter",text:"Align center",cmd:"JustifyCenter",icon:"align-center"},{name:"alignright",text:"Align right",cmd:"JustifyRight",icon:"align-right"},{name:"alignjustify",text:"Justify",cmd:"JustifyFull",icon:"align-justify"}];global$e.each(alignToolbarButtons,function(item){editor.ui.registry.addToggleButton(item.name,{tooltip:item.text,onAction:function(){return editor.execCommand(item.cmd)},icon:item.icon,onSetup:onSetupFormatToggle(editor,item.name)})});var alignNoneToolbarButton={name:"alignnone",text:"No alignment",cmd:"JustifyNone",icon:"align-none"};editor.ui.registry.addButton(alignNoneToolbarButton.name,{tooltip:alignNoneToolbarButton.text,onAction:function(){return editor.execCommand(alignNoneToolbarButton.cmd)},icon:alignNoneToolbarButton.icon})},AlignmentButtons={register:register$5},toggleFormat=function(editor,fmt){return function(){editor.execCommand("mceToggleFormat",!1,fmt)}},registerFormatButtons=function(editor){global$e.each([{name:"bold",text:"Bold",icon:"bold"},{name:"italic",text:"Italic",icon:"italic"},{name:"underline",text:"Underline",icon:"underline"},{name:"strikethrough",text:"Strikethrough",icon:"strike-through"},{name:"subscript",text:"Subscript",icon:"subscript"},{name:"superscript",text:"Superscript",icon:"superscript"}],function(btn,idx){editor.ui.registry.addToggleButton(btn.name,{tooltip:btn.text,icon:btn.icon,onSetup:onSetupFormatToggle(editor,btn.name),onAction:toggleFormat(editor,btn.name)})});for(var i=1;i<=6;i++){var name="h"+i;editor.ui.registry.addToggleButton(name,{text:name.toUpperCase(),tooltip:"Heading "+i,onSetup:onSetupFormatToggle(editor,name),onAction:toggleFormat(editor,name)})}},registerCommandButtons=function(editor){global$e.each([{name:"cut",text:"Cut",action:"Cut",icon:"cut"},{name:"copy",text:"Copy",action:"Copy",icon:"copy"},{name:"paste",text:"Paste",action:"Paste",icon:"paste"},{name:"help",text:"Help",action:"mceHelp",icon:"help"},{name:"selectall",text:"Select all",action:"SelectAll",icon:"select-all"},{name:"newdocument",text:"New document",action:"mceNewDocument",icon:"new-document"},{name:"removeformat",text:"Clear formatting",action:"RemoveFormat",icon:"remove-formatting"},{name:"remove",text:"Remove",action:"Delete",icon:"remove"}],function(btn){editor.ui.registry.addButton(btn.name,{tooltip:btn.text,icon:btn.icon,onAction:function(){return editor.execCommand(btn.action)}})})},registerCommandToggleButtons=function(editor){global$e.each([{name:"blockquote",text:"Blockquote",action:"mceBlockQuote",icon:"quote"}],function(btn){editor.ui.registry.addToggleButton(btn.name,{tooltip:btn.text,icon:btn.icon,onAction:function(){return editor.execCommand(btn.action)},onSetup:onSetupFormatToggle(editor,btn.name)})})},registerButtons=function(editor){registerFormatButtons(editor),registerCommandButtons(editor),registerCommandToggleButtons(editor)},registerMenuItems=function(editor){global$e.each([{name:"bold",text:"Bold",action:"Bold",icon:"bold",shortcut:"Meta+B"},{name:"italic",text:"Italic",action:"Italic",icon:"italic",shortcut:"Meta+I"},{name:"underline",text:"Underline",action:"Underline",icon:"underline",shortcut:"Meta+U"},{name:"strikethrough",text:"Strikethrough",action:"Strikethrough",icon:"strike-through",shortcut:""},{name:"subscript",text:"Subscript",action:"Subscript",icon:"subscript",shortcut:""},{name:"superscript",text:"Superscript",action:"Superscript",icon:"superscript",shortcut:""},{name:"removeformat",text:"Clear formatting",action:"RemoveFormat",icon:"remove-formatting",shortcut:""},{name:"newdocument",text:"New document",action:"mceNewDocument",icon:"new-document",shortcut:""},{name:"cut",text:"Cut",action:"Cut",icon:"cut",shortcut:"Meta+X"},{name:"copy",text:"Copy",action:"Copy",icon:"copy",shortcut:"Meta+C"},{name:"paste",text:"Paste",action:"Paste",icon:"paste",shortcut:"Meta+V"},{name:"selectall",text:"Select all",action:"SelectAll",icon:"select-all",shortcut:"Meta+A"}],function(btn){editor.ui.registry.addMenuItem(btn.name,{text:btn.text,icon:btn.icon,shortcut:btn.shortcut,onAction:function(){return editor.execCommand(btn.action)}})}),editor.ui.registry.addMenuItem("codeformat",{text:"Code",icon:"sourcecode",onAction:toggleFormat(editor,"code")})},register$6=function(editor){registerButtons(editor),registerMenuItems(editor)},SimpleControls={register:register$6},toggleUndoRedoState=function(api,editor,type){var checkState=function(){return!!editor.undoManager&&editor.undoManager[type]()},onUndoStateChange=function(){api.setDisabled(editor.readonly||!checkState())};return api.setDisabled(!checkState()),editor.on("Undo Redo AddUndo TypingUndo ClearUndos SwitchMode",onUndoStateChange),function(){return editor.off("Undo Redo AddUndo TypingUndo ClearUndos SwitchMode",onUndoStateChange)}},registerMenuItems$1=function(editor){editor.ui.registry.addMenuItem("undo",{text:"Undo",icon:"undo",shortcut:"Meta+Z",onSetup:function(api){return toggleUndoRedoState(api,editor,"hasUndo")},onAction:function(){return editor.execCommand("undo")}}),editor.ui.registry.addMenuItem("redo",{text:"Redo",icon:"redo",shortcut:"Meta+Y",onSetup:function(api){return toggleUndoRedoState(api,editor,"hasRedo")},onAction:function(){return editor.execCommand("redo")}})},registerButtons$1=function(editor){editor.ui.registry.addButton("undo",{tooltip:"Undo",icon:"undo",onSetup:function(api){return toggleUndoRedoState(api,editor,"hasUndo")},onAction:function(){return editor.execCommand("undo")}}),editor.ui.registry.addButton("redo",{tooltip:"Redo",icon:"redo",onSetup:function(api){return toggleUndoRedoState(api,editor,"hasRedo")},onAction:function(){return editor.execCommand("redo")}})},register$7=function(editor){registerMenuItems$1(editor),registerButtons$1(editor)},UndoRedo={register:register$7},toggleVisualAidState=function(api,editor){api.setActive(editor.hasVisual);var onVisualAid=function(e){api.setActive(e.hasVisual)};return editor.on("VisualAid",onVisualAid),function(){return editor.off("VisualAid",onVisualAid)}},registerMenuItems$2=function(editor){editor.ui.registry.addToggleMenuItem("visualaid",{text:"Visual aids",onSetup:function(api){return toggleVisualAidState(api,editor)},onAction:function(){editor.execCommand("mceToggleVisualAid")}})},registerToolbarButton=function(editor){editor.ui.registry.addButton("visualaid",{tooltip:"Visual aids",text:"Visual aids",onAction:function(){return editor.execCommand("mceToggleVisualAid")}})},register$8=function(editor){registerToolbarButton(editor),registerMenuItems$2(editor)},VisualAid={register:register$8},toggleOutdentState=function(api,editor){api.setDisabled(!editor.queryCommandState("outdent"));var onNodeChange=function(){api.setDisabled(!editor.queryCommandState("outdent"))};return editor.on("NodeChange",onNodeChange),function(){return editor.off("NodeChange",onNodeChange)}},registerButtons$2=function(editor){editor.ui.registry.addButton("outdent",{tooltip:"Decrease indent",icon:"outdent",onSetup:function(api){return toggleOutdentState(api,editor)},onAction:function(){return editor.execCommand("outdent")}}),editor.ui.registry.addButton("indent",{tooltip:"Increase indent",icon:"indent",onAction:function(){return editor.execCommand("indent")}})},register$9=function(editor){registerButtons$2(editor)},IndentOutdent={register:register$9},register$a=function(editor,backstage){alignSelectMenu(editor,backstage),fontSelectMenu(editor,backstage),styleSelectMenu(editor,backstage),formatSelectMenu(editor,backstage),fontsizeSelectMenu(editor,backstage)},ComplexControls={register:register$a},setup$6=function(editor,backstage){AlignmentButtons.register(editor),SimpleControls.register(editor),ComplexControls.register(editor,backstage),UndoRedo.register(editor),ColorSwatch.register(editor),VisualAid.register(editor),IndentOutdent.register(editor)},FormatControls={setup:setup$6},nu$d=function(x,y){return{anchor:"makeshift",x:x,y:y}},transpose$1=function(pos,dx,dy){return nu$d(pos.x+dx,pos.y+dy)},fromPageXY=function(e){return nu$d(e.pageX,e.pageY)},fromClientXY=function(e){return nu$d(e.clientX,e.clientY)},transposeContentAreaContainer=function(element,pos){var containerPos=global$7.DOM.getPos(element);return transpose$1(pos,containerPos.x,containerPos.y)},getPointAnchor=function(editor,e){return"contextmenu"===e.type?editor.inline?fromPageXY(e):transposeContentAreaContainer(editor.getContentAreaContainer(),fromClientXY(e)):getSelectionAnchor(editor)},getSelectionAnchor=function(editor){return{anchor:"selection",root:Element.fromDom(editor.selection.getNode())}},getNodeAnchor$1=function(editor){return{anchor:"node",node:Option.some(Element.fromDom(editor.selection.getNode())),root:Element.fromDom(editor.getBody())}},patchPipeConfig=function(config){return"string"==typeof config?config.split(/[ ,]/):config},shouldNeverUseNative=function(editor){return editor.settings.contextmenu_never_use_native||!1
},getMenuItems=function(editor,name,defaultItems){var contextMenus=editor.ui.registry.getAll().contextMenus;return get(editor.settings,name).map(patchPipeConfig).getOrThunk(function(){return filter(patchPipeConfig(defaultItems),function(item){return has(contextMenus,item)})})},isContextMenuDisabled=function(editor){return!1===editor.getParam("contextmenu")},getContextMenu=function(editor){return getMenuItems(editor,"contextmenu","link linkchecker image imagetools table spellchecker configurepermanentpen")},Settings$1={shouldNeverUseNative:shouldNeverUseNative,getContextMenu:getContextMenu,isContextMenuDisabled:isContextMenuDisabled},isSeparator$1=function(item){return isString(item)?"|"===item:"separator"===item.type},separator$3={type:"separator"},makeContextItem=function(item){if(isString(item))return item;switch(item.type){case"separator":return separator$3;case"submenu":return{type:"nestedmenuitem",text:item.text,icon:item.icon,getSubmenuItems:function(){var items=item.getSubmenuItems();return isString(items)?items:map(items,makeContextItem)}};default:return{type:"menuitem",text:item.text,icon:item.icon,onAction:noarg(item.onAction)}}},addContextMenuGroup=function(xs,groupItems){if(0===groupItems.length)return xs;var lastMenuItem=last(xs).filter(function(item){return!isSeparator$1(item)}),before=lastMenuItem.fold(function(){return[]},function(_){return[separator$3]});return xs.concat(before).concat(groupItems).concat([separator$3])},generateContextMenu=function(contextMenus,menuConfig,selectedElement){var items=foldl(menuConfig,function(acc,name){if(has(contextMenus,name)){var items_1=contextMenus[name].update(selectedElement);if(isString(items_1))return addContextMenuGroup(acc,items_1.split(" "));if(items_1.length>0){var allItems=map(items_1,makeContextItem);return addContextMenuGroup(acc,allItems)}return acc}return acc.concat([name])},[]);return items.length>0&&isSeparator$1(items[items.length-1])&&items.pop(),items},isNativeOverrideKeyEvent=function(editor,e){return e.ctrlKey&&!Settings$1.shouldNeverUseNative(editor)},setup$7=function(editor,lazySink,backstage){var contextmenu=build$1(InlineView.sketch({dom:{tag:"div"},lazySink:lazySink,onEscape:function(){return editor.focus()},fireDismissalEventInstead:{},inlineBehaviours:derive$1([config("dismissContextMenu",[run(dismissRequested(),function(comp,se){Sandboxing.close(comp),editor.focus()})])])}));editor.on("init",function(){editor.on("contextmenu",function(e){if(Settings$1.shouldNeverUseNative(editor)&&e.preventDefault(),!isNativeOverrideKeyEvent(editor,e)&&!Settings$1.isContextMenuDisabled(editor)){var isTriggeredByKeyboardEvent=2!==e.button||e.target===editor.getBody(),anchorSpec=isTriggeredByKeyboardEvent?getNodeAnchor$1(editor):getPointAnchor(editor,e),registry=editor.ui.registry.getAll(),menuConfig=Settings$1.getContextMenu(editor),selectedElement=isTriggeredByKeyboardEvent?editor.selection.getStart(!0):e.target,items=generateContextMenu(registry.contextMenus,menuConfig,selectedElement);build$2(items,ItemResponse$1.CLOSE_ON_EXECUTE,backstage).map(function(menuData){e.preventDefault(),InlineView.showMenuAt(contextmenu,anchorSpec,{menu:{markers:markers$1("normal")},data:menuData})})}})})},parseToInt=function(val){var re=/^[0-9\.]+(|px)$/i;return re.test(""+val)?Option.some(parseInt(val,10)):Option.none()},numToPx=function(val){return isNumber(val)?val+"px":val},Utils={parseToInt:parseToInt,numToPx:numToPx},initialAttribute="data-initial-z-index",resetZIndex=function(blocker){parent(blocker.element()).filter(isElement).each(function(root){var initZIndex=get$2(root,initialAttribute);has$1(root,initialAttribute)?set$2(root,"z-index",initZIndex):remove$6(root,"z-index"),remove$1(root,initialAttribute)})},changeZIndex=function(blocker){parent(blocker.element()).filter(isElement).each(function(root){getRaw(root,"z-index").each(function(zindex){set$1(root,initialAttribute,zindex)}),set$2(root,"z-index",get$4(blocker.element(),"z-index"))})},instigate=function(anyComponent,blocker){anyComponent.getSystem().addToGui(blocker),changeZIndex(blocker)},discard=function(blocker){resetZIndex(blocker),blocker.getSystem().removeFromGui(blocker)},get$d=function(component,snapsInfo){var element=component.element(),x=parseInt(get$2(element,snapsInfo.leftAttr),10),y=parseInt(get$2(element,snapsInfo.topAttr),10);return isNaN(x)||isNaN(y)?Option.none():Option.some(Position(x,y))},set$8=function(component,snapsInfo,pt){var element=component.element();set$1(element,snapsInfo.leftAttr,pt.left()+"px"),set$1(element,snapsInfo.topAttr,pt.top()+"px")},clear=function(component,snapsInfo){var element=component.element();remove$1(element,snapsInfo.leftAttr),remove$1(element,snapsInfo.topAttr)},getCoords=function(component,snapInfo,coord,delta){return get$d(component,snapInfo).fold(function(){return coord},function(fixed){return fixed$1(fixed.left()+delta.left(),fixed.top()+delta.top())})},moveOrSnap=function(component,snapInfo,coord,delta,scroll,origin){var newCoord=getCoords(component,snapInfo,coord,delta),snap=findSnap(component,snapInfo,newCoord,scroll,origin),fixedCoord=asFixed(newCoord,scroll,origin);return set$8(component,snapInfo,fixedCoord),snap.fold(function(){return{coord:fixed$1(fixedCoord.left(),fixedCoord.top()),extra:Option.none()}},function(spanned){return{coord:spanned.output(),extra:spanned.extra()}})},stopDrag=function(component,snapInfo){clear(component,snapInfo)},findSnap=function(component,snapInfo,newCoord,scroll,origin){var snaps=snapInfo.getSnapPoints(component);return findMap(snaps,function(snap){var sensor=snap.sensor(),inRange=withinRange(newCoord,sensor,snap.range().left(),snap.range().top(),scroll,origin);return inRange?Option.some({output:constant(absorb(snap.output(),newCoord,scroll,origin)),extra:snap.extra}):Option.none()})},getCurrentCoord=function(target){return getRaw(target,"left").bind(function(left){return getRaw(target,"top").bind(function(top){return getRaw(target,"position").map(function(position){var nu="fixed"===position?fixed$1:offset;return nu(parseInt(left,10),parseInt(top,10))})})}).getOrThunk(function(){var location=absolute(target);return absolute$2(location.left(),location.top())})},clampCoords=function(component,coords,scroll,origin,startData){var bounds=startData.bounds,absoluteCoord=asAbsolute(coords,scroll,origin),newX=cap(absoluteCoord.left(),bounds.x(),bounds.width()-startData.width),newY=cap(absoluteCoord.top(),bounds.y(),bounds.height()-startData.height),newCoords=absolute$2(newX,newY);return coords.fold(function(){var offset$1=asOffset(newCoords,scroll,origin);return offset(offset$1.left(),offset$1.top())},function(){return newCoords},function(){var fixed=asFixed(newCoords,scroll,origin);return fixed$1(fixed.left(),fixed.top())})},calcNewCoord=function(component,optSnaps,currentCoord,scroll,origin,delta,startData){var newCoord=optSnaps.fold(function(){var translated=translate$1(currentCoord,delta.left(),delta.top()),fixedCoord=asFixed(translated,scroll,origin);return fixed$1(fixedCoord.left(),fixedCoord.top())},function(snapInfo){var snapping=moveOrSnap(component,snapInfo,currentCoord,delta,scroll,origin);return snapping.extra.each(function(extra){snapInfo.onSensor(component,extra)}),snapping.coord});return clampCoords(component,newCoord,scroll,origin,startData)},dragBy=function(component,dragConfig,startData,delta){var target=dragConfig.getTarget(component.element());if(dragConfig.repositionTarget){var doc=owner(component.element()),scroll=get$8(doc),origin=getOrigin(target,scroll),currentCoord=getCurrentCoord(target),newCoord=calcNewCoord(component,dragConfig.snaps,currentCoord,scroll,origin,delta,startData),styles=toStyles(newCoord,scroll,origin);setAll$1(target,styles)}dragConfig.onDrag(component,target,delta)},calcStartData=function(dragConfig,comp){return{bounds:dragConfig.getBounds(),height:getOuter$1(comp.element()),width:getOuter$2(comp.element())}},defaultLazyViewport$1=function(){var scroll=get$8();return{x:scroll.left,y:scroll.top,width:constant(domGlobals.window.innerWidth),height:constant(domGlobals.window.innerHeight),bottom:constant(scroll.top()+domGlobals.window.innerHeight),right:constant(scroll.left()+domGlobals.window.innerWidth)}},SnapSchema=optionObjOf("snaps",[strict$1("getSnapPoints"),onHandler("onSensor"),strict$1("leftAttr"),strict$1("topAttr"),defaulted$1("lazyViewport",defaultLazyViewport$1)]),init$b=function(dragApi){return derive([run(mousedown(),dragApi.forceDrop),run(mouseup(),dragApi.drop),run(mousemove(),function(comp,simulatedEvent){dragApi.move(simulatedEvent.event())}),run(mouseout(),dragApi.delayDrop)])},getData$1=function(event){return Option.from(Position(event.x(),event.y()))},getDelta$1=function(old,nu){return Position(nu.left()-old.left(),nu.top()-old.top())},MouseData=Object.freeze({getData:getData$1,getDelta:getDelta$1}),handlers=function(dragConfig,dragState){var updateStartState=function(comp){dragState.setStartData(calcStartData(dragConfig,comp))};return derive([run(windowScroll(),updateStartState),run(mousedown(),function(component,simulatedEvent){var raw=simulatedEvent.event().raw();if(0===raw.button){simulatedEvent.stop();var dragApi={drop:function(){stop()},delayDrop:function(){delayDrop.schedule()},forceDrop:function(){stop()},move:function(event){delayDrop.cancel();var delta=dragState.update(MouseData,event),dragStartData=dragState.getStartData().getOrThunk(function(){return calcStartData(dragConfig,component)});delta.each(function(dlt){dragBy(component,dragConfig,dragStartData,dlt)})}},blocker=component.getSystem().build(Container.sketch({dom:{styles:{left:"0px",top:"0px",width:"100%",height:"100%",position:"fixed","z-index":"1000000000000000"},classes:[dragConfig.blockerClass]},events:init$b(dragApi)})),stop=function(){discard(blocker),dragConfig.snaps.each(function(snapInfo){stopDrag(component,snapInfo)});var target=dragConfig.getTarget(component.element());dragState.reset(),dragConfig.onDrop(component,target)},delayDrop=DelayedFunction(stop,200),start=function(){updateStartState(component),instigate(component,blocker)};start()}})])},schema$r=[defaulted$1("useFixed",!1),strict$1("blockerClass"),defaulted$1("getTarget",identity),defaulted$1("onDrag",noop),defaulted$1("repositionTarget",!0),onHandler("onDrop"),defaultedFunction("getBounds",win),SnapSchema,output("dragger",{handlers:handlers})],getDataFrom=function(touches){var touch=touches[0];return Option.some(Position(touch.clientX,touch.clientY))},getData$2=function(event){var raw=event.raw(),touches=raw.touches;return 1===touches.length?getDataFrom(touches):Option.none()},getDelta$2=function(old,nu){return Position(nu.left()-old.left(),nu.top()-old.top())},TouchData=Object.freeze({getData:getData$2,getDelta:getDelta$2}),handlers$1=function(dragConfig,dragState){var updateStartState=function(comp){dragState.setStartData(calcStartData(dragConfig,comp))};return derive([run(windowScroll(),updateStartState),run(touchstart(),function(component,simulatedEvent){updateStartState(component),simulatedEvent.stop()}),run(touchmove(),function(component,simulatedEvent){simulatedEvent.stop();var delta=dragState.update(TouchData,simulatedEvent.event()),dragStartData=dragState.getStartData().getOrThunk(function(){return calcStartData(dragConfig,component)});delta.each(function(dlt){dragBy(component,dragConfig,dragStartData,dlt)})}),run(touchend(),function(component,simulatedEvent){dragConfig.snaps.each(function(snapInfo){stopDrag(component,snapInfo)});var target=dragConfig.getTarget(component.element());dragState.reset(),dragConfig.onDrop(component,target)})])},schema$s=[defaulted$1("useFixed",!1),defaulted$1("getTarget",identity),defaulted$1("onDrag",noop),defaulted$1("repositionTarget",!0),defaulted$1("onDrop",noop),defaultedFunction("getBounds",win),SnapSchema,output("dragger",{handlers:handlers$1})],mouse=schema$r,touch=schema$s,DraggingBranches=Object.freeze({mouse:mouse,touch:touch}),init$c=function(){var previous=Option.none(),startData=Option.none(),reset=function(){previous=Option.none(),startData=Option.none()},calculateDelta=function(mode,nu){var result=previous.map(function(old){return mode.getDelta(old,nu)});return previous=Option.some(nu),result},update=function(mode,dragEvent){return mode.getData(dragEvent).bind(function(nuData){return calculateDelta(mode,nuData)})},setStartData=function(data){startData=Option.some(data)},getStartData=function(){return startData},readState=constant({});return nu$5({readState:readState,reset:reset,update:update,getStartData:getStartData,setStartData:setStartData})},DragState=Object.freeze({init:init$c}),Dragging=createModes$1({branchKey:"mode",branches:DraggingBranches,name:"dragging",active:{events:function(dragConfig,dragState){var dragger=dragConfig.dragger;return dragger.handlers(dragConfig,dragState)}},extra:{snap:MixedBag(["sensor","range","output"],["extra"])},state:DragState});(function(ResizeTypes){ResizeTypes[ResizeTypes.None=0]="None",ResizeTypes[ResizeTypes.Both=1]="Both",ResizeTypes[ResizeTypes.Vertical=2]="Vertical"})(ResizeTypes||(ResizeTypes={}));var calcCappedSize=function(originalSize,delta,minSize,maxSize){var newSize=originalSize+delta,minOverride=minSize.filter(function(min){return newSize<min}),maxOverride=maxSize.filter(function(max){return newSize>max});return minOverride.or(maxOverride).getOr(newSize)},getDimensions=function(editor,deltas,resizeType,originalHeight,originalWidth){var dimensions={};return dimensions.height=calcCappedSize(originalHeight,deltas.top(),getMinHeightSetting(editor),getMaxHeightSetting(editor)),resizeType===ResizeTypes.Both&&(dimensions.width=calcCappedSize(originalWidth,deltas.left(),getMinWidthSetting(editor),getMaxWidthSetting(editor))),dimensions},resize$3=function(editor,deltas,resizeType){var container=Element.fromDom(editor.getContainer()),dimensions=getDimensions(editor,deltas,resizeType,get$6(container),get$7(container));each$1(dimensions,function(val,dim){return set$2(container,dim,Utils.numToPx(val))}),Events.fireResizeEditor(editor)},isHidden$1=function(elm){if(1===elm.nodeType){if("BR"===elm.nodeName||elm.getAttribute("data-mce-bogus"))return!0;if("bookmark"===elm.getAttribute("data-mce-type"))return!0}return!1},renderElementPath=function(editor,settings){settings.delimiter||(settings.delimiter="»");var getDataPath=function(data){var parts=data||[],newPathElements=map(parts,function(part,index){return Button.sketch({dom:{tag:"div",classes:["tox-statusbar__path-item"],attributes:{role:"button","data-index":index,"tab-index":-1,"aria-level":index+1},innerHtml:part.name},action:function(btn){editor.focus(),editor.selection.select(part.element),editor.nodeChanged()}})}),divider={dom:{tag:"div",classes:["tox-statusbar__path-divider"],attributes:{"aria-hidden":!0},innerHtml:" "+settings.delimiter+" "}};return foldl(newPathElements.slice(1),function(acc,element){var newAcc=acc;return newAcc.push(divider),newAcc.push(element),newAcc},[newPathElements[0]])},updatePath=function(parents){for(var newPath=[],i=parents.length;i-- >0;){var parent=parents[i];if(1===parent.nodeType&&!isHidden$1(parent)){var args=editor.fire("ResolveName",{name:parent.nodeName.toLowerCase(),target:parent});if(args.isDefaultPrevented()||newPath.push({name:args.name,element:parent}),args.isPropagationStopped())break}}return newPath};return{dom:{tag:"div",classes:["tox-statusbar__path"],attributes:{role:"navigation"}},behaviours:derive$1([Keying.config({mode:"flow",selector:"div[role=button]"}),Tabstopping.config({}),Replacing.config({}),config("elementPathEvents",[runOnAttached(function(comp,e){editor.shortcuts.add("alt+F11","focus statusbar elementpath",function(){return Keying.focusIn(comp)}),editor.on("NodeChange",function(e){var newPath=updatePath(e.parents);newPath.length>0&&Replacing.set(comp,getDataPath(newPath))})})])]),components:[]}},ElementPath={renderElementPath:renderElementPath},renderWordCount=function(editor,providersBackstage){var _a,replaceCountText=function(comp,count,mode){return Replacing.set(comp,[text(providersBackstage.translate(["{0} "+mode,count[mode]]))])};return Button.sketch({dom:{tag:"button",classes:["tox-statusbar__wordcount"]},components:[],buttonBehaviours:derive$1([Tabstopping.config({}),Replacing.config({}),Representing.config({store:{mode:"memory",initialValue:{mode:"words",count:{words:0,characters:0}}}}),config("wordcount-events",[run(tapOrClick(),function(comp){var currentVal=Representing.getValue(comp),newMode="words"===currentVal.mode?"characters":"words";Representing.setValue(comp,{mode:newMode,count:currentVal.count}),replaceCountText(comp,currentVal.count,newMode)}),runOnAttached(function(comp){editor.on("wordCountUpdate",function(e){var mode=Representing.getValue(comp).mode;Representing.setValue(comp,{mode:mode,count:e.wordCount}),replaceCountText(comp,e.wordCount,mode)})})])]),eventOrder:(_a={},_a[tapOrClick()]=["wordcount-events","alloy.base.behaviour"],_a)})},renderStatusbar=function(editor,providersBackstage){var renderResizeHandlerIcon=function(resizeType){return{dom:{tag:"div",classes:["tox-statusbar__resize-handle"],attributes:{title:providersBackstage.translate("Resize")},innerHtml:get$c("resize-handle",providersBackstage.icons)},behaviours:derive$1([Dragging.config({mode:"mouse",repositionTarget:!1,onDrag:function(comp,target,delta){resize$3(editor,delta,resizeType)},blockerClass:"tox-blocker"})])}},renderBranding=function(){var label=global$5.translate(["Powered by {0}","Tiny"]),linkHtml='<a href="https://www.tiny.cloud/?utm_campaign=editor_referral&amp;utm_medium=poweredby&amp;utm_source=tinymce&amp;utm_content=v5" rel="noopener" target="_blank" tabindex="-1" aria-label="'+label+'">'+label+"</a>";return{dom:{tag:"span",classes:["tox-statusbar__branding"],innerHtml:linkHtml}}},getResizeType=function(editor){var fallback=!contains$1(editor.settings.plugins,"autoresize"),resize=editor.getParam("resize",fallback);return!1===resize?ResizeTypes.None:"both"===resize?ResizeTypes.Both:ResizeTypes.Vertical},getTextComponents=function(){var components=[];return editor.getParam("elementpath",!0,"boolean")&&components.push(ElementPath.renderElementPath(editor,{})),contains$1(editor.settings.plugins,"wordcount")&&components.push(renderWordCount(editor,providersBackstage)),editor.getParam("branding",!0,"boolean")&&components.push(renderBranding()),components.length>0?[{dom:{tag:"div",classes:["tox-statusbar__text-container"]},components:components}]:[]},getComponents=function(){var components=getTextComponents(),resizeType=getResizeType(editor);return resizeType!==ResizeTypes.None&&components.push(renderResizeHandlerIcon(resizeType)),components};return{dom:{tag:"div",classes:["tox-statusbar"]},components:getComponents()}},setup$8=function(editor){var isInline=editor.getParam("inline",!1,"boolean"),mode=isInline?Inline:Iframe,lazyOuterContainer=Option.none(),platform=PlatformDetection$1.detect(),isIE=platform.browser.isIE(),platformClasses=isIE?["tox-platform-ie"]:[],dirAttributes=global$5.isRtl()?{attributes:{dir:"rtl"}}:{},sink=build$1({dom:__assign({tag:"div",classes:["tox","tox-silver-sink","tox-tinymce-aux"].concat(platformClasses)},dirAttributes),behaviours:derive$1([Positioning.config({useFixed:!1})])}),memAnchorBar=record({dom:{tag:"div",classes:["tox-anchorbar"]}}),lazyAnchorBar=function(){return lazyOuterContainer.bind(function(container){return memAnchorBar.getOpt(container)}).getOrDie("Could not find a anchor bar element")},lazyMoreButton=function(){return lazyOuterContainer.bind(function(container){return OuterContainer.getMoreButton(container)}).getOrDie("Could not find more button element")},lazyToolbar=function(){return lazyOuterContainer.bind(function(container){return OuterContainer.getToolbar(container)}).getOrDie("Could not find more toolbar element")},lazyThrobber=function(){return lazyOuterContainer.bind(function(container){return OuterContainer.getThrobber(container)}).getOrDie("Could not find throbber element")},backstage=init$8(sink,editor,lazyAnchorBar,lazyMoreButton),lazySink=function(){return Result.value(sink)},partMenubar=OuterContainer.parts().menubar({dom:{tag:"div",classes:["tox-menubar"]},backstage:backstage,onEscape:function(){editor.focus()}}),toolbarDrawer=function(editor){return getToolbarDrawer(editor)},partToolbar=OuterContainer.parts().toolbar({dom:{tag:"div",classes:["tox-toolbar"]},getSink:lazySink,backstage:backstage,onEscape:function(){editor.focus()},split:toolbarDrawer(editor),lazyToolbar:lazyToolbar,lazyMoreButton:lazyMoreButton}),partMultipleToolbar=OuterContainer.parts()["multiple-toolbar"]({dom:{tag:"div",classes:["tox-toolbar-overlord"]},onEscape:function(){}}),partSocket=OuterContainer.parts().socket({dom:{tag:"div",classes:["tox-edit-area"]}}),partSidebar=OuterContainer.parts().sidebar({dom:{tag:"div",classes:["tox-sidebar"]}}),partThrobber=OuterContainer.parts().throbber({dom:{tag:"div",classes:["tox-throbber"]},backstage:backstage}),statusbar=editor.getParam("statusbar",!0,"boolean")&&!isInline?Option.some(renderStatusbar(editor,backstage.shared.providers)):Option.none(),socketSidebarContainer={dom:{tag:"div",classes:["tox-sidebar-wrap"]},components:[partSocket,partSidebar]},hasMultipleToolbar=isMultipleToolbars(editor),hasToolbar=isToolbarEnabled(editor),hasMenubar=isMenubarEnabled(editor),hasToolbarDrawer=toolbarDrawer(editor)!==ToolbarDrawer.default,getPartToolbar=function(){return hasMultipleToolbar?(hasToolbarDrawer&&domGlobals.console.warn("Toolbar drawer cannot be applied when multiple toolbars are active"),[partMultipleToolbar]):hasToolbar?[partToolbar]:[]},editorComponents=flatten([hasMenubar?[partMenubar]:[],getPartToolbar(),useFixedContainer(editor)?[]:[memAnchorBar.asSpec()],isInline?[]:[socketSidebarContainer]]),editorContainer={dom:{tag:"div",classes:["tox-editor-container"]},components:editorComponents},containerComponents=flatten([[editorContainer],isInline?[]:statusbar.toArray(),[partThrobber]]),isHidden=isInline&&!hasMenubar&&!hasToolbar&&!hasMultipleToolbar,attributes=__assign({role:"application"},global$5.isRtl()?{dir:"rtl"}:{},isHidden?{"aria-hidden":"true"}:{}),outerContainer=build$1(OuterContainer.sketch({dom:{tag:"div",classes:["tox","tox-tinymce"].concat(isInline?["tox-tinymce-inline"]:[]).concat(platformClasses),styles:__assign({visibility:"hidden"},isHidden?{opacity:"0",border:"0"}:{}),attributes:attributes},components:containerComponents,behaviours:derive$1(mode.getBehaviours(editor).concat([Keying.config({mode:"cyclic",selector:".tox-menubar, .tox-toolbar, .tox-toolbar__primary, .tox-toolbar__overflow--open, .tox-sidebar__overflow--open, .tox-statusbar__path, .tox-statusbar__wordcount, .tox-statusbar__branding a"})]))}));lazyOuterContainer=Option.some(outerContainer),editor.shortcuts.add("alt+F9","focus menubar",function(){OuterContainer.focusMenubar(outerContainer)}),editor.shortcuts.add("alt+F10","focus toolbar",function(){OuterContainer.focusToolbar(outerContainer)});var mothership=takeover(outerContainer),uiMothership=takeover(sink);Events$1.setup(editor,mothership,uiMothership);var getUi=function(){var channels={broadcastAll:uiMothership.broadcast,broadcastOn:uiMothership.broadcastOn,register:function(){}};return{channels:channels}},setEditorSize=function(elm){var DOM=global$7.DOM,baseWidth=editor.getParam("width",DOM.getStyle(elm,"width")),baseHeight=getHeightSetting(editor),minWidth=getMinWidthSetting(editor),minHeight=getMinHeightSetting(editor),parsedWidth=Utils.parseToInt(baseWidth).bind(function(w){return Utils.numToPx(minWidth.map(function(mw){return Math.max(w,mw)}))}).getOr(Utils.numToPx(baseWidth)),parsedHeight=Utils.parseToInt(baseHeight).bind(function(h){return minHeight.map(function(mh){return Math.max(h,mh)})}).getOr(baseHeight),stringWidth=Utils.numToPx(parsedWidth);if(isValidValue("div","width",stringWidth)&&set$2(outerContainer.element(),"width",stringWidth),!editor.inline){var stringHeight=Utils.numToPx(parsedHeight);isValidValue("div","height",stringHeight)?set$2(outerContainer.element(),"height",stringHeight):set$2(outerContainer.element(),"height","200px")}return parsedHeight},renderUI=function(){FormatControls.setup(editor,backstage),setup$7(editor,lazySink,backstage),setup$4(editor),setup$5(editor,lazyThrobber,backstage.shared);var _a=editor.ui.registry.getAll(),buttons=_a.buttons,menuItems=_a.menuItems,contextToolbars=_a.contextToolbars,sidebars=_a.sidebars,toolbarOpt=getMultipleToolbarsSetting(editor),rawUiConfig={menuItems:menuItems,menus:editor.settings.menu?map$1(editor.settings.menu,function(menu){return merge(menu,{items:menu.items})}):{},menubar:editor.settings.menubar,toolbar:toolbarOpt.getOrThunk(function(){return editor.getParam("toolbar",!0)}),buttons:buttons,sidebar:sidebars};ContextToolbar.register(editor,contextToolbars,sink,{backstage:backstage});var elm=editor.getElement(),height=setEditorSize(elm),uiComponents={mothership:mothership,uiMothership:uiMothership,outerContainer:outerContainer},args={targetNode:elm,height:height};return mode.render(editor,uiComponents,rawUiConfig,backstage,args)};return{mothership:mothership,uiMothership:uiMothership,backstage:backstage,renderUI:renderUI,getUi:getUi}},Render={setup:setup$8},describedBy=function(describedElement,describeElement){var describeId=Option.from(get$2(describedElement,"id")).fold(function(){var id=generate$1("dialog-describe");return set$1(describeElement,"id",id),id},identity);set$1(describedElement,"aria-describedby",describeId)},AriaLabel={labelledBy:function(labelledElement,labelElement){var labelId=Option.from(get$2(labelledElement,"id")).fold(function(){var id=generate$1("dialog-label");return set$1(labelElement,"id",id),id},identity);set$1(labelledElement,"aria-labelledby",labelId)}},schema$t=constant([strict$1("lazySink"),option("dragBlockClass"),defaultedFunction("getBounds",win),defaulted$1("useTabstopAt",constant(!0)),defaulted$1("eventOrder",{}),field$1("modalBehaviours",[Keying]),onKeyboardHandler("onExecute"),onStrictKeyboardHandler("onEscape")]),basic={sketch:identity},parts$e=constant([optional({name:"draghandle",overrides:function(detail,spec){return{behaviours:derive$1([Dragging.config({mode:"mouse",getTarget:function(handle){return ancestor$1(handle,'[role="dialog"]').getOr(handle)},blockerClass:detail.dragBlockClass.getOrDie(new Error("The drag blocker class was not specified for a dialog with a drag handle: \n"+JSON.stringify(spec,null,2)).message),getBounds:detail.getDragBounds})])}}}),required({schema:[strict$1("dom")],name:"title"}),required({factory:basic,schema:[strict$1("dom")],name:"close"}),required({factory:basic,schema:[strict$1("dom")],name:"body"}),optional({factory:basic,schema:[strict$1("dom")],name:"footer"}),external$1({factory:{sketch:function(spec,detail){return __assign({},spec,{dom:detail.dom,components:detail.components})}},schema:[defaulted$1("dom",{tag:"div",styles:{position:"fixed",left:"0px",top:"0px",right:"0px",bottom:"0px"}}),defaulted$1("components",[])],name:"blocker"})]),factory$h=function(detail,components,spec,externals){var dialogBusyEvent=generate$1("alloy.dialog.busy"),dialogIdleEvent=generate$1("alloy.dialog.idle"),busyBehaviours=derive$1([Keying.config({mode:"special",onTab:function(){return Option.some(!0)},onShiftTab:function(){return Option.some(!0)}}),Focusing.config({})]),showDialog=function(dialog){var sink=detail.lazySink(dialog).getOrDie(),busyComp=Cell(Option.none()),externalBlocker=externals.blocker(),blocker=sink.getSystem().build(__assign({},externalBlocker,{components:externalBlocker.components.concat([premade$1(dialog)]),behaviours:derive$1([config("dialog-blocker-events",[run(dialogIdleEvent,function(blocker,se){has$1(dialog.element(),"aria-busy")&&(remove$1(dialog.element(),"aria-busy"),busyComp.get().each(function(bc){return Replacing.remove(dialog,bc)}))}),run(dialogBusyEvent,function(blocker,se){set$1(dialog.element(),"aria-busy","true");var getBusySpec=se.event().getBusySpec();busyComp.get().each(function(bc){Replacing.remove(dialog,bc)});var busySpec=getBusySpec(dialog,busyBehaviours),busy=blocker.getSystem().build(busySpec);busyComp.set(Option.some(busy)),Replacing.append(dialog,premade$1(busy)),busy.hasConfigured(Keying)&&Keying.focusIn(busy)})])])}));attach(sink,blocker),Keying.focusIn(dialog)},hideDialog=function(dialog){parent(dialog.element()).each(function(blockerDom){dialog.getSystem().getByDom(blockerDom).each(function(blocker){detach(blocker)})})},getDialogBody=function(dialog){return getPartOrDie(dialog,detail,"body")},getDialogFooter=function(dialog){return getPartOrDie(dialog,detail,"footer")},setBusy=function(dialog,getBusySpec){emitWith(dialog,dialogBusyEvent,{getBusySpec:getBusySpec})},setIdle=function(dialog){emit(dialog,dialogIdleEvent)},modalEventsId=generate$1("modal-events"),eventOrder=__assign({},detail.eventOrder,{"alloy.system.attached":[modalEventsId].concat(detail.eventOrder["alloy.system.attached"]||[])});return{uid:detail.uid,dom:detail.dom,components:components,apis:{show:showDialog,hide:hideDialog,getBody:getDialogBody,getFooter:getDialogFooter,setIdle:setIdle,setBusy:setBusy},eventOrder:eventOrder,domModification:{attributes:{role:"dialog","aria-modal":"true"}},behaviours:augment(detail.modalBehaviours,[Replacing.config({}),Keying.config({mode:"cyclic",onEnter:detail.onExecute,onEscape:detail.onEscape,useTabstopAt:detail.useTabstopAt}),config(modalEventsId,[runOnAttached(function(c){AriaLabel.labelledBy(c.element(),getPartOrDie(c,detail,"title").element()),describedBy(c.element(),getPartOrDie(c,detail,"body").element())})])])}},ModalDialog=composite$1({name:"ModalDialog",configFields:schema$t(),partFields:parts$e(),factory:factory$h,apis:{show:function(apis,dialog){apis.show(dialog)},hide:function(apis,dialog){apis.hide(dialog)},getBody:function(apis,dialog){return apis.getBody(dialog)},getFooter:function(apis,dialog){return apis.getFooter(dialog)},setBusy:function(apis,dialog,getBusySpec){apis.setBusy(dialog,getBusySpec)},setIdle:function(apis,dialog){apis.setIdle(dialog)}}}),alertBannerFields=[strictString("type"),strictString("text"),strictStringEnum("level",["info","warn","error","success"]),strictString("icon"),defaulted$1("url","")],alertBannerSchema=objOf(alertBannerFields),createBarFields=function(itemsField){return[strictString("type"),itemsField]},buttonFields=[strictString("type"),strictString("text"),defaultedBoolean("disabled",!1),defaultedBoolean("primary",!1),field("name","name",defaultedThunk(function(){return generate$1("button-name")}),string),optionString("icon"),defaultedBoolean("borderless",!1)],buttonSchema=objOf(buttonFields),checkboxFields=[strictString("type"),strictString("name"),strictString("label"),defaultedBoolean("disabled",!1)],checkboxSchema=objOf(checkboxFields),checkboxDataProcessor=boolean,formComponentFields=[strictString("type"),strictString("name")],formComponentWithLabelFields=formComponentFields.concat([optionString("label")]),colorInputFields=formComponentWithLabelFields,colorInputSchema=objOf(colorInputFields),colorInputDataProcessor=string,colorPickerFields=formComponentWithLabelFields,colorPickerSchema=objOf(colorPickerFields),colorPickerDataProcessor=string,dropZoneFields=formComponentWithLabelFields,dropZoneSchema=objOf(dropZoneFields),dropZoneDataProcessor=arrOfVal(),createGridFields=function(itemsField){return[strictString("type"),strictNumber("columns"),itemsField]
},iframeFields=formComponentWithLabelFields.concat([defaultedBoolean("sandboxed",!0)]),iframeSchema=objOf(iframeFields),iframeDataProcessor=string,inputFields=formComponentWithLabelFields.concat([optionString("placeholder"),defaultedBoolean("maximized",!1),defaultedBoolean("disabled",!1)]),inputSchema=objOf(inputFields),inputDataProcessor=string,selectBoxFields=formComponentWithLabelFields.concat([strictArrayOfObj("items",[strictString("text"),strictString("value")]),defaultedNumber("size",1),defaultedBoolean("disabled",!1)]),selectBoxSchema=objOf(selectBoxFields),selectBoxDataProcessor=string,sizeInputFields=formComponentWithLabelFields.concat([defaultedBoolean("constrain",!0),defaultedBoolean("disabled",!1)]),sizeInputSchema=objOf(sizeInputFields),sizeInputDataProcessor=objOf([strictString("width"),strictString("height")]),textAreaFields=formComponentWithLabelFields.concat([optionString("placeholder"),defaultedBoolean("maximized",!1),defaultedBoolean("disabled",!1)]),textAreaSchema=objOf(textAreaFields),textAreaDataProcessor=string,urlInputFields=formComponentWithLabelFields.concat([defaultedStringEnum("filetype","file",["image","media","file"]),defaulted$1("disabled",!1)]),urlInputSchema=objOf(urlInputFields),urlInputDataProcessor=objOf([strictString("value"),defaulted$1("meta",{})]),customEditorFields=formComponentFields.concat([defaultedString("tag","textarea"),strictString("scriptId"),strictString("scriptUrl"),defaultedPostMsg("settings",void 0)]),customEditorFieldsOld=formComponentFields.concat([defaultedString("tag","textarea"),strictFunction("init")]),customEditorSchema=valueOf(function(v){return asRaw("customeditor.old",objOfOnly(customEditorFieldsOld),v).orThunk(function(){return asRaw("customeditor.new",objOfOnly(customEditorFields),v)})}),customEditorDataProcessor=string,htmlPanelFields=[strictString("type"),strictString("html"),defaultedStringEnum("presets","presentation",["presentation","document"])],htmlPanelSchema=objOf(htmlPanelFields),imageToolsFields=formComponentWithLabelFields.concat([strictOf("currentState",objOf([strict$1("blob"),strictString("url")]))]),imageToolsSchema=objOf(imageToolsFields),collectionFields=formComponentWithLabelFields.concat([defaulted$1("columns","auto")]),collectionSchema=objOf(collectionFields),collectionDataProcessor=arrOfObj$1([strictString("value"),strictString("text"),strictString("icon")]),createLabelFields=function(itemsField){return[strictString("type"),strictString("label"),itemsField]},tableFields=[strictString("type"),strictArrayOf("header",string),strictArrayOf("cells",arrOf(string))],tableSchema=objOf(tableFields),createItemsField=function(name){return field("items","items",strict(),arrOf(valueOf(function(v){return asRaw("Checking item of "+name,itemSchema$2,v).fold(function(sErr){return Result.error(formatError(sErr))},function(passValue){return Result.value(passValue)})})))},itemSchema$2=valueThunkOf(function(){return chooseProcessor("type",{alertbanner:alertBannerSchema,bar:objOf(createBarFields(createItemsField("bar"))),button:buttonSchema,checkbox:checkboxSchema,colorinput:colorInputSchema,colorpicker:colorPickerSchema,dropzone:dropZoneSchema,grid:objOf(createGridFields(createItemsField("grid"))),iframe:iframeSchema,input:inputSchema,selectbox:selectBoxSchema,sizeinput:sizeInputSchema,textarea:textAreaSchema,urlinput:urlInputSchema,customeditor:customEditorSchema,htmlpanel:htmlPanelSchema,imagetools:imageToolsSchema,collection:collectionSchema,label:objOf(createLabelFields(createItemsField("label"))),table:tableSchema,panel:panelSchema})}),panelFields=[strictString("type"),defaulted$1("classes",[]),strictArrayOf("items",itemSchema$2)],panelSchema=objOf(panelFields),tabFields=[field("name","name",defaultedThunk(function(){return generate$1("tab-name")}),string),strictString("title"),strictArrayOf("items",itemSchema$2)],tabPanelFields=[strictString("type"),strictArrayOfObj("tabs",tabFields)],tabPanelSchema=objOf(tabPanelFields),baseButtonFields=[field("name","name",defaultedThunk(function(){return generate$1("button-name")}),string),optionString("icon"),defaultedStringEnum("align","end",["start","end"]),defaultedBoolean("primary",!1),defaultedBoolean("disabled",!1)],dialogButtonFields=baseButtonFields.concat([strictString("text")]),normalButtonFields=[strictStringEnum("type",["submit","cancel","custom"])].concat(dialogButtonFields),menuButtonFields=[strictStringEnum("type",["menu"])].concat(baseButtonFields,baseMenuButtonFields),dialogButtonSchema=choose$1("type",{submit:normalButtonFields,cancel:normalButtonFields,custom:normalButtonFields,menu:menuButtonFields}),dialogSchema=objOf([strictString("title"),strictOf("body",chooseProcessor("type",{panel:panelSchema,tabpanel:tabPanelSchema})),defaultedString("size","normal"),strictArrayOf("buttons",dialogButtonSchema),defaulted$1("initialData",{}),defaultedFunction("onAction",noop),defaultedFunction("onChange",noop),defaultedFunction("onSubmit",noop),defaultedFunction("onClose",noop),defaultedFunction("onCancel",noop),defaulted$1("onTabChange",noop)]),createDialog=function(spec){return asRaw("dialog",dialogSchema,spec)},getAllObjects=function(obj){return isObject(obj)?[obj].concat(bind(values(obj),getAllObjects)):isArray(obj)?bind(obj,getAllObjects):[]},isNamedItem=function(obj){return isString(obj.type)&&isString(obj.name)},dataProcessors={checkbox:checkboxDataProcessor,colorinput:colorInputDataProcessor,colorpicker:colorPickerDataProcessor,dropzone:dropZoneDataProcessor,input:inputDataProcessor,iframe:iframeDataProcessor,sizeinput:sizeInputDataProcessor,selectbox:selectBoxDataProcessor,size:sizeInputDataProcessor,textarea:textAreaDataProcessor,urlinput:urlInputDataProcessor,customeditor:customEditorDataProcessor,collection:collectionDataProcessor},getDataProcessor=function(item){return Option.from(dataProcessors[item.type])},getNamedItems=function(structure){return filter(getAllObjects(structure),isNamedItem)},createDataValidator=function(structure){var fields=bind(getNamedItems(structure),function(item){return getDataProcessor(item).fold(function(){return[]},function(schema){return[strictOf(item.name,schema)]})});return objOf(fields)},urlDialogButtonSchema=objOf([strictStringEnum("type",["cancel","custom"])].concat(dialogButtonFields)),urlDialogSchema=objOf([strictString("title"),strictString("url"),optionNumber("height"),optionNumber("width"),optionArrayOf("buttons",urlDialogButtonSchema),defaultedFunction("onAction",noop),defaultedFunction("onCancel",noop),defaultedFunction("onClose",noop),defaultedFunction("onMessage",noop)]),createUrlDialog=function(spec){return asRaw("dialog",urlDialogSchema,spec)},extract$1=function(structure){var internalDialog=getOrDie(createDialog(structure)),dataValidator=createDataValidator(structure),initialData=structure.initialData;return{internalDialog:internalDialog,dataValidator:dataValidator,initialData:initialData}},DialogManager={open:function(factory,structure){var extraction=extract$1(structure);return factory(extraction.internalDialog,extraction.initialData,extraction.dataValidator)},openUrl:function(factory,structure){var internalDialog=getOrDie(createUrlDialog(structure));return factory(internalDialog)},redial:function(structure){return extract$1(structure)}},toValidValues=function(values){var errors=[],result={};return each$1(values,function(value,name){value.fold(function(){errors.push(name)},function(v){result[name]=v})}),errors.length>0?Result.error(errors):Result.value(result)},renderBodyPanel=function(spec,backstage){var memForm=record(Form.sketch(function(parts){return{dom:{tag:"div",classes:["tox-form"].concat(spec.classes)},components:map(spec.items,function(item){return interpretInForm(parts,item,backstage)})}}));return{dom:{tag:"div",classes:["tox-dialog__body"]},components:[{dom:{tag:"div",classes:["tox-dialog__body-content"]},components:[memForm.asSpec()]}],behaviours:derive$1([Keying.config({mode:"acyclic",useTabstopAt:not(NavigableObject.isPseudoStop)}),ComposingConfigs.memento(memForm),RepresentingConfigs.memento(memForm,{postprocess:function(formValue){return toValidValues(formValue).fold(function(err){return domGlobals.console.error(err),{}},function(vals){return vals})}})])}},factory$i=function(detail,spec){return{uid:detail.uid,dom:detail.dom,components:detail.components,events:events$7(detail.action),behaviours:augment(detail.tabButtonBehaviours,[Focusing.config({}),Keying.config({mode:"execution",useSpace:!0,useEnter:!0}),Representing.config({store:{mode:"memory",initialValue:detail.value}})]),domModification:detail.domModification}},TabButton=single$2({name:"TabButton",configFields:[defaulted$1("uid",void 0),strict$1("value"),field("dom","dom",mergeWithThunk(function(spec){return{attributes:{role:"tab",id:generate$1("aria"),"aria-selected":"false"}}}),anyValue$1()),option("action"),defaulted$1("domModification",{}),field$1("tabButtonBehaviours",[Focusing,Keying,Representing]),strict$1("view")],factory:factory$i}),schema$u=constant([strict$1("tabs"),strict$1("dom"),defaulted$1("clickToDismiss",!1),field$1("tabbarBehaviours",[Highlighting,Keying]),markers(["tabClass","selectedClass"])]),tabsPart=group({factory:TabButton,name:"tabs",unit:"tab",overrides:function(barDetail,tabSpec){var dismissTab$1=function(tabbar,button){Highlighting.dehighlight(tabbar,button),emitWith(tabbar,dismissTab(),{tabbar:tabbar,button:button})},changeTab$1=function(tabbar,button){Highlighting.highlight(tabbar,button),emitWith(tabbar,changeTab(),{tabbar:tabbar,button:button})};return{action:function(button){var tabbar=button.getSystem().getByUid(barDetail.uid).getOrDie(),activeButton=Highlighting.isHighlighted(tabbar,button),response=activeButton&&barDetail.clickToDismiss?dismissTab$1:activeButton?noop:changeTab$1;response(tabbar,button)},domModification:{classes:[barDetail.markers.tabClass]}}}}),parts$f=constant([tabsPart]),factory$j=function(detail,components,spec,externals){return{uid:detail.uid,dom:detail.dom,components:components,"debug.sketcher":"Tabbar",domModification:{attributes:{role:"tablist"}},behaviours:augment(detail.tabbarBehaviours,[Highlighting.config({highlightClass:detail.markers.selectedClass,itemClass:detail.markers.tabClass,onHighlight:function(tabbar,tab){set$1(tab.element(),"aria-selected","true")},onDehighlight:function(tabbar,tab){set$1(tab.element(),"aria-selected","false")}}),Keying.config({mode:"flow",getInitial:function(tabbar){return Highlighting.getHighlighted(tabbar).map(function(tab){return tab.element()})},selector:"."+detail.markers.tabClass,executeOnMove:!0})])}},Tabbar=composite$1({name:"Tabbar",configFields:schema$u(),partFields:parts$f(),factory:factory$j}),factory$k=function(detail,spec){return{uid:detail.uid,dom:detail.dom,behaviours:augment(detail.tabviewBehaviours,[Replacing.config({})]),domModification:{attributes:{role:"tabpanel"}}}},Tabview=single$2({name:"Tabview",configFields:[field$1("tabviewBehaviours",[Replacing])],factory:factory$k}),schema$v=constant([defaulted$1("selectFirst",!0),onHandler("onChangeTab"),onHandler("onDismissTab"),defaulted$1("tabs",[]),field$1("tabSectionBehaviours",[])]),barPart=required({factory:Tabbar,schema:[strict$1("dom"),strictObjOf("markers",[strict$1("tabClass"),strict$1("selectedClass")])],name:"tabbar",defaults:function(detail){return{tabs:detail.tabs}}}),viewPart=required({factory:Tabview,name:"tabview"}),parts$g=constant([barPart,viewPart]),factory$l=function(detail,components,spec,externals){var changeTab$1=function(button){var tabValue=Representing.getValue(button);getPart(button,detail,"tabview").each(function(tabview){var tabWithValue=find(detail.tabs,function(t){return t.value===tabValue});tabWithValue.each(function(tabData){var panel=tabData.view();set$1(tabview.element(),"aria-labelledby",get$2(button.element(),"id")),Replacing.set(tabview,panel),detail.onChangeTab(tabview,button,panel)})})},changeTabBy=function(section,byPred){getPart(section,detail,"tabbar").each(function(tabbar){byPred(tabbar).each(emitExecute)})};return{uid:detail.uid,dom:detail.dom,components:components,behaviours:get$b(detail.tabSectionBehaviours),events:derive(flatten([detail.selectFirst?[runOnAttached(function(section,simulatedEvent){changeTabBy(section,Highlighting.getFirst)})]:[],[run(changeTab(),function(section,simulatedEvent){var button=simulatedEvent.event().button();changeTab$1(button)}),run(dismissTab(),function(section,simulatedEvent){var button=simulatedEvent.event().button();detail.onDismissTab(section,button)})]])),apis:{getViewItems:function(section){return getPart(section,detail,"tabview").map(function(tabview){return Replacing.contents(tabview)}).getOr([])},showTab:function(section,tabKey){var getTabIfNotActive=function(tabbar){var candidates=Highlighting.getCandidates(tabbar),optTab=find(candidates,function(c){return Representing.getValue(c)===tabKey});return optTab.filter(function(tab){return!Highlighting.isHighlighted(tabbar,tab)})};changeTabBy(section,getTabIfNotActive)}}}},TabSection=composite$1({name:"TabSection",configFields:schema$v(),partFields:parts$g(),factory:factory$l,apis:{getViewItems:function(apis,component){return apis.getViewItems(component)},showTab:function(apis,component,tabKey){apis.showTab(component,tabKey)}}}),measureHeights=function(allTabs,tabview,tabviewComp){return map(allTabs,function(tab,i){Replacing.set(tabviewComp,allTabs[i].view());var rect=tabview.dom().getBoundingClientRect();return Replacing.set(tabviewComp,[]),rect.height})},getMaxHeight=function(heights){return head(sort(heights,function(a,b){return a>b?-1:a<b?1:0}))},getMaxTabviewHeight=function(dialog,dialogBody){var maxHeight,rootElm=ancestor$1(dialog,".tox-dialog-wrap").getOr(dialog),isFixed="fixed"===get$4(rootElm,"position");maxHeight=isFixed?Math.max(domGlobals.document.documentElement.clientHeight,domGlobals.window.innerHeight):Math.max(domGlobals.document.documentElement.offsetHeight,domGlobals.document.documentElement.scrollHeight);var dialogChrome=dialog.dom().getBoundingClientRect().height-dialogBody.dom().getBoundingClientRect().height;return maxHeight-dialogChrome},showTab=function(allTabs,comp){head(allTabs).each(function(tab){return TabSection.showTab(comp,tab.value)})},updateTabviewHeight=function(dialogBody,tabview,maxTabHeight){ancestor$1(dialogBody,'[role="dialog"]').each(function(dialog){maxTabHeight.get().map(function(height){return set$2(tabview,"height","0"),Math.min(height,getMaxTabviewHeight(dialog,dialogBody))}).each(function(height){set$2(tabview,"height",height+"px")})})},setMode=function(allTabs){var maxTabHeight,extraEvents,selectFirst,smartTabHeight=(maxTabHeight=Cell(Option.none()),extraEvents=[runOnAttached(function(comp){descendant$1(comp.element(),'[role="tabpanel"]').each(function(tabview){set$2(tabview,"visibility","hidden"),comp.getSystem().getByDom(tabview).toOption().each(function(tabviewComp){var heights=measureHeights(allTabs,tabview,tabviewComp),maxTabHeightOpt=getMaxHeight(heights);maxTabHeight.set(maxTabHeightOpt)}),updateTabviewHeight(comp.element(),tabview,maxTabHeight),remove$6(tabview,"visibility"),showTab(allTabs,comp),global$2.requestAnimationFrame(function(){updateTabviewHeight(comp.element(),tabview,maxTabHeight)})})}),run(windowResize(),function(comp){descendant$1(comp.element(),'[role="tabpanel"]').each(function(tabview){updateTabviewHeight(comp.element(),tabview,maxTabHeight)})}),run(formResizeEvent,function(comp,se){descendant$1(comp.element(),'[role="tabpanel"]').each(function(tabview){var oldFocus=active();set$2(tabview,"visibility","hidden");var oldHeight=getRaw(tabview,"height").map(function(h){return parseInt(h,10)});remove$6(tabview,"height");var newHeight=tabview.dom().getBoundingClientRect().height,hasGrown=oldHeight.forall(function(h){return newHeight>h});hasGrown?(maxTabHeight.set(Option.from(newHeight)),updateTabviewHeight(comp.element(),tabview,maxTabHeight)):oldHeight.each(function(h){set$2(tabview,"height",h+"px")}),remove$6(tabview,"visibility"),oldFocus.each(focus$1)})})],selectFirst=!1,{extraEvents:extraEvents,selectFirst:selectFirst}),naiveTabHeight=function(){var extraEvents=[],selectFirst=!0;return{extraEvents:extraEvents,selectFirst:selectFirst}}();return{smartTabHeight:smartTabHeight,naiveTabHeight:naiveTabHeight}},SendDataToSectionChannel="send-data-to-section",SendDataToViewChannel="send-data-to-view",renderTabPanel=function(spec,backstage){var storedValue=Cell({}),updateDataWithForm=function(form){var formData=Representing.getValue(form),validData=toValidValues(formData).getOr({}),currentData=storedValue.get(),newData=deepMerge(currentData,validData);storedValue.set(newData)},setDataOnForm=function(form){var tabData=storedValue.get();Representing.setValue(form,tabData)},oldTab=Cell(null),allTabs=map(spec.tabs,function(tab){return{value:tab.name,dom:{tag:"div",classes:["tox-dialog__body-nav-item"],innerHtml:backstage.shared.providers.translate(tab.title)},view:function(){return[Form.sketch(function(parts){return{dom:{tag:"div",classes:["tox-form"]},components:map(tab.items,function(item){return interpretInForm(parts,item,backstage)}),formBehaviours:derive$1([Keying.config({mode:"acyclic",useTabstopAt:not(NavigableObject.isPseudoStop)}),config("TabView.form.events",[runOnAttached(setDataOnForm),runOnDetached(updateDataWithForm)]),Receiving.config({channels:wrapAll$1([{key:SendDataToSectionChannel,value:{onReceive:updateDataWithForm}},{key:SendDataToViewChannel,value:{onReceive:setDataOnForm}}])})])}})]}}}),tabMode=setMode(allTabs).smartTabHeight;return TabSection.sketch({dom:{tag:"div",classes:["tox-dialog__body"]},onChangeTab:function(section,button,_viewItems){var name=Representing.getValue(button);emitWith(section,formTabChangeEvent,{name:name,oldName:oldTab.get()}),oldTab.set(name)},tabs:allTabs,components:[TabSection.parts().tabbar({dom:{tag:"div",classes:["tox-dialog__body-nav"]},components:[Tabbar.parts().tabs({})],markers:{tabClass:"tox-tab",selectedClass:"tox-dialog__body-nav-item--active"},tabbarBehaviours:derive$1([Tabstopping.config({})])}),TabSection.parts().tabview({dom:{tag:"div",classes:["tox-dialog__body-content"]}})],selectFirst:tabMode.selectFirst,tabSectionBehaviours:derive$1([config("tabpanel",tabMode.extraEvents),Keying.config({mode:"acyclic"}),Composing.config({find:function(comp){return head(TabSection.getViewItems(comp))}}),Representing.config({store:{mode:"manual",getValue:function(tsection){return tsection.getSystem().broadcastOn([SendDataToSectionChannel],{}),storedValue.get()},setValue:function(tsection,value){storedValue.set(value),tsection.getSystem().broadcastOn([SendDataToViewChannel],{})}}})])})},dialogChannel=generate$1("update-dialog"),titleChannel=generate$1("update-title"),bodyChannel=generate$1("update-body"),footerChannel=generate$1("update-footer"),bodySendMessageChannel=generate$1("body-send-message"),renderBody=function(spec,id,backstage,ariaAttrs){var renderComponents=function(incoming){switch(incoming.body.type){case"tabpanel":return[renderTabPanel(incoming.body,backstage)];default:return[renderBodyPanel(incoming.body,backstage)]}},updateState=function(_comp,incoming){return Option.some({isTabPanel:function(){return"tabpanel"===incoming.body.type}})},ariaAttributes={"aria-live":"polite"};return{dom:{tag:"div",classes:["tox-dialog__content-js"],attributes:__assign({},id.map(function(x){return{id:x}}).getOr({}),ariaAttrs?ariaAttributes:{})},components:[],behaviours:derive$1([ComposingConfigs.childAt(0),Reflecting.config({channel:bodyChannel,updateState:updateState,renderComponents:renderComponents,initialData:spec})])}},renderInlineBody=function(spec,contentId,backstage,ariaAttrs){return renderBody(spec,Option.some(contentId),backstage,ariaAttrs)},renderModalBody=function(spec,backstage){var bodySpec=renderBody(spec,Option.none(),backstage,!1);return ModalDialog.parts().body(bodySpec)},renderIframeBody=function(spec){var bodySpec={dom:{tag:"div",classes:["tox-dialog__content-js"]},components:[{dom:{tag:"div",classes:["tox-dialog__body-iframe"]},components:[NavigableObject.craft({dom:{tag:"iframe",attributes:{src:spec.url}},behaviours:derive$1([Tabstopping.config({}),Focusing.config({})])})]}],behaviours:derive$1([Keying.config({mode:"acyclic",useTabstopAt:not(NavigableObject.isPseudoStop)})])};return ModalDialog.parts().body(bodySpec)},initCommonEvents=function(fireApiEvent,extras){return[runWithTarget(focusin(),NavigableObject.onFocus),fireApiEvent(formCloseEvent,function(api,spec){extras.onClose(),spec.onClose()}),fireApiEvent(formCancelEvent,function(api,spec,_event,self){spec.onCancel(api),emit(self,formCloseEvent)}),run(formUnblockEvent,function(c,se){return extras.onUnblock()}),run(formBlockEvent,function(c,se){return extras.onBlock(se.event())})]},initUrlDialog=function(getInstanceApi,extras){var fireApiEvent=function(eventName,f){return run(eventName,function(c,se){withSpec(c,function(spec,_c){f(getInstanceApi(),spec,se.event(),c)})})},withSpec=function(c,f){Reflecting.getState(c).get().each(function(currentDialog){f(currentDialog,c)})};return initCommonEvents(fireApiEvent,extras).concat([fireApiEvent(formActionEvent,function(api,spec,event){spec.onAction(api,{name:event.name()})})])},initDialog=function(getInstanceApi,extras){var fireApiEvent=function(eventName,f){return run(eventName,function(c,se){withSpec(c,function(spec,_c){f(getInstanceApi(),spec,se.event(),c)})})},withSpec=function(c,f){Reflecting.getState(c).get().each(function(currentDialogInit){f(currentDialogInit.internalDialog,c)})};return initCommonEvents(fireApiEvent,extras).concat([fireApiEvent(formSubmitEvent,function(api,spec){return spec.onSubmit(api)}),fireApiEvent(formChangeEvent,function(api,spec,event){spec.onChange(api,{name:event.name()})}),fireApiEvent(formActionEvent,function(api,spec,event,component){var focusIn=function(){return Keying.focusIn(component)},current=active();spec.onAction(api,{name:event.name(),value:event.value()}),active().fold(function(){focusIn()},function(focused){!contains$2(component.element(),focused)||has$1(focused,"disabled")?focusIn():contains$2(focused,current.getOrNull())&&has$1(current.getOrDie(),"disabled")&&focusIn()})}),fireApiEvent(formTabChangeEvent,function(api,spec,event){spec.onTabChange(api,{newTabName:event.name(),oldTabName:event.oldName()})}),runOnDetached(function(component){var api=getInstanceApi();Representing.setValue(component,api.getData())})])},SilverDialogEvents={initUrlDialog:initUrlDialog,initDialog:initDialog},makeButton=function(button,backstage){return renderFooterButton(button,button.type,backstage)},lookup$2=function(compInSystem,footerButtons,buttonName){return find(footerButtons,function(button){return button.name===buttonName}).bind(function(memButton){return memButton.memento.getOpt(compInSystem)})},renderComponents=function(_data,state){var footerButtons=state.map(function(s){return s.footerButtons}).getOr([]),buttonGroups=partition(footerButtons,function(button){return"start"===button.align}),makeGroup=function(edge,buttons){return Container.sketch({dom:{tag:"div",classes:["tox-dialog__footer-"+edge]},components:map(buttons,function(button){return button.memento.asSpec()})})},startButtons=makeGroup("start",buttonGroups.pass),endButtons=makeGroup("end",buttonGroups.fail);return[startButtons,endButtons]},renderFooter=function(initSpec,backstage){var updateState=function(_comp,data){var footerButtons=map(data.buttons,function(button){var memButton=record(makeButton(button,backstage));return{name:button.name,align:button.align,memento:memButton}}),lookupByName=function(compInSystem,buttonName){return lookup$2(compInSystem,footerButtons,buttonName)};return Option.some({lookupByName:lookupByName,footerButtons:footerButtons})};return{dom:fromHtml$2('<div class="tox-dialog__footer"></div>'),components:[],behaviours:derive$1([Reflecting.config({channel:footerChannel,initialData:initSpec,updateState:updateState,renderComponents:renderComponents})])}},renderInlineFooter=function(initSpec,backstage){return renderFooter(initSpec,backstage)},renderModalFooter=function(initSpec,backstage){return ModalDialog.parts().footer(renderFooter(initSpec,backstage))},getCompByName=function(access,name){var root=access.getRoot();if(root.getSystem().isConnected()){var form_1=Composing.getCurrent(access.getFormWrapper()).getOr(access.getFormWrapper());return Form.getField(form_1,name).fold(function(){var footer=access.getFooter(),footerState=Reflecting.getState(footer);return footerState.get().bind(function(f){return f.lookupByName(form_1,name)})},function(comp){return Option.some(comp)})}return Option.none()},validateData=function(access,data){var root=access.getRoot();return Reflecting.getState(root).get().map(function(dialogState){return getOrDie(asRaw("data",dialogState.dataValidator,data))}).getOr(data)},getDialogApi=function(access,doRedial){var withRoot=function(f){var root=access.getRoot();root.getSystem().isConnected()&&f(root)},getData=function(){var root=access.getRoot(),valueComp=root.getSystem().isConnected()?access.getFormWrapper():root;return Representing.getValue(valueComp)},setData=function(newData){withRoot(function(_){var prevData=instanceApi.getData(),mergedData=merge(prevData,newData),newInternalData=validateData(access,mergedData),form=access.getFormWrapper();Representing.setValue(form,newInternalData)})},disable=function(name){getCompByName(access,name).each(Disabling.disable)},enable=function(name){getCompByName(access,name).each(Disabling.enable)},focus=function(name){getCompByName(access,name).each(Focusing.focus)},block=function(message){if(!isString(message))throw new Error("The dialogInstanceAPI.block function should be passed a blocking message of type string as an argument");withRoot(function(root){emitWith(root,formBlockEvent,{message:message})})},unblock=function(){withRoot(function(root){emit(root,formUnblockEvent)})},showTab=function(name){withRoot(function(_){var body=access.getBody(),bodyState=Reflecting.getState(body);bodyState.get().exists(function(b){return b.isTabPanel()})&&Composing.getCurrent(body).each(function(tabSection){TabSection.showTab(tabSection,name)})})},redial=function(d){withRoot(function(root){var dialogInit=doRedial(d);root.getSystem().broadcastOn([dialogChannel],dialogInit),root.getSystem().broadcastOn([titleChannel],dialogInit.internalDialog),root.getSystem().broadcastOn([bodyChannel],dialogInit.internalDialog),root.getSystem().broadcastOn([footerChannel],dialogInit.internalDialog),instanceApi.setData(dialogInit.initialData)})},close=function(){withRoot(function(root){emit(root,formCloseEvent)})},instanceApi={getData:getData,setData:setData,disable:disable,enable:enable,focus:focus,block:block,unblock:unblock,showTab:showTab,redial:redial,close:close};return instanceApi},renderClose=function(providersBackstage){return Button.sketch({dom:{tag:"button",classes:["tox-button","tox-button--icon","tox-button--naked"],attributes:{type:"button","aria-label":providersBackstage.translate("Close"),title:providersBackstage.translate("Close")}},components:[{dom:{tag:"div",classes:["tox-icon"],innerHtml:'<svg width="24" height="24" xmlns="http://www.w3.org/2000/svg"><path d="M17.953 7.453L13.422 12l4.531 4.547-1.406 1.406L12 13.422l-4.547 4.531-1.406-1.406L10.578 12 6.047 7.453l1.406-1.406L12 10.578l4.547-4.531z" fill-rule="evenodd"></path></svg>'}}],action:function(comp){emit(comp,formCancelEvent)}})},renderTitle=function(spec,id,providersBackstage){var renderComponents=function(data){return[text(providersBackstage.translate(data.title))]};return{dom:{tag:"div",classes:["tox-dialog__title"],attributes:__assign({},id.map(function(x){return{id:x}}).getOr({}))},components:renderComponents(spec),behaviours:derive$1([Reflecting.config({channel:titleChannel,renderComponents:renderComponents})])}},renderDragHandle=function(){return{dom:fromHtml$2('<div class="tox-dialog__draghandle"></div>')}},renderInlineHeader=function(spec,titleId,providersBackstage){return Container.sketch({dom:fromHtml$2('<div class="tox-dialog__header"></div>'),components:[renderTitle(spec,Option.some(titleId),providersBackstage),renderDragHandle(),renderClose(providersBackstage)],containerBehaviours:derive$1([Dragging.config({mode:"mouse",blockerClass:"blocker",getTarget:function(handle){return closest$3(handle,'[role="dialog"]').getOrDie()},snaps:{getSnapPoints:function(){return[]},leftAttr:"data-drag-left",topAttr:"data-drag-top"}})])})},renderModalHeader=function(spec,providersBackstage){var pTitle=ModalDialog.parts().title(renderTitle(spec,Option.none(),providersBackstage)),pHandle=ModalDialog.parts().draghandle(renderDragHandle()),pClose=ModalDialog.parts().close(renderClose(providersBackstage)),components=[pTitle].concat(spec.draggable?[pHandle]:[]).concat([pClose]);return Container.sketch({dom:fromHtml$2('<div class="tox-dialog__header"></div>'),components:components})},getHeader=function(title,backstage){return renderModalHeader({title:backstage.shared.providers.translate(title),draggable:backstage.dialog.isDraggableModal()},backstage.shared.providers)},getEventExtras=function(lazyDialog,extra){return{onClose:function(){return extra.closeWindow()},onBlock:function(blockEvent){ModalDialog.setBusy(lazyDialog(),function(d,bs){return{dom:{tag:"div",classes:["tox-dialog__busy-spinner"],attributes:{"aria-label":blockEvent.message()},styles:{left:"0px",right:"0px",bottom:"0px",top:"0px",position:"absolute"}},behaviours:bs,components:[{dom:fromHtml$2('<div class="tox-spinner"><div></div><div></div><div></div></div>')}]}})},onUnblock:function(){ModalDialog.setIdle(lazyDialog())}}},renderModalDialog=function(spec,initialData,dialogEvents,backstage){var _a,updateState=function(_comp,incoming){return Option.some(incoming)};return build$1(ModalDialog.sketch({lazySink:backstage.shared.getSink,onEscape:function(c){return emit(c,formCancelEvent),Option.some(!0)},useTabstopAt:function(elem){return!NavigableObject.isPseudoStop(elem)},modalBehaviours:derive$1([Reflecting.config({channel:dialogChannel,updateState:updateState,initialData:initialData}),RepresentingConfigs.memory({}),Focusing.config({}),config("execute-on-form",dialogEvents.concat([runOnSource(focusin(),function(comp,se){Keying.focusIn(comp)})])),config("scroll-lock",[runOnAttached(function(){add$2(body(),"tox-dialog__disable-scroll")}),runOnDetached(function(){remove$4(body(),"tox-dialog__disable-scroll")})])].concat(spec.extraBehaviours)),eventOrder:(_a={},_a[execute()]=["execute-on-form"],_a[receive()]=["reflecting","receiving"],_a[attachedToDom()]=["scroll-lock","reflecting","messages","execute-on-form","alloy.base.behaviour"],_a[detachedFromDom()]=["alloy.base.behaviour","execute-on-form","messages","reflecting","scroll-lock"],_a),dom:{tag:"div",classes:["tox-dialog"].concat(spec.extraClasses),styles:__assign({position:"relative"},spec.extraStyles)},components:[spec.header,spec.body].concat(spec.footer.toArray()),dragBlockClass:"tox-dialog-wrap",parts:{blocker:{dom:fromHtml$2('<div class="tox-dialog-wrap"></div>'),components:[{dom:{tag:"div",classes:["tox-dialog-wrap__backdrop"]}}]}}}))},renderDialog=function(dialogInit,extra,backstage){var getForm,header=getHeader(dialogInit.internalDialog.title,backstage),body=renderModalBody({body:dialogInit.internalDialog.body},backstage),footer=renderModalFooter({buttons:dialogInit.internalDialog.buttons},backstage),dialogEvents=SilverDialogEvents.initDialog(function(){return instanceApi},getEventExtras(function(){return dialog},extra)),dialogSize="normal"!==dialogInit.internalDialog.size?"large"===dialogInit.internalDialog.size?["tox-dialog--width-lg"]:["tox-dialog--width-md"]:[],spec={header:header,body:body,footer:Option.some(footer),extraClasses:dialogSize,extraBehaviours:[],extraStyles:{}},dialog=renderModalDialog(spec,dialogInit,dialogEvents,backstage),modalAccess=(getForm=function(){var outerForm=ModalDialog.getBody(dialog);return Composing.getCurrent(outerForm).getOr(outerForm)},{getRoot:function(){return dialog},getBody:function(){return ModalDialog.getBody(dialog)},getFooter:function(){
return ModalDialog.getFooter(dialog)},getFormWrapper:getForm}),instanceApi=getDialogApi(modalAccess,extra.redial);return{dialog:dialog,instanceApi:instanceApi}},global$g=tinymce.util.Tools.resolve("tinymce.util.URI"),getUrlDialogApi=function(root){var withRoot=function(f){root.getSystem().isConnected()&&f(root)},block=function(message){if(!isString(message))throw new Error("The urlDialogInstanceAPI.block function should be passed a blocking message of type string as an argument");withRoot(function(root){emitWith(root,formBlockEvent,{message:message})})},unblock=function(){withRoot(function(root){emit(root,formUnblockEvent)})},close=function(){withRoot(function(root){emit(root,formCloseEvent)})},sendMessage=function(data){withRoot(function(root){root.getSystem().broadcastOn([bodySendMessageChannel],data)})};return{block:block,unblock:unblock,close:close,sendMessage:sendMessage}},SUPPORTED_MESSAGE_ACTIONS=["insertContent","setContent","execCommand","close","block","unblock"],isSupportedMessage=function(data){return isObject(data)&&-1!==SUPPORTED_MESSAGE_ACTIONS.indexOf(data.mceAction)},isCustomMessage=function(data){return!isSupportedMessage(data)&&isObject(data)&&has(data,"mceAction")},handleMessage=function(editor,api,data){switch(data.mceAction){case"insertContent":editor.insertContent(data.content);break;case"setContent":editor.setContent(data.content);break;case"execCommand":var ui=!!isBoolean(data.ui)&&data.ui;editor.execCommand(data.cmd,ui,data.value);break;case"close":api.close();break;case"block":api.block(data.message);break;case"unblock":api.unblock()}},renderUrlDialog=function(internalDialog,extra,editor,backstage){var _a,header=getHeader(internalDialog.title,backstage),body=renderIframeBody(internalDialog),footer=internalDialog.buttons.bind(function(buttons){return 0===buttons.length?Option.none():Option.some(renderModalFooter({buttons:buttons},backstage))}),dialogEvents=SilverDialogEvents.initUrlDialog(function(){return instanceApi},getEventExtras(function(){return dialog},extra)),styles=__assign({},internalDialog.height.fold(function(){return{}},function(height){return{height:height+"px","max-height":height+"px"}}),internalDialog.width.fold(function(){return{}},function(width){return{width:width+"px","max-width":width+"px"}})),classes=internalDialog.width.isNone()&&internalDialog.height.isNone()?["tox-dialog--width-lg"]:[],iframeUri=new global$g(internalDialog.url,{base_uri:new global$g(domGlobals.window.location.href)}),iframeDomain=iframeUri.protocol+"://"+iframeUri.host+(iframeUri.port?":"+iframeUri.port:""),messageHandlerUnbinder=Cell(Option.none()),extraBehaviours=[config("messages",[runOnAttached(function(){var unbind=bind$3(Element.fromDom(domGlobals.window),"message",function(e){if(iframeUri.isSameOrigin(new global$g(e.raw().origin))){var data=e.raw().data;isSupportedMessage(data)?handleMessage(editor,instanceApi,data):isCustomMessage(data)&&internalDialog.onMessage(instanceApi,data)}});messageHandlerUnbinder.set(Option.some(unbind))}),runOnDetached(function(){messageHandlerUnbinder.get().each(function(unbinder){return unbinder.unbind()})})]),Receiving.config({channels:(_a={},_a[bodySendMessageChannel]={onReceive:function(comp,data){descendant$1(comp.element(),"iframe").each(function(iframeEle){var iframeWin=iframeEle.dom().contentWindow;iframeWin.postMessage(data,iframeDomain)})}},_a)})],spec={header:header,body:body,footer:footer,extraClasses:classes,extraBehaviours:extraBehaviours,extraStyles:styles},dialog=renderModalDialog(spec,internalDialog,dialogEvents,backstage),instanceApi=getUrlDialogApi(dialog);return{dialog:dialog,instanceApi:instanceApi}},renderInlineDialog=function(dialogInit,extra,backstage,ariaAttrs){var _a,_b,dialogLabelId=generate$1("dialog-label"),dialogContentId=generate$1("dialog-content"),updateState=function(_comp,incoming){return Option.some(incoming)},memHeader=record(renderInlineHeader({title:dialogInit.internalDialog.title,draggable:!0},dialogLabelId,backstage.shared.providers)),memBody=record(renderInlineBody({body:dialogInit.internalDialog.body},dialogContentId,backstage,ariaAttrs)),memFooter=record(renderInlineFooter({buttons:dialogInit.internalDialog.buttons},backstage)),dialogEvents=SilverDialogEvents.initDialog(function(){return instanceApi},{onBlock:function(){},onUnblock:function(){},onClose:function(){return extra.closeWindow()}}),dialog=build$1({dom:{tag:"div",classes:["tox-dialog","tox-dialog-inline"],attributes:(_a={role:"dialog"},_a["aria-labelledby"]=dialogLabelId,_a["aria-describedby"]=""+dialogContentId,_a)},eventOrder:(_b={},_b[receive()]=[Reflecting.name(),Receiving.name()],_b[execute()]=["execute-on-form"],_b[attachedToDom()]=["reflecting","execute-on-form"],_b),behaviours:derive$1([Keying.config({mode:"cyclic",onEscape:function(c){return emit(c,formCloseEvent),Option.some(!0)},useTabstopAt:function(elem){return!NavigableObject.isPseudoStop(elem)&&("button"!==name(elem)||"disabled"!==get$2(elem,"disabled"))}}),Reflecting.config({channel:dialogChannel,updateState:updateState,initialData:dialogInit}),Focusing.config({}),config("execute-on-form",dialogEvents.concat([runOnSource(focusin(),function(comp,se){Keying.focusIn(comp)})])),RepresentingConfigs.memory({})]),components:[memHeader.asSpec(),memBody.asSpec(),memFooter.asSpec()]}),instanceApi=getDialogApi({getRoot:function(){return dialog},getFooter:function(){return memFooter.get(dialog)},getBody:function(){return memBody.get(dialog)},getFormWrapper:function(){var body=memBody.get(dialog);return Composing.getCurrent(body).getOr(body)}},extra.redial);return{dialog:dialog,instanceApi:instanceApi}},hiddenHeader={dom:{tag:"div",styles:{display:"none"},classes:["tox-dialog__header"]}},defaultHeader={dom:{tag:"div",classes:["tox-dialog__header"]}},pClose=function(onClose,providersBackstage){return ModalDialog.parts().close(Button.sketch({dom:{tag:"button",classes:["tox-button","tox-button--icon","tox-button--naked"],attributes:{type:"button","aria-label":providersBackstage.translate("Close")}},action:onClose,buttonBehaviours:derive$1([Tabstopping.config({})])}))},pUntitled=function(){return ModalDialog.parts().title({dom:{tag:"div",classes:["tox-dialog__title"],innerHtml:"",styles:{display:"none"}}})},pBodyMessage=function(message,providersBackstage){return ModalDialog.parts().body({dom:{tag:"div",classes:["tox-dialog__body"]},components:[{dom:{tag:"div",classes:["tox-dialog__body-content"]},components:[{dom:fromHtml$2("<p>"+providersBackstage.translate(message)+"</p>")}]}]})},pFooter=function(buttons){return ModalDialog.parts().footer({dom:{tag:"div",classes:["tox-dialog__footer"]},components:buttons})},pFooterGroup=function(startButtons,endButtons){return[Container.sketch({dom:{tag:"div",classes:["tox-dialog__footer-start"]},components:startButtons}),Container.sketch({dom:{tag:"div",classes:["tox-dialog__footer-end"]},components:endButtons})]},renderDialog$1=function(spec){return ModalDialog.sketch({lazySink:spec.lazySink,onEscape:function(){return spec.onCancel(),Option.some(!0)},dom:{tag:"div",classes:["tox-dialog"].concat(spec.extraClasses)},components:[deepMerge(spec.headerOverride.getOr(defaultHeader),{components:[spec.partSpecs.title,spec.partSpecs.close]}),spec.partSpecs.body,spec.partSpecs.footer],parts:{blocker:{dom:fromHtml$2('<div class="tox-dialog-wrap"></div>'),components:[{dom:{tag:"div",classes:["tox-dialog-wrap__backdrop"]}}]}},modalBehaviours:derive$1([config("basic-dialog-events",[run(formCancelEvent,function(comp,se){spec.onCancel()}),run(formSubmitEvent,function(comp,se){spec.onSubmit()})])])})},setup$9=function(extras){var sharedBackstage=extras.backstage.shared,open=function(message,callback){var closeDialog=function(){ModalDialog.hide(alertDialog),callback()},memFooterClose=record(renderFooterButton({name:"close-alert",text:"OK",primary:!0,align:"end",disabled:!1,icon:Option.none()},"cancel",extras.backstage)),alertDialog=build$1(renderDialog$1({lazySink:function(){return sharedBackstage.getSink()},headerOverride:Option.some(hiddenHeader),partSpecs:{title:pUntitled(),close:pClose(function(){closeDialog()},sharedBackstage.providers),body:pBodyMessage(message,sharedBackstage.providers),footer:pFooter(pFooterGroup([],[memFooterClose.asSpec()]))},onCancel:function(){return closeDialog()},onSubmit:noop,extraClasses:["tox-alert-dialog"]}));ModalDialog.show(alertDialog);var footerCloseButton=memFooterClose.get(alertDialog);Focusing.focus(footerCloseButton)};return{open:open}},setup$a=function(extras){var sharedBackstage=extras.backstage.shared,open=function(message,callback){var closeDialog=function(state){ModalDialog.hide(confirmDialog),callback(state)},memFooterYes=record(renderFooterButton({name:"yes",text:"Yes",primary:!0,align:"end",disabled:!1,icon:Option.none()},"submit",extras.backstage)),footerNo=renderFooterButton({name:"no",text:"No",primary:!0,align:"end",disabled:!1,icon:Option.none()},"cancel",extras.backstage),confirmDialog=build$1(renderDialog$1({lazySink:function(){return sharedBackstage.getSink()},headerOverride:Option.some(hiddenHeader),partSpecs:{title:pUntitled(),close:pClose(function(){closeDialog(!1)},sharedBackstage.providers),body:pBodyMessage(message,sharedBackstage.providers),footer:pFooter(pFooterGroup([],[footerNo,memFooterYes.asSpec()]))},onCancel:function(){return closeDialog(!1)},onSubmit:function(){return closeDialog(!0)},extraClasses:["tox-confirm-dialog"]}));ModalDialog.show(confirmDialog);var footerYesButton=memFooterYes.get(confirmDialog);Focusing.focus(footerYesButton)};return{open:open}},validateData$1=function(data,validator){return getOrDie(asRaw("data",validator,data))},setup$b=function(extras){var alertDialog=setup$9(extras),confirmDialog=setup$a(extras),open=function(config,params,closeWindow){return void 0!==params&&"toolbar"===params.inline?openInlineDialog(config,extras.backstage.shared.anchors.toolbar(),closeWindow,params.ariaAttrs):void 0!==params&&"cursor"===params.inline?openInlineDialog(config,extras.backstage.shared.anchors.cursor(),closeWindow,params.ariaAttrs):openModalDialog(config,closeWindow)},openUrl=function(config,closeWindow){return openModalUrlDialog(config,closeWindow)},openModalUrlDialog=function(config,closeWindow){var factory=function(contents){var dialog=renderUrlDialog(contents,{closeWindow:function(){ModalDialog.hide(dialog.dialog),closeWindow(dialog.instanceApi)}},extras.editor,extras.backstage);return ModalDialog.show(dialog.dialog),dialog.instanceApi};return DialogManager.openUrl(factory,config)},openModalDialog=function(config,closeWindow){var factory=function(contents,internalInitialData,dataValidator){var initialData=internalInitialData,dialogInit={dataValidator:dataValidator,initialData:initialData,internalDialog:contents},dialog=renderDialog(dialogInit,{redial:DialogManager.redial,closeWindow:function(){ModalDialog.hide(dialog.dialog),closeWindow(dialog.instanceApi)}},extras.backstage);return ModalDialog.show(dialog.dialog),dialog.instanceApi.setData(initialData),dialog.instanceApi};return DialogManager.open(factory,config)},openInlineDialog=function(config$1,anchor,closeWindow,ariaAttrs){var factory=function(contents,internalInitialData,dataValidator){var initialData=validateData$1(internalInitialData,dataValidator),dialogInit={dataValidator:dataValidator,initialData:initialData,internalDialog:contents},dialogUi=renderInlineDialog(dialogInit,{redial:DialogManager.redial,closeWindow:function(){InlineView.hide(inlineDialog),closeWindow(dialogUi.instanceApi)}},extras.backstage,ariaAttrs),inlineDialog=build$1(InlineView.sketch({lazySink:extras.backstage.shared.getSink,dom:{tag:"div",classes:[]},fireDismissalEventInstead:{},inlineBehaviours:derive$1([config("window-manager-inline-events",[run(dismissRequested(),function(comp,se){emit(dialogUi.dialog,formCancelEvent)})])])}));return InlineView.showAt(inlineDialog,anchor,premade$1(dialogUi.dialog)),dialogUi.instanceApi.setData(initialData),Keying.focusIn(dialogUi.dialog),dialogUi.instanceApi};return DialogManager.open(factory,config$1)},confirm=function(message,callback){confirmDialog.open(message,function(state){callback(state)})},alert=function(message,callback){alertDialog.open(message,function(){callback()})},close=function(instanceApi){instanceApi.close()};return{open:open,openUrl:openUrl,alert:alert,close:close,confirm:confirm}},WindowManager={setup:setup$b};Theme()})(window);